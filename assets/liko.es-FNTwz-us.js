const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/liko.physics.es-Bka1YuRG.js","assets/index-BKZWgIt2.js"])))=>i.map(i=>d[i]);
import{_ as Fe}from"./index-BKZWgIt2.js";var $e=Object.defineProperty,ze=(s,t,e)=>t in s?$e(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,n=(s,t,e)=>ze(s,typeof t!="symbol"?t+"":t,e);const nt=Math.PI*2,Ye=180/Math.PI,Oe=Math.PI/180;var _=(s=>(s[s.transform=1]="transform",s[s.size=2]="size",s[s.texture=4]="texture",s[s.color=8]="color",s[s.filter=16]="filter",s[s.child=32]="child",s[s.parent=64]="parent",s))(_||{}),v=(s=>(s.added="added",s.addedToStage="addedToStage",s.removed="removed",s.destroyed="destroyed",s.resize="resize",s.pointerDown="pointerdown",s.pointerUp="pointerup",s.pointerMove="pointermove",s.pointerOver="pointerover",s.pointerOut="pointerout",s.pointerUpOutside="pointerupoutside",s.click="click",s.signal="signal",s.collisionStart="collisionStart",s.collisionEnd="collisionEnd",s.update="update",s.keydown="keydown",s.keyup="keyup",s.wheel="wheel",s.played="played",s.stopped="stopped",s.ended="ended",s.paused="paused",s.resumed="resumed",s.loaded="loaded",s.progress="progress",s.complete="complete",s.error="error",s))(v||{});const le={},ce={},de={};function ue(s,t){le[s]=t}function pe(s){const t=le[s];if(t===void 0){console.error(`can not create script: ${s}`);return}return new t}function fe(s,t){ce[s]=t}function mt(s){const t=ce[s];if(t===void 0){console.error(`can not create node: ${s}`);return}return new t}function Xe(s,t){de[s]=t}function ge(s){const t=de[s];if(t===void 0){console.error(`can not create filter: ${s}`);return}return new t}const Qi=Object.freeze(Object.defineProperty({__proto__:null,createFilterInstance:ge,createNodeInstance:mt,createScriptInstance:pe,regFilter:Xe,regNode:fe,regScript:ue},Symbol.toStringTag,{value:"Module"}));class ye{constructor(t,e,i=!1){n(this,"_destroyed",!1),this.callback=t,this.caller=e,this.once=i}destroy(){this._destroyed||(this._destroyed=!0,this.callback=void 0,this.caller=void 0)}get destroyed(){return this._destroyed}run(t){this.callback&&(t!=null&&t.length?this.callback.call(this.caller,...t):this.callback.call(this.caller),this.once&&this.destroy())}}class ht{constructor(){n(this,"_events",{})}on(t,e,i){this._addListener(t,e,i,!1)}once(t,e,i){this._addListener(t,e,i,!0)}_addListener(t,e,i,r){const a=this._events,o=t.toLowerCase();a[o]&&this.off(o,e,i);const h=new ye(e,i||this,r);a[o]?a[o].push(h):a[o]=[h]}off(t,e,i){const r=this._events[t.toLowerCase()];if(!(!r||r.length===0)){if(e===void 0){r.length=0;return}for(let a=r.length-1;a>-1;a--){const o=r[a];o.callback===e&&(!i||o.caller===i)&&(r.splice(a,1),o.destroy())}}}offAll(t){if(!t)this._events={};else{const e=Object.values(this._events);for(const i of e)for(let r=i.length-1;r>-1;r--){const a=i[r];a.caller===t&&(i.splice(r,1),a.destroy())}}}emit(t,...e){const i=this._events[t.toLowerCase()];if(!(!i||i.length===0))for(let r=0,a=i.length;r<a;r++){const o=i[r];o&&(o.run(e),o.once&&i.splice(r,1))}}hasListener(t){const e=this._events[t.toLowerCase()];return!!e&&e.length!==0}destroy(){this.offAll()}}class Xt extends ye{constructor(t,e,i=!1,r,a=0,o=!1){super(t,e,i),n(this,"nextTime",0),this.args=r,this.delay=a,this.useFrame=o}runTime(t){super.run(this.args),this.once||(this.nextTime=t+this.delay-(t-this.nextTime)%this.delay)}run(){super.run(this.args),this.once||(this.nextTime+=this.delay)}destroy(){this.destroyed||(this.nextTime=Number.POSITIVE_INFINITY,super.destroy())}}const gt=class X{constructor(){n(this,"_timers",[]),n(this,"_lastTime",0),n(this,"delta",0),n(this,"scale",1),n(this,"currentTime",0),n(this,"currentFrame",0),n(this,"_paused",!1),n(this,"_destroyed",!1)}static callLater(t,e,...i){for(const a of X._callLaterList)if(a.callback===t&&a.caller===e)return!1;const r=new Xt(t,e,!0,i);return X._callLaterList.push(r),!0}static runAllCallLater(){if(X._callLaterList.length>0){for(let t=0;t<X._callLaterList.length;t++)X._callLaterList[t].run();X._callLaterList.length=0}}get paused(){return this._paused}get count(){let t=0;for(const e of this._timers)!e.destroyed&&t++;return t}get destroyed(){return this._destroyed}destroy(){this._destroyed||(this._destroyed=!0,this.clearAll())}setTimeout(t,e,i,...r){this._add(t,e,i,r,!1,!0)}setInterval(t,e,i,...r){this._add(t,e,i,r,!1,!1)}onFrame(t,e,...i){this._add(1,t,e,i,!0,!1)}_add(t,e,i,r,a,o){if(this._destroyed)return;let h=t;o||(a&&t<1&&(h=1),!a&&t<.001&&(h=.001)),this.clearTimer(e,i);const l=new Xt(e,i,o,r,h,a);l.nextTime=(a?this.currentFrame:this.currentTime)+h,this._timers.push(l)}clearTimer(t,e){for(const i of this._timers)if(i.callback===t&&(!e||i.caller===e)){i.destroy();return}}clearAll(t){const e=this._timers;for(const i of e)(!t||i.caller===t)&&i.destroy();t||(e.length=0)}pause(){this._paused=!0}resume(){this._paused=!1}update(t=X.system.currentTime){if(this._paused||this._destroyed){this.delta=0;return}if(t>this._lastTime){const e=t-this._lastTime;this._lastTime=t,this.delta=e*this.scale,this.currentTime+=this.delta,this.currentFrame++;const i=this._timers;for(const r of i){const a=r.useFrame?this.currentFrame:this.currentTime;a>=r.nextTime&&r.runTime(a)}this.currentFrame%2e3===0&&this._clean()}else this.delta=0}_clean(){this._timers.length>0&&(this._timers=this._timers.filter(t=>!t.destroyed))}};n(gt,"system",new gt),n(gt,"_callLaterList",[]);let E=gt,Pt=0;function me(){return Pt++}function q(s=""){return Pt++,`${s}${Pt}${Math.random().toString(36).substring(2,9)}`}const Ft=document.createElement("canvas");Ft.width=1;Ft.height=1;const xt=Ft.getContext("2d");function Ne(s,t){return xt.createPattern(s,t)}function Ge(s,t){return new Promise(e=>{const i=new Image;i.src=s,i.crossOrigin="anonymous",i.onload=()=>{e(xt.createPattern(i,t))}})}function Ue(s,t){const e=xt.createLinearGradient(s.startX,s.startY,s.endX,s.endY);for(const i of t)e.addColorStop(i.offset,i.color);return e}function We(s,t){const e=xt.createRadialGradient(s.startX,s.startY,s.startRadius,s.endX,s.endY,s.endRadius);for(const i of t)e.addColorStop(i.offset,i.color);return e}function lt(s=100,t=100){const e=document.createElement("canvas");return e.width=s,e.height=t,e}function xe(s){const t=s.split("/");return t.pop(),`${t.join("/")}/`}function je(s){return new Promise(t=>{setTimeout(t,s*1e3)})}function He(){return new Promise(s=>{E.callLater(()=>s())})}function $t(s){const t=JSON.stringify(s);return JSON.parse(t)}function _e(s){const t=pe(s.script);return t&&(t.id=s.id,t.setProps(s.props)),t}function qe(s){const t=mt(s.type);return t&&(t.id=s.id,t.fromJson(s)),t}const Zi=Object.freeze(Object.defineProperty({__proto__:null,cloneJson:$t,createCanvas:lt,createLinearGradient:Ue,createNode:qe,createPattern:Ne,createPatternFromUrl:Ge,createRadialGradient:We,createScript:_e,getPathRoot:xe,getUID:q,getUIDNumber:me,waitNextFrame:He,waitTime:je},Symbol.toStringTag,{value:"Module"})),tt={loadBlob:async s=>(await fetch(s)).blob(),loadText:async s=>(await fetch(s)).text(),loadJson:async s=>(await fetch(s)).json(),loadArrayBuffer:async s=>(await fetch(s)).arrayBuffer()};class Ke{constructor(t){n(this,"_keydownHandler",this._onKeydown.bind(this)),n(this,"_keyupHandler",this._onKeyup.bind(this)),n(this,"_wheelHandler",this._onWheel.bind(this)),n(this,"_keyMap",{}),n(this,"ignoreCase",!0),this.stage=t,globalThis.addEventListener("keydown",this._keydownHandler,{capture:!0,passive:!0}),globalThis.addEventListener("keyup",this._keyupHandler,{capture:!0,passive:!0}),t.canvas.addEventListener("wheel",this._wheelHandler,{capture:!0,passive:!1})}destroy(){globalThis.removeEventListener("keydown",this._keydownHandler,!0),globalThis.removeEventListener("keyup",this._keyupHandler,!0),this.stage.canvas.removeEventListener("wheel",this._wheelHandler,!1)}_getKey(t){return this.ignoreCase?t.toLowerCase():t}_onKeydown(t){const e=this._getKey(t.key);this._keyMap[e]=!0,this.stage.emit(v.keydown,t)}_onKeyup(t){const e=this._getKey(t.key);this._keyMap[e]=!1,this.stage.emit(v.keyup,t)}_onWheel(t){t.preventDefault(),this.stage.emit(v.wheel,t)}hasKeydown(t){const e=this._getKey(t);return this._keyMap[e]===!0}}class z{constructor(t){n(this,"propagationStopped",!1),n(this,"preventDefaulted",!1),n(this,"nativeEvent"),n(this,"target"),n(this,"currentTarget"),n(this,"pointer",{x:0,y:0}),n(this,"movement",{x:0,y:0}),n(this,"altKey",!1),n(this,"ctrlKey",!1),n(this,"shiftKey",!1),n(this,"detail",0),n(this,"button",0),n(this,"path",[]),this.type=t}preventDefault(){this.preventDefaulted=!0,this.nativeEvent.preventDefault()}stopPropagation(){this.propagationStopped=!0}cloneFrom(t){return this.type=t.type,this.nativeEvent=t.nativeEvent,this.target=t.target,this.currentTarget=t.currentTarget,this.pointer=t.pointer,this.movement=t.movement,this.altKey=t.altKey,this.ctrlKey=t.ctrlKey,this.shiftKey=t.shiftKey,this.detail=t.detail,this.button=t.button,this}clone(){return new z(this.type).cloneFrom(this)}}const bt={down:new z("pointerdown"),up:new z("pointerup"),move:new z("pointermove"),over:new z("pointerover"),out:new z("pointerout"),upOutside:new z("pointerupoutside"),click:new z("click")};class Je{constructor(t){n(this,"_downHandler",this._onPointerDown.bind(this)),n(this,"_moveHandler",this._onPointerMove.bind(this)),n(this,"_upHandler",this._onPointerUp.bind(this)),n(this,"_lastOver"),n(this,"_canvas"),this.root=t,this._canvas=t.canvas,this._canvas.addEventListener("pointerdown",this._downHandler,{capture:!0,passive:!0}),globalThis.addEventListener("pointermove",this._moveHandler,{capture:!0,passive:!0}),globalThis.addEventListener("pointerup",this._upHandler,{capture:!0,passive:!0})}destroy(){this._canvas.removeEventListener("pointerdown",this._downHandler,!0),globalThis.removeEventListener("pointermove",this._moveHandler,!0),globalThis.removeEventListener("pointerup",this._upHandler,!0),this._lastOver=void 0}_onPointerDown(t){const e=this._convertEvent(t,"down");this.hitTest(this.root,e.pointer,e.path),this._emitEvent(e)}_onPointerUp(t){const e=this._convertEvent(t,"up"),i=bt.down.path;if(t.target===this._canvas){if(this.hitTest(this.root,e.pointer,e.path),this._emitEvent(e),!e.preventDefaulted){const r=this._cloneEvent(e,"click"),a=r.path;for(const o of e.path)i.includes(o)&&a.push(o);this._emitEvent(r)}}else{const r=this._cloneEvent(e,"upOutside");r.path.push(...i),this._emitEvent(r)}}_onPointerMove(t){const e=this._convertEvent(t,"move");if(this.hitTest(this.root,e.pointer,e.path),e.path.length<1)return;this._emitEvent(e);const i=e.path[0],r=this._cloneEvent(e,"over"),a=this._cloneEvent(e,"out");this._lastOver!==i&&(this._lastOver&&(this._getPathByTarget(this._lastOver,a.path),this._emitEvent(a)),i!==this.root?(this._getPathByTarget(i,r.path),this._emitEvent(r),this._lastOver=i):this._lastOver=void 0)}_getPathByTarget(t,e){t.pointerEnabled&&e.push(t),t.parent&&this._getPathByTarget(t.parent,e)}_cloneEvent(t,e){const i=bt[e],r=i.type;return i.cloneFrom(t),i.type=r,i.propagationStopped=!1,i.preventDefaulted=!1,i.path.length=0,i}_convertEvent(t,e){const i=bt[e];return i.nativeEvent=t,i.pointer=this._convertPoint(t.clientX,t.clientY,i.pointer),i.movement.x=t.movementX,i.movement.y=t.movementY,i.altKey=t.altKey,i.ctrlKey=t.ctrlKey,i.shiftKey=t.shiftKey,i.detail=t.detail,i.button=t.button,i.propagationStopped=!1,i.preventDefaulted=!1,i.path.length=0,i}_convertPoint(t,e,i){const r=this._canvas,a=r.isConnected?r.getBoundingClientRect():{width:r.width,height:r.height,left:0,top:0};return i.x=(t-a.left)*(r.width/a.width)/Y.pixelRatio,i.y=(e-a.top)*(r.height/a.height)/Y.pixelRatio,i}hitTest(t,e,i){if(!t.pointerEnabled&&!t.pointerEnabledForChildren||!t.visible)return i;if(t.pointerEnabledForChildren&&t.children.length)for(let r=t.children.length-1;r>-1;r--){const a=t.children[r],o=this.hitTest(a,e,i);if(o.length)return t.pointerEnabled&&o.push(t),o}return t.pointerEnabled&&t.hitTest(e)&&i.push(t),i}_emitEvent(t){if(t.path.length){t.target=t.path[0];for(const e of t.path)t.propagationStopped||(t.currentTarget=e,e.emit(t.type,t))}}}class Qe extends ht{constructor(){super(...arguments),n(this,"_data",{})}fromJson(t){const e=Object.keys(t);for(const i of e){const r=t[i];typeof r!="object"?this._data[i]=r:this._data[i]=$t(r)}}get(t){return this._data[t]}set(t,e){this._data[t]!==e&&(this._data[t]=e,this.emit("changed",t,e))}remove(t){delete this._data[t]}clear(){this._data={}}destroy(){super.destroy(),this.clear()}}const St=class ve{constructor(t=0,e=0){n(this,"x",0),n(this,"y",0),this.x=t,this.y=e}set(t=0,e=t){return this.x=t,this.y=e,this}reset(){this.x=0,this.y=0}equals(t){return t.x===this.x&&t.y===this.y}radian(t){return Math.atan2(t.y-this.y,t.x-this.x)}distance(t){const e=this.x-t.x,i=this.y-t.y;return Math.sqrt(e*e+i*i)}add(t,e){return this.x+=t,this.y+=e,this}normalize(){const t=Math.sqrt(this.x*this.x+this.y*this.y);return t!==0&&(this.x=this.x/t,this.y=this.y/t),this}copyFrom(t){return this.set(t.x,t.y),this}clone(){return new ve(this.x,this.y)}};n(St,"TEMP",new St);let L=St;class F{constructor(t=1,e=0,i=0,r=1,a=0,o=0){n(this,"a",1),n(this,"b",0),n(this,"c",0),n(this,"d",1),n(this,"tx",0),n(this,"ty",0),this.set(t,e,i,r,a,o)}static get IDENTITY(){return ti.identity()}static get TEMP(){return Ze.identity()}get isIdentity(){return this.a===1&&this.b===0&&this.c===0&&this.d===1&&this.tx===0&&this.ty===0}set(t,e,i,r,a,o){return this.a=t,this.b=e,this.c=i,this.d=r,this.tx=a,this.ty=o,this}apply(t,e){const i=e||new L,r=t.x,a=t.y;return i.x=this.a*r+this.c*a+this.tx,i.y=this.b*r+this.d*a+this.ty,i}applyInverse(t,e){const i=e||new L,{a:r,b:a,c:o,d:h,tx:l,ty:c}=this,{x:d,y:u}=t,p=1/(r*h+o*-a);return i.x=h*p*d+-o*p*u+(c*o-l*h)*p,i.y=r*p*u+-a*p*d+(-c*r+l*a)*p,i}translate(t,e){return this.tx+=t,this.ty+=e,this}scale(t,e){return this.a*=t,this.d*=e,this.c*=t,this.b*=e,this.tx*=t,this.ty*=e,this}rotate(t){const e=Math.cos(t),i=Math.sin(t),r=this.a,a=this.c,o=this.tx;return this.a=r*e-this.b*i,this.b=r*i+this.b*e,this.c=a*e-this.d*i,this.d=a*i+this.d*e,this.tx=o*e-this.ty*i,this.ty=o*i+this.ty*e,this}append(t){const e=this.a,i=this.b,r=this.c,a=this.d;return this.a=t.a*e+t.b*r,this.b=t.a*i+t.b*a,this.c=t.c*e+t.d*r,this.d=t.c*i+t.d*a,this.tx=t.tx*e+t.ty*r+this.tx,this.ty=t.tx*i+t.ty*a+this.ty,this}prepend(t){const e=this.tx;if(t.a!==1||t.b!==0||t.c!==0||t.d!==1){const i=this.a,r=this.c;this.a=i*t.a+this.b*t.c,this.b=i*t.b+this.b*t.d,this.c=r*t.a+this.d*t.c,this.d=r*t.b+this.d*t.d}return this.tx=e*t.a+this.ty*t.c+t.tx,this.ty=e*t.b+this.ty*t.d+t.ty,this}decompose(t){const{a:e,b:i,c:r,d:a}=this,o=-Math.atan2(-r,a),h=Math.atan2(i,e),l=Math.abs(o+h);let c=0;l<1e-5||Math.abs(nt-l)<1e-5?c=Math.abs(h)<1e-5?0:h:c=0;const d={x:1,y:1};d.x=Math.sqrt(e*e+i*i),d.y=Math.sqrt(r*r+a*a);const u={x:0,y:0},p=t.pivot;return u.x=this.tx+(p.x*e+p.y*r),u.y=this.ty+(p.x*i+p.y*a),{position:u,scale:d,rotation:c}}invert(){const t=this.a,e=this.b,i=this.c,r=this.d,a=this.tx,o=t*r-e*i;return this.a=r/o,this.b=-e/o,this.c=-i/o,this.d=t/o,this.tx=(i*this.ty-r*a)/o,this.ty=-(t*this.ty-e*a)/o,this}identity(){return this.set(1,0,0,1,0,0),this}copyFrom(t){return this.set(t.a,t.b,t.c,t.d,t.tx,t.ty),this}clone(){return new F(this.a,this.b,this.c,this.d,this.tx,this.ty)}}const Ze=new F,ti=new F,ct=[new L,new L,new L,new L],Ct=class be{constructor(t=0,e=0,i=0,r=0){n(this,"x",0),n(this,"y",0),n(this,"width",0),n(this,"height",0),this.set(t,e,i,r)}get left(){return this.x}get right(){return this.x+this.width}get top(){return this.y}get bottom(){return this.y+this.height}set(t,e,i,r){return this.x=t,this.y=e,this.width=i,this.height=r,this}reset(){return this.set(0,0,0,0),this}copyFrom(t){return this.set(t.x,t.y,t.width,t.height),this}copyFromBounds(t){return this.set(t.minX,t.minY,t.width,t.height),this}equals(t){return t.x===this.x&&t.y===this.y&&t.width===this.width&&t.height===this.height}fit(t){const e=Math.min(this.x,t.x),i=Math.max(this.x+this.width,t.x+t.width),r=Math.min(this.y,t.y),a=Math.max(this.y+this.height,t.y+t.height);return this.x=e,this.width=i-e,this.y=r,this.height=a-r,this}pad(t=0,e=t){return this.x-=t,this.y-=e,this.width+=t*2,this.height+=e*2,this}contains(t,e){return!(t<this.x||t>this.x+this.width||e<this.y||e>this.y+this.height)}intersects(t,e){if(!e){const Le=this.x<t.x?t.x:this.x;if((this.right>t.right?t.right:this.right)<=Le)return!1;const Ve=this.y<t.y?t.y:this.y;return(this.bottom>t.bottom?t.bottom:this.bottom)>Ve}const i=this.left,r=this.right,a=this.top,o=this.bottom;if(r<=i||o<=a)return!1;const h=ct[0].set(t.left,t.top),l=ct[1].set(t.left,t.bottom),c=ct[2].set(t.right,t.top),d=ct[3].set(t.right,t.bottom);if(c.x<=h.x||l.y<=h.y)return!1;const u=Math.sign(e.a*e.d-e.b*e.c);if(u===0||(e.apply(h,h),e.apply(l,l),e.apply(c,c),e.apply(d,d),Math.max(h.x,l.x,c.x,d.x)<=i||Math.min(h.x,l.x,c.x,d.x)>=r||Math.max(h.y,l.y,c.y,d.y)<=a||Math.min(h.y,l.y,c.y,d.y)>=o))return!1;const p=u*(l.y-h.y),f=u*(h.x-l.x),m=p*i+f*a,g=p*r+f*a,y=p*i+f*o,x=p*r+f*o;if(Math.max(m,g,y,x)<=p*h.x+f*h.y||Math.min(m,g,y,x)>=p*d.x+f*d.y)return!1;const P=u*(h.y-c.y),b=u*(c.x-h.x),S=P*i+b*a,M=P*r+b*a,D=P*i+b*o,Q=P*r+b*o;return!(Math.max(S,M,D,Q)<=P*h.x+b*h.y||Math.min(S,M,D,Q)>=P*d.x+b*d.y)}clone(){return new be(this.x,this.y,this.width,this.height)}};n(Ct,"TEMP",new Ct);let zt=Ct;const ei=new F;class K{constructor(t=Number.POSITIVE_INFINITY,e=Number.POSITIVE_INFINITY,i=Number.NEGATIVE_INFINITY,r=Number.NEGATIVE_INFINITY){n(this,"minX",Number.POSITIVE_INFINITY),n(this,"minY",Number.POSITIVE_INFINITY),n(this,"maxX",Number.NEGATIVE_INFINITY),n(this,"maxY",Number.NEGATIVE_INFINITY),n(this,"_rectangle"),this.set(t,e,i,r)}get x(){return this.minX}get y(){return this.minY}get width(){return this.maxX-this.minX}get height(){return this.maxY-this.minY}get left(){return this.minX}get right(){return this.maxX}get top(){return this.minY}get bottom(){return this.maxY}get isValid(){return this.minX+this.minY!==Number.POSITIVE_INFINITY}get isEmpty(){return this.minX>this.maxX||this.minY>this.maxY}get rectangle(){return this._rectangle??(this._rectangle=new zt),this.isEmpty?this._rectangle.set(0,0,0,0):this._rectangle.copyFromBounds(this),this._rectangle}set(t,e,i,r){return this.minX=t,this.minY=e,this.maxX=i,this.maxY=r,this}reset(){return this.minX=Number.POSITIVE_INFINITY,this.minY=Number.POSITIVE_INFINITY,this.maxX=Number.NEGATIVE_INFINITY,this.maxY=Number.NEGATIVE_INFINITY,this}addFrame(t,e,i,r,a){const{a:o,b:h,c:l,d:c,tx:d,ty:u}=a??ei;let{minX:p,minY:f,maxX:m,maxY:g}=this,y=o*t+l*e+d,x=h*t+c*e+u;return y<p&&(p=y),x<f&&(f=x),y>m&&(m=y),x>g&&(g=x),y=o*i+l*e+d,x=h*i+c*e+u,y<p&&(p=y),x<f&&(f=x),y>m&&(m=y),x>g&&(g=x),y=o*t+l*r+d,x=h*t+c*r+u,y<p&&(p=y),x<f&&(f=x),y>m&&(m=y),x>g&&(g=x),y=o*i+l*r+d,x=h*i+c*r+u,y<p&&(p=y),x<f&&(f=x),y>m&&(m=y),x>g&&(g=x),this.minX=p,this.minY=f,this.maxX=m,this.maxY=g,this}addRect(t,e){return this.addFrame(t.x,t.y,t.x+t.width,t.y+t.height,e),this}addBounds(t,e){return this.addFrame(t.minX,t.minY,t.maxX,t.maxY,e),this}addBoundsMask(t){return this.minX=this.minX>t.minX?this.minX:t.minX,this.minY=this.minY>t.minY?this.minY:t.minY,this.maxX=this.maxX<t.maxX?this.maxX:t.maxX,this.maxY=this.maxY<t.maxY?this.maxY:t.maxY,this}applyMatrix(t){const{minX:e,minY:i,maxX:r,maxY:a}=this,{a:o,b:h,c:l,d:c,tx:d,ty:u}=t;let p=o*e+l*i+d,f=h*e+c*i+u;return this.minX=p,this.minY=f,this.maxX=p,this.maxY=f,p=o*r+l*i+d,f=h*r+c*i+u,this.minX=p<this.minX?p:this.minX,this.minY=f<this.minY?f:this.minY,this.maxX=p>this.maxX?p:this.maxX,this.maxY=f>this.maxY?f:this.maxY,p=o*e+l*a+d,f=h*e+c*a+u,this.minX=p<this.minX?p:this.minX,this.minY=f<this.minY?f:this.minY,this.maxX=p>this.maxX?p:this.maxX,this.maxY=f>this.maxY?f:this.maxY,p=o*r+l*a+d,f=h*r+c*a+u,this.minX=p<this.minX?p:this.minX,this.minY=f<this.minY?f:this.minY,this.maxX=p>this.maxX?p:this.maxX,this.maxY=f>this.maxY?f:this.maxY,this}fit(t){return this.minX<t.left&&(this.minX=t.left),this.maxX>t.right&&(this.maxX=t.right),this.minY<t.top&&(this.minY=t.top),this.maxY>t.bottom&&(this.maxY=t.bottom),this}pad(t,e=t){return this.minX-=t,this.maxX+=t,this.minY-=e,this.maxY+=e,this}ceil(){return this.minX=Math.floor(this.minX),this.minY=Math.floor(this.minY),this.maxX=Math.ceil(this.maxX),this.maxY=Math.ceil(this.maxY),this}scale(t,e=t){return this.minX*=t,this.minY*=e,this.maxX*=t,this.maxY*=e,this}contains(t,e){return this.minX<=t&&this.minY<=e&&this.maxX>=t&&this.maxY>=e}clone(){return new K(this.minX,this.minY,this.maxX,this.maxY)}}class et{constructor(t,e=0,i=0){n(this,"_observer"),n(this,"_x",0),n(this,"_y",0),this._x=e,this._y=i,this._observer=t}get x(){return this._x}set x(t){this._x!==t&&(this._x=t,this._observer.markDirty(_.transform))}get y(){return this._y}set y(t){this._y!==t&&(this._y=t,this._observer.markDirty(_.transform))}set(t=0,e=t){return(this._x!==t||this._y!==e)&&(this._x=t,this._y=e,this._observer.markDirty(_.transform)),this}add(t,e){return this._x+=t,this._y+=e,this._observer.markDirty(_.transform),this}equals(t){return t.x===this._x&&t.y===this._y}copyFrom(t){return(this._x!==t.x||this._y!==t.y)&&(this._x=t.x,this._y=t.y,this._observer.markDirty(_.transform)),this}clone(t){return new et(t??this._observer,this._x,this._y)}}const Tt=class{constructor({observer:t}={}){n(this,"scale",new et(this,1,1)),n(this,"pivot",new et(this,0,0)),n(this,"_observer"),n(this,"_rotation",0),n(this,"_cx",1),n(this,"_sx",0),this._observer=t}get rotation(){return this._rotation}set rotation(t){this._rotation!==t&&(this._rotation=t,this._cx=Math.cos(t),this._sx=Math.sin(t),this.markDirty())}getMatrix(t,e){const i=t,{scale:r,pivot:a}=this;return i.a=this._cx*r._x,i.b=this._sx*r._x,i.c=-this._sx*r._y,i.d=this._cx*r._y,i.tx=e.x-(a._x*i.a+a._y*i.c),i.ty=e.y-(a._x*i.b+a._y*i.d),i}updateMatrix(t,e,i,r){const{_cx:a,_sx:o}=this,{_x:h,_y:l}=this.scale,{_x:c,_y:d}=this.pivot,u=a*h,p=o*h,f=-o*l,m=a*l,g=i.x-(c*u+d*f),y=i.y-(c*p+d*m);t.set(u,p,f,m,g,y);const{a:x,b:P,c:b,d:S}=r;e.a=u*x+p*b,e.b=u*P+p*S,e.c=f*x+m*b,e.d=f*P+m*S,e.tx=g*x+y*b+r.tx,e.ty=g*P+y*S+r.ty}markDirty(){var t;(t=this._observer)==null||t.markDirty(_.transform)}};n(Tt,"TEMP",new Tt);let we=Tt;const At=class Pe{constructor(t=0,e=0,i=0,r=0,a=0){n(this,"x",0),n(this,"y",0),n(this,"width",0),n(this,"height",0),n(this,"rotation",0),this.set(t,e,i,r,a)}get left(){return this.x}get right(){return this.x+this.width}get top(){return this.y}get bottom(){return this.y+this.height}set(t,e,i,r,a){return this.x=t,this.y=e,this.width=i,this.height=r,this.rotation=a??this.rotation,this}reset(){return this.set(0,0,0,0,0),this}copyFrom(t){return this.set(t.x,t.y,t.width,t.height,t.rotation),this}clone(){return new Pe(this.x,this.y,this.width,this.height,this.rotation)}};n(At,"TEMP",new At);let ii=At;const rt=class{constructor(t){n(this,"_cache",new Map),n(this,"_Class"),this._Class=t}get(t){let e=this._cache.get(t);return e===void 0&&(e=new this._Class,this._cache.set(t,e)),e}has(t){return this._cache.has(t)}};n(rt,"gloBounds",new rt(K)),n(rt,"rotatingRect",new rt(ii));let Nt=rt;const si=/^rgba\((\d+),\s*(\d+),\s*(\d+),\s*([\d.]+)\)$/i,ri=/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/i,ai=/^(#|0x)([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i,oi={red:"#ff0000",green:"#00ff00",blue:"#0000ff",yellow:"#ffff00",cyan:"#00ffff",magenta:"#ff00ff",white:"#ffffff",black:"#000000",orange:"#ffa500",purple:"#800080",pink:"#ffc0cb",brown:"#a52a2a",gray:"#808080",grey:"#808080",transparent:"rgba(0,0,0,0)"},Mt=class{constructor(t){n(this,"_color",new Float32Array([1,1,1,1])),n(this,"_value","#ffffff"),n(this,"abgr",0),this.value=t??16777215}set value(t){this._value!==t&&(this._value=t,this._parseColor(t))}get value(){return this._value}_parseColor(t){let[e,i,r,a]=[0,0,0,1];switch(typeof t){case"number":{const h=t;e=h>>16&255,i=h>>8&255,r=h&255;break}case"string":{const h=oi[t.toLowerCase()]??t;if(h.startsWith("rgba")){const l=h.match(si);l&&(e=Number(l[1]),i=Number(l[2]),r=Number(l[3]),a=Number(l[4]))}else if(h.startsWith("rgb")){const l=h.match(ri);l&&(e=Number(l[1]),i=Number(l[2]),r=Number(l[3]))}else if(h.startsWith("#")||h.startsWith("0x")){const l=h.match(ai);l&&(e=Number.parseInt(l[2],16),i=Number.parseInt(l[3],16),r=Number.parseInt(l[4],16))}break}}this._color[0]=e/255,this._color[1]=i/255,this._color[2]=r/255,this._color[3]=a;const o=Math.round(a*255);this.abgr=o<<24|r<<16|i<<8|e}get red(){return this._color[0]}get green(){return this._color[1]}get blue(){return this._color[2]}get alpha(){return this._color[3]}toString(){const[t,e,i]=this._color.map(r=>r*255);return`rgba(${t},${e},${i},${this._color[3]})`}changeAlpha(t){this._color[3]=t;const e=Math.round(this._color[0]*255),i=Math.round(this._color[1]*255),r=Math.round(this._color[2]*255),a=Math.round(t*255);this.abgr=a<<24|r<<16|i<<8|e}};n(Mt,"Default",new Mt(16777215));let T=Mt;const Gt={click:!0,pointerdown:!0,pointerup:!0,pointermove:!0,pointerover:!0,pointerout:!0,pointerupoutside:!0},Ut=new we,Wt={},jt=[],Ht=[],qt=[],G=new ht;class O{constructor(t){n(this,"pp",{id:"",userData:Wt,event:G,children:jt,filters:Ht,scripts:qt,transform:Ut,tintColor:T.Default,alpha:1,localMatrix:new F,worldMatrix:new F,position:new et(this),anchor:new et(this),width:-1,height:-1,visible:!0,destroyed:!1,dirty:_.transform|_.size|_.texture|_.color,stage:void 0,parent:void 0,localBounds:new K,boundsDirty:!0}),n(this,"enabled",!0),n(this,"label",""),n(this,"cacheEnabled",!1),n(this,"pointerEnabled",!1),n(this,"pointerEnabledForChildren",!1),t&&this.setProps(t)}destroy(){var t,e,i;this.pp.destroyed||(this.pp.destroyed=!0,this.enabled=!1,this.offAll(),(t=this.scene)==null||t.offAll(this),(e=this.stage)==null||e.offAll(this),(i=this.stage)==null||i.timer.clearAll(this),this.removeSelf(),this.destroyScripts(),this.destroyFilters(),this.destroyChildren())}get destroyed(){return this.pp.destroyed}get stage(){return this.pp.stage}get scene(){var t;return(t=this.pp.parent)==null?void 0:t.scene}get parent(){return this.pp.parent}set parent(t){t?t.addChild(this):this.removeSelf()}get children(){return this.pp.children}get filters(){return this.pp.filters}get scripts(){return this.pp.scripts}set scripts(t){this.destroyScripts();for(const e of t)this.addScript(e)}get userData(){return this.pp.userData===Wt&&(this.pp.userData={}),this.pp.userData}set userData(t){this.pp.userData=t}get id(){return this.pp.id||(this.pp.id=q()),this.pp.id}set id(t){this.pp.id!==t&&(this.pp.id=t)}get visible(){return this.pp.visible&&this.enabled}set visible(t){this.pp.visible!==t&&(this.pp.visible=t,this.markDirty(_.child))}get width(){return this.pp.width>=0?this.pp.width:this.getLocalBounds().width}set width(t){const e=this.pp;e.width!==t&&(e.width=t,this.transform.pivot.x=t*e.anchor.x,this.emit(v.resize),this.markDirty(_.size))}get height(){return this.pp.height>=0?this.pp.height:this.getLocalBounds().height}set height(t){const e=this.pp;e.height!==t&&(e.height=t,this.transform.pivot.y=t*e.anchor.y,this.emit(v.resize),this.markDirty(_.size))}get position(){return this.pp.position}set position(t){this.pp.position.copyFrom(t)}get scale(){return this.transform.scale}set scale(t){this.transform.scale.copyFrom(t)}get rotation(){return this.transform.rotation}set rotation(t){this.transform.rotation=t}get angle(){return this.transform.rotation*Ye}set angle(t){this.transform.rotation=t*Oe}get pivot(){return this.transform.pivot}get anchor(){return this.pp.anchor}set anchor(t){this.pp.anchor.copyFrom(t);const{pivot:e}=this.transform,{width:i,height:r}=this.getLocalBounds();i>0&&r>0&&(e.x=i*t.x,e.y=r*t.y,this.markDirty(_.transform))}get tintColor(){return this.pp.tintColor.value}set tintColor(t){const e=this.pp;e.tintColor.value!==t&&(e.tintColor===T.Default&&(e.tintColor=new T(t)),e.tintColor.value=t,this.markDirty(_.color))}get alpha(){return this.pp.alpha}set alpha(t){this.pp.alpha!==t&&(this.pp.alpha=t,this.markDirty(_.color))}get worldAlpha(){return this.pp.tintColor.alpha}get transform(){return this.pp.transform===Ut&&(this.pp.transform=new we({observer:this})),this.pp.transform}get localMatrix(){const{dirty:t,transform:e,localMatrix:i,position:r}=this.pp;return t&_.transform?e.getMatrix(i,r):i}set localMatrix(t){const{position:e,scale:i,rotation:r}=t.decompose(this.pp.transform);this.position=e,this.scale=i,this.rotation=r}get worldMatrix(){const{dirty:t,worldMatrix:e}=this.pp;return t&_.transform&&this._$getParentWorldMatrix(this,e.identity()).append(this.localMatrix),e}_$getParentWorldMatrix(t,e){const i=t.parent;return i&&(this._$getParentWorldMatrix(i,e),e.append(i.localMatrix)),e}markDirty(t){const e=this.pp;if((e.dirty&t)===0){if(e.dirty|=t,t===_.transform||t===_.color)e.children.length&&this._$dirtyChildren(t);else{if(t===_.child)return e.boundsDirty=!0,this._$dirtyParent(t);t===_.size&&(e.boundsDirty=!0)}this._$dirtyParent(_.parent)}}_$dirtyParent(t){let e=this.parent;for(;e&&(e.pp.dirty&t)===0;)e.pp.dirty|=t,e=e.parent}_$dirtyChildren(t){for(const e of this.children)(e.pp.dirty&t)===0&&(e.pp.dirty|=t,e.children.length&&e._$dirtyChildren(t))}addChild(t,e){const i=this.pp;return i.children===jt&&(i.children=[]),t.removeSelf(),t.pp.parent=this,e!==void 0?i.children.splice(e,0,t):i.children.push(t),i.stage&&this._$addToStage(t,i.stage),t.emit(v.added,this),this.markDirty(_.child),this}_$addToStage(t,e){t.pp.stage=e,t.emit(v.addedToStage,e);for(const i of t.children)this._$addToStage(i,e)}getIndexInParent(){return this.parent?this.parent.children.indexOf(this):-1}setChildIndex(t,e){const i=this.children;if(e<0||e>=i.length)throw new Error(`The index ${e} is out of bounds`);const r=t.getIndexInParent();return i.splice(r,1),i.splice(e,0,t),this.markDirty(_.child),this}findChild(t){const{id:e,label:i,Class:r,deep:a}=t,{children:o}=this.pp;for(let h=0,l=o.length;h<l;h++){const c=o[h];if(e&&c.id===e||i&&c.label===i||r&&c instanceof r)return c}if(a)for(let h=0,l=o.length;h<l;h++){const c=o[h].findChild(t);if(c)return c}}removeChild(t){if(t){const e=this.pp.children.indexOf(t);e!==-1&&(t.pp.parent=void 0,t.pp.stage=void 0,this.pp.children.splice(e,1),t.emit(v.removed,this),this.markDirty(_.child))}return this}removeSelf(){return this.pp.parent&&this.pp.parent.removeChild(this),this}removeChildren(){const{children:t}=this;if(t.length){for(const e of t)e.pp.parent=void 0,e.emit(v.removed,this);t.length=0,this.markDirty(_.child)}return this}destroyChildren(){const{children:t}=this;if(t.length){for(let e=t.length-1;e>-1;e--)t[e].destroy();t.length=0,this.markDirty(_.child)}return this}addFilter(t){return this.pp.filters===Ht&&(this.pp.filters=[]),this.pp.filters.push(t),this.markDirty(_.filter),this}updateFilter(t){return t._dirty=!0,this.markDirty(_.filter),this}findFilter(t){const{id:e,label:i,Class:r}=t,{filters:a}=this.pp;for(let o=0,h=a.length;o<h;o++){const l=a[o];if(e&&l.id===e||i&&l.label===i||r&&l instanceof r)return l}}removeFilter(t){if(t){const e=this.pp.filters.indexOf(t);e!==-1&&(this.pp.filters.splice(e,1),this.markDirty(_.filter))}return this}destroyFilters(){const{filters:t}=this;if(t.length){for(let e=t.length-1;e>-1;e--)t[e].destroy();t.length=0,this.markDirty(_.filter)}return this}addScript(t){const e=this.pp;return e.scripts===qt&&(e.scripts=[]),e.scripts.push(t),t.target=this,this}findScript(t){const{id:e,label:i,Class:r}=t,{scripts:a}=this.pp;for(let o=0,h=a.length;o<h;o++){const l=a[o];if(e&&l.id===e||i&&l.label===i||r&&l instanceof r)return l}}destroyScripts(){const{scripts:t}=this.pp;for(let e=t.length-1;e>-1;e--)t[e].destroy();return t.length=0,this}getWorldScale(t,e){const i=e??new L;i.x=this.scale.x,i.y=this.scale.y;let r=this.parent;for(;r&&(i.x*=r.scale.x,i.y*=r.scale.y,r!==t);)r=r.parent;return i}getWorldRotation(t){let e=this.rotation,i=this.parent;for(;i&&(e+=i.rotation,i!==t);)i=i.parent;return e}_customLocalBounds(t){}getLocalBounds(){const{width:t,height:e,localBounds:i,boundsDirty:r}=this.pp;return r?(i.reset(),t>=0&&e>=0?(i.addFrame(0,0,t,e),this.pp.boundsDirty=!1,i):(this._customLocalBounds(i),i.isValid?(this.pp.boundsDirty=!1,i):(console.warn("localBounds width <=0",this),new K(0,0,1,1)))):i}getWorldBounds(t){const e=Nt.gloBounds.get(this);e.reset();const i=this.getLocalBounds();if(e.addFrame(i.x,i.y,i.right,i.bottom,this.worldMatrix),t&&t!==this.stage){const r=t.worldToLocal(e),a=t.getWorldScale();e.set(r.x,r.y,r.x+e.width/a.x,r.y+e.height/a.y)}return e}getWorldRotatingRect(t){const e=Nt.rotatingRect.get(this);this.localToWorld(L.TEMP.set(0,0),e);const i=this.getWorldScale(t,L.TEMP);return e.width=this.width*i.x,e.height=this.height*i.y,e.rotation=this.getWorldRotation(t),e}localToWorld(t,e,i){const r=this.worldMatrix.apply(t,e);return i&&i!==this.stage&&i.worldToLocal(r,r),r}worldToLocal(t,e,i){if(i&&i!==this.stage){const r=i.worldMatrix.apply(t,e);return this.worldMatrix.applyInverse(r,r)}return this.worldMatrix.applyInverse(t)}fromJson(t){this.pp.id=t.id,this.setProps(t.props);const{children:e}=t;if(e)for(const i of e){const r=i.props.editorOnly?void 0:mt(i.type);r&&(this.addChild(r),r.fromJson(i))}return this.setFilters(t.filters),this.setScripts(t.scripts),this}setProps(t){if(t){const e=Object.keys(t);for(const i of e)this._$setProp(i,t[i])}return this}_$setProp(t,e){if(t.startsWith("on")&&typeof e=="function"){const i=t.charAt(2).toLowerCase()+t.slice(3);this.on(i,e,this)}else t in this&&(this[t]=e)}setScripts(t){if(this.destroyScripts(),t)for(const e of t){const i=_e(e);i&&(this.addScript(i),i.setProps(e.props))}return this}setFilters(t){if(this.destroyFilters(),t)for(const e of t){const i=ge(e.type);i&&(this.addFilter(i),i.setProps(e.props))}return this}hitTest(t){const e=this.worldToLocal(t,L.TEMP),{width:i,height:r}=this.pp;return i>=0&&r>=0?e.x>=0&&e.y>=0&&i>=e.x&&r>=e.y:this.getLocalBounds().contains(e.x,e.y)}on(t,e,i){return this.pp.event===G&&(this.pp.event=new ht),Gt[t]&&(!this.pointerEnabled||!this.pointerEnabledForChildren)&&(this.pointerEnabled=!0,this.pointerEnabledForChildren=!0,this._$pointerEnableParent()),this.pp.event.on(t,e,i),this}_$pointerEnableParent(){let t=this.parent;for(;t&&!t.pointerEnabledForChildren;)t.pointerEnabledForChildren=!0,t=t.parent}once(t,e,i){return this.pp.event===G&&(this.pp.event=new ht),Gt[t]&&(this.pointerEnabled=!0,this.pointerEnabledForChildren=!0,this._$pointerEnableParent()),this.pp.event.once(t,e,i),this}off(t,e,i){return this.pp.event===G?this:(this.pp.event.off(t,e,i),this)}offAll(t){return this.pp.event===G?this:(this.pp.event.offAll(t),this)}emit(t,...e){return this.pp.event===G?this:(this.pp.event.emit(t,...e),this)}hasListener(t){return this.pp.event===G?!1:this.pp.event.hasListener(t)}}function Se(s,t){const e=s.byteLength/8|0,i=new Float64Array(s,0,e);new Float64Array(t,0,e).set(i);const r=s.byteLength-e*8;if(r>0){const a=new Uint8Array(s,e*8,r);new Uint8Array(t,e*8,r).set(a)}return t}class ni{constructor(t=4){n(this,"_array"),n(this,"_buffer"),n(this,"destroyed",!1),n(this,"loaded",!1),n(this,"data"),n(this,"size",0),this.size=t,this._array=new ArrayBuffer(t*4),this.data=new Uint32Array(this._array)}destroy(){var t;this.destroyed||(this.destroyed=!0,(t=this._buffer)==null||t.destroy())}fat(t){var e;let i=Math.max(t,this.size*1.5);i+=i%2,this.size=i;const r=Se(this._array,new ArrayBuffer(i*4));this.data=new Uint32Array(r),(e=this._buffer)==null||e.destroy(),this._buffer=void 0}get buffer(){return this._buffer||(this._buffer=A.createIndexBuffer("index",this.data)),this._buffer}upload(){this.loaded||(this.loaded=!0,A.uploadBuffer(this.buffer,this.data,!0))}reset(){this.loaded=!1}}class wt{constructor(t="vertex"){n(this,"_array"),n(this,"_buffer"),n(this,"f32Data"),n(this,"u32Data"),n(this,"size",0),n(this,"destroyed",!1),n(this,"loaded",!1),this.label=t,this.size=1,this._array=new ArrayBuffer(this.size*4),this.f32Data=new Float32Array(this._array),this.u32Data=new Uint32Array(this._array)}destroy(){var t;this.destroyed||(this.destroyed=!0,(t=this._buffer)==null||t.destroy())}fat(t){var e;this.size=t;const i=Se(this._array,new ArrayBuffer(t*4));this.f32Data=new Float32Array(i),this.u32Data=new Uint32Array(i),(e=this._buffer)==null||e.destroy(),this._buffer=void 0}get buffer(){return this._buffer||(this._buffer=A.createVertexBuffer(this.label,this.f32Data)),this._buffer}upload(){this.loaded||(this.loaded=!0,A.uploadBuffer(this.buffer,this.f32Data))}reset(){this.loaded=!1}}const Ce=class at{static get instance(){return at._instance??(at._instance=new at),at._instance}render(t,e){const i=t.pp.dirty;let r=e[0].renderNode(t);for(const a of e)i||a._dirty?(r=a.render(r),r.label=t.label):r=a.renderTarget;return r.pp.transform=t.transform,r.position=t.position,r.width=t.width,r.height=t.height,r}};n(Ce,"_instance");let hi=Ce;const Kt=new Map;function li(s){let t=Kt.get(s);return t||(t=new vt,s.on(v.destroyed,()=>t==null?void 0:t.reset()),Kt.set(s,t)),t}class _t{constructor(t){n(this,"vertexSize",4*2),n(this,"indexSize",6),n(this,"colorSize",4*1),n(this,"uvSize",4*3),n(this,"vertexStart",0),n(this,"indexStart",0),n(this,"colorStart",0),n(this,"uvStart",0),n(this,"batch"),n(this,"textureId",0),this.node=t}packVertex(t){const{node:e,vertexStart:i}=this,{f32Data:r}=t,{width:a,height:o,trimRect:h}=e.texture,{width:l,height:c}=e.getLocalBounds(),d=e.pp.worldMatrix,u=l/a,p=c/o,f=d.a*u,m=d.b*u,g=d.c*p,y=d.d*p,x=d.tx,P=d.ty,b=h.width,S=h.x,M=h.height,D=h.y;r[i]=f*S+g*D+x,r[i+1]=y*D+m*S+P,r[i+2]=f*b+g*D+x,r[i+3]=y*D+m*b+P,r[i+4]=f*b+g*M+x,r[i+5]=y*M+m*b+P,r[i+6]=f*S+g*M+x,r[i+7]=y*M+m*S+P}packIndex(t){const{indexStart:e}=this,{data:i}=t,r=this.vertexStart*.5;i[e]=r+0,i[e+1]=r+1,i[e+2]=r+2,i[e+3]=r+0,i[e+4]=r+2,i[e+5]=r+3}packColor(t){const{colorStart:e}=this,{node:i}=this,{u32Data:r}=t,a=i.pp.tintColor.abgr;r[e]=a,r[e+1]=a,r[e+2]=a,r[e+3]=a}packUV(t){if(this.node.texture.repeat){this.packTilingUV(t);return}const{node:e,uvStart:i,textureId:r}=this,{f32Data:a,u32Data:o}=t,h=e.texture.uvs,l=o;a[i]=h.x0,a[i+1]=h.y0,l[i+2]=r,a[i+3]=h.x1,a[i+4]=h.y1,l[i+5]=r,a[i+6]=h.x2,a[i+7]=h.y2,l[i+8]=r,a[i+9]=h.x3,a[i+10]=h.y3,l[i+11]=r}packTilingUV(t){const{node:e,uvStart:i,textureId:r}=this,{f32Data:a,u32Data:o}=t,h=e.texture.uvs,l=o,{width:c,height:d}=e.getLocalBounds(),{width:u,height:p}=e.texture,f=u>0?c/u:1,m=p>0?d/p:1,g=h.x1-h.x0,y=h.y3-h.y0,x={x0:h.x0,y0:h.y0,x1:h.x0+g*f,y1:h.y0,x2:h.x0+g*f,y2:h.y0+y*m,x3:h.x0,y3:h.y0+y*m};a[i]=x.x0,a[i+1]=x.y0,l[i+2]=r,a[i+3]=x.x1,a[i+4]=x.y1,l[i+5]=r,a[i+6]=x.x2,a[i+7]=x.y2,l[i+8]=r,a[i+9]=x.x3,a[i+10]=x.y3,l[i+11]=r}}const ci=lt(1,1);class Te{constructor(t,e){n(this,"uid",q("RenderTargetBuffer")),n(this,"loaded",!0),n(this,"width",0),n(this,"height",0),n(this,"texture"),n(this,"sampler"),n(this,"view"),n(this,"bitmap",ci),n(this,"destroyed",!1),n(this,"repeat",!1),this.width=t,this.height=e,this.texture=A.createTexture("renderTarget",t,e),this.sampler=A.defaultSampler,this.view=this.texture.createView()}destroy(){this.destroyed||(this.destroyed=!0,this.texture.destroy())}upload(){}dirty(){}}const U=[1,1,0,-1,-1,-1,0,1,1,1,0,-1,-1,-1,0,1],W=[0,1,1,1,0,-1,-1,-1,0,1,1,1,0,-1,-1,-1],j=[0,-1,-1,-1,0,1,1,1,0,1,1,1,0,-1,-1,-1],H=[1,1,0,-1,-1,-1,0,1,-1,-1,0,1,1,1,0,-1],kt=[],Ae=[],dt=Math.sign;function di(){for(let s=0;s<16;s++){const t=[];kt.push(t);for(let e=0;e<16;e++){const i=dt(U[s]*U[e]+j[s]*W[e]),r=dt(W[s]*U[e]+H[s]*W[e]),a=dt(U[s]*j[e]+j[s]*H[e]),o=dt(W[s]*j[e]+H[s]*H[e]);for(let h=0;h<16;h++)if(U[h]===i&&W[h]===r&&j[h]===a&&H[h]===o){t.push(h);break}}}for(let s=0;s<16;s++){const t=new F;t.set(U[s],W[s],j[s],H[s],0,0),Ae.push(t)}}di();const C={E:0,SE:1,S:2,SW:3,W:4,NW:5,N:6,NE:7,MIRROR_VERTICAL:8,MAIN_DIAGONAL:10,MIRROR_HORIZONTAL:12,REVERSE_DIAGONAL:14,uX:s=>U[s],uY:s=>W[s],vX:s=>j[s],vY:s=>H[s],inv:s=>s&8?s&15:-s&7,add:(s,t)=>kt[s][t],sub:(s,t)=>kt[s][C.inv(t)],rotate180:s=>s^4,isVertical:s=>(s&3)===2,byDirection:(s,t)=>Math.abs(s)*2<=Math.abs(t)?t>=0?C.S:C.N:Math.abs(t)*2<=Math.abs(s)?s>0?C.E:C.W:t>0?s>0?C.SE:C.SW:s>0?C.NE:C.NW,matrixAppendRotationInv:(s,t,e=0,i=0)=>{const r=Ae[C.inv(t)];r.tx=e,r.ty=i,s.append(r)}},It=class I{constructor(){n(this,"uid",q()),n(this,"uvs",{x0:0,y0:0,x1:1,y1:0,x2:1,y2:1,x3:0,y3:1}),n(this,"url",""),n(this,"_buffer"),n(this,"_width",0),n(this,"_height",0),n(this,"_destroyed",!1),n(this,"_trimmed",!1),n(this,"_rotated",!1),n(this,"_trimRect",new zt),n(this,"_sheet")}static get BLANK(){return I._blank||(I._blank=new I().setBuffer(new Te(1,1))),I._blank}static get WHITE(){if(!I._white){const t=document.createElement("canvas");t.width=1,t.height=1;const e=t.getContext("2d");e.fillStyle="white",e.fillRect(0,0,1,1),I._white=I.createFromCanvas(t)}return I._white}get repeat(){var t;return((t=this._buffer)==null?void 0:t.repeat)??!1}get width(){return this._width}get height(){return this._height}get sheet(){return this._sheet}get trimRect(){return this._trimRect}get trimmed(){return this._trimmed}get rotated(){return this._rotated}get destroyed(){return this._destroyed}get buffer(){return this._buffer}static async createFromUrl(t){return V.load(t,"image")}static createFromCanvas(t){return new I().setBuffer(new J(t))}static createFormBuffer(t,e,i){return new I().setBuffer(t,e,i)}setBuffer(t,e,i){var r;return this._buffer!==t&&((r=this._buffer)==null||r.destroy(),this._buffer=t,this._sheet=i,this.url=e??""),i?(this._width=i.sourceSize.w,this._height=i.sourceSize.h,this._trimmed=i.trimmed,this._rotated=i.rotated,this._trimRect.set(i.spriteSourceSize.x,i.spriteSourceSize.y,i.spriteSourceSize.x+i.frame.w,i.spriteSourceSize.y+i.frame.h),this._updateUvs(i)):(this._width=t.width,this._height=t.height,this._trimmed=!1,this._rotated=!1,this._trimRect.set(0,0,t.width,t.height)),this}_updateUvs(t){const{uvs:e,_rotated:i}=this,{frame:r}=t,{width:a,height:o}=this.buffer,h=r.x/a,l=r.y/o,c=(i?r.h:r.w)/a,d=(i?r.w:r.h)/o;if(i){let u=2;const p=c/2,f=d/2,m=h+p,g=l+f;u=C.add(u,C.NW),e.x0=m+p*C.uX(u),e.y0=g+f*C.uY(u),u=C.add(u,2),e.x1=m+p*C.uX(u),e.y1=g+f*C.uY(u),u=C.add(u,2),e.x2=m+p*C.uX(u),e.y2=g+f*C.uY(u),u=C.add(u,2),e.x3=m+p*C.uX(u),e.y3=g+f*C.uY(u)}else e.x0=h,e.y0=l,e.x1=h+c,e.y1=l,e.x2=h+c,e.y2=l+d,e.x3=h,e.y3=l+d}destroy(){var t;this===I.BLANK||this===I.WHITE||this._destroyed||(this._destroyed=!0,(t=this._buffer)==null||t.destroy(),this._buffer=void 0)}};n(It,"_blank"),n(It,"_white");let k=It;const N=s=>t=>(fe(s,t),t),ui=s=>t=>(ue(s,t),t);var pi=(s,t,e,i)=>{for(var r=t,a=s.length-1,o;a>=0;a--)(o=s[a])&&(r=o(r)||r);return r};let Bt=class extends O{constructor(s){super(),n(this,"renderObject",new _t(this)),this.pp.url="",this.pp.repeat=!1,this.setProps(s)}get texture(){return this.pp.texture}set texture(s){if(this.pp.texture!==s){this.pp.repeat&&!s.repeat?this.pp.texture=new k().setBuffer(new J(s.buffer.bitmap,!0)):this.pp.texture=s,this.emit(v.resize);const t=this.renderObject.batch,e=(t==null?void 0:t.getTextureId(s))??(t==null?void 0:t.add(this.texture));e!==void 0&&e>-1?(this.renderObject.textureId=e,this.markDirty(_.texture)):this.markDirty(_.child)}}get url(){return this.pp.url}set url(s){this.load(s)}async load(s){const t=this.pp;if(t.url!==s){t.url=s;const e=await V.load(s);if(this.destroyed||!e||t.url!==s)return;this.texture=e,t.width===-1&&(this.width=e.width),t.height===-1&&(this.height=e.height),this.markDirty(_.size)}this.emit(v.loaded)}_customLocalBounds(s){const t=this.pp.texture;t&&s.addFrame(0,0,t.width,t.height)}get repeat(){return this.pp.repeat}set repeat(s){if(this.pp.repeat!==s){this.pp.repeat=s;const t=this.pp.texture;t&&(this.texture=new k().setBuffer(new J(t.buffer.bitmap,s)))}}};Bt=pi([N("Sprite")],Bt);class fi extends Bt{constructor(){super(),n(this,"buffer"),this.texture=new k}destroy(){var t;(t=this.buffer)==null||t.destroy()}createTexture(t,e){var i;return(!this.buffer||this.width!==t||this.height!==e)&&((i=this.buffer)==null||i.destroy(),this.width=t,this.height=e,this.buffer=new Te(t,e),this.texture.setBuffer(this.buffer)),this.buffer.texture}}const gi=16,ut=new fi;class yi{constructor(){n(this,"_group"),n(this,"_binds",[]),n(this,"_cacheKey",""),n(this,"map",new Map),n(this,"buffers",[]),n(this,"count",0),ut.createTexture(1,1).createView();const t=ut.buffer.view,e=ut.buffer.sampler;for(let i=0;i<16;i++)this._binds.push({binding:i*2,visibility:GPUShaderStage.FRAGMENT,type:"TextureView",resource:t}),this._binds.push({binding:i*2+1,visibility:GPUShaderStage.FRAGMENT,type:"Sampler",resource:e})}get group(){const t=this._createTextureGroup(this.buffers);if(this._group!==t){this._group=t;for(let e=0,i=this.buffers.length;e<i;e++)this.buffers[e].upload()}return this._group}reset(){this.count=0,this.map.clear(),this.buffers.length=0}_createTextureGroup(t){const e=t.length,i=this._binds;let r="";for(let a=0;a<16;a++){const o=this._binds[a*2],h=this._binds[a*2+1];let l=ut.buffer;a<e&&(l=t[a],r+=l.uid),o.resource=l.view,h.resource=l.sampler}if(r!==this._cacheKey){this._cacheKey=r;const{group:a}=A.createGroup("texture",i);return a}return this._group}add(t){const e=this.map.get(t.uid);if(e!==void 0)return e;const i=this.count;return i<gi?(this.buffers.push(t),this.map.set(t.uid,i),this.count++,i):-1}getTextureId(t){return this.map.get(t.buffer.uid)}}const Me=class Dt{constructor(t){n(this,"textureGroup",new yi),n(this,"pipeline","batch"),n(this,"used",!0),n(this,"startIndex",0),n(this,"size",0),this.batchGroup=t}static create(t){const e=Dt._pool;for(let r=0,a=e.length;r<a;r++){const o=e[r];if(!o.used)return o.used=!0,o.batchGroup=t,o}const i=new Dt(t);return e.push(i),i}add(t){return this.textureGroup.add(t.buffer)}getTextureId(t){return this.textureGroup.getTextureId(t)}reset(){this.used=!1,this.startIndex=0,this.size=0,this.textureGroup.reset()}};n(Me,"_pool",[]);let mi=Me;class vt{constructor(){n(this,"camera"),n(this,"batches",[]),n(this,"nodes",[]),n(this,"posBuffer",new wt("position")),n(this,"colorBuffer",new wt("color")),n(this,"uvBuffer",new wt("uv")),n(this,"indexBuffer",new ni),n(this,"vertexSize",0),n(this,"colorSize",0),n(this,"uvSize",0),n(this,"indexSize",0),n(this,"spriteCount",0),n(this,"updateCount",0),n(this,"resetCount",0)}collect(t,e,i){return t.pp.dirty===0?this:(t.pp.dirty&_.child?(this.reset(),this.camera=i,this._collect(t,e,t.alpha),this.spriteCount>0&&(this._fat(),this._batch(),this._uploadBuffer())):this.update(),this)}update(){if(!(this.nodes.length<1||this.nodes[0].pp.dirty===0)){this._update(),this._uploadBuffer();for(const t of this.batches)t instanceof vt&&t.update()}}_update(){this.updateCount++;const t=this.nodes.length;let e=0;for(;e<t;){const i=this.nodes[e];e++;const{dirty:r,transform:a,localMatrix:o,worldMatrix:h,position:l,parent:c,tintColor:d,alpha:u}=i.pp,p=r&_.transform,f=r&_.color;if(p&&a.updateMatrix(o,h,l,c.worldMatrix),f&&(d===T.Default&&(i.pp.tintColor=new T),i.pp.tintColor.changeAlpha(u*c.pp.tintColor.alpha)),"renderObject"in i&&i.texture){const m=i.renderObject;(p||r&_.size)&&(m.packVertex(this.posBuffer),this.posBuffer.loaded=!1),f&&(m.packColor(this.colorBuffer),this.colorBuffer.loaded=!1),r&_.texture&&(m.packUV(this.uvBuffer),this.uvBuffer.loaded=!1)}i.pp.dirty=0}}_collect(t,e,i){const{pp:r,children:a}=t,{visible:o,alpha:h,dirty:l,transform:c,localMatrix:d,position:u}=r;if(!o||h<.001)return;l&_.transform&&c.updateMatrix(d,r.worldMatrix,u,e),l&_.color&&(r.tintColor===T.Default&&(r.tintColor=new T),r.tintColor.changeAlpha(h*i)),this.nodes.push(t),"texture"in t&&t.texture&&this._add(t);const p=a.length;if(p){let f=0;for(;f<p;)this._collectChild(a[f],r.worldMatrix,r.tintColor.alpha),f++}}_add(t){this.spriteCount++;const e=t.renderObject;e.vertexStart=this.vertexSize,e.colorStart=this.colorSize,e.uvStart=this.uvSize,e.indexStart=this.indexSize,this.vertexSize+=e.vertexSize,this.colorSize+=e.colorSize,this.uvSize+=e.uvSize,this.indexSize+=e.indexSize}_collectChild(t,e,i){const{filters:r}=t.pp;if(r.length){const a=hi.instance.render(t,r);this._collect(a,e,i)}else if(t.cacheEnabled){const a=li(t);a.collect(t,e,this.camera),this.batches.push(a)}else this._collect(t,e,i)}_fat(){this.vertexSize>this.posBuffer.size&&this.posBuffer.fat(this.vertexSize),this.colorSize>this.colorBuffer.size&&this.colorBuffer.fat(this.colorSize),this.uvSize>this.uvBuffer.size&&this.uvBuffer.fat(this.uvSize),this.indexSize>this.indexBuffer.size&&this.indexBuffer.fat(this.indexSize)}_batch(){let t=this._createBatch();const e=this.nodes.length;let i=0;for(let r=0;r<e;r++){const a=this.nodes[r];if(!a.texture){a.pp.dirty=0;continue}const o=a.renderObject;let h=t.add(a.texture);h===-1&&(t.size=i-t.startIndex,t=this._createBatch(),t.startIndex=i,h=t.add(a.texture)),o.batch=t,o.textureId=h,o.packVertex(this.posBuffer),o.packColor(this.colorBuffer),o.packUV(this.uvBuffer),o.packIndex(this.indexBuffer),i+=o.indexSize,a.pp.dirty=0}t.size=i-t.startIndex}_createBatch(){const t=mi.create(this);return this.batches.push(t),t}_uploadBuffer(){this.posBuffer.upload(),this.colorBuffer.upload(),this.uvBuffer.upload(),this.indexBuffer.upload()}reset(){this.resetCount++;for(const t of this.batches)t.reset();this.batches.length=0,this.posBuffer.reset(),this.colorBuffer.reset(),this.uvBuffer.reset(),this.indexBuffer.reset(),this.vertexSize=0,this.colorSize=0,this.uvSize=0,this.indexSize=0,this.nodes.length=0,this.spriteCount=0}}const xi=`struct VertexInput {
  @location(0) aPos: vec2<f32>,
  @location(1) aColor: vec4<f32>,
  @location(2) aUV: vec2<f32>,
  @location(3) aTextureId: u32,
};

struct VertexOutput {
  @builtin(position) vPos: vec4<f32>,
  @location(0) vUV: vec2<f32>,
  @location(1) vColor: vec4<f32>,
  @location(2) @interpolate(flat) vId: u32,
};

@group(0) @binding(0) var<uniform> uProjection: mat4x4<f32>;

@vertex
fn vert_main(input: VertexInput) -> VertexOutput {
    var output: VertexOutput;
    output.vPos = uProjection * vec4<f32>(input.aPos, 0.0, 1.0);
    output.vUV = input.aUV;
    output.vColor = input.aColor;
    output.vId = input.aTextureId;
    return output;
}

@group(1) @binding(0) var texture1: texture_2d<f32>;
@group(1) @binding(1) var sampler1: sampler;
@group(1) @binding(2) var texture2: texture_2d<f32>;
@group(1) @binding(3) var sampler2: sampler;
@group(1) @binding(4) var texture3: texture_2d<f32>;
@group(1) @binding(5) var sampler3: sampler;
@group(1) @binding(6) var texture4: texture_2d<f32>;
@group(1) @binding(7) var sampler4: sampler;
@group(1) @binding(8) var texture5: texture_2d<f32>;
@group(1) @binding(9) var sampler5: sampler;
@group(1) @binding(10) var texture6: texture_2d<f32>;
@group(1) @binding(11) var sampler6: sampler;
@group(1) @binding(12) var texture7: texture_2d<f32>;
@group(1) @binding(13) var sampler7: sampler;
@group(1) @binding(14) var texture8: texture_2d<f32>;
@group(1) @binding(15) var sampler8: sampler;
@group(1) @binding(16) var texture9: texture_2d<f32>;
@group(1) @binding(17) var sampler9: sampler;
@group(1) @binding(18) var texture10: texture_2d<f32>;
@group(1) @binding(19) var sampler10: sampler;
@group(1) @binding(20) var texture11: texture_2d<f32>;
@group(1) @binding(21) var sampler11: sampler;
@group(1) @binding(22) var texture12: texture_2d<f32>;
@group(1) @binding(23) var sampler12: sampler;
@group(1) @binding(24) var texture13: texture_2d<f32>;
@group(1) @binding(25) var sampler13: sampler;
@group(1) @binding(26) var texture14: texture_2d<f32>;
@group(1) @binding(27) var sampler14: sampler;
@group(1) @binding(28) var texture15: texture_2d<f32>;
@group(1) @binding(29) var sampler15: sampler;
@group(1) @binding(30) var texture16: texture_2d<f32>;
@group(1) @binding(31) var sampler16: sampler;

@fragment
fn frag_main(
    @location(0) vUV: vec2<f32>,
    @location(1) vColor: vec4<f32>,
    @location(2) @interpolate(flat) vId: u32,
) -> @location(0) vec4<f32> {
    var outColor: vec4<f32>;
    var uvDx = dpdx(vUV);
    var uvDy = dpdy(vUV);

    switch vId {
        case 0:{
            outColor = textureSampleGrad(texture1, sampler1, vUV, uvDx, uvDy);
            break;
        }
        case 1:{
            outColor = textureSampleGrad(texture2, sampler2, vUV, uvDx, uvDy);
            break;
        }
        case 2:{
            outColor = textureSampleGrad(texture3, sampler3, vUV, uvDx, uvDy);
            break;
        }
        case 3:{
            outColor = textureSampleGrad(texture4, sampler4, vUV, uvDx, uvDy);
            break;
        }
        case 4:{
            outColor = textureSampleGrad(texture5, sampler5, vUV, uvDx, uvDy);
            break;
        }
        case 5:{
            outColor = textureSampleGrad(texture6, sampler6, vUV, uvDx, uvDy);
            break;
        }
        case 6:{
            outColor = textureSampleGrad(texture7, sampler7, vUV, uvDx, uvDy);
            break;
        }
        case 7:{
            outColor = textureSampleGrad(texture8, sampler8, vUV, uvDx, uvDy);
            break;
        }
        case 8:{
            outColor = textureSampleGrad(texture9, sampler9, vUV, uvDx, uvDy);
            break;
        }
        case 9:{
            outColor = textureSampleGrad(texture10, sampler10, vUV, uvDx, uvDy);
            break;
        }
        case 10:{
            outColor = textureSampleGrad(texture11, sampler11, vUV, uvDx, uvDy);
            break;
        }
        case 11:{
            outColor = textureSampleGrad(texture12, sampler12, vUV, uvDx, uvDy);
            break;
        }
        case 12:{
            outColor = textureSampleGrad(texture13, sampler13, vUV, uvDx, uvDy);
            break;
        }
        case 13:{
            outColor = textureSampleGrad(texture14, sampler14, vUV, uvDx, uvDy);
            break;
        }
        case 14:{
            outColor = textureSampleGrad(texture15, sampler15, vUV, uvDx, uvDy);
            break;
        }
        default:{
            outColor = textureSampleGrad(texture16, sampler16, vUV, uvDx, uvDy);
            break;
        }
    }
    return outColor * vColor;
}`;class _i{constructor(){n(this,"pipeline");const t=this.createCameraLayout(),e=this.createTexturesLayout();this.pipeline=this.createRenderPipeline([t,e],xi)}createCameraLayout(){const t=[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{}}];return this.createLayout("camera",t)}createTexturesLayout(){const t=[];for(let e=0;e<32;e+=2)t.push({binding:e,visibility:GPUShaderStage.FRAGMENT,texture:{}}),t.push({binding:e+1,visibility:GPUShaderStage.FRAGMENT,sampler:{}});return this.createLayout("texture",t)}createRenderPipeline(t,e){const{device:i,format:r}=A;return i.createRenderPipeline({label:"spriteRenderPipe",layout:i.createPipelineLayout({bindGroupLayouts:t}),vertex:{module:i.createShaderModule({code:e}),entryPoint:"vert_main",buffers:[{arrayStride:2*4,stepMode:"vertex",attributes:[{shaderLocation:0,format:"float32x2",offset:0}]},{arrayStride:1*4,stepMode:"vertex",attributes:[{shaderLocation:1,format:"unorm8x4",offset:0}]},{arrayStride:3*4,stepMode:"vertex",attributes:[{shaderLocation:2,format:"float32x2",offset:0},{shaderLocation:3,format:"uint32",offset:2*4}]}]},fragment:{module:i.createShaderModule({code:e}),entryPoint:"frag_main",targets:[{format:r,blend:{alpha:{dstFactor:"one-minus-src-alpha",operation:"add",srcFactor:"src-alpha"},color:{dstFactor:"one-minus-src-alpha",operation:"add",srcFactor:"src-alpha"}}}]},primitive:{topology:"triangle-list"}})}createLayout(t,e){const{device:i}=A;return i.createBindGroupLayout({label:`${t}-layout`,entries:e})}render(t,e){const{posBuffer:i,colorBuffer:r,uvBuffer:a,indexBuffer:o,camera:h}=t.batchGroup;e.setPipeline(this.pipeline),e.setVertexBuffer(0,i.buffer),e.setVertexBuffer(1,r.buffer),e.setVertexBuffer(2,a.buffer),e.setIndexBuffer(o.buffer,"uint32"),e.setBindGroup(0,h.group),e.setBindGroup(1,t.textureGroup.group),e.drawIndexed(t.size,1,t.startIndex)}}const Rt=class ${constructor(t){n(this,"_color"),n(this,"batchGroup",new vt);const e=new T(t);this._color={r:e.red,g:e.green,b:e.blue,a:e.alpha},$.addPipeline("batch",new _i)}static addPipeline(t,e){$._pipelines[t]=e}static getPipeline(t){return $._pipelines[t]}static get instance(){return $._instance??($._instance=new $),$._instance}render(t,e,i,r){const{device:a}=A,o=this.batchGroup.collect(t,e,i);if(o.batches.length){const h=a.createCommandEncoder(),l=h.beginRenderPass({colorAttachments:[{view:r.createView(),clearValue:this._color,loadOp:"clear",storeOp:"store"}]});this.flush(o,l),l.end(),a.queue.submit([h.finish()])}}flush(t,e){const{batches:i}=t,r=i.length;for(let a=0;a<r;a++){const o=i[a];if("textureGroup"in o){const h=$.getPipeline(o.pipeline);console.assert(h!==void 0,`pipeline ${o.pipeline} is null`),h.render(o,e)}else this.flush(o,e)}}};n(Rt,"_pipelines",{}),n(Rt,"_instance");let vi=Rt;class bi{constructor(){n(this,"debug",!1),n(this,"format"),n(this,"device"),n(this,"defaultSampler"),n(this,"defaultRepeatSampler")}async init(t){const e=await navigator.gpu.requestAdapter();if(!e)throw new Error("Failed to initialize webgpu adapter");if(this.device=await(e==null?void 0:e.requestDevice()),!this.device)throw new Error("Failed to initialize webgpu device");this.format=navigator.gpu.getPreferredCanvasFormat();const i=t.canvas.getContext("webgpu");return i.configure({device:this.device,format:navigator.gpu.getPreferredCanvasFormat()}),this.defaultSampler=this.createSampler("default"),this.defaultRepeatSampler=this.createSampler("defaultRepeat","linear","linear","repeat","repeat"),{context:i,gpuRender:new vi(t.bgColor)}}setViewport(t,e){this.debug&&console.log("setViewport",t,e)}createProjectionMatrixBuffer(t,e){const{device:i}=this,r=i.createBuffer({label:`${t}-buffer`,size:e.byteLength,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});i.queue.writeBuffer(r,0,e);const a=i.createBindGroupLayout({label:`${t}-layout`,entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{}}]}),o=i.createBindGroup({label:`${t}-group`,layout:a,entries:[{binding:0,resource:{buffer:r}}]});return this.debug&&console.log("createUniformGroup",t),{buffer:r,group:o}}createVertexBuffer(t,e){const{device:i}=this,r=i.createBuffer({label:`${t}-buffer`,size:e.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST});return this.debug&&console.log("createBuffer",t),r}createIndexBuffer(t,e){const{device:i}=this,r=i.createBuffer({label:`${t}-buffer`,size:e.byteLength,usage:GPUBufferUsage.INDEX|GPUBufferUsage.COPY_DST});return this.debug&&console.log("createBuffer",t),r}createUniformBuffer(t,e){const{device:i}=this,r=i.createBuffer({label:`${t}-buffer`,size:e.byteLength,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});return this.debug&&console.log("createBuffer",t),r}uploadUniform(t,e){this.device.queue.writeBuffer(t,0,e),this.debug&&console.log("uploadUniform",t.label)}uploadBuffer(t,e,i=!1){this.device.queue.writeBuffer(t,0,e),this.debug&&console.log("uploadBuffer",t.label)}createGroup(t,e){const{device:i}=this,r=i.createBindGroupLayout({label:`${t}-layout`,entries:e.map(o=>{const{type:h}=o;return{binding:o.binding,visibility:o.visibility,buffer:h==="Buffer"?{}:void 0,sampler:h==="Sampler"?{}:void 0,texture:h==="TextureView"?{}:void 0}})}),a=i.createBindGroup({label:`${t}-group`,layout:r,entries:e.map(o=>{const{resource:h}=o;return{binding:o.binding,resource:o.type==="Buffer"?{buffer:h}:h}})});return this.debug&&console.log("createGroup",t),{layout:r,group:a}}createFilterPipeline(t,e,i){this.debug&&console.log("createFilterPipeline",t);const{device:r}=this;return r.createRenderPipeline({label:`${t}-renderPipe`,layout:r.createPipelineLayout({bindGroupLayouts:e}),vertex:{module:r.createShaderModule({code:i}),entryPoint:"vert_main",buffers:[{arrayStride:4*4,stepMode:"vertex",attributes:[{shaderLocation:0,format:"float32x2",offset:0},{shaderLocation:1,format:"float32x2",offset:2*4}]}]},fragment:{module:r.createShaderModule({code:i}),entryPoint:"frag_main",targets:[{format:this.format}]},primitive:{topology:"triangle-strip"}})}createTexture(t,e,i){return this.debug&&console.log("createTexture",t),this.device.createTexture({label:`${t}-texture`,format:this.format,size:[e,i],usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT})}createSampler(t,e="linear",i="linear",r="clamp-to-edge",a="clamp-to-edge"){return this.debug&&console.log("createSampler",t),this.device.createSampler({label:`${t}-sampler`,minFilter:e,magFilter:i,addressModeU:r,addressModeV:a})}uploadTexture(t,e){this.debug&&console.log("uploadTexture"),this.device.queue.copyExternalImageToTexture({source:t},{texture:e},[t.width,t.height])}}let A;function wi(){A=new bi}class J{constructor(t,e=!1){n(this,"uid",q("TextureBuffer")),n(this,"width",0),n(this,"height",0),n(this,"bitmap"),n(this,"texture"),n(this,"sampler"),n(this,"view"),n(this,"destroyed",!1),n(this,"loaded",!1),n(this,"repeat",!1);const{width:i,height:r}=t;console.assert(i>=0&&r>=0),this.bitmap=t,this.width=i,this.height=r,this.texture=A.createTexture("texture",i,r),this.repeat=e,this.sampler=e?A.defaultRepeatSampler:A.defaultSampler,this.view=this.texture.createView()}destroy(){this.destroyed||(this.destroyed=!0,this.texture.destroy())}upload(){this.loaded||(this.loaded=!0,A.uploadTexture(this.bitmap,this.texture))}dirty(){this.uid=q("TextureBuffer"),this.loaded=!1}}class Pi{constructor(){n(this,"map",{png:!0,jpg:!0,jpeg:!0,webp:!0,image:!0})}test(t){return!!this.map[t]}async load(t){try{const e=await tt.loadBlob(t),i=await createImageBitmap(e);return k.createFormBuffer(new J(i),t)}catch(e){console.error(`Error loading image from ${t}:`,e);return}}}class Si{constructor(){n(this,"map",{json:!0,scene:!0})}test(t){return!!this.map[t]}async load(t){try{return await tt.loadJson(t)}catch(e){console.error(`Error loading JSON from ${t}:`,e);return}}}const ke=class Et extends ht{constructor(){super(...arguments),n(this,"_loadingMap",{}),n(this,"cacheMap",{}),n(this,"_total",0),n(this,"_loaded",0)}static regLoader(t){Et._loaders.push(t)}get total(){return this._total}get loaded(){return this._loaded}get loadingCount(){return this._total-this._loaded}load(t,e){const i=this.get(t);if(i)return Promise.resolve(i);const r=this._loadingMap[t];if(r)return r;this._total++;const a=e??this._getTypeByExt(t),o=Et._loaders.find(l=>l.test(a));if(!o)return this._error("no loader can load:",t),Promise.resolve(void 0);const h=new Promise(l=>{o.load(t,this).then(c=>{this._complete(t,c),l(c)}).catch(c=>{this._error(t,c.toString()),l(void 0)})});return this._loadingMap[t]=h,h}_getTypeByExt(t){let e=t.substring(t.lastIndexOf(".")+1);return e.indexOf("?")!==-1&&(e=e.substring(0,e.lastIndexOf("?"))),e.toLowerCase()}_complete(t,e){e!==void 0&&this.cache(t,e),delete this._loadingMap[t],this._loaded++;const i=this._total>0?this._loaded/this._total:1;this.emit(v.progress,i),this.emit(v.loaded,t,e),this._loaded>=this._total&&(this._total=this._loaded,this.emit(v.complete))}_error(t,e){console.error("Failed to load url:",t,"Error:",e),delete this._loadingMap[t],this._loaded++,this.emit(v.error,t,e)}cache(t,e){e!==void 0&&(this.cacheMap[t]=e)}get(t){return this.cacheMap[t]}unload(t){const e=this.cacheMap[t];delete this.cacheMap[t],e&&(typeof e.destroy=="function"&&e.destroy(),typeof e.dispose=="function"&&e.dispose())}clear(){for(const t of Object.keys(this.cacheMap))this.unload(t);this._loadingMap={},this._total=0,this._loaded=0}resetCount(){this._total-=this._loaded,this._loaded=0}};n(ke,"_loaders",[]);let st=ke;class Ci{constructor(){n(this,"map",{atlas:!0,sheet:!0})}test(t){return!!this.map[t]}async load(t,e){try{const i=await tt.loadJson(t),r=xe(t),a=r+i.meta.image,o=await createImageBitmap(await tt.loadBlob(a)),h=new J(o),l=i.frames,c=Object.keys(l),d=c.length,u=[];for(let p=0;p<d;p++){const f=c[p],m=l[f],g=r+f,y=k.createFormBuffer(h,g,m);e.cache(g,y),u.push(y)}return u.sort((p,f)=>{const m=Jt(p.url),g=Jt(f.url);return m-g}),u}catch(i){console.error(`Error loading sheet from ${t}:`,i);return}}}function Jt(s){const t=s.match(/\d+/);return t?Number.parseInt(t[0]):0}const Ie=class R{constructor(t,e=!1,i=1){n(this,"url"),n(this,"volume"),n(this,"loop"),n(this,"playbackRate",1),n(this,"isPlaying",!1),n(this,"destroyed",!1),n(this,"onEnd"),n(this,"_gainNode",R.audioContext.createGain()),n(this,"_source"),n(this,"_startTime",0),n(this,"_offset",0),n(this,"_audioPlaying",!1),n(this,"_playID",0),this.url=t,this.loop=e,this.volume=Math.max(0,Math.min(1,i)),this._gainNode.gain.value=i,this._gainNode.connect(R.audioContext.destination)}static async ensureAudioContext(){if(R.audioContext.state==="suspended")try{return await R.audioContext.resume(),!0}catch(t){return console.error("Failed to resume audio context:",t),!1}return!0}currentTime(){return!this.isPlaying||this.destroyed?this._offset:this._offset+(R.audioContext.currentTime-this._startTime)}duration(){const t=V.get(this.url);return t?t.duration:0}play(t=0){if(!(this.isPlaying||this.destroyed))return this.isPlaying=!0,this._playID=me(),this._offset=t,this._load(this._playID).then(e=>{e&&(this._source=e,this._audioPlaying=!0,this._source.start(0,this._offset),this._startTime=R.audioContext.currentTime)}),this}async _load(t){const e=await V.load(this.url);if(!e||this.destroyed||!this.isPlaying||this._playID!==t)return;const i=R.audioContext.createBufferSource();return i.buffer=e,i.playbackRate.value=this.playbackRate,i.loop=this.loop,i.connect(this._gainNode),i.onended=()=>{var r;this.loop||(this.stop(),(r=this.onEnd)==null||r.call(this,this.url))},i}pause(){return!this.isPlaying||this.destroyed?this._offset:(this.isPlaying=!1,this._offset+=R.audioContext.currentTime-this._startTime,this._source&&this._audioPlaying&&(this._source.stop(),this._source=void 0,this._audioPlaying=!1),this)}resume(){if(!(this.isPlaying||this.destroyed))return this.play(this._offset),this}stop(){if(!(!this.isPlaying||this.destroyed))return this.isPlaying=!1,this._offset=0,this._source&&this._audioPlaying&&(this._source.stop(),this._source=void 0,this._audioPlaying=!1),this}setLoop(t){if(!(this.loop===t||this.destroyed))return this.loop=t,this._source&&(this._source.loop=t),this}setVolume(t){if(this.volume===t||this.destroyed)return this.volume;const e=Math.max(0,Math.min(1,t));return this.volume=e,this._gainNode.gain.value=e,this}fadeIn(t=0){const e=this._gainNode.gain;if(t>0){const i=R.audioContext.currentTime;e.linearRampToValueAtTime(e.value,i+t),e.setValueAtTime(0,i)}return this}fadeOut(t=0){const e=this._gainNode.gain;if(t>0){const i=R.audioContext.currentTime;e.linearRampToValueAtTime(0,i+t),e.setValueAtTime(e.value,i)}return this}setPlaybackRate(t){if(this.playbackRate===t||this.destroyed)return this.playbackRate;const e=Math.max(.1,Math.min(10,t));return this.playbackRate=e,this._source&&(this._source.playbackRate.value=e),this}destroy(t=!0){this.destroyed||(this.destroyed=!0,this.stop(),this._source&&(this._source.disconnect(),this._source.onended=null,this._source=void 0),this._gainNode.disconnect(),t&&V.unload(this.url))}};n(Ie,"audioContext",new(window.AudioContext||window.webkitAudioContext));let Yt=Ie;class Ti{constructor(){n(this,"map",{mp3:!0,sound:!0})}test(t){return!!this.map[t]}async load(t){try{const e=await tt.loadArrayBuffer(t);return await Yt.audioContext.decodeAudioData(e)}catch(e){console.error(`Error loading sound from ${t}`,e);return}}}class Ai{constructor(){n(this,"map",{text:!0,plist:!0})}test(t){return!!this.map[t]}async load(t){try{return await tt.loadText(t)}catch(e){console.error(`Error loading Text from ${t}:`,e);return}}}st.regLoader(new Pi);st.regLoader(new Si);st.regLoader(new Ci);st.regLoader(new Ti);st.regLoader(new Ai);const V=new st;class Ot{constructor(){n(this,"id",""),n(this,"label",""),n(this,"_$awaked",!1),n(this,"_$destroyed",!1),n(this,"_$enabled",!0),n(this,"_$target")}get awaked(){return this._$awaked}get destroyed(){return this._$destroyed}get enabled(){return this._$enabled}set enabled(t){t!==this._$enabled&&(this._$enabled=t,this._$target&&(t?this.onEnable():this.onDisable()))}get target(){return this._$target||console.warn("Script target is not set"),this._$target}set target(t){t!==this._$target&&(this._$target=t,t&&this.onCreate())}get stage(){var t;return(t=this._$target)==null?void 0:t.stage}get scene(){var t;return(t=this._$target)==null?void 0:t.scene}setProps(t){if(t){const e=Object.keys(t);for(const i of e)this.setProp(i,t[i])}return this}setProp(t,e){t in this&&(this[t]=e)}signal(t,e){var i,r;(r=(i=this._$target)==null?void 0:i.scene)==null||r.emit(v.signal,t,e)}update(t){this._$enabled&&(this._$awaked||this._$awake(),this.onUpdate(t))}_$awake(){this._$awaked||(this._$awaked=!0,this.onAwake())}onEnable(){}onDisable(){}onCreate(){}onAwake(){}onUpdate(t){}onDestroy(){}destroy(){var t,e,i,r;this._$destroyed||(this._$destroyed=!0,this._$enabled=!1,this.onDestroy(),(t=this._$target)==null||t.offAll(this),(e=this.scene)==null||e.offAll(this),(i=this.stage)==null||i.offAll(this),(r=this.stage)==null||r.timer.clearAll(this),this._$target=void 0)}}class Mi extends Ot{constructor(){super(...arguments),n(this,"followEnabled",!0),n(this,"smoothness",.1),n(this,"followX",!0),n(this,"followY",!0),n(this,"offsetX",0),n(this,"offsetY",0),n(this,"_targetNode"),n(this,"_worldBounds"),n(this,"_sceneConstraints"),n(this,"_targetSceneX",0),n(this,"_targetSceneY",0),n(this,"_currentSceneX",0),n(this,"_currentSceneY",0)}get worldBounds(){return this._worldBounds}set worldBounds(t){this._worldBounds=t,this._updateSceneConstraints()}followTarget(t,e){this._targetNode=t,this.followX=(e==null?void 0:e.followX)??!0,this.followY=(e==null?void 0:e.followY)??!0,this.offsetX=(e==null?void 0:e.offsetX)??0,this.offsetY=(e==null?void 0:e.offsetY)??0,((e==null?void 0:e.immediate)??!0)&&this.snapToTarget()}lookAt(t,e,i=!1){this._calculateTargetScenePosition(t,e),i&&(this._currentSceneX=this._targetSceneX,this._currentSceneY=this._targetSceneY,this._updateScenePosition())}setWorldBounds(t){this.worldBounds=t}snapToTarget(){this._targetNode&&(this._calculateTargetPositionFromNode(this._targetNode),this._applyBoundsConstraint(),this.followX&&(this._currentSceneX=this._targetSceneX),this.followY&&(this._currentSceneY=this._targetSceneY),this._updateScenePosition())}getCurrentPosition(){return{x:this._currentSceneX,y:this._currentSceneY}}getTargetPosition(){return{x:this._targetSceneX,y:this._targetSceneY}}isAtTarget(t=1){const e=Math.abs(this._currentSceneX-this._targetSceneX),i=Math.abs(this._currentSceneY-this._targetSceneY);return e<t&&i<t}onCreate(){var t;(t=this.target)!=null&&t.scene&&(this._currentSceneX=this.target.scene.position.x,this._currentSceneY=this.target.scene.position.y)}onAwake(){this._targetNode&&this.snapToTarget()}onUpdate(t){this._targetNode&&(this.followEnabled&&this._calculateTargetPositionFromNode(this._targetNode),this._applyBoundsConstraint(),this._applySmoothMovement(t),this._updateScenePosition())}onDestroy(){this._targetNode=void 0,this.worldBounds=void 0}_updateSceneConstraints(){if(!this._worldBounds||!this.stage){this._sceneConstraints=void 0;return}const t=this._worldBounds,e=t.x,i=t.x+t.width-this.stage.width,r=t.y,a=t.y+t.height-this.stage.height,o=-e,h=-i,l=-r,c=-a,d=Math.max(0,o-h),u=Math.max(0,l-c);this._sceneConstraints=new zt(h,c,d,u)}_calculateTargetPositionFromNode(t){if(!this.scene||!this.stage)return;const e=this._getNodeWorldCenter(t);this._calculateTargetScenePosition(e.x,e.y)}_calculateTargetScenePosition(t,e){if(!(!this.scene||!this.stage)){if(this.followX){const i=this.stage.width/2-t;this._targetSceneX=this.scene.position.x+i+this.offsetX}if(this.followY){const i=this.stage.height/2-e;this._targetSceneY=this.scene.position.y+i+this.offsetY}}}_getNodeWorldCenter(t){const e=t.getLocalBounds(),i=e.width/2,r=e.height/2,a={x:i,y:r};return t.localToWorld(a,a)}_applyBoundsConstraint(){if(!this._sceneConstraints)return;const{left:t,right:e,top:i,bottom:r}=this._sceneConstraints;this.followX&&(this._targetSceneX=Math.max(t,Math.min(e,this._targetSceneX))),this.followY&&(this._targetSceneY=Math.max(i,Math.min(r,this._targetSceneY)))}_applySmoothMovement(t){if(this.smoothness<=0)return;const e=Math.min(1,this.smoothness*(t/.016));this.followX&&(this._currentSceneX+=(this._targetSceneX-this._currentSceneX)*e),this.followY&&(this._currentSceneY+=(this._targetSceneY-this._currentSceneY)*e)}_updateScenePosition(){this.scene&&(this.followX&&(this.scene.position.x=this._currentSceneX),this.followY&&(this.scene.position.y=this._currentSceneY))}}var ki=(s,t,e,i)=>{for(var r=t,a=s.length-1,o;a>=0;a--)(o=s[a])&&(r=o(r)||r);return r};let yt=class extends O{constructor(s){super(),n(this,"json"),n(this,"timeScale",1),n(this,"camera",new Mi),n(this,"onUpdate");const t=this.pp;t.url="",t.currentTime=0,t.isPlaying=!1,t.paused=!1,this.on(v.addedToStage,this.play,this),this.on(v.removed,this.stop,this),this.addScript(this.camera),this.setProps(s)}get scene(){return this}get currentTime(){return this.pp.currentTime}get isPlaying(){return this.pp.isPlaying}get paused(){return this.pp.paused}get url(){return this.pp.url}set url(s){this.load(s)}destroy(){this.destroyed||(this.stop(),this.json=void 0,super.destroy())}async load(s,t=!0){if(this.pp.url===s&&this.json){this.emit(v.loaded);return}this.pp.url=s;try{const e=await V.load(s);if(!e)return;t&&await this.preloadAssets(e),this.fromJson(e),this.emit(v.loaded)}catch(e){throw this.emit(v.error,e),e}}async preloadAssets(s){const t=[];this._$collectAsset(s,t);const e=t.length;if(e){const i=[];let r=0;for(const a of t){const o=V.load(a);o.then(()=>{r++,this.emit(v.progress,r/e)}),i.push(o)}await Promise.all(i)}}_$collectAsset(s,t){var e;if(s.props.url&&t.push(s.props.url),(e=s.children)!=null&&e.length)for(const i of s.children)this._$collectAsset(i,t)}play(){var s;const t=this.pp;return t.isPlaying||(t.isPlaying=!0,t.paused=!1,(s=this.stage)==null||s.timer.onFrame(this.update,this),this.emit(v.played)),this}stop(){var s;return this.pp.isPlaying&&(this.pp.isPlaying=!1,(s=this.stage)==null||s.timer.clearTimer(this.update,this),this.emit(v.stopped)),this}pause(){var s;const t=this.pp;return!t.isPlaying||t.paused?this:(t.paused=!0,(s=this.stage)==null||s.timer.clearTimer(this.update,this),this.emit(v.paused),this)}resume(){var s;const t=this.pp;return!t.isPlaying||!t.paused?this:(t.paused=!1,(s=this.stage)==null||s.timer.onFrame(this.update,this),this.emit(v.resumed),this)}update(s){var t;const e=this.stage;if(!this.enabled||!e||this.pp.paused)return;const i=s??e.timer.delta*this.timeScale;this.pp.currentTime+=i,this._$updateScripts(this,i),this.emit(v.update,i),(t=this.onUpdate)==null||t.call(this,i)}_$updateScripts(s,t){if(s.enabled){const{scripts:e}=s;if(e.length)for(const r of e)r.update(t);const{children:i}=s;if(i.length)for(const r of i)this._$updateScripts(r,t)}}fromJson(s){return this.json=s,super.fromJson(s),this}cloneNode(s){const t=this._$findNodeData(s,this.json);if(t){const e=$t(t),i=mt(e.type);if(i)return e.props.id=q(),e.props.editorOnly=!1,i.fromJson(e),i}console.warn(`clone node ${s.id??s.label} failed`)}_$findNodeData(s,t){var e;if(!t)return;const{id:i,label:r}=s;if(t.id===i||t.props.label===r)return t;if((e=t.children)!=null&&e.length)for(const a of t.children){const o=this._$findNodeData(s,a);if(o)return o}}};yt=ki([N("Scene")],yt);class Ii extends O{constructor(){super(),n(this,"timer",new E),n(this,"store",new Qe),n(this,"canvas"),n(this,"renderer"),n(this,"keyboard"),n(this,"pointer"),this.pp.stage=this,this.pointerEnabled=!0,this.pointerEnabledForChildren=!0,this.label="Stage"}autoResize(){const t=this.canvas.parentElement;if(t){const e=t.getBoundingClientRect();this.resize(e.width,e.height)}}resize(t,e){const i=Math.round(t),r=Math.round(e);return i===this.width&&r===this.height?this:(this.width=i,this.height=r,Y.pixelRatio!==1?(this.canvas.width=i*Y.pixelRatio,this.canvas.height=r*Y.pixelRatio,this.canvas.style.cssText=`width: ${i}px; height: ${r}px; `):(this.canvas.width=i,this.canvas.height=r),this.renderer.resize(i,r),this.pp.localBounds.set(0,0,i,r),this)}getLocalBounds(){return this.pp.localBounds}hitTest(t){return this.getLocalBounds().contains(t.x,t.y)}async loadScene(t,e){const i=new yt;return await i.load(t,e==null?void 0:e.preloadAssets),e!=null&&e.destroyOther&&this.destroyChildren(),this.addChild(i),i}async createScene(t,e){const i=new yt;return e!=null&&e.preloadAssets&&await i.preloadAssets(t),i.fromJson(t),e!=null&&e.destroyOther&&this.destroyChildren(),this.addChild(i),i}pause(){return this.timer.pause(),this}resume(){return this.timer.resume(),this}destroy(){this.destroyed||(this.timer.destroy(),this.store.destroy(),this.renderer.destroy(),this.keyboard.destroy(),this.pointer.destroy(),super.destroy())}}async function Bi(){const{physics:s}=await Fe(async()=>{const{physics:t}=await import("./liko.physics.es-Bka1YuRG.js");return{physics:t}},__vite__mapDeps([0,1]));return window.physics=s,s}class Di{constructor(){n(this,"_width",1),n(this,"_height",1),n(this,"group"),n(this,"buffer"),n(this,"data",new Float32Array(16)),n(this,"projectionMatrix",new F),n(this,"rootMatrix",new F),n(this,"loaded",!1),n(this,"destroyed",!1);const{group:t,buffer:e}=A.createProjectionMatrixBuffer("uProjection",this.data);this.group=t,this.buffer=e}destroy(){this.destroyed||(this.destroyed=!0,this.buffer.destroy())}resize(t,e){if(t!==this._width||e!==this._height){const i=this._createMatrix(t,e);A.uploadUniform(this.buffer,i),A.setViewport(t*devicePixelRatio,e*devicePixelRatio),this.loaded=!0}}_createMatrix(t,e){return this._width=t,this._height=e,this.calProjection(this.projectionMatrix,0,0,t,e,!1),this.projectionMatrix.append(this.rootMatrix),this.toArray(this.projectionMatrix)}toArray(t){const e=this.data;return e[0]=t.a,e[1]=t.b,e[2]=0,e[3]=0,e[4]=t.c,e[5]=t.d,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=-1,e[11]=0,e[12]=t.tx,e[13]=t.ty,e[14]=1,e[15]=1,e}calProjection(t,e,i,r,a,o){const h=o?1:-1;return t.identity(),t.a=1/r*2,t.d=h*(1/a*2),t.tx=-1-e*t.a,t.ty=-h-i*t.d,t}}class Ri{constructor(){n(this,"canvas"),n(this,"context"),n(this,"gpuRender"),n(this,"camera")}destroy(){var t;(t=this.camera)==null||t.destroy()}async init(t){const{context:e,gpuRender:i}=await A.init(t);this.context=e,this.gpuRender=i,this.camera=new Di}render(t){t.pp.dirty!==0&&this.gpuRender.render(t,t.worldMatrix,this.camera,this.context.getCurrentTexture())}resize(t,e){this.camera.resize(t,e)}}const Ei={width:innerWidth,height:innerHeight,bgColor:0,pixelRatio:window.devicePixelRatio},Be=class De{constructor(){n(this,"_frameHandle",0),n(this,"_renderHandler",this.render.bind(this)),n(this,"renderer",new Ri),n(this,"stage",new Ii),wi()}async init(t){var e;const i=(t==null?void 0:t.canvas)??lt(),r={canvas:i,...Ei,...t};if(De.pixelRatio=r.pixelRatio,this.stage.canvas=i,this.stage.renderer=this.renderer,this.stage.keyboard=new Ke(this.stage),this.stage.pointer=new Je(this.stage),!i.parentNode){const a=typeof r.container=="string"?document.getElementById(r.container):r.container??document.body;if(a)a.appendChild(i);else throw new Error(`cant not find canvas's container:${r.container}`)}return await this.renderer.init(r),this.stage.resize(r.width,r.height),r.autoResize&&(window.onresize=()=>{this.stage.autoResize()},this.stage.autoResize()),(e=r.physics)!=null&&e.enabled&&(await Bi()).init({timer:this.stage.timer,...r.physics}),this._frameHandle=requestAnimationFrame(this._renderHandler),i}pause(){cancelAnimationFrame(this._frameHandle)}resume(){this._frameHandle=requestAnimationFrame(this._renderHandler)}render(t){E.runAllCallLater(),this.renderer.render(this.stage);const e=t*.001;E.system.update(e),this.stage.timer.update(e),this._frameHandle=requestAnimationFrame(this._renderHandler)}destroy(){cancelAnimationFrame(this._frameHandle),this._renderHandler=()=>{},this.stage.destroy(),this.renderer.destroy()}};n(Be,"pixelRatio",window.devicePixelRatio);let Y=Be;var Li=(s,t,e,i)=>{for(var r=t,a=s.length-1,o;a>=0;a--)(o=s[a])&&(r=o(r)||r);return r};let Qt=class extends O{constructor(s){super(s),n(this,"renderObject",new _t(this));const t=this.pp;t.bounds=new K,t.cmd=[],t.canvas=lt(1,1),t.ctx=t.canvas.getContext("2d"),t.texture=new k,t.changed=!1,t.maxLineWidth=0,t.clipped=!1}get texture(){return this.pp.cmd.length===0?k.BLANK:(this.pp.changed&&this._$drawCanvas(),this.pp.texture)}clear(){const s=this.pp;return s.cmd.length=0,s.bounds.reset(),s.ctx.clearRect(0,0,s.canvas.width,s.canvas.height),s.maxLineWidth=0,s.clipped=!1,this._$dirty(),this}rect(s,t,e,i){return console.assert(e>=0&&i>=0),this.pp.cmd.push({type:"rect",params:[s,t,e,i]}),this._$addPoint(s,t),this._$addPoint(s+e,t+i),this}roundRect(s,t,e,i,r){return this.pp.cmd.push({type:"roundRect",params:[s,t,e,i,r]}),this._$addPoint(s,t),this._$addPoint(s+e,t+i),this}circle(s,t,e){return this.pp.cmd.push({type:"arc",params:[s,t,e,0,nt]}),this._$addPoint(s-e,t-e),this._$addPoint(s+e,t+e),this}ellipse(s,t,e,i,r=0,a=nt){return this.pp.cmd.push({type:"ellipse",params:[s,t,e,i,0,r,a]}),this._$addPoint(s-e,t-i),this._$addPoint(s+e,t+i),this}polygon(s){this.beginPath();for(let t=0;t<s.length;t++)t===0?this.moveTo(s[t].x,s[t].y):this.lineTo(s[t].x,s[t].y);return this.closePath(),this}moveTo(s,t){return this.pp.cmd.push({type:"moveTo",params:[s,t]}),this._$addPoint(s,t),this}lineTo(s,t){return this.pp.cmd.push({type:"lineTo",params:[s,t]}),this._$addPoint(s,t),this}arc(s,t,e,i,r){return this.pp.cmd.push({type:"arc",params:[s,t,e,i,r]}),this._$addPoint(s-e,t-e),this._$addPoint(s+e,t+e),this}arcTo(s,t,e,i,r){return this.pp.cmd.push({type:"arcTo",params:[s,t,e,i,r]}),this._$addPoint(s,t),this._$addPoint(e,i),this}quadraticCurveTo(s,t,e,i){return this.pp.cmd.push({type:"quadraticCurveTo",params:[s,t,e,i]}),this._$addPoint(e,i),this._$addPoint(s,t),this}bezierCurveTo(s,t,e,i,r,a){return this.pp.cmd.push({type:"bezierCurveTo",params:[s,t,e,i,r,a]}),this._$addPoint(r,a),this._$addPoint(s,t),this._$addPoint(e,i),this}beginPath(){return this.pp.cmd.push({type:"beginPath",params:[]}),this}closePath(){return this.pp.cmd.push({type:"closePath",params:[]}),this}clip(s){return this.pp.cmd.push({type:"clip",params:s?[s]:[]}),this.pp.clipped=!0,this}drawImage(s,t,e,i,r,a,o,h,l){const c=s instanceof k?s.buffer.bitmap:s,d=i??s.width,u=r??s.height,{cmd:p}=this.pp;return a!==void 0&&o!==void 0&&h!==void 0&&l!==void 0?p.push({type:"drawImage",params:[c,a,o,h,l,t,e,i,r]}):i!==void 0&&r!==void 0?p.push({type:"drawImage",params:[c,t,e,i,r]}):p.push({type:"drawImage",params:[c,t,e]}),this._$addPoint(t,e),this._$addPoint(t+d,e+u),this}drawSvg(s,t=0,e=0,i=1){const r=new Blob([s],{type:"image/svg+xml"}),a=URL.createObjectURL(r),o=new Image;return o.src=a,o.onerror=()=>{throw new Error('SVG 内容错误，检查是否包含 xmlns="http://www.w3.org/2000/svg" 的定义')},o.onload=()=>{const h=o.width*i,l=o.height*i;this.pp.cmd.push({type:"drawImage",params:[o,t,e,h,l]}),this._$addPoint(t,e),this._$addPoint(t+h,e+l),this._$dirty()},this}fill(s){return this.pp.cmd.push({type:"fill",params:[(s==null?void 0:s.color)??"#FFD700"]}),this._$dirty(),this}_$fill(s){const{ctx:t}=this.pp;t.fillStyle=s,t.fill()}stroke(s){const t=s?{width:1,color:"#FFD700",...s}:{width:1,color:"#FFD700"};return t.width=Math.max(t.width,1e-4),this.pp.cmd.push({type:"stroke",params:[t.color,t.width,t.cap,t.join,t.dash,t.dashOffset,t.miterLimit]}),t.width&&(this.pp.maxLineWidth=Math.max(this.pp.maxLineWidth,t.width)),this._$dirty(),this}_$stroke(s,t,e,i,r,a,o){const h=this.pp.ctx;h.strokeStyle=s,t&&(h.lineWidth=t),e&&(h.lineCap=e),i&&(h.lineJoin=i),r&&h.setLineDash(r),a&&(h.lineDashOffset=a),o&&(h.miterLimit=o),h.stroke()}_$drawCanvas(){const{changed:s,canvas:t,ctx:e,cmd:i,maxLineWidth:r,bounds:a}=this.pp;if(s&&(this.pp.changed=!1,e.clearRect(0,0,t.width,t.height),i.length)){const{width:o,height:h}=a,l=Y.pixelRatio,c=Math.ceil((o+r)*l),d=Math.ceil((h+r)*l),u={x:a.x-r*.5,y:a.y-r*.5};this._$resizeCanvas(u,c,d),e.reset(),e.scale(l,l),e.translate(-u.x,-u.y);for(const p of i)p.type==="fill"?this._$fill.apply(this,p.params):p.type==="stroke"?this._$stroke.apply(this,p.params):CanvasRenderingContext2D.prototype[p.type].apply(e,p.params)}}_$resizeCanvas(s,t,e){console.assert(t>0&&e>0,"canvas width and height must be greater than 0");const{canvas:i,texture:r,width:a,height:o}=this.pp,h={frame:{x:0,y:0,w:t,h:e},spriteSourceSize:{x:s.x*Y.pixelRatio,y:s.y*Y.pixelRatio,w:t,h:e},sourceSize:{w:t,h:e},rotated:!1,trimmed:!0};t>i.width||e>i.height?(i.width=t,i.height=e,r.setBuffer(new J(i),void 0,h),this.markDirty(_.child)):(r.setBuffer(r.buffer,void 0,h),r.buffer.dirty()),a===-1&&o===-1&&(this.pp.boundsDirty=!0,this.anchor=this.anchor)}_$addPoint(s,t){if(this.pp.clipped)return;const{bounds:e}=this.pp;s<e.minX&&(e.minX=s),s>e.maxX&&(e.maxX=s),t<e.minY&&(e.minY=t),t>e.maxY&&(e.maxY=t)}_customLocalBounds(s){const{bounds:t,maxLineWidth:e}=this.pp,i=e*.5;s.addFrame(t.minX-i,t.minY-i,t.maxX+i,t.maxY+i)}_$dirty(){this.pp.changed||(this.pp.changed=!0,this.markDirty(_.transform),this.markDirty(_.texture),this.markDirty(_.size),E.callLater(this._$drawCanvas,this))}isPointInPath(s){const t=this.worldToLocal(s);return this.pp.ctx.isPointInPath(t.x,t.y)}destroy(){var s;this.pp.cmd.length=0,(s=this.pp.texture)==null||s.destroy(),super.destroy()}};Qt=Li([N("Canvas")],Qt);class Vi{constructor(t){n(this,"_vertices",[]),n(this,"_indices",[]),n(this,"_colors",[]),n(this,"_geometryDirty",!0),n(this,"vertexStart",0),n(this,"indexStart",0),n(this,"colorStart",0),n(this,"uvStart",0),n(this,"batch"),n(this,"textureId",0),this.node=t}get vertexSize(){return this.generateGeometry(),this._vertices.length}get indexSize(){return this.generateGeometry(),this._indices.length}get colorSize(){return this.generateGeometry(),this._vertices.length*.5}get uvSize(){return this.generateGeometry(),this._vertices.length*.5*3}markGeometryDirty(){this._geometryDirty=!0}generateGeometry(){if(!this._geometryDirty)return;this._vertices.length=0,this._indices.length=0,this._colors.length=0;const{drawRect:t,drawCircle:e,drawEllipse:i,drawRoundedRect:r,drawLine:a,drawPolygon:o}=this.node.pp;t&&this._generateRect(t),e&&this._generateCircle(e),i&&this._generateEllipse(i),r&&this._generateRoundedRect(r),a&&this._generateLine(a),o&&this._generatePolygon(o),this._geometryDirty=!1}_generateRect(t){const{x:e,y:i,width:r,height:a,fill:o,stroke:h,strokeWidth:l=1}=t;if(o){const c=new T(o).abgr;this._addQuad(e,i,e+r,i,e+r,i+a,e,i+a,c)}if(h){const c=new T(h).abgr;this._addRectStroke(e,i,r,a,l,c)}}_generateCircle(t){const{x:e,y:i,radius:r,fill:a,stroke:o,strokeWidth:h=1}=t,l=Math.max(24,Math.min(64,Math.floor(r/1.5)));if(a){const c=new T(a).abgr;this._addCircleFill(e,i,r,l,c)}if(o){const c=new T(o).abgr;this._addCircleStroke(e,i,r,l,h,c)}}_generateEllipse(t){const{x:e,y:i,radiusX:r,radiusY:a,fill:o,stroke:h,strokeWidth:l=1}=t,c=(r+a)*.5,d=Math.max(24,Math.min(64,Math.floor(c/1.5)));if(o){const u=new T(o).abgr;this._addEllipseFill(e,i,r,a,d,u)}if(h){const u=new T(h).abgr;this._addEllipseStroke(e,i,r,a,d,l,u)}}_generateRoundedRect(t){const{x:e,y:i,width:r,height:a,cornerRadius:o,fill:h,stroke:l,strokeWidth:c=1}=t,d=Math.min(r,a)*.5,u=Math.min(o,d);if(h){const p=new T(h).abgr;this._addRoundedRectFill(e,i,r,a,u,p)}if(l){const p=new T(l).abgr;this._addRoundedRectStroke(e,i,r,a,u,c,p)}}_generateLine(t){const{points:e,color:i,lineWidth:r=1}=t,a=new T(i).abgr;for(let o=0,h=e.length-1;o<h;o++)this._addLineSegment(e[o],e[o+1],r,a)}_generatePolygon(t){const{points:e,fill:i,stroke:r,strokeWidth:a=1}=t;if(i&&e.length>=3){const o=new T(i).abgr;this._addPolygonFill(e,o)}if(r&&e.length>=2){const o=new T(r).abgr;this._addPolygonStroke(e,a,o)}}_addQuad(t,e,i,r,a,o,h,l,c){const d=this._vertices.length*.5;this._vertices.push(t,e,i,r,a,o,h,l),this._colors.push(c,c,c,c),this._indices.push(d,d+1,d+2,d,d+2,d+3)}_addRectStroke(t,e,i,r,a,o){const h=a*.5,l=t+h,c=t+i-h,d=e+h,u=e+r-h;this._addLineSegment({x:l,y:d},{x:c,y:d},a,o),this._addLineSegment({x:c,y:d},{x:c,y:u},a,o),this._addLineSegment({x:c,y:u},{x:l,y:u},a,o),this._addLineSegment({x:l,y:u},{x:l,y:d},a,o)}_addCircleFill(t,e,i,r,a){const o=this._vertices.length*.5;this._vertices.push(t,e),this._colors.push(a);for(let h=0;h<=r;h++){const l=h/r*Math.PI*2,c=t+Math.cos(l)*i,d=e+Math.sin(l)*i;this._vertices.push(c,d),this._colors.push(a)}for(let h=0;h<r;h++)this._indices.push(o,o+h+1,o+h+2)}_addCircleStroke(t,e,i,r,a,o){const h=Math.max(0,i-a*.5),l=[];for(let c=0;c<=r;c++){const d=c/r*Math.PI*2;l.push({x:t+Math.cos(d)*h,y:e+Math.sin(d)*h})}for(let c=0;c<l.length-1;c++)this._addLineSegment(l[c],l[c+1],a,o)}_addEllipseFill(t,e,i,r,a,o){const h=this._vertices.length*.5;this._vertices.push(t,e),this._colors.push(o);for(let l=0;l<=a;l++){const c=l/a*Math.PI*2,d=t+Math.cos(c)*i,u=e+Math.sin(c)*r;this._vertices.push(d,u),this._colors.push(o)}for(let l=0;l<a;l++)this._indices.push(h,h+l+1,h+l+2)}_addEllipseStroke(t,e,i,r,a,o,h){const l=Math.max(0,i-o*.5),c=Math.max(0,r-o*.5),d=Math.PI*2/a,u=[];for(let p=0;p<=a;p++){const f=p*d;u.push({x:t+Math.cos(f)*l,y:e+Math.sin(f)*c})}for(let p=0;p<u.length-1;p++)this._addLineSegment(u[p],u[p+1],o,h)}_addRoundedRectFill(t,e,i,r,a,o){if(a===0){this._addQuad(t,e,t+i,e,t+i,e+r,t,e+r,o);return}const h=Math.max(6,Math.min(16,Math.floor(a/1.5))),l=a*2;i>l&&this._addQuad(t+a,e,t+i-a,e,t+i-a,e+r,t+a,e+r,o),r>l&&(this._addQuad(t,e+a,t+a,e+a,t+a,e+r-a,t,e+r-a,o),this._addQuad(t+i-a,e+a,t+i,e+a,t+i,e+r-a,t+i-a,e+r-a,o));const c=Math.PI,d=[{x:t+a,y:e+a,startAngle:c,endAngle:c*1.5},{x:t+i-a,y:e+a,startAngle:c*1.5,endAngle:c*2},{x:t+i-a,y:e+r-a,startAngle:0,endAngle:c*.5},{x:t+a,y:e+r-a,startAngle:c*.5,endAngle:c}];for(const u of d){const p=this._vertices.length*.5;this._vertices.push(u.x,u.y),this._colors.push(o);for(let f=0;f<=h;f++){const m=u.startAngle+f/h*(u.endAngle-u.startAngle),g=u.x+Math.cos(m)*a,y=u.y+Math.sin(m)*a;this._vertices.push(g,y),this._colors.push(o)}for(let f=0;f<h;f++)this._indices.push(p,p+f+1,p+f+2)}}_addRoundedRectStroke(t,e,i,r,a,o,h){if(a===0){this._addRectStroke(t,e,i,r,o,h);return}const l=Math.max(6,Math.min(16,Math.floor(a/1.5))),c=o*.5,d=Math.max(0,a-c),u=t+c,p=e+c,f=i-o,m=r-o,g=[{x:u+d,y:p+d,startAngle:Math.PI,endAngle:Math.PI*1.5},{x:u+f-d,y:p+d,startAngle:Math.PI*1.5,endAngle:Math.PI*2},{x:u+f-d,y:p+m-d,startAngle:0,endAngle:Math.PI*.5},{x:u+d,y:p+m-d,startAngle:Math.PI*.5,endAngle:Math.PI}],y=[[{x:u+d,y:p},{x:u+f-d,y:p}],[{x:u+f,y:p+d},{x:u+f,y:p+m-d}],[{x:u+f-d,y:p+m},{x:u+d,y:p+m}],[{x:u,y:p+m-d},{x:u,y:p+d}]];for(const x of y)this._addLineSegment(x[0],x[1],o,h);for(const x of g){const P=[];for(let b=0;b<=l;b++){const S=x.startAngle+b/l*(x.endAngle-x.startAngle);P.push({x:x.x+Math.cos(S)*d,y:x.y+Math.sin(S)*d})}for(let b=0;b<P.length-1;b++)this._addLineSegment(P[b],P[b+1],o,h)}}_addLineSegment(t,e,i,r){const a=e.x-t.x,o=e.y-t.y,h=a*a+o*o;if(h===0)return;const l=1/Math.sqrt(h),c=-o*l,d=a*l,u=i*.5;this._addQuad(t.x+c*u,t.y+d*u,e.x+c*u,e.y+d*u,e.x-c*u,e.y-d*u,t.x-c*u,t.y-d*u,r)}_addPolygonFill(t,e){if(t.length<3)return;const i=this._vertices.length*.5;for(const r of t)this._vertices.push(r.x,r.y),this._colors.push(e);for(let r=1;r<t.length-1;r++)this._indices.push(i,i+r,i+r+1)}_addPolygonStroke(t,e,i){if(t.length<3)return;const r=this._getInsetPolygonPoints(t,e*.5);for(let a=0;a<r.length;a++){const o=r[a],h=r[(a+1)%r.length];this._addLineSegment(o,h,e,i)}}_getInsetPolygonPoints(t,e){if(e<=0||t.length<3)return t;const i=this._isPolygonClockwise(t),r=[],a=t.length;for(let o=0;o<a;o++){const h=t[(o-1+a)%a],l=t[o],c=t[(o+1)%a],d={x:l.x-h.x,y:l.y-h.y},u={x:c.x-l.x,y:c.y-l.y};let p,f;i?(p={x:d.y,y:-d.x},f={x:u.y,y:-u.x}):(p={x:-d.y,y:d.x},f={x:-u.y,y:u.x});const m=Math.sqrt(p.x*p.x+p.y*p.y),g=Math.sqrt(f.x*f.x+f.y*f.y);m>0&&(p.x/=m,p.y/=m),g>0&&(f.x/=g,f.y/=g);let y={x:p.x+f.x,y:p.y+f.y},x=Math.sqrt(y.x*y.x+y.y*y.y);x<.001?(y=p,x=1):(y.x/=x,y.y/=x);const P=Math.abs(p.x*f.x+p.y*f.y),b=Math.sqrt(Math.max(0,1-P*P)),S=b>.001?1/b:1,M=Math.min(e*S,e*10);r.push({x:l.x+y.x*M,y:l.y+y.y*M})}return r}_isPolygonClockwise(t){let e=0;for(let i=0;i<t.length;i++){const r=t[i],a=t[(i+1)%t.length];e+=(a.x-r.x)*(a.y+r.y)}return e>0}packVertex(t){this.generateGeometry();const{vertexStart:e}=this,{f32Data:i}=t,r=this.node.pp.worldMatrix,{a,b:o,c:h,d:l,tx:c,ty:d}=r;for(let u=0;u<this._vertices.length;u+=2){const p=this._vertices[u],f=this._vertices[u+1];i[e+u]=a*p+h*f+c,i[e+u+1]=o*p+l*f+d}}packIndex(t){const{indexStart:e}=this,{data:i}=t,r=this.vertexStart*.5;for(let a=0;a<this._indices.length;a++)i[e+a]=this._indices[a]+r}packColor(t){const{colorStart:e}=this,{u32Data:i}=t,r=this.node.pp.tintColor;for(let a=0,o=this._colors.length;a<o;a++){const h=this._colors[a];if(r.abgr===-1)i[e+a]=h;else{const l=r.alpha,c=r.red,d=r.green,u=r.blue,p=(h>>>24&255)/255,f=(h>>>16&255)/255,m=(h>>>8&255)/255,g=(h&255)/255,y=Math.round(p*l*255),x=Math.round(g*c*255),P=Math.round(m*d*255),b=Math.round(f*u*255);i[e+a]=y<<24|b<<16|P<<8|x}}}packUV(t){const{uvStart:e}=this,{f32Data:i,u32Data:r}=t,a=r,o=this._vertices.length*.5,h=this.textureId,l=3;for(let c=0;c<o;c++){const d=e+c*l;i[d]=.5,i[d+1]=.5,a[d+2]=h}}}var Fi=(s,t,e,i)=>{for(var r=t,a=s.length-1,o;a>=0;a--)(o=s[a])&&(r=o(r)||r);return r};let Zt=class extends O{constructor(s){super(),n(this,"renderObject",new Vi(this)),n(this,"texture",k.WHITE),this.pp.bounds=new K,this.setProps(s)}_$setProp(s,t){switch(s){case"drawLine":this.drawLine(t);break;case"drawRect":this.drawRect(t);break;case"drawCircle":this.drawCircle(t);break;case"drawEllipse":this.drawEllipse(t);break;case"drawRoundedRect":this.drawRoundedRect(t);break;case"drawPolygon":this.drawPolygon(t);break;default:super._$setProp(s,t)}}drawLine(s){if(this.pp.drawLine=s,s.points.length<2)throw new Error("Line points must be at least 2");return this._markGeometryDirty(),this}drawRect(s){if(this.pp.drawRect=s,!s.fill&&!s.stroke)throw new Error("Rectangle must have fill or stroke");if(s.width<=0||s.height<=0)throw new Error("Rectangle width and height must be positive");return this._markGeometryDirty(),this}drawCircle(s){if(this.pp.drawCircle=s,!s.fill&&!s.stroke)throw new Error("Circle must have fill or stroke");if(s.radius<=0)throw new Error("Circle radius must be positive");return this._markGeometryDirty(),this}drawEllipse(s){if(this.pp.drawEllipse=s,!s.fill&&!s.stroke)throw new Error("Ellipse must have fill or stroke");if(s.radiusX<=0||s.radiusY<=0)throw new Error("Ellipse radiusX and radiusY must be positive");return this._markGeometryDirty(),this}drawRoundedRect(s){if(this.pp.drawRoundedRect=s,!s.fill&&!s.stroke)throw new Error("Rounded rectangle must have fill or stroke");if(s.width<=0||s.height<=0)throw new Error("Rounded rectangle width and height must be positive");return this._markGeometryDirty(),this}drawPolygon(s){if(this.pp.drawPolygon=s,!s.fill&&!s.stroke)throw new Error("Polygon must have fill or stroke");if(s.points.length<3)throw new Error("Polygon must have at least 3 points");return this._markGeometryDirty(),this}clear(){return this.pp.drawLine=void 0,this.pp.drawRect=void 0,this.pp.drawCircle=void 0,this.pp.drawEllipse=void 0,this.pp.drawRoundedRect=void 0,this.pp.drawPolygon=void 0,this._markGeometryDirty(),this}_markGeometryDirty(){this.pp.boundsDirty=!0,this.renderObject.markGeometryDirty(),this.markDirty(_.child)}_updateBounds(){if(!this.pp.boundsDirty)return;this.pp.bounds.reset();const{drawLine:s,drawRect:t,drawCircle:e,drawEllipse:i,drawRoundedRect:r,drawPolygon:a}=this.pp;if(s){const{points:o}=s;for(const h of o)this._addPoint(h.x,h.y)}if(t){const{x:o,y:h,width:l,height:c}=t;this._addPoint(o,h),this._addPoint(o+l,h+c)}if(e){const{x:o,y:h,radius:l}=e;this._addPoint(o-l,h-l),this._addPoint(o+l,h+l)}if(i){const{x:o,y:h,radiusX:l,radiusY:c}=i;this._addPoint(o-l,h-c),this._addPoint(o+l,h+c)}if(r){const{x:o,y:h,width:l,height:c}=r;this._addPoint(o,h),this._addPoint(o+l,h+c)}if(a){const{points:o}=a;for(const h of o)this._addPoint(h.x,h.y)}}_addPoint(s,t){const{bounds:e}=this.pp;s<e.minX&&(e.minX=s),s>e.maxX&&(e.maxX=s),t<e.minY&&(e.minY=t),t>e.maxY&&(e.maxY=t)}_customLocalBounds(s){this._updateBounds();const{bounds:t}=this.pp;s.addFrame(t.minX,t.minY,t.maxX,t.maxY)}};Zt=Fi([N("Shape")],Zt);var $i=(s,t,e,i)=>{for(var r=t,a=s.length-1,o;a>=0;a--)(o=s[a])&&(r=o(r)||r);return r};let te=class extends O{hitTest(){return!1}_customLocalBounds(s){for(const t of this.children){const{position:e}=t;t.rotation?(s.addFrame(0,0,t.width,t.height),s.applyMatrix(t.localMatrix)):s.addFrame(e.x,e.y,e.x+t.width,e.y+t.height)}}};te=$i([N("Container")],te);var zi=(s,t,e,i)=>{for(var r=t,a=s.length-1,o;a>=0;a--)(o=s[a])&&(r=o(r)||r);return r};let ee=class extends O{constructor(s){super(),n(this,"renderObject",new _t(this)),n(this,"isPlaying",!1),n(this,"frameRate",20),this.pp.url="",this.pp.currentFrame=0,this.pp.textures=[],this.setProps(s),this._$renderFrame(this.pp.currentFrame)}get textures(){return this.pp.textures}set textures(s){this.pp.textures!==s&&(this.pp.textures=s,this.pp.currentFrame=-1,this.currentFrame=0,this.markDirty(_.child),this.anchor=this.anchor)}get texture(){return this.pp.texture}set texture(s){this.pp.texture!==s&&(this.pp.texture=s,this.markDirty(_.texture),this.markDirty(_.size))}get duration(){return this.pp.textures.length/this.frameRate}get currentFrame(){return this.pp.currentFrame}set currentFrame(s){this.pp.currentFrame!==s&&(this.pp.currentFrame=s,this._$renderFrame(s))}_$renderFrame(s){const{textures:t}=this.pp;if(t.length){let e=s;e>=t.length&&(e=0,this.pp.currentFrame=0),this.texture=t[e],e===t.length-1&&this.emit(v.ended)}}get url(){return this.pp.url}set url(s){this.pp.url!==s&&this.load(s)}async load(s){if(this.pp.url!==s){this.pp.url=s;const t=await V.load(s,"sheet");if(this.destroyed||!t||this.pp.url!==s)return;console.assert(t.length>0),this.textures=t,this.emit(v.loaded)}}_customLocalBounds(s){const{texture:t}=this.pp;t&&s.addFrame(0,0,t.width,t.height)}play(){var s;return this.isPlaying||(this.isPlaying=!0,console.assert(this.stage!==void 0,"please add to stage first before play"),(s=this.stage)==null||s.timer.setInterval(1/this.frameRate,this._$update,this),this.emit(v.played)),this}stop(){var s;return this.isPlaying&&(this.isPlaying=!1,(s=this.stage)==null||s.timer.clearTimer(this._$update,this),this.emit(v.stopped)),this}_$update(){this.currentFrame++}gotoTime(s){return this.currentFrame=Math.round(s/this.duration*this.pp.textures.length),this}destroy(){this.stop(),this.textures.length=0,super.destroy()}};ee=zi([N("AnimatedSprite")],ee);var Yi=(s,t,e,i)=>{for(var r=t,a=s.length-1,o;a>=0;a--)(o=s[a])&&(r=o(r)||r);return r};let ie=class extends O{constructor(s){super(),n(this,"renderObject",new _t(this)),n(this,"padding",4);const t=this.pp;t.canvas=lt(100,20),t.ctx=t.canvas.getContext("2d"),t.text="",t.lines=[],t.textColor="#efefef",t.textStrokeColor="",t.textStrokeWidth=0,t.fontFamily="Arial",t.fontSize=12,t.fontWeight="normal",t.fontStyle="normal",t.textAlign="left",t.lineHeight=0,t.measureWidth=0,t.measureHeight=0,t.changed=!1,t.texture=new k,this.setProps(s)}get texture(){return this.pp.text?(this.pp.changed&&this._$drawText(),this.pp.texture):k.BLANK}get text(){return this.pp.text}set text(s){const t=this.pp;t.text!==s&&(t.text=s,t.lines=t.text.split(`
`),this._$dirty())}_$dirty(){this.pp.changed||(this.pp.changed=!0,this.markDirty(_.texture),this.markDirty(_.transform),this.markDirty(_.size),E.callLater(this._$drawText,this))}get textColor(){return this.pp.textColor}set textColor(s){this.pp.textColor!==s&&(this.pp.textColor=s,this._$dirty())}get textStrokeColor(){return this.pp.textStrokeColor}set textStrokeColor(s){this.pp.textStrokeColor!==s&&(this.pp.textStrokeColor=s,this._$dirty())}get textStrokeWidth(){return this.pp.textStrokeWidth}set textStrokeWidth(s){this.pp.textStrokeWidth!==s&&(this.pp.textStrokeWidth=s,this._$dirty())}get fontFamily(){return this.pp.fontFamily}set fontFamily(s){this.pp.fontFamily!==s&&(this.pp.fontFamily=s,this._$dirty())}get fontSize(){return this.pp.fontSize}set fontSize(s){this.pp.fontSize!==s&&(this.pp.fontSize=s,this._$dirty())}get fontWeight(){return this.pp.fontWeight}set fontWeight(s){this.pp.fontWeight!==s&&(this.pp.fontWeight=s,this._$dirty())}get fontStyle(){return this.pp.fontStyle}set fontStyle(s){this.pp.fontStyle!==s&&(this.pp.fontStyle=s,this._$dirty())}get lineHeight(){const{lineHeight:s,fontSize:t}=this.pp;return s>0?s:t}set lineHeight(s){this.pp.lineHeight!==s&&(this.pp.lineHeight=s,this._$dirty())}get textAlign(){return this.pp.textAlign}set textAlign(s){this.pp.textAlign!==s&&(this.pp.textAlign=s,this._$dirty())}get width(){return super.width}set width(s){this.pp.width!==s&&(super.width=s,this._$dirty())}get height(){return super.height}set height(s){this.pp.height!==s&&(super.height=s,this._$dirty())}get textWidth(){return this.pp.measureWidth+this.pp.textStrokeWidth+this.padding*2}get textHeight(){return this.pp.measureHeight+this.pp.textStrokeWidth+this.padding*2}destroy(){this.pp.texture.destroy(),super.destroy()}setText(s){return this.text=s,this}_$resetStyle(){const{ctx:s,fontStyle:t,fontWeight:e,fontSize:i,fontFamily:r,textColor:a,textAlign:o,textStrokeColor:h}=this.pp;s.textBaseline="alphabetic",s.font=`${t?`${t} `:""}${e} ${i}px ${r}`,s.fillStyle=a,s.textAlign=o,s.strokeStyle=h}_$measure(){const{lines:s,ctx:t}=this.pp;this._$resetStyle();let e=0;for(const r of s)e=Math.max(Math.ceil(t.measureText(r).width),e);this.pp.measureWidth=e,this.pp.measureHeight=this.lineHeight*s.length;const i=t.measureText("|ÉqÅM");return{ascent:i.actualBoundingBoxAscent,fontHeight:i.actualBoundingBoxAscent+i.actualBoundingBoxDescent}}_customLocalBounds(s){s.addFrame(0,0,this.textWidth,this.textHeight)}getLocalBounds(){return this.pp.changed&&this._$drawText(),super.getLocalBounds()}_$drawText(){const{changed:s,canvas:t,ctx:e,textAlign:i,textStrokeWidth:r,textStrokeColor:a,textColor:o,lines:h}=this.pp;if(s){this.pp.changed=!1,e.clearRect(0,0,t.width,t.height);const l=this._$measure(),c=Y.pixelRatio,d=Math.ceil(this.textWidth*c),u=Math.ceil(this.textHeight*c);this._$resizeCanvas(d,u),this._$resetStyle();const p=i==="left"?0:i==="right"?this.pp.measureWidth:this.pp.measureWidth*.5,f=this.lineHeight,m=(f-l.fontHeight)*.5;if(e.resetTransform(),e.scale(c,c),e.translate(r*.5+this.padding,r*.5+this.padding),r&&a){e.strokeStyle=a,e.lineWidth=r;for(let g=0;g<h.length;g++){const y=h[g],x=g*f+m+l.ascent;e.strokeText(y,p,x)}}if(o){e.fillStyle=o;for(let g=0;g<h.length;g++){const y=h[g],x=g*f+m+l.ascent;e.fillText(y,p,x)}}}}_$resizeCanvas(s,t){const{canvas:e,texture:i,width:r,height:a}=this.pp;if(s>e.width||t>e.height)e.width=s,e.height=t,i.setBuffer(new J(e)),this.markDirty(_.child);else{const o={frame:{x:0,y:0,w:s,h:t},spriteSourceSize:{x:0,y:0,w:s,h:t},sourceSize:{w:s,h:t},rotated:!1,trimmed:!0};i.setBuffer(i.buffer,void 0,o),i.buffer.dirty()}r===-1&&a===-1&&(this.pp.boundsDirty=!0,this.anchor=this.anchor)}};ie=Yi([N("Text")],ie);class Re extends Ot{_$awake(){this.awaked||(this._$regEvent(),super._$awake())}_$regEvent(){var t;const e=Re.prototype,i=this.target;if(i){const{onClick:r,onPointerDown:a,onPointerUp:o,onPointerMove:h,onCollisionStart:l,onCollisionEnd:c,onSignal:d}=e;this.onClick!==r&&i.on(v.click,this.onClick,this),this.onPointerDown!==a&&i.on(v.pointerDown,this.onPointerDown,this),this.onPointerUp!==o&&i.on(v.pointerUp,this.onPointerUp,this),this.onPointerMove!==h&&i.on(v.pointerMove,this.onPointerMove,this),this.onCollisionStart!==l&&i.on(v.collisionStart,this.onCollisionStart,this),this.onCollisionEnd!==c&&i.on(v.collisionEnd,this.onCollisionEnd,this),this.onSignal!==d&&((t=this.scene)==null||t.on(v.signal,this.onSignal,this));const{stage:u}=this;if(u){const{onStageClick:p,onStagePointerDown:f,onStagePointerUp:m,onStagePointerMove:g,onKeyDown:y,onKeyUp:x}=e;this.onStageClick!==p&&u.on(v.click,this.onStageClick,this),this.onStagePointerDown!==f&&u.on(v.pointerDown,this.onStagePointerDown,this),this.onStagePointerUp!==m&&u.on(v.pointerUp,this.onStagePointerUp,this),this.onStagePointerMove!==g&&u.on(v.pointerMove,this.onStagePointerMove,this),this.onKeyDown!==y&&u.on(v.keydown,this.onKeyDown,this),this.onKeyUp!==x&&u.on(v.keyup,this.onKeyUp,this)}}}onClick(t){}onPointerDown(t){}onPointerUp(t){}onPointerMove(t){}onCollisionStart(t){}onCollisionEnd(t){}onSignal(t,e){}onStageClick(t){}onStagePointerDown(t){}onStagePointerUp(t){}onStagePointerMove(t){}onKeyDown(t){}onKeyUp(t){}}const se=Math.PI/2,pt=7.5625,ot=1.70158,ft=ot*1.525,re=6.9813172,w={Linear(s){return s},QuadIn(s){return s*s},QuadOut(s){return s*(2-s)},QuadInOut(s){let t=s*2;return t<1?.5*t*t:-.5*(--t*(t-2)-1)},CubicIn(s){return s*s*s},CubicOut(s){return(s-1)**3+1},CubicInOut(s){let t=s*2;return t<1?.5*t**3:(t=t-2,.5*(t**3+2))},QuartIn(s){return s**4},QuartOut(s){return 1-(s-1)**4},QuartInOut(s){let t=s*2;return t<1?.5*t**4:(t=t-2,-.5*(t**4-2))},QuintIn(s){return s*s*s*s*s},QuintOut(s){return(s-1)**5+1},QuintInOut(s){let t=s*2;return t<1?.5*t**5:(t=t-2,.5*(t**5+2))},SineIn(s){return 1-Math.sin((1-s)*se)},SineOut(s){return Math.sin(s*se)},SineInOut(s){return .5*(1-Math.sin(Math.PI*(.5-s)))},ExpoIn(s){return s===0?0:1024**(s-1)},ExpoOut(s){return s===1?1:1-2**(-10*s)},ExpoInOut(s){if(s===0)return 0;if(s===1)return 1;const t=s*2;return t<1?.5*1024**(t-1):.5*(-(2**(-10*(t-1)))+2)},CircIn(s){return 1-Math.sqrt(1-s*s)},CircOut(s){const t=s-1;return Math.sqrt(1-t*t)},CircInOut(s){let t=s*2;return t<1?-.5*(Math.sqrt(1-t*t)-1):(t=t-2,.5*(Math.sqrt(1-t*t)+1))},ElasticIn(s){return s===0?0:s===1?1:-(2**(10*(s-1)))*Math.sin((s-1.1)*5*Math.PI)},ElasticOut(s){return s===0?0:s===1?1:2**(-10*s)*Math.sin((s-.1)*5*Math.PI)+1},ElasticInOut(s){if(s===0)return 0;if(s===1)return 1;const t=s*2;return t<1?-.5*2**(10*(t-1))*Math.sin((t-1.1)*5*Math.PI):.5*2**(-10*(t-1))*Math.sin((t-.1)*5*Math.PI)+1},BackIn(s){return s===1?1:s*s*((ot+1)*s-ot)},BackOut(s){const t=s-1;return s===0?0:t*t*((ot+1)*t+ot)+1},BackInOut(s){let t=s*2;return t<1?.5*(t*t*((ft+1)*t-ft)):(t=t-2,.5*(t*t*((ft+1)*t+ft)+2))},BounceIn(s){return 1-w.BounceOut(1-s)},BounceOut(s){if(s<1/2.75)return pt*s*s;if(s<2/2.75){const e=s-.5454545454545454;return pt*e*e+.75}if(s<2.5/2.75){const e=s-.8181818181818182;return pt*e*e+.9375}const t=s-2.625/2.75;return pt*t*t+.984375},BounceInOut(s){return s<.5?w.BounceIn(s*2)*.5:w.BounceOut(s*2-1)*.5+.5},Immediately(s){return s>0?1:0},Pulse(s){return s<.5?w.SineIn(s*2):1-w.SineOut((s-.5)*2)},Jelly(s){return s<.5?Math.sin(re*w.SineIn(s*2)):Math.sin(re*(1-w.SineOut((s-.5)*2)))},Collision(s){return s<.25?w.QuartOut(s*4):1-w.BounceOut((s-.25)*4/3)},Pendulum(s){return s<.25?s*4:s<.5?1-(s-.25)*4:s<.75?(s-.5)*4:1-(s-.75)*4},Heart(s){return s<.25?w.QuadOut(s*4):s<.5?1-w.QuadIn((s-.25)*4):s<.75?w.QuadOut((s-.5)*4):1-w.QuadIn((s-.75)*4)},Breathe(s){return s<.25?w.QuartOut(s*4):s<.5?1-w.QuadIn((s-.25)*4):s<.75?-w.QuartOut((s-.5)*4):w.QuadIn((s-.75)*4)-1},Wave(s){return s<.25?s*4:s<.5?(s-.25)*4:s<.75?(s-.5)*4:(s-.75)*4},Swing(s){return s<.5?w.Breathe(s*2):w.Breathe((s-.5)*2)*.5},Flash(s){return s<.1?w.Linear(s*10):s<.2?1-w.Linear((s-.1)*10):s<.3?w.Linear((s-.2)*10):s<.4?1-w.Linear((s-.3)*10):s<.5?w.Linear((s-.4)*10):w.Linear((s-.5)*2)},Shake(s){const t=1-s;return Math.sin(s*30)*t*t}};function Oi(s){return w[s]||w.Linear}class Xi{constructor(){n(this,"_from",{}),n(this,"_diff",{}),n(this,"_repeatTimes",0),n(this,"target",{}),n(this,"to"),n(this,"from"),n(this,"_startTime",0),n(this,"_delay",0),n(this,"duration",1),n(this,"_repeat",1),n(this,"repeatDelay",0),n(this,"yoyo",!1),n(this,"_ease",w.Linear),n(this,"awaked",!1),n(this,"started",!1),n(this,"ended",!1)}get delay(){return this._delay}set delay(t){this._delay=t,this._startTime=t}get repeat(){return this._repeat}set repeat(t){t!==this._repeat&&(this._repeat=t<=0?Number.POSITIVE_INFINITY:t)}get ease(){return this._ease}set ease(t){typeof t=="string"?this._ease=Oi(t):this._ease=t}setProps(t){if(t){const e=Object.keys(t);for(const i of e)this.setProp(i,t[i])}}setProp(t,e){t in this&&(this[t]=e)}update(t){!this.ended&&t>=this._startTime&&(this.started||this._start(),t<this._startTime+this.duration?this._updateProgress(t):this._end())}_start(){this.awaked||(this.awaked=!0,this.to?this._toKey(this.to):this.from&&this._fromKey(this.from),this.onAwake(this.target)),this.started||(this.started=!0,this.onStart(this.target))}_toKey(t){const e=Object.keys(t);for(const i of e)i in this.target&&this._setDiff(i,this._fromTarget(i,t[i]),this._formatValue(i,t[i]))}_fromKey(t){const e=Object.keys(t);for(const i of e)i in this.target&&this._setDiff(i,this._formatValue(i,t[i]),this._fromTarget(i,t[i]))}_fromTarget(t,e){const i=this.target[t];if(typeof i=="number")return i;const r={},a=Object.keys(e);for(const o of a)r[o]=i[o];return r}_formatValue(t,e){if(typeof e=="number")return e;if(typeof e=="string")return e.startsWith("*")?this.target[t]*Number.parseFloat(e.replace("*","")):this.target[t]+Number.parseFloat(e);const i={},r=Object.keys(e);for(const a of r){const o=e[a];typeof o=="number"?i[a]=o:o.startsWith("*")?i[a]=this.target[t][a]*Number.parseFloat(o.replace("*","")):i[a]=this.target[t][a]+Number.parseFloat(o)}return i}_setDiff(t,e,i){if(this._from[t]=e,typeof e=="number"&&typeof i=="number")this._diff[t]=i-e;else if(typeof e=="object"&&typeof i=="object"){const r={},a=Object.keys(e);for(const o of a)r[o]=i[o]-e[o];this._diff[t]=r}}_updateProgress(t){let e=(t-this._startTime)/this.duration;e=e<0?0:e<1?e:1,this.onUpdate(this._easeValue(e))}_easeValue(t){let e=t;return this.yoyo&&(e=this._repeatTimes%2===0?t:1-t),this.ease(e)}onUpdate(t){const e=Object.keys(this._diff);for(const i of e){const r=this._diff[i];if(typeof r=="number")this.target[i]=this._from[i]+r*t;else{const a=this.target[i],o=Object.keys(r);for(const h of o)a[h]=this._from[i][h]+r[h]*t}}}_end(){this._repeatTimes++,this._repeatTimes<this.repeat?(this._startTime=this.delay+(this.repeatDelay+this.duration)*this._repeatTimes,this.started=!1,this.ended=!1,this.onUpdate(this._easeValue(this.yoyo?0:1)),this.onEnd(this.target)):this._complete()}_complete(){this.onUpdate(this._easeValue(this.yoyo?0:1)),this.ended=!0,this.onEnd(this.target),this.onComplete(this.target)}goto(t){if(this.repeat>1){const e=this.duration+this.repeatDelay;this._repeatTimes=t>this.delay+this.duration?Math.floor((t-this.delay)/e):0,this._repeatTimes>this.repeat&&(this._repeatTimes=this.repeat),this._startTime=this.delay+e*this._repeatTimes}this.started=!1,this.ended=!1,t>=this._startTime&&this.update(t)}reset(){this._repeatTimes=0,this._startTime=this.delay,this.started=!1,this.ended=!1,this.awaked=!1}onAwake(t){}onStart(t){}onEnd(t){}onComplete(t){}}const Ee=class B{constructor(){n(this,"_effects",[]),n(this,"_current"),n(this,"_currentTime",0),n(this,"_isPlaying",!1),n(this,"_paused",!1),n(this,"_destroyed",!1),n(this,"_resolve"),n(this,"_onAllComplete"),n(this,"label")}static to(t){const e=t.label;e&&B.clear(e);const i=new B().to(t);return i.label=e,B._list.push(i),i}static from(t){const e=t.label;e&&B.clear(e);const i=new B().from(t);return i.label=e,B._list.push(i),i}static clear(t){for(const e of B._list)if(e.label===t){e.destroy();break}}static clearAll(){const t=[...B._list];for(const e of t)e.destroy();B._list.length=0}get destroyed(){return this._destroyed}get isPlaying(){return this._isPlaying}get paused(){return this._paused}set(t,e){const i=Object.keys(e);for(const r of i)r in t&&(t[r]=e[r]);return this}to(t){return this._add(!0,t)}from(t){return this._add(!1,t)}wait(t){return this._add(!0,{target:{},props:{},duration:t})}call(t){return this._add(!0,{target:{},props:{},duration:0,onStart:t})}_add(t,e){const i=new Xi;return i.target=e.target,i.duration=e.duration??1,i.ease=e.ease??w.Linear,i.delay=this._lastEndTime()+(e.delay??0),i.repeat=e.repeat??1,i.repeatDelay=e.repeatDelay??0,i.yoyo=!!e.yoyo,e.onUpdate&&(i.onUpdate=e.onUpdate),e.onStart&&(i.onStart=e.onStart),e.onEnd&&(i.onEnd=e.onEnd),e.onComplete&&(i.onComplete=e.onComplete),t?i.to=e.props:i.from=e.props,this._effects.push(i),this}_lastEndTime(){if(this._effects.length<1)return 0;const t=this._effects[this._effects.length-1];return t.delay+t.duration}_next(){const t=this._current??this._effects.shift();if(t){this._current=t;const e=t.onComplete;t.onComplete=()=>{this._current=void 0,e&&e.call(t,t.target),this._next()}}else this.stop(),this._resolve&&this._resolve(),this._onAllComplete&&this._onAllComplete(),this.destroy()}play(){return this._destroyed||this._isPlaying?Promise.resolve():new Promise(t=>{this._currentTime=0,this._paused=!1,this._resolve=t,this._isPlaying=!0,this._next(),this._update(),E.system.onFrame(this._update,this)})}_update(t){var e;this._currentTime+=t??E.system.delta,(e=this._current)==null||e.update(this._currentTime)}pause(){return this._isPlaying&&!this._paused&&(this._paused=!0,E.system.clearTimer(this._update,this)),this}resume(){return this._isPlaying&&this._paused&&(this._paused=!1,E.system.onFrame(this._update,this)),this}stop(){return this._isPlaying&&(this._isPlaying=!1,this._paused=!1,E.system.clearTimer(this._update,this)),this}destroy(){if(this._destroyed)return;this._destroyed=!0,this.stop(),this._effects.length=0,this._current=void 0,this._resolve=void 0,this._onAllComplete=void 0;const t=B._list.indexOf(this);t!==-1&&B._list.splice(t,1)}onAllComplete(t){return this._onAllComplete=t,this}};n(Ee,"_list",[]);let ss=Ee;class Ni{constructor(){n(this,"_music",{})}play(t,e=!0,i=1,r=!1){let a=this._music[t];return a&&!a.destroyed?(a.setLoop(e),a.setVolume(i)):(a=new Yt(t,e,i),this._music[t]=a),a.onEnd=r?o=>this.destroy(o):void 0,a.play(),a}pause(t){var e;(e=this._music[t])==null||e.pause()}pauseAll(){for(const t of Object.values(this._music))t.pause()}resume(t){var e;(e=this._music[t])==null||e.resume()}resumeAll(){for(const t of Object.values(this._music))t.resume()}stop(t){var e;(e=this._music[t])==null||e.stop()}stopAll(){for(const t of Object.values(this._music))t.stop()}setVolume(t,e){var i;(i=this._music[t])==null||i.setVolume(e)}setVolumeAll(t){for(const e of Object.values(this._music))e.setVolume(t)}fadeIn(t,e=1){var i;(i=this._music[t])==null||i.fadeIn(e)}fadeInAll(t=1){for(const e of Object.values(this._music))e.fadeIn(t)}fadeOut(t,e=1){var i;(i=this._music[t])==null||i.fadeOut(e)}fadeOutAll(t=1){for(const e of Object.values(this._music))e.fadeOut(t)}setLoop(t,e){var i;(i=this._music[t])==null||i.setLoop(e)}setLoopAll(t){for(const e of Object.values(this._music))e.setLoop(t)}setPlaybackRate(t,e){var i;(i=this._music[t])==null||i.setPlaybackRate(e)}setPlaybackRateAll(t){for(const e of Object.values(this._music))e.setPlaybackRate(t)}destroy(t){var e;(e=this._music[t])==null||e.destroy(),delete this._music[t]}destroyAll(){for(const t of Object.values(this._music))t.destroy();this._music={}}}class Gi{constructor(){n(this,"_sounds",[])}play(t,e=1,i=!1){let r=this._sounds.find(a=>a.url===t&&!a.isPlaying);r?r.setVolume(e):(r=new Yt(t,!1,e),this._sounds.push(r)),r.onEnd=i?a=>this.destroy(a):void 0,r.play()}stop(t){for(const e of this._sounds)e.url===t&&e.stop()}stopAll(){for(const t of this._sounds)t.stop()}destroy(t){for(const e of this._sounds)e.url===t&&e.destroy();this._sounds=this._sounds.filter(e=>!e.destroyed)}destroyAll(){for(const t of this._sounds)t.destroy();this._sounds=[]}}const rs=new Gi,as=new Ni;class Ui{constructor(t){n(this,"particleSystem"),n(this,"vertices"),n(this,"colors"),n(this,"uvs"),n(this,"indices"),n(this,"maxParticles",0),n(this,"activeParticleCount",0),n(this,"batch"),n(this,"textureId",-1),n(this,"vertexStart",0),n(this,"indexStart",0),n(this,"colorStart",0),n(this,"uvStart",0),this.particleSystem=t,this.vertices=new Float32Array(0),this.colors=new Float32Array(0),this.uvs=new Float32Array(0),this.indices=new Uint16Array(0)}ensureBufferCapacity(t){if(this.maxParticles>=t)return;this.maxParticles=t;const e=t*4,i=t*6;this.vertices=new Float32Array(e*2),this.colors=new Float32Array(e*1),this.uvs=new Float32Array(e*3),this.indices=new Uint16Array(i)}get vertexSize(){return this.activeParticleCount*4*2}get indexSize(){return this.activeParticleCount*6}get colorSize(){return this.activeParticleCount*4*1}get uvSize(){return this.activeParticleCount*4*3}updateParticles(t){const e=t.filter(l=>l.isAlive);if(this.activeParticleCount=e.length,this.activeParticleCount===0)return;const i=this.particleSystem.config;this.ensureBufferCapacity(i.maxParticles);let r=0,a=0,o=0,h=0;for(let l=0;l<this.activeParticleCount;l++){const c=e[l],d=c.size/2,u=Math.cos(c.rotation),p=Math.sin(c.rotation),f=[{x:-d,y:-d},{x:d,y:-d},{x:d,y:d},{x:-d,y:d}];for(let S=0;S<4;S++){const M=f[S],D=M.x*u-M.y*p,Q=M.x*p+M.y*u;this.vertices[r++]=c.x+D,this.vertices[r++]=c.y+Q}const m=Math.max(0,Math.min(255,Math.round(c.r*255))),g=Math.max(0,Math.min(255,Math.round(c.g*255))),y=Math.max(0,Math.min(255,Math.round(c.b*255))),x=Math.max(0,Math.min(255,Math.round(c.a*255)))<<24|y<<16|g<<8|m;for(let S=0;S<4;S++){const M=new ArrayBuffer(4),D=new Uint32Array(M),Q=new Float32Array(M);D[0]=x,this.colors[a++]=Q[0]}const P=[{u:0,v:0},{u:1,v:0},{u:1,v:1},{u:0,v:1}];for(let S=0;S<4;S++)this.uvs[o++]=P[S].u,this.uvs[o++]=P[S].v,this.uvs[o++]=this.textureId;const b=l*4;this.indices[h++]=b+0,this.indices[h++]=b+1,this.indices[h++]=b+2,this.indices[h++]=b+0,this.indices[h++]=b+2,this.indices[h++]=b+3}}updateTexture(t){t?this.batch?this.textureId=this.batch.getTextureId(t)??this.batch.add(t):this.textureId=0:this.textureId=-1}packVertex(t){const e=this.activeParticleCount*4*2;if(e>0){const i=this.vertices.subarray(0,e);if(this.vertexStart+e>t.f32Data.length){console.error("顶点缓冲区越界:",{vertexStart:this.vertexStart,actualVertexCount:e,bufferSize:t.f32Data.length,requiredSize:this.vertexStart+e,activeParticles:this.activeParticleCount,maxParticles:this.maxParticles});return}t.f32Data.set(i,this.vertexStart)}}packIndex(t){const e=this.activeParticleCount*6;if(e>0){const i=this.indices.subarray(0,e);if(this.indexStart+e>t.data.length){console.error("索引缓冲区越界:",{indexStart:this.indexStart,actualIndexCount:e,bufferSize:t.data.length,requiredSize:this.indexStart+e,activeParticles:this.activeParticleCount});return}const r=this.vertexStart/2;for(let a=0;a<i.length;a++)t.data[this.indexStart+a]=i[a]+r}}packColor(t){const e=this.activeParticleCount*4;if(e>0){const i=this.colors.subarray(0,e);if(this.colorStart+e>t.u32Data.length){console.error("颜色缓冲区越界:",{colorStart:this.colorStart,actualColorCount:e,bufferSize:t.u32Data.length,requiredSize:this.colorStart+e,activeParticles:this.activeParticleCount});return}const r=new ArrayBuffer(i.length*4),a=new Float32Array(r),o=new Uint32Array(r);a.set(i);for(let h=0;h<i.length;h++)t.u32Data[this.colorStart+h]=o[h]}}packUV(t){const e=this.activeParticleCount*4*3;if(e>0){const i=this.uvs.subarray(0,e);if(this.uvStart+e>t.f32Data.length){console.error("UV缓冲区越界:",{uvStart:this.uvStart,actualUVCount:e,bufferSize:t.f32Data.length,requiredSize:this.uvStart+e,activeParticles:this.activeParticleCount});return}const{f32Data:r,u32Data:a}=t,o=a;for(let h=0;h<i.length;h+=3){const l=this.uvStart+h;r[l]=i[h],r[l+1]=i[h+1],o[l+2]=i[h+2]}}}getVertices(){return this.vertices}getColors(){return this.colors}getUVs(){return this.uvs}getIndices(){return this.indices}getActiveParticleCount(){return this.activeParticleCount}}var it=(s=>(s[s.GRAVITY=0]="GRAVITY",s[s.RADIUS=1]="RADIUS",s))(it||{});const Lt={emitterMode:0,positionType:0,maxParticles:300,duration:-1,emissionRate:30,particleLifespan:1,particleLifespanVariance:0,sourcePositionX:0,sourcePositionY:0,sourcePositionVarianceX:0,sourcePositionVarianceY:0,startParticleSize:32,startParticleSizeVariance:0,finishParticleSize:32,finishParticleSizeVariance:0,rotationStart:0,rotationStartVariance:0,rotationEnd:0,rotationEndVariance:0,startColorRed:1,startColorGreen:1,startColorBlue:1,startColorAlpha:1,startColorVarianceRed:0,startColorVarianceGreen:0,startColorVarianceBlue:0,startColorVarianceAlpha:0,finishColorRed:1,finishColorGreen:1,finishColorBlue:1,finishColorAlpha:0,finishColorVarianceRed:0,finishColorVarianceGreen:0,finishColorVarianceBlue:0,finishColorVarianceAlpha:0,gravityX:0,gravityY:0,speed:100,speedVariance:30,radialAcceleration:0,radialAccelVariance:0,tangentialAcceleration:0,tangentialAccelVariance:0,angle:0,angleVariance:360,rotationIsDir:!1,maxRadius:0,maxRadiusVariance:0,minRadius:0,rotatePerSecond:0,rotatePerSecondVariance:0,blendFuncSource:770,blendFuncDestination:771};class ae{constructor(){n(this,"x",0),n(this,"y",0),n(this,"vx",0),n(this,"vy",0),n(this,"gx",0),n(this,"gy",0),n(this,"radialAccel",0),n(this,"tangentialAccel",0),n(this,"rotation",0),n(this,"rotationDelta",0),n(this,"size",0),n(this,"sizeDelta",0),n(this,"r",1),n(this,"g",1),n(this,"b",1),n(this,"a",1),n(this,"dr",0),n(this,"dg",0),n(this,"db",0),n(this,"da",0),n(this,"timeToLive",0),n(this,"totalTimeToLive",0),n(this,"angle",0),n(this,"angleDelta",0),n(this,"radius",0),n(this,"radiusDelta",0)}reset(){this.x=this.y=0,this.vx=this.vy=0,this.gx=this.gy=0,this.radialAccel=this.tangentialAccel=0,this.rotation=this.rotationDelta=0,this.size=this.sizeDelta=0,this.r=this.g=this.b=this.a=1,this.dr=this.dg=this.db=this.da=0,this.timeToLive=this.totalTimeToLive=0,this.angle=this.angleDelta=0,this.radius=this.radiusDelta=0}get lifePercent(){return this.totalTimeToLive>0?1-this.timeToLive/this.totalTimeToLive:0}get isAlive(){return this.timeToLive>0}get position(){return{x:this.x,y:this.y}}set position(t){this.x=t.x,this.y=t.y}get velocity(){return{x:this.vx,y:this.vy}}set velocity(t){this.vx=t.x,this.vy=t.y}get gravity(){return{x:this.gx,y:this.gy}}set gravity(t){this.gx=t.x,this.gy=t.y}get radialAcceleration(){return this.radialAccel}set radialAcceleration(t){this.radialAccel=t}get tangentialAcceleration(){return this.tangentialAccel}set tangentialAcceleration(t){this.tangentialAccel=t}get color(){return{r:this.r,g:this.g,b:this.b,a:this.a}}set color(t){this.r=t.r,this.g=t.g,this.b=t.b,this.a=t.a}get colorDelta(){return{r:this.dr,g:this.dg,b:this.db,a:this.da}}set colorDelta(t){this.dr=t.r,this.dg=t.g,this.db=t.b,this.da=t.a}}class Wi{constructor(t){n(this,"config"),n(this,"particlePool",[]),n(this,"poolIndex",0),n(this,"position",{x:0,y:0}),n(this,"elapsed",0),n(this,"emitCounter",0),n(this,"isEmitting",!1),n(this,"randomValues",new Float32Array(100)),n(this,"randomIndex",0),this.config=t,this.initParticlePool()}initParticlePool(){this.particlePool=[];for(let t=0;t<this.config.maxParticles;t++)this.particlePool.push(new ae)}updateConfig(t){if(this.config=t,this.particlePool.length<t.maxParticles){const e=t.maxParticles-this.particlePool.length;for(let i=0;i<e;i++)this.particlePool.push(new ae)}}start(){this.isEmitting=!0,this.elapsed=0,this.emitCounter=0}stop(){this.isEmitting=!1}reset(){this.elapsed=0,this.emitCounter=0,this.poolIndex=0;for(const t of this.particlePool)t.reset()}setPosition(t,e){this.position.x=t,this.position.y=e}update(t){const e=[];if(!this.isEmitting)return e;if(this.elapsed+=t,this.config.duration!==-1&&this.elapsed>=this.config.duration)return this.stop(),e;const i=1/this.config.emissionRate;for(this.emitCounter+=t;this.emitCounter>i;){const r=this.getNextParticle();r&&(this.initParticle(r),e.push(r)),this.emitCounter-=i}return e}getNextParticle(){const t=this.config.maxParticles;let e=this.poolIndex;for(let i=0;i<t;i++){const r=this.particlePool[e];if(!r.isAlive)return this.poolIndex=(e+1)%t,r;e=(e+1)%t}return null}getRandomMinus1To1(){if(this.randomIndex>=this.randomValues.length){for(let t=0;t<this.randomValues.length;t++)this.randomValues[t]=Math.random()*2-1;this.randomIndex=0}return this.randomValues[this.randomIndex++]}initParticle(t){const e=this.config;t.reset(),t.timeToLive=Math.max(0,e.particleLifespan+e.particleLifespanVariance*this.getRandomMinus1To1()),t.totalTimeToLive=t.timeToLive,t.x=this.position.x+e.sourcePositionVarianceX*this.getRandomMinus1To1(),t.y=this.position.y+e.sourcePositionVarianceY*this.getRandomMinus1To1();const i=Math.max(0,e.startParticleSize+e.startParticleSizeVariance*this.getRandomMinus1To1()),r=Math.max(0,e.finishParticleSize+e.finishParticleSizeVariance*this.getRandomMinus1To1());t.size=i,t.sizeDelta=(r-i)/t.timeToLive;const a={r:this.clamp(e.startColorRed+e.startColorVarianceRed*this.getRandomMinus1To1(),0,1),g:this.clamp(e.startColorGreen+e.startColorVarianceGreen*this.getRandomMinus1To1(),0,1),b:this.clamp(e.startColorBlue+e.startColorVarianceBlue*this.getRandomMinus1To1(),0,1),a:this.clamp(e.startColorAlpha+e.startColorVarianceAlpha*this.getRandomMinus1To1(),0,1)},o={r:this.clamp(e.finishColorRed+e.finishColorVarianceRed*this.getRandomMinus1To1(),0,1),g:this.clamp(e.finishColorGreen+e.finishColorVarianceGreen*this.getRandomMinus1To1(),0,1),b:this.clamp(e.finishColorBlue+e.finishColorVarianceBlue*this.getRandomMinus1To1(),0,1),a:this.clamp(e.finishColorAlpha+e.finishColorVarianceAlpha*this.getRandomMinus1To1(),0,1)};t.r=a.r,t.g=a.g,t.b=a.b,t.a=a.a,t.dr=(o.r-a.r)/t.timeToLive,t.dg=(o.g-a.g)/t.timeToLive,t.db=(o.b-a.b)/t.timeToLive,t.da=(o.a-a.a)/t.timeToLive;const h=e.rotationStart+e.rotationStartVariance*this.getRandomMinus1To1(),l=e.rotationEnd+e.rotationEndVariance*this.getRandomMinus1To1();t.rotation=h,t.rotationDelta=(l-h)/t.timeToLive,e.emitterMode===it.GRAVITY?this.initGravityParticle(t):this.initRadiusParticle(t)}initGravityParticle(t){const e=this.config;t.gx=e.gravityX,t.gy=e.gravityY;const i=(e.angle+e.angleVariance*this.getRandomMinus1To1())*(Math.PI/180),r=e.speed+e.speedVariance*this.getRandomMinus1To1();t.vx=Math.cos(i)*r,t.vy=Math.sin(i)*r,t.radialAccel=e.radialAcceleration+e.radialAccelVariance*this.getRandomMinus1To1(),t.tangentialAccel=e.tangentialAcceleration+e.tangentialAccelVariance*this.getRandomMinus1To1(),e.rotationIsDir&&(t.rotation=i)}initRadiusParticle(t){const e=this.config,i=Math.max(0,e.maxRadius+e.maxRadiusVariance*this.getRandomMinus1To1()),r=Math.max(0,e.minRadius);t.radius=i,t.radiusDelta=(r-i)/t.timeToLive;const a=e.angle+e.angleVariance*this.getRandomMinus1To1();t.angle=a*(Math.PI/180),t.angleDelta=(e.rotatePerSecond+e.rotatePerSecondVariance*this.getRandomMinus1To1())*(Math.PI/180),t.x=this.position.x+Math.cos(t.angle)*t.radius,t.y=this.position.y+Math.sin(t.angle)*t.radius}clamp(t,e,i){return Math.min(Math.max(t,e),i)}getActiveParticleCount(){let t=0;for(const e of this.particlePool)e.isAlive&&t++;return t}getActiveParticles(){return this.particlePool.filter(t=>t.isAlive)}}class ji{constructor(t){n(this,"config"),this.config=t}updateConfig(t){this.config=t}updateParticle(t,e,i){return t.timeToLive-=e,t.timeToLive<=0?!1:(this.updateColor(t,e),this.updateSize(t,e),this.updateRotation(t,e),this.config.emitterMode===it.GRAVITY?this.updateGravityParticle(t,e):this.updateRadiusParticle(t,e,i),!0)}updateParticles(t,e,i){let r=0;const a=this.config.gravityX,o=this.config.gravityY,h=this.config.emitterMode===it.GRAVITY,l=this.config.rotationIsDir||!1;for(let c=0;c<t.length;c++){const d=t[c];d.isAlive&&(d.timeToLive-=e,!(d.timeToLive<=0)&&(d.r=this.clampColor(d.r+d.dr*e),d.g=this.clampColor(d.g+d.dg*e),d.b=this.clampColor(d.b+d.db*e),d.a=this.clampColor(d.a+d.da*e),d.size=Math.max(0,d.size+d.sizeDelta*e),d.rotation+=d.rotationDelta*e,h?this.updateGravityParticleInline(d,e,a,o,l):this.updateRadiusParticleInline(d,e,i),r++))}return r}updateColor(t,e){t.r+=t.dr*e,t.g+=t.dg*e,t.b+=t.db*e,t.a+=t.da*e,t.r=this.clamp(t.r,0,1),t.g=this.clamp(t.g,0,1),t.b=this.clamp(t.b,0,1),t.a=this.clamp(t.a,0,1)}updateSize(t,e){t.size+=t.sizeDelta*e,t.size=Math.max(0,t.size)}updateRotation(t,e){t.rotation+=t.rotationDelta*e}updateGravityParticle(t,e){const i=t.x,r=t.y,a=Math.sqrt(i*i+r*r);let o=0,h=0;a>0&&(o=i/a,h=r/a);const l=-h,c=o;t.vx+=o*t.radialAccel*e,t.vy+=h*t.radialAccel*e,t.vx+=l*t.tangentialAccel*e,t.vy+=c*t.tangentialAccel*e,t.vx+=t.gx*e,t.vy+=t.gy*e,t.x+=t.vx*e,t.y+=t.vy*e,this.config.rotationIsDir&&(t.rotation=Math.atan2(t.vy,t.vx))}updateRadiusParticle(t,e,i){t.angle+=t.angleDelta*e,t.radius+=t.radiusDelta*e,t.radius=Math.max(0,t.radius),t.x=i.x+Math.cos(t.angle)*t.radius,t.y=i.y+Math.sin(t.angle)*t.radius}clamp(t,e,i){return Math.min(Math.max(t,e),i)}interpolateColor(t){const e=t.lifePercent,i={r:this.config.startColorRed,g:this.config.startColorGreen,b:this.config.startColorBlue,a:this.config.startColorAlpha},r={r:this.config.finishColorRed,g:this.config.finishColorGreen,b:this.config.finishColorBlue,a:this.config.finishColorAlpha};return{r:this.lerp(i.r,r.r,e),g:this.lerp(i.g,r.g,e),b:this.lerp(i.b,r.b,e),a:this.lerp(i.a,r.a,e)}}interpolateSize(t){const e=t.lifePercent;return this.lerp(this.config.startParticleSize,this.config.finishParticleSize,e)}lerp(t,e,i){return t+(e-t)*i}updateGravityParticleInline(t,e,i,r,a){const o=t.x,h=t.y,l=Math.sqrt(o*o+h*h);if(l>0){const c=1/l,d=o*c,u=h*c,p=-u,f=d;t.vx+=(d*t.radialAccel+p*t.tangentialAccel)*e,t.vy+=(u*t.radialAccel+f*t.tangentialAccel)*e}t.vx+=i*e,t.vy+=r*e,t.x+=t.vx*e,t.y+=t.vy*e,a&&(t.rotation=Math.atan2(t.vy,t.vx))}updateRadiusParticleInline(t,e,i){t.angle+=t.angleDelta*e,t.radius=Math.max(0,t.radius+t.radiusDelta*e);const r=Math.cos(t.angle),a=Math.sin(t.angle);t.x=i.x+r*t.radius,t.y=i.y+a*t.radius}clampColor(t){return t<0?0:t>1?1:t}}var Vt;(s=>{function t(o){const h=new DOMParser().parseFromString(o,"text/xml"),l=h.querySelector("parsererror");if(l)throw new Error(`plist解析错误: ${l.textContent}`);const c=h.querySelector("plist > dict");if(!c)throw new Error("无效的plist格式：未找到根字典");const d={...Lt};return e(c,d),d}s.parseParticleConfig=t;function e(o,h){var l;const c=o.children;for(let d=0;d<c.length;d+=2){const u=c[d],p=c[d+1];if(!u||!p||u.tagName!=="key")continue;const f=(l=u.textContent)==null?void 0:l.trim();if(!f)continue;const m=i(p);a(h,f,m)}}function i(o){var h;const l=o.tagName.toLowerCase(),c=((h=o.textContent)==null?void 0:h.trim())||"";switch(l){case"real":case"integer":return Number(c);case"string":return c;case"true":return!0;case"false":return!1;case"dict":{const d={};return e(o,d),d}case"array":return r(o);default:return c}}function r(o){const h=[],l=o.children;for(let c=0;c<l.length;c++)h.push(i(l[c]));return h}function a(o,h,l){const c={emitterType:"emitterMode",positionType:"positionType",maxParticles:"maxParticles",duration:"duration",emissionRate:"emissionRate",particleLifespan:"particleLifespan",particleLifespanVariance:"particleLifespanVariance",sourcePositionx:"sourcePositionX",sourcePositiony:"sourcePositionY",sourcePositionVariancex:"sourcePositionVarianceX",sourcePositionVariancey:"sourcePositionVarianceY",startParticleSize:"startParticleSize",startParticleSizeVariance:"startParticleSizeVariance",finishParticleSize:"finishParticleSize",finishParticleSizeVariance:"finishParticleSizeVariance",rotationStart:"rotationStart",rotationStartVariance:"rotationStartVariance",rotationEnd:"rotationEnd",rotationEndVariance:"rotationEndVariance",startColorRed:"startColorRed",startColorGreen:"startColorGreen",startColorBlue:"startColorBlue",startColorAlpha:"startColorAlpha",startColorVarianceRed:"startColorVarianceRed",startColorVarianceGreen:"startColorVarianceGreen",startColorVarianceBlue:"startColorVarianceBlue",startColorVarianceAlpha:"startColorVarianceAlpha",finishColorRed:"finishColorRed",finishColorGreen:"finishColorGreen",finishColorBlue:"finishColorBlue",finishColorAlpha:"finishColorAlpha",finishColorVarianceRed:"finishColorVarianceRed",finishColorVarianceGreen:"finishColorVarianceGreen",finishColorVarianceBlue:"finishColorVarianceBlue",finishColorVarianceAlpha:"finishColorVarianceAlpha",gravityx:"gravityX",gravityy:"gravityY",speed:"speed",speedVariance:"speedVariance",radialAcceleration:"radialAcceleration",radialAccelVariance:"radialAccelVariance",tangentialAcceleration:"tangentialAcceleration",tangentialAccelVariance:"tangentialAccelVariance",angle:"angle",angleVariance:"angleVariance",rotationIsDir:"rotationIsDir",maxRadius:"maxRadius",maxRadiusVariance:"maxRadiusVariance",minRadius:"minRadius",rotatePerSecond:"rotatePerSecond",rotatePerSecondVariance:"rotatePerSecondVariance",textureFileName:"textureFileName",textureImageData:"textureImageData",blendFuncSource:"blendFuncSource",blendFuncDestination:"blendFuncDestination"}[h];c&&(c==="emitterMode"?o[c]=l===1?it.RADIUS:it.GRAVITY:c==="positionType"||c==="blendFuncSource"||c==="blendFuncDestination"?o[c]=l:c==="angle"||c==="angleVariance"?o[c]=l*Math.PI/180:o[c]=l)}})(Vt||(Vt={}));var Hi=(s,t,e,i)=>{for(var r=t,a=s.length-1,o;a>=0;a--)(o=s[a])&&(r=o(r)||r);return r};let oe=class extends O{constructor(s){super(),n(this,"renderObject",new Ui(this)),n(this,"emitter"),n(this,"updater"),n(this,"isPlaying",!1),n(this,"isPaused",!1),n(this,"autoPlay",!1);const t={...Lt,...s};this.pp.url=t.url||"",this.pp.texture=t.texture,this.pp.config=t.config||{...Lt},this.autoPlay=t.autoPlay??!1,this.emitter=new Wi(this.pp.config),this.updater=new ji(this.pp.config),t.tintColor&&(this.tintColor=t.tintColor),this.pp.texture||(this.pp.texture=k.WHITE),this.renderObject.updateTexture(this.pp.texture),this.markDirty(_.child|_.texture),t.url&&this.load(t.url).catch(console.error),t.onConfigLoaded&&this.on(v.loaded,t.onConfigLoaded),this.setProps(t),t.config&&this.autoPlay&&(this.stage?this.play():this.once(v.addedToStage,()=>{this.play()}))}get config(){return this.pp.config}set config(s){this.pp.config=s,this.emitter.updateConfig(s),this.updater.updateConfig(s),this.markDirty(_.child)}get url(){return this.pp.url}set url(s){this.pp.url!==s&&(this.pp.url=s,this.load(s).catch(console.error))}get texture(){return this.pp.texture||k.WHITE}set texture(s){this.pp.texture!==s&&(this.pp.texture=s,this.renderObject.updateTexture(s),this.markDirty(_.texture))}get particleCount(){return this.emitter.getActiveParticleCount()}async load(s){try{const t=await V.load(s);if(!t)throw new Error(`Failed to load plist content from: ${s}`);const e=Vt.parseParticleConfig(t);if(this.config=e,e.textureFileName&&this.pp.texture===k.WHITE){const i=this._resolveTextureUrl(s,e.textureFileName);try{const r=await V.load(i);this.texture=r}catch(r){console.warn("Failed to load particle texture:",r)}}this.emit(v.loaded),this.autoPlay&&this.play()}catch(t){throw console.error("Failed to load particle config:",t),t}}_resolveTextureUrl(s,t){return s.substring(0,s.lastIndexOf("/")+1)+t}play(){if(!this.stage){console.error("ParticleSystem: stage is undefined, cannot play");return}this.isPlaying=!0,this.isPaused=!1,this.emitter.start(),this.stage.timer.onFrame(this.onUpdate,this)}stop(){this.isPlaying=!1,this.emitter.stop()}pause(){this.isPaused=!0}resume(){this.isPaused=!1}reset(){this.emitter.reset(),this.isPlaying=!1,this.isPaused=!1}setEmissionRate(s){this.pp.config.emissionRate=s,this.emitter.updateConfig(this.pp.config)}setParticleLifespan(s,t=0){this.pp.config.particleLifespan=s,this.pp.config.particleLifespanVariance=t,this.emitter.updateConfig(this.pp.config)}setStartColor(s){this.pp.config.startColorRed=s.r,this.pp.config.startColorGreen=s.g,this.pp.config.startColorBlue=s.b,this.pp.config.startColorAlpha=s.a,this.emitter.updateConfig(this.pp.config)}setEndColor(s){this.pp.config.finishColorRed=s.r,this.pp.config.finishColorGreen=s.g,this.pp.config.finishColorBlue=s.b,this.pp.config.finishColorAlpha=s.a,this.emitter.updateConfig(this.pp.config)}setParticleSize(s,t=s){this.pp.config.startParticleSize=s,this.pp.config.finishParticleSize=t,this.emitter.updateConfig(this.pp.config)}setGravity(s,t){this.pp.config.gravityX=s,this.pp.config.gravityY=t,this.emitter.updateConfig(this.pp.config),this.updater.updateConfig(this.pp.config)}setAngle(s,t=0){this.pp.config.angle=s,this.pp.config.angleVariance=t,this.emitter.updateConfig(this.pp.config)}onUpdate(){var s;if(this.isPaused)return;const t=(s=this.stage)==null?void 0:s.timer.delta;this.emitter.setPosition(this.worldMatrix.tx,this.worldMatrix.ty),this.emitter.update(t);const e=this.emitter.getActiveParticles(),i=this.updater.updateParticles(e,t,{x:this.worldMatrix.tx,y:this.worldMatrix.ty});this.renderObject.updateParticles(e),this.markDirty(_.child),!this.isPlaying&&i===0&&this.emit("complete")}_customLocalBounds(s){const t=this.pp.config,e=Math.max(t.startParticleSize,t.finishParticleSize),i=t.sourcePositionVarianceX,r=t.sourcePositionVarianceY,a=e/2;s.addFrame(-i-a,-r-a,i*2+e,r*2+e)}destroy(){this.stop(),this.reset(),super.destroy()}};oe=Hi([N("ParticleSystem")],oe);function qi(s,t){if(!s.awaked)return s.joints.push(t),null;const{physics:e,body:i,target:r}=s,{pl:a,world:o,toPhPos:h,toPh:l}=e;switch(t.jointType){case"revolute":{const{localAnchorA:c,localAnchorB:d}=Z(s,t),u={bodyA:i,bodyB:t.targetBody.body,localAnchorA:c,localAnchorB:d,collideConnected:t.collideConnected,enableLimit:t.enableLimit,lowerAngle:t.lowerAngle,upperAngle:t.upperAngle,enableMotor:t.enableMotor,maxMotorTorque:t.maxMotorTorque,motorSpeed:t.motorSpeed};return o.createJoint(new a.RevoluteJoint(u))}case"distance":{const{localAnchorA:c,localAnchorB:d}=Z(s,t),u={bodyA:i,bodyB:t.targetBody.body,localAnchorA:c,localAnchorB:d,collideConnected:t.collideConnected,length:l(t.length??10),frequencyHz:t.frequency,dampingRatio:t.dampingRatio};return o.createJoint(new a.DistanceJoint(u))}case"fixed":{const{localAnchorA:c,localAnchorB:d}=Z(s,t),u={bodyA:i,bodyB:t.targetBody.body,localAnchorA:c,localAnchorB:d,collideConnected:t.collideConnected,frequencyHz:t.frequency,dampingRatio:t.dampingRatio};return o.createJoint(new a.WeldJoint(u))}case"prismatic":{const{localAnchorA:c,localAnchorB:d}=Z(s,t),u={bodyA:i,bodyB:t.targetBody.body,localAnchorA:c,localAnchorB:d,localAxisA:{x:-t.localAxis.x,y:-t.localAxis.y},collideConnected:t.collideConnected,enableLimit:t.enableLimit,lowerTranslation:t.lowerTranslation?l(t.lowerTranslation):void 0,upperTranslation:t.upperTranslation?l(t.upperTranslation):void 0,enableMotor:t.enableMotor,maxMotorForce:t.maxMotorForce,motorSpeed:t.motorSpeed};return o.createJoint(new a.PrismaticJoint(u))}case"wheel":{const{localAnchorA:c,localAnchorB:d}=Z(s,t),u={bodyA:i,bodyB:t.targetBody.body,localAnchorA:c,localAnchorB:d,localAxisA:{x:-t.localAxis.x,y:-t.localAxis.y},collideConnected:t.collideConnected,enableMotor:t.enableMotor,maxMotorTorque:t.maxMotorTorque,motorSpeed:t.motorSpeed?-t.motorSpeed:void 0,frequencyHz:t.frequency||2,dampingRatio:t.dampingRatio||.7};return o.createJoint(new a.WheelJoint(u))}case"rope":{const{localAnchorA:c,localAnchorB:d}=Z(s,t),u={bodyA:i,bodyB:t.targetBody.body,localAnchorA:c,localAnchorB:d,maxLength:l(t.maxLength),collideConnected:t.collideConnected};return o.createJoint(new a.RopeJoint(u))}case"motor":{const c={bodyA:i,bodyB:t.targetBody.body,collideConnected:t.collideConnected!==!1,linearOffset:t.linearOffset?h(t.linearOffset):void 0,angularOffset:t.angularOffset??0,maxForce:t.maxForce??1,maxTorque:t.maxTorque??1,correctionFactor:t.correctionFactor??.3};return o.createJoint(new a.MotorJoint(c))}case"pulley":{const c=t.targetBody.target,d={x:t.localAnchorA.x+r.pivot.x,y:t.localAnchorA.y+r.pivot.y},u={x:t.localAnchorB.x+c.pivot.x,y:t.localAnchorB.y+c.pivot.y},p=h(d),f=h(u),m=h(t.groundAnchorA),g=h(t.groundAnchorB),y={bodyA:i,bodyB:t.targetBody.body,localAnchorA:p,localAnchorB:f,groundAnchorA:m,groundAnchorB:g,lengthA:l(t.lengthA),lengthB:l(t.lengthB),ratio:t.ratio,collideConnected:t.collideConnected!==!1};return o.createJoint(new a.PulleyJoint(y))}}}function Z(s,t){if("localAnchor"in t){const{physics:e,target:i}=s,r={x:t.localAnchor.x+i.pivot.x,y:t.localAnchor.y+i.pivot.y},a=t.targetBody.target.worldToLocal(i.localToWorld(r)),o=e.toPhPos(r),h=e.toPhPos(a);return{localAnchorA:o,localAnchorB:h}}return{localAnchorA:{x:0,y:0},localAnchorB:{x:0,y:0}}}function ne(s,t){var e,i;if(!s.awaked){s.shapes.push(t);return}const{physics:r,body:a}=s,o={density:1,isSensor:s.isSensor,friction:s.friction,restitution:s.restitution,filterGroupIndex:0,filterCategoryBits:r.getCategoryBit(s.category),filterMaskBits:r.getCategoryMask(s.categoryAccepted),...t},h=s.target.getWorldRotatingRect(s.scene),l=r,{pl:c,toPh:d,toPhPos:u}=l;let p;const f=d(((e=t.offset)==null?void 0:e.x)??0),m=d(((i=t.offset)==null?void 0:i.y)??0);switch(t.shapeType){case"box":{const g=d(t.width??h.width)/2,y=d(t.height??h.height)/2;p=a.createFixture(new c.Box(g,y,{x:g+f,y:y+m}),o);break}case"circle":{const g=d(t.radius??h.height/2),y=f+g,x=m+g;p=a.createFixture(new c.Circle({x:y,y:x},g),o);break}case"chain":{const g=t.vertices.map(y=>u({x:y.x+f,y:y.y+m}));if(console.assert(g.length>=2,"Chain shape must have at least 2 vertices"),g.length<2)return;p=a.createFixture(new c.Chain(g,!1),o);break}case"polygon":{const g=t.vertices.map(y=>u({x:y.x+f,y:y.y+m}));if(console.assert(g.length>=3&&g.length<=8,"Polygon shape must have 3-8 vertices"),g.length<3||g.length>8)return;p=a.createFixture(new c.Polygon(g),o);break}}o.crossSide&&(p==null||p.setUserData({crossSide:o.crossSide}))}var Ki=(s,t,e,i)=>{for(var r=t,a=s.length-1,o;a>=0;a--)(o=s[a])&&(r=o(r)||r);return r};let he=class extends Ot{constructor(s){if(super(),n(this,"_tempPos2D",{x:0,y:0}),n(this,"_joints",[]),n(this,"physics",window.physics),n(this,"body"),n(this,"rigidType","static"),n(this,"shapes",[]),n(this,"joints",[]),n(this,"category",""),n(this,"isSensor",!1),n(this,"friction",.2),n(this,"restitution",0),n(this,"onCollisionStart"),n(this,"onCollisionEnd"),n(this,"_categoryAccepted"),!this.physics)throw new Error("physics not init, please enable the physics system in app.init");this.body=this.physics.world.createBody({active:!1,type:"kinematic",fixedRotation:!0}),s&&this.setProps(s)}get categoryAccepted(){return this._categoryAccepted}set categoryAccepted(s){typeof s=="string"?this._categoryAccepted=s.split(/[,，]/):this._categoryAccepted=s}get angularVelocity(){return this.body.getAngularVelocity()}set angularVelocity(s){this.body.setAngularVelocity(s)}get angularDamping(){return this.body.getAngularDamping()}set angularDamping(s){this.body.setAngularDamping(s)}get gravityScale(){return this.body.getGravityScale()}set gravityScale(s){this.body.setGravityScale(s)}get linearVelocity(){return this.body.getLinearVelocity()}set linearVelocity(s){this.body.setLinearVelocity(s)}get linearDamping(){return this.body.getLinearDamping()}set linearDamping(s){this.body.setLinearDamping(s)}get bullet(){return this.body.isBullet()}set bullet(s){this.body.setBullet(s)}get allowRotation(){return!this.body.isFixedRotation()}set allowRotation(s){this.body.setFixedRotation(!s)}get allowSleeping(){return this.body.isSleepingAllowed()}set allowSleeping(s){this.body.setSleepingAllowed(s)}get sleeping(){return!this.body.isAwake()}set sleeping(s){this.body.setAwake(!s)}get mass(){return this.body.getMass()}onAwake(){const s=this.body,t=this.target;if(this.rigidType==="dynamic"?s.setDynamic():this.rigidType==="static"&&s.setStatic(),this.shapes.length)for(const r of this.shapes)ne(this,r);else ne(this,{shapeType:"box"});const e=L.TEMP.set(0,0),i=t.localToWorld(e,e,this.scene);if(s.setPosition(this.physics.toPhPos(i)),s.setAngle(t.rotation),s.setActive(!0),s.setUserData(this),(this.onCollisionStart||this.onCollisionEnd)&&this._registerCollisionEvent(),this.joints.length)for(const r of this.joints){const a=qi(this,r);a==null||a.setUserData(r.label),a&&this._joints.push(a)}}_registerCollisionEvent(){this.onCollisionStart&&this.target.on(v.collisionStart,this.onCollisionStart,this),this.onCollisionEnd&&this.target.on(v.collisionEnd,this.onCollisionEnd,this)}onUpdate(){if(this.rigidType==="static")return;const s=this.target,t=this.body.getPosition();let e=this.physics.to2DPos(t,this._tempPos2D);if(!this.physics.inBoundaryArea(e)){this.target.destroy();return}if(this.target.parent!==this.scene&&(e=this.target.parent.worldToLocal(e,e,this.scene)),this.allowRotation){const h=this.body.getAngle();s.rotation=h%nt}const i=s.pivot.x*Math.abs(s.scale.x),r=s.pivot.y*Math.abs(s.scale.y);if(s.rotation===0){s.position.set(e.x+i,e.y+r);return}const a=Math.cos(s.rotation),o=Math.sin(s.rotation);s.position.set(e.x+(i*a-r*o),e.y+(i*o+r*a))}onEnable(){this.body.setActive(!0)}onDisable(){this.body.setActive(!1)}setPosition(s,t){let e={x:s,y:t};this.target.parent!==this.scene&&(e=this.target.parent.localToWorld(e,e,this.scene)),this.body.setPosition(this.physics.toPhPos(e)),this.rigidType!=="static"&&this.body.setAwake(!0)}getPosition(){const s=this.body.getPosition();return this.physics.to2DPos(s,s)}getRotation(){return this.body.getAngle()%nt}setRotation(s){this.body.setAngle(s),this.target.rotation=s,this.rigidType!=="static"&&this.body.setAwake(!0)}setLinearVelocity(s,t){this.body.setLinearVelocity({x:s??this.linearVelocity.x,y:t??this.linearVelocity.y})}applyLinearImpulse(s,t={x:0,y:0}){console.assert(this.rigidType==="dynamic","applyLinearImpulse only works on dynamic bodies"),this.body.applyLinearImpulse(s,t,!0)}applyForce(s,t={x:0,y:0}){console.assert(this.rigidType==="dynamic","applyForce only works on dynamic bodies"),this.body.applyForce(s,t,!0)}applyForceToCenter(s){console.assert(this.rigidType==="dynamic","applyForceToCenter only works on dynamic bodies"),this.body.applyForceToCenter(s,!0)}applyTorque(s){console.assert(this.rigidType==="dynamic"&&this.allowRotation,"applyTorque only works on dynamic bodies with allowRotation enabled"),this.body.applyTorque(s,!0)}applyAngularImpulse(s){console.assert(this.rigidType==="dynamic"&&this.allowRotation,"applyAngularImpulse only works on dynamic bodies with allowRotation enabled"),this.body.applyAngularImpulse(s,!0)}destroyJoint(s){const t=this._joints.find(e=>e.getUserData()===s);t&&(this.physics.world.destroyJoint(t),this._joints=this._joints.filter(e=>e!==t))}onDestroy(){for(const s of this._joints)this.physics.world.destroyJoint(s);this.physics.world.destroyBody(this.body)}};he=Ki([ui("RigidBody")],he);export{Bt as $,yt as C,Y as O,w as P,Qi as Q,Re as T,E as V,rs as Z,V as a,v as b,ss as c,oe as d,he as f,zt as g,Qt as i,Zi as j,k,ee as n,ie as o,Zt as s,as as t};
