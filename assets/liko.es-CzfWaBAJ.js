const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/liko.physics.es-DzdsK7A9.js","assets/index-Bu-paSGE.js"])))=>i.map(i=>d[i]);
import{_ as _e}from"./index-Bu-paSGE.js";var ve=Object.defineProperty,be=(i,t,e)=>t in i?ve(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e,n=(i,t,e)=>be(i,typeof t!="symbol"?t+"":t,e);const tt=Math.PI*2,we=180/Math.PI,Se=Math.PI/180;var g=(i=>(i[i.transform=1]="transform",i[i.size=2]="size",i[i.texture=4]="texture",i[i.color=8]="color",i[i.filter=16]="filter",i[i.child=32]="child",i[i.parent=64]="parent",i))(g||{}),_=(i=>(i.added="added",i.addToStage="addToStage",i.removed="removed",i.destroyed="destroyed",i.resize="resize",i.transform="transform",i.pointerdown="pointerdown",i.pointerup="pointerup",i.pointermove="pointermove",i.pointerover="pointerover",i.pointerout="pointerout",i.pointerupoutside="pointerupoutside",i.click="click",i.signal="signal",i.collisionStart="collisionStart",i.collisionEnd="collisionEnd",i.update="update",i.keydown="keydown",i.keyup="keyup",i.wheel="wheel",i.played="played",i.stopped="stopped",i.ended="ended",i.paused="paused",i.resumed="resumed",i.loaded="loaded",i.progress="progress",i.complete="complete",i.error="error",i))(_||{});const qt={},Kt={},Te={};function Pe(i,t){qt[i]=t}function Ce(i){const t=qt[i];if(t===void 0){console.error(`can not create script: ${i}`);return}return new t}function Ae(i,t){Kt[i]=t}function Jt(i){const t=Kt[i];if(t===void 0){console.error(`can not create node: ${i}`);return}return new t}function ke(i){const t=Te[i];if(t===void 0){console.error(`can not create filter: ${i}`);return}return new t}const K=i=>t=>(Ae(i,t),t),Be=i=>t=>(Pe(i,t),t);class Qt{constructor(t,e,s=!1){n(this,"_destroyed",!1),this.callback=t,this.caller=e,this.once=s}destroy(){this._destroyed||(this._destroyed=!0,this.callback=void 0,this.caller=void 0)}get destroyed(){return this._destroyed}run(t){this.callback&&(t!=null&&t.length?this.callback.call(this.caller,...t):this.callback.call(this.caller),this.once&&this.destroy())}}class et{constructor(){n(this,"_events",{})}on(t,e,s){this._addListener(t,e,s,!1)}once(t,e,s){this._addListener(t,e,s,!0)}_addListener(t,e,s,r){const o=this._events,a=t.toLowerCase();o[a]&&this.off(a,e,s);const h=new Qt(e,s||this,r);o[a]?o[a].push(h):o[a]=[h]}off(t,e,s){const r=this._events[t.toLowerCase()];if(!(!r||r.length===0)){if(e===void 0){r.length=0;return}for(let o=r.length-1;o>-1;o--){const a=r[o];a.callback===e&&(!s||a.caller===s)&&(r.splice(o,1),a.destroy())}}}offAll(t){if(!t)this._events={};else{const e=Object.values(this._events);for(const s of e)for(let r=s.length-1;r>-1;r--){const o=s[r];o.caller===t&&(s.splice(r,1),o.destroy())}}}emit(t,...e){const s=this._events[t.toLowerCase()];if(!(!s||s.length===0))for(let r=0,o=s.length;r<o;r++){const a=s[r];a&&(a.run(e),a.once&&s.splice(r,1))}}hasListener(t){const e=this._events[t.toLowerCase()];return!!e&&e.length!==0}destroy(){this.offAll()}}class Mt extends Qt{constructor(t,e,s=!1,r,o=0,a=!1){super(t,e,s),n(this,"nextTime",0),this.args=r,this.delay=o,this.useFrame=a}runTime(t){super.run(this.args),this.once||(this.nextTime=t+this.delay-(t-this.nextTime)%this.delay)}run(){super.run(this.args),this.once||(this.nextTime+=this.delay)}destroy(){this.destroyed||(this.nextTime=Number.POSITIVE_INFINITY,super.destroy())}}const lt=class L{constructor(){n(this,"_timers",[]),n(this,"_lastTime",0),n(this,"delta",0),n(this,"scale",1),n(this,"currentTime",0),n(this,"currentFrame",0),n(this,"_paused",!1),n(this,"_destroyed",!1)}static callLater(t,e,...s){for(const o of L._callLaterList)if(o.callback===t&&o.caller===e)return!1;const r=new Mt(t,e,!0,s);return L._callLaterList.push(r),!0}static runAllCallLater(){if(L._callLaterList.length>0){for(let t=0;t<L._callLaterList.length;t++)L._callLaterList[t].run();L._callLaterList.length=0}}get paused(){return this._paused}get count(){let t=0;for(const e of this._timers)!e.destroyed&&t++;return t}get destroyed(){return this._destroyed}destroy(){this._destroyed||(this._destroyed=!0,this.clearAll())}setTimeout(t,e,s,...r){this._add(t,e,s,r,!1,!0)}setInterval(t,e,s,...r){this._add(t,e,s,r,!1,!1)}onFrame(t,e,...s){this._add(1,t,e,s,!0,!1)}_add(t,e,s,r,o,a){if(this._destroyed)return;let h=t;a||(o&&t<1&&(h=1),!o&&t<.001&&(h=.001)),this.clearTimer(e,s);const l=new Mt(e,s,a,r,h,o);l.nextTime=(o?this.currentFrame:this.currentTime)+h,this._timers.push(l)}clearTimer(t,e){for(const s of this._timers)if(s.callback===t&&(!e||s.caller===e)){s.destroy();return}}clearAll(t){const e=this._timers;for(const s of e)(!t||s.caller===t)&&s.destroy();t||(e.length=0)}pause(){this._paused=!0}resume(){this._paused=!1}update(t=L.system.currentTime){if(this._paused||this._destroyed){this.delta=0;return}if(t>this._lastTime){const e=t-this._lastTime;this._lastTime=t,this.delta=e*this.scale,this.currentTime+=this.delta,this.currentFrame++;const s=this._timers;for(const r of s){const o=r.useFrame?this.currentFrame:this.currentTime;o>=r.nextTime&&r.runTime(o)}this.currentFrame%2e3===0&&this._clean()}else this.delta=0}_clean(){this._timers.length>0&&(this._timers=this._timers.filter(t=>!t.destroyed))}};n(lt,"system",new lt),n(lt,"_callLaterList",[]);let I=lt,mt=0;function Ie(){return mt++}function H(i=""){return mt++,`${i}${mt}${Math.random().toString(36).substring(2,9)}`}const At=document.createElement("canvas");At.width=1;At.height=1;const kt=At.getContext("2d");function Ts(i,t){return new Promise(e=>{const s=new Image;s.src=i,s.crossOrigin="anonymous",s.onload=()=>{e(kt.createPattern(s,t))}})}function Ps(i,t){const e=kt.createLinearGradient(i.startX,i.startY,i.endX,i.endY);for(const s of t)e.addColorStop(s.offset,s.color);return e}function Cs(i,t){const e=kt.createRadialGradient(i.startX,i.startY,i.startRadius,i.endX,i.endY,i.endRadius);for(const s of t)e.addColorStop(s.offset,s.color);return e}function Me(i){const t=i.split("/");return t.pop(),`${t.join("/")}/`}function Zt(i){const t=JSON.stringify(i);return JSON.parse(t)}function De(i){const t=Ce(i.props.script);return t&&(t.id=i.id,t.setProps(i.props)),t}class Ee{constructor(t){n(this,"_keydownHandler",this._onKeydown.bind(this)),n(this,"_keyupHandler",this._onKeyup.bind(this)),n(this,"_wheelHandler",this._onWheel.bind(this)),n(this,"_keyMap",{}),this.stage=t,globalThis.addEventListener("keydown",this._keydownHandler,{capture:!0,passive:!0}),globalThis.addEventListener("keyup",this._keyupHandler,{capture:!0,passive:!0}),t.canvas.addEventListener("wheel",this._wheelHandler,{capture:!0,passive:!1})}destroy(){globalThis.removeEventListener("keydown",this._keydownHandler,!0),globalThis.removeEventListener("keyup",this._keyupHandler,!0),this.stage.canvas.removeEventListener("wheel",this._wheelHandler,!1)}_onKeydown(t){this._keyMap[t.key]=!0,this.stage.emit(_.keydown,t)}_onKeyup(t){this._keyMap[t.key]=!1,this.stage.emit(_.keyup,t)}_onWheel(t){t.preventDefault(),this.stage.emit(_.wheel,t)}hasKeydown(t){return this._keyMap[t]===!0}}class E{constructor(t){n(this,"propagationStopped",!1),n(this,"preventDefaulted",!1),n(this,"nativeEvent"),n(this,"target"),n(this,"currentTarget"),n(this,"pointer",{x:0,y:0}),n(this,"movement",{x:0,y:0}),n(this,"altKey",!1),n(this,"ctrlKey",!1),n(this,"shiftKey",!1),n(this,"detail",0),n(this,"button",0),n(this,"path",[]),this.type=t}preventDefault(){this.preventDefaulted=!0,this.nativeEvent.preventDefault()}stopPropagation(){this.propagationStopped=!0}cloneFrom(t){return this.type=t.type,this.nativeEvent=t.nativeEvent,this.target=t.target,this.currentTarget=t.currentTarget,this.pointer=t.pointer,this.movement=t.movement,this.altKey=t.altKey,this.ctrlKey=t.ctrlKey,this.shiftKey=t.shiftKey,this.detail=t.detail,this.button=t.button,this}clone(){return new E(this.type).cloneFrom(this)}}const ft={down:new E("pointerdown"),up:new E("pointerup"),move:new E("pointermove"),over:new E("pointerover"),out:new E("pointerout"),upOutside:new E("pointerupoutside"),click:new E("click")};class $e{constructor(t){n(this,"_downHandler",this._onPointerDown.bind(this)),n(this,"_moveHandler",this._onPointerMove.bind(this)),n(this,"_upHandler",this._onPointerUp.bind(this)),n(this,"_lastOver"),n(this,"_canvas"),this.root=t,this._canvas=t.canvas,this._canvas.addEventListener("pointerdown",this._downHandler,{capture:!0,passive:!0}),globalThis.addEventListener("pointermove",this._moveHandler,{capture:!0,passive:!0}),globalThis.addEventListener("pointerup",this._upHandler,{capture:!0,passive:!0})}destroy(){this._canvas.removeEventListener("pointerdown",this._downHandler,!0),globalThis.removeEventListener("pointermove",this._moveHandler,!0),globalThis.removeEventListener("pointerup",this._upHandler,!0),this._lastOver=void 0}_onPointerDown(t){const e=this._convertEvent(t,"down");this.hitTest(this.root,e.pointer,e.path),this._emitEvent(e)}_onPointerUp(t){const e=this._convertEvent(t,"up"),s=ft.down.path;if(t.target===this._canvas){if(this.hitTest(this.root,e.pointer,e.path),this._emitEvent(e),!e.preventDefaulted){const r=this._cloneEvent(e,"click"),o=r.path;for(const a of e.path)s.includes(a)&&o.push(a);this._emitEvent(r)}}else{const r=this._cloneEvent(e,"upOutside");r.path.push(...s),this._emitEvent(r)}}_onPointerMove(t){const e=this._convertEvent(t,"move");if(this.hitTest(this.root,e.pointer,e.path),e.path.length<1)return;this._emitEvent(e);const s=e.path[0],r=this._cloneEvent(e,"over"),o=this._cloneEvent(e,"out");this._lastOver!==s&&(this._lastOver&&(this._getPathByTarget(this._lastOver,o.path),this._emitEvent(o)),s!==this.root?(this._getPathByTarget(s,r.path),this._emitEvent(r),this._lastOver=s):this._lastOver=void 0)}_getPathByTarget(t,e){t.pointerEnabled&&e.push(t),t.parent&&this._getPathByTarget(t.parent,e)}_cloneEvent(t,e){const s=ft[e],r=s.type;return s.cloneFrom(t),s.type=r,s.propagationStopped=!1,s.preventDefaulted=!1,s.path.length=0,s}_convertEvent(t,e){const s=ft[e];return s.nativeEvent=t,s.pointer=this._convertPoint(t.clientX,t.clientY,s.pointer),s.movement.x=t.movementX,s.movement.y=t.movementY,s.altKey=t.altKey,s.ctrlKey=t.ctrlKey,s.shiftKey=t.shiftKey,s.detail=t.detail,s.button=t.button,s.propagationStopped=!1,s.preventDefaulted=!1,s.path.length=0,s}_convertPoint(t,e,s){const r=this._canvas,o=r.isConnected?r.getBoundingClientRect():{width:r.width,height:r.height,left:0,top:0};return s.x=(t-o.left)*(r.width/o.width)/$.pixelRatio,s.y=(e-o.top)*(r.height/o.height)/$.pixelRatio,s}hitTest(t,e,s){if(!t.pointerEnabled&&!t.pointerEnabledForChildren||!t.visible)return s;if(t.pointerEnabledForChildren&&t.children.length)for(let r=t.children.length-1;r>-1;r--){const o=t.children[r],a=this.hitTest(o,e,s);if(a.length)return t.pointerEnabled&&a.push(t),a}return t.pointerEnabled&&t.hitTest(e)&&s.push(t),s}_emitEvent(t){if(t.path.length){t.target=t.path[0];for(const e of t.path)t.propagationStopped||(t.currentTarget=e,e.emit(t.type,t))}}}class Fe extends et{constructor(){super(...arguments),n(this,"_data",{})}fromJson(t){const e=Object.keys(t);for(const s of e){const r=t[s];typeof r!="object"?this._data[s]=r:this._data[s]=Zt(r)}}get(t){return this._data[t]}set(t,e){this._data[t]!==e&&(this._data[t]=e,this.emit("changed",t,e))}remove(t){delete this._data[t]}clear(){this._data={}}destroy(){super.destroy(),this.clear()}}const gt=class te{constructor(t=0,e=0){n(this,"x",0),n(this,"y",0),this.x=t,this.y=e}set(t=0,e=t){return this.x=t,this.y=e,this}reset(){this.x=0,this.y=0}equals(t){return t.x===this.x&&t.y===this.y}radian(t){return Math.atan2(t.y-this.y,t.x-this.x)}distance(t){const e=this.x-t.x,s=this.y-t.y;return Math.sqrt(e*e+s*s)}add(t,e){return this.x+=t,this.y+=e,this}normalize(){const t=Math.sqrt(this.x*this.x+this.y*this.y);return t!==0&&(this.x=this.x/t,this.y=this.y/t),this}copyFrom(t){return this.set(t.x,t.y),this}clone(){return new te(this.x,this.y)}};n(gt,"TEMP",new gt);let B=gt;class M{constructor(t=1,e=0,s=0,r=1,o=0,a=0){n(this,"a",1),n(this,"b",0),n(this,"c",0),n(this,"d",1),n(this,"tx",0),n(this,"ty",0),this.set(t,e,s,r,o,a)}static get IDENTITY(){return Oe.identity()}static get TEMP(){return Le.identity()}get isIdentity(){return this.a===1&&this.b===0&&this.c===0&&this.d===1&&this.tx===0&&this.ty===0}set(t,e,s,r,o,a){return this.a=t,this.b=e,this.c=s,this.d=r,this.tx=o,this.ty=a,this}apply(t,e){const s=e||new B,r=t.x,o=t.y;return s.x=this.a*r+this.c*o+this.tx,s.y=this.b*r+this.d*o+this.ty,s}applyInverse(t,e){const s=e||new B,{a:r,b:o,c:a,d:h,tx:l,ty:u}=this,{x:f,y:c}=t,d=1/(r*h+a*-o);return s.x=h*d*f+-a*d*c+(u*a-l*h)*d,s.y=r*d*c+-o*d*f+(-u*r+l*o)*d,s}translate(t,e){return this.tx+=t,this.ty+=e,this}scale(t,e){return this.a*=t,this.d*=e,this.c*=t,this.b*=e,this.tx*=t,this.ty*=e,this}rotate(t){const e=Math.cos(t),s=Math.sin(t),r=this.a,o=this.c,a=this.tx;return this.a=r*e-this.b*s,this.b=r*s+this.b*e,this.c=o*e-this.d*s,this.d=o*s+this.d*e,this.tx=a*e-this.ty*s,this.ty=a*s+this.ty*e,this}append(t){const e=this.a,s=this.b,r=this.c,o=this.d;return this.a=t.a*e+t.b*r,this.b=t.a*s+t.b*o,this.c=t.c*e+t.d*r,this.d=t.c*s+t.d*o,this.tx=t.tx*e+t.ty*r+this.tx,this.ty=t.tx*s+t.ty*o+this.ty,this}prepend(t){const e=this.tx;if(t.a!==1||t.b!==0||t.c!==0||t.d!==1){const s=this.a,r=this.c;this.a=s*t.a+this.b*t.c,this.b=s*t.b+this.b*t.d,this.c=r*t.a+this.d*t.c,this.d=r*t.b+this.d*t.d}return this.tx=e*t.a+this.ty*t.c+t.tx,this.ty=e*t.b+this.ty*t.d+t.ty,this}decompose(t){const{a:e,b:s,c:r,d:o}=this,a=-Math.atan2(-r,o),h=Math.atan2(s,e),l=Math.abs(a+h);let u=0;l<1e-5||Math.abs(tt-l)<1e-5?u=Math.abs(h)<1e-5?0:h:u=0;const f={x:1,y:1};f.x=Math.sqrt(e*e+s*s),f.y=Math.sqrt(r*r+o*o);const c={x:0,y:0},d=t.pivot;return c.x=this.tx+(d.x*e+d.y*r),c.y=this.ty+(d.x*s+d.y*o),{pos:c,scale:f,rotation:u}}invert(){const t=this.a,e=this.b,s=this.c,r=this.d,o=this.tx,a=t*r-e*s;return this.a=r/a,this.b=-e/a,this.c=-s/a,this.d=t/a,this.tx=(s*this.ty-r*o)/a,this.ty=-(t*this.ty-e*o)/a,this}identity(){return this.set(1,0,0,1,0,0),this}copyFrom(t){return this.set(t.a,t.b,t.c,t.d,t.tx,t.ty),this}clone(){return new M(this.a,this.b,this.c,this.d,this.tx,this.ty)}}const Le=new M,Oe=new M,rt=[new B,new B,new B,new B],xt=class ee{constructor(t=0,e=0,s=0,r=0){n(this,"x",0),n(this,"y",0),n(this,"width",0),n(this,"height",0),this.set(t,e,s,r)}get left(){return this.x}get right(){return this.x+this.width}get top(){return this.y}get bottom(){return this.y+this.height}set(t,e,s,r){return this.x=t,this.y=e,this.width=s,this.height=r,this}reset(){return this.set(0,0,0,0),this}copyFrom(t){return this.set(t.x,t.y,t.width,t.height),this}copyFromBounds(t){return this.set(t.minX,t.minY,t.width,t.height),this}equals(t){return t.x===this.x&&t.y===this.y&&t.width===this.width&&t.height===this.height}fit(t){const e=Math.min(this.x,t.x),s=Math.max(this.x+this.width,t.x+t.width),r=Math.min(this.y,t.y),o=Math.max(this.y+this.height,t.y+t.height);return this.x=e,this.width=s-e,this.y=r,this.height=o-r,this}pad(t=0,e=t){return this.x-=t,this.y-=e,this.width+=t*2,this.height+=e*2,this}contains(t,e){return t>=this.x&&t<this.x+this.width&&e>=this.y&&e<this.y+this.height}strokeContains(t,e,s){const{width:r,height:o}=this;if(r<=0||o<=0)return!1;const a=this.x,h=this.y,l=a-s/2,u=a+r+s/2,f=h-s/2,c=h+o+s/2,d=a+s/2,p=a+r-s/2,x=h+s/2,y=h+o-s/2;return t>=l&&t<=u&&e>=f&&e<=c&&!(t>d&&t<p&&e>x&&e<y)}intersects(t,e){if(!e){const ge=this.x<t.x?t.x:this.x;if((this.right>t.right?t.right:this.right)<=ge)return!1;const xe=this.y<t.y?t.y:this.y;return(this.bottom>t.bottom?t.bottom:this.bottom)>xe}const s=this.left,r=this.right,o=this.top,a=this.bottom;if(r<=s||a<=o)return!1;const h=rt[0].set(t.left,t.top),l=rt[1].set(t.left,t.bottom),u=rt[2].set(t.right,t.top),f=rt[3].set(t.right,t.bottom);if(u.x<=h.x||l.y<=h.y)return!1;const c=Math.sign(e.a*e.d-e.b*e.c);if(c===0||(e.apply(h,h),e.apply(l,l),e.apply(u,u),e.apply(f,f),Math.max(h.x,l.x,u.x,f.x)<=s||Math.min(h.x,l.x,u.x,f.x)>=r||Math.max(h.y,l.y,u.y,f.y)<=o||Math.min(h.y,l.y,u.y,f.y)>=a))return!1;const d=c*(l.y-h.y),p=c*(h.x-l.x),x=d*s+p*o,y=d*r+p*o,m=d*s+p*a,v=d*r+p*a;if(Math.max(x,y,m,v)<=d*h.x+p*h.y||Math.min(x,y,m,v)>=d*f.x+p*f.y)return!1;const T=c*(h.y-u.y),P=c*(u.x-h.x),A=T*s+P*o,z=T*r+P*o,N=T*s+P*a,It=T*r+P*a;return!(Math.max(A,z,N,It)<=T*h.x+P*h.y||Math.min(A,z,N,It)>=T*f.x+P*f.y)}clone(){return new ee(this.x,this.y,this.width,this.height)}};n(xt,"TEMP",new xt);let se=xt;const Re=new M;class st{constructor(t=Number.POSITIVE_INFINITY,e=Number.POSITIVE_INFINITY,s=Number.NEGATIVE_INFINITY,r=Number.NEGATIVE_INFINITY){n(this,"minX",Number.POSITIVE_INFINITY),n(this,"minY",Number.POSITIVE_INFINITY),n(this,"maxX",Number.NEGATIVE_INFINITY),n(this,"maxY",Number.NEGATIVE_INFINITY),n(this,"_rectangle"),this.set(t,e,s,r)}get x(){return this.minX}get y(){return this.minY}get width(){return this.maxX-this.minX}get height(){return this.maxY-this.minY}get left(){return this.minX}get right(){return this.maxX}get top(){return this.minY}get bottom(){return this.maxY}get isValid(){return this.minX+this.minY!==Number.POSITIVE_INFINITY}get isEmpty(){return this.minX>this.maxX||this.minY>this.maxY}get rectangle(){return this._rectangle??(this._rectangle=new se),this.isEmpty?this._rectangle.set(0,0,0,0):this._rectangle.copyFromBounds(this),this._rectangle}set(t,e,s,r){return this.minX=t,this.minY=e,this.maxX=s,this.maxY=r,this}reset(){return this.minX=Number.POSITIVE_INFINITY,this.minY=Number.POSITIVE_INFINITY,this.maxX=Number.NEGATIVE_INFINITY,this.maxY=Number.NEGATIVE_INFINITY,this}addFrame(t,e,s,r,o){const{a,b:h,c:l,d:u,tx:f,ty:c}=o??Re;let{minX:d,minY:p,maxX:x,maxY:y}=this,m=a*t+l*e+f,v=h*t+u*e+c;return m<d&&(d=m),v<p&&(p=v),m>x&&(x=m),v>y&&(y=v),m=a*s+l*e+f,v=h*s+u*e+c,m<d&&(d=m),v<p&&(p=v),m>x&&(x=m),v>y&&(y=v),m=a*t+l*r+f,v=h*t+u*r+c,m<d&&(d=m),v<p&&(p=v),m>x&&(x=m),v>y&&(y=v),m=a*s+l*r+f,v=h*s+u*r+c,m<d&&(d=m),v<p&&(p=v),m>x&&(x=m),v>y&&(y=v),this.minX=d,this.minY=p,this.maxX=x,this.maxY=y,this}addRect(t,e){return this.addFrame(t.x,t.y,t.x+t.width,t.y+t.height,e),this}addBounds(t,e){return this.addFrame(t.minX,t.minY,t.maxX,t.maxY,e),this}addBoundsMask(t){return this.minX=this.minX>t.minX?this.minX:t.minX,this.minY=this.minY>t.minY?this.minY:t.minY,this.maxX=this.maxX<t.maxX?this.maxX:t.maxX,this.maxY=this.maxY<t.maxY?this.maxY:t.maxY,this}applyMatrix(t){const{minX:e,minY:s,maxX:r,maxY:o}=this,{a,b:h,c:l,d:u,tx:f,ty:c}=t;let d=a*e+l*s+f,p=h*e+u*s+c;return this.minX=d,this.minY=p,this.maxX=d,this.maxY=p,d=a*r+l*s+f,p=h*r+u*s+c,this.minX=d<this.minX?d:this.minX,this.minY=p<this.minY?p:this.minY,this.maxX=d>this.maxX?d:this.maxX,this.maxY=p>this.maxY?p:this.maxY,d=a*e+l*o+f,p=h*e+u*o+c,this.minX=d<this.minX?d:this.minX,this.minY=p<this.minY?p:this.minY,this.maxX=d>this.maxX?d:this.maxX,this.maxY=p>this.maxY?p:this.maxY,d=a*r+l*o+f,p=h*r+u*o+c,this.minX=d<this.minX?d:this.minX,this.minY=p<this.minY?p:this.minY,this.maxX=d>this.maxX?d:this.maxX,this.maxY=p>this.maxY?p:this.maxY,this}fit(t){return this.minX<t.left&&(this.minX=t.left),this.maxX>t.right&&(this.maxX=t.right),this.minY<t.top&&(this.minY=t.top),this.maxY>t.bottom&&(this.maxY=t.bottom),this}pad(t,e=t){return this.minX-=t,this.maxX+=t,this.minY-=e,this.maxY+=e,this}ceil(){return this.minX=Math.floor(this.minX),this.minY=Math.floor(this.minY),this.maxX=Math.ceil(this.maxX),this.maxY=Math.ceil(this.maxY),this}scale(t,e=t){return this.minX*=t,this.minY*=e,this.maxX*=t,this.maxY*=e,this}contains(t,e){return this.minX<=t&&this.minY<=e&&this.maxX>=t&&this.maxY>=e}clone(){return new st(this.minX,this.minY,this.maxX,this.maxY)}}class q{constructor(t,e=0,s=0){n(this,"_observer"),n(this,"_x",0),n(this,"_y",0),this._x=e,this._y=s,this._observer=t}get x(){return this._x}set x(t){this._x!==t&&(this._x=t,this._observer.markDirty(g.transform))}get y(){return this._y}set y(t){this._y!==t&&(this._y=t,this._observer.markDirty(g.transform))}set(t=0,e=t){return(this._x!==t||this._y!==e)&&(this._x=t,this._y=e,this._observer.markDirty(g.transform)),this}add(t,e){return this._x+=t,this._y+=e,this._observer.markDirty(g.transform),this}equals(t){return t.x===this._x&&t.y===this._y}copyFrom(t){return(this._x!==t.x||this._y!==t.y)&&(this._x=t.x,this._y=t.y,this._observer.markDirty(g.transform)),this}clone(t){return new q(t??this._observer,this._x,this._y)}}const _t=class{constructor({observer:t}={}){n(this,"scale",new q(this,1,1)),n(this,"pivot",new q(this,0,0)),n(this,"_observer"),n(this,"_rotation",0),n(this,"_cx",1),n(this,"_sx",0),this._observer=t}get rotation(){return this._rotation}set rotation(t){this._rotation!==t&&(this._rotation=t,this._cx=Math.cos(t),this._sx=Math.sin(t),this.markDirty())}getMatrix(t,e){const s=t,{scale:r,pivot:o}=this;return s.a=this._cx*r._x,s.b=this._sx*r._x,s.c=-this._sx*r._y,s.d=this._cx*r._y,s.tx=e.x-(o._x*s.a+o._y*s.c),s.ty=e.y-(o._x*s.b+o._y*s.d),s}updateMatrix(t,e,s,r){const{_cx:o,_sx:a}=this,{_x:h,_y:l}=this.scale,{_x:u,_y:f}=this.pivot,c=o*h,d=a*h,p=-a*l,x=o*l,y=s.x-(u*c+f*p),m=s.y-(u*d+f*x);t.set(c,d,p,x,y,m);const{a:v,b:T,c:P,d:A}=r;e.a=c*v+d*P,e.b=c*T+d*A,e.c=p*v+x*P,e.d=p*T+x*A,e.tx=y*v+m*P+r.tx,e.ty=y*T+m*A+r.ty}markDirty(){var t;(t=this._observer)==null||t.markDirty(g.transform)}};n(_t,"TEMP",new _t);let ie=_t;const vt=class re{constructor(t=0,e=0,s=0,r=0,o=0){n(this,"x",0),n(this,"y",0),n(this,"width",0),n(this,"height",0),n(this,"rotation",0),this.set(t,e,s,r,o)}get left(){return this.x}get right(){return this.x+this.width}get top(){return this.y}get bottom(){return this.y+this.height}set(t,e,s,r,o){return this.x=t,this.y=e,this.width=s,this.height=r,this.rotation=o??0,this}reset(){return this.set(0,0,0,0,0),this}copyFrom(t){return this.set(t.x,t.y,t.width,t.height,t.rotation),this}clone(){return new re(this.x,this.y,this.width,this.height,this.rotation)}};n(vt,"TEMP",new vt);let ze=vt;const J=class{constructor(t){n(this,"_cache",new Map),n(this,"_Class"),this._Class=t}get(t){let e=this._cache.get(t);return e===void 0&&(e=new this._Class,this._cache.set(t,e)),e}has(t){return this._cache.has(t)}};n(J,"gloBounds",new J(st)),n(J,"rotatingRect",new J(ze));let Dt=J;const Ne=/^rgba\((\d+),\s*(\d+),\s*(\d+),\s*([\d.]+)\)$/i,Ye=/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/i,Ve=/^(#|0x)([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i,bt=class{constructor(t){n(this,"_color",new Float32Array([1,1,1,1])),n(this,"_value","#ffffff"),n(this,"argb",0),this.value=t??16777215}set value(t){this._value!==t&&(this._value=t,this._parseColor(t))}get value(){return this._value}_parseColor(t){let[e,s,r,o]=[0,0,0,1];switch(typeof t){case"number":{const h=t;e=h>>16&255,s=h>>8&255,r=h&255;break}case"string":{if(t.startsWith("rgba")){const h=t.match(Ne);h&&(e=Number(h[1]),s=Number(h[2]),r=Number(h[3]),o=Number(h[4]))}else if(t.startsWith("rgb")){const h=t.match(Ye);h&&(e=Number(h[1]),s=Number(h[2]),r=Number(h[3]))}else if(t.startsWith("#")||t.startsWith("0x")){const h=t.match(Ve);h&&(e=Number.parseInt(h[2],16),s=Number.parseInt(h[3],16),r=Number.parseInt(h[4],16))}break}}this._color[0]=e/255,this._color[1]=s/255,this._color[2]=r/255,this._color[3]=o;const a=Math.round(o*255);this.argb=a<<24|e<<16|s<<8|r}get red(){return this._color[0]}get green(){return this._color[1]}get blue(){return this._color[2]}get alpha(){return this._color[3]}toString(){const[t,e,s]=this._color.map(r=>r*255);return`rgba(${t},${e},${s},${this._color[3]})`}changeAlpha(t){this._color[3]=t;const e=Math.round(this._color[0]*255),s=Math.round(this._color[1]*255),r=Math.round(this._color[2]*255),o=Math.round(t*255);this.argb=o<<24|e<<16|s<<8|r}};n(bt,"Default",new bt(16777215));let O=bt;const Et={click:!0,pointerdown:!0,pointerup:!0,pointermove:!0,pointerover:!0,pointerout:!0,pointerupoutside:!0},$t=new ie,Ft={},Lt=[],Ot=[],Rt=[],Y=new et;class j{constructor(t){n(this,"pp",{id:"",userData:Ft,event:Y,children:Lt,filters:Ot,scripts:Rt,transform:$t,tintColor:O.Default,alpha:1,localMatrix:new M,worldMatrix:new M,pos:new q(this),anchor:new q(this),width:-1,height:-1,visible:!0,destroyed:!1,dirty:g.transform|g.size|g.texture|g.color,stage:void 0,parent:void 0,localBounds:new st}),n(this,"enabled",!0),n(this,"label",""),n(this,"cacheEnabled",!1),n(this,"pointerEnabled",!1),n(this,"pointerEnabledForChildren",!1),t&&this.setProps(t)}destroy(){var t,e,s;this.pp.destroyed||(this.pp.destroyed=!0,this.enabled=!1,this.offAll(),(t=this.scene)==null||t.offAll(this),(e=this.stage)==null||e.offAll(this),(s=this.stage)==null||s.timer.clearAll(this),this.removeSelf(),this.destroyScripts(),this.destroyFilters(),this.destroyChildren())}get destroyed(){return this.pp.destroyed}get stage(){return this.pp.stage}get scene(){var t;return(t=this.pp.parent)==null?void 0:t.scene}get parent(){return this.pp.parent}set parent(t){t?t.addChild(this):this.removeSelf()}get children(){return this.pp.children}get filters(){return this.pp.filters}get scripts(){return this.pp.scripts}set scripts(t){this.destroyScripts();for(const e of t)this.addScript(e)}get userData(){return this.pp.userData===Ft&&(this.pp.userData={}),this.pp.userData}set userData(t){this.pp.userData=t}get id(){return this.pp.id||(this.pp.id=H()),this.pp.id}set id(t){this.pp.id!==t&&(this.pp.id=t)}get visible(){return this.pp.visible&&this.enabled}set visible(t){this.pp.visible!==t&&(this.pp.visible=t,this.markDirty(g.child))}get width(){return this.pp.width>=0?this.pp.width:this.getLocalBounds().width}set width(t){const e=this.pp;e.width!==t&&(e.width=t,this.transform.pivot.x=t*e.anchor.x,this.emit(_.resize),this.markDirty(g.size))}get height(){return this.pp.height>=0?this.pp.height:this.getLocalBounds().height}set height(t){const e=this.pp;e.height!==t&&(e.height=t,this.transform.pivot.y=t*e.anchor.y,this.emit(_.resize),this.markDirty(g.size))}get pos(){return this.pp.pos}set pos(t){this.pp.pos.copyFrom(t)}get scale(){return this.transform.scale}set scale(t){this.transform.scale.copyFrom(t)}get rotation(){return this.transform.rotation}set rotation(t){this.transform.rotation=t}get angle(){return this.transform.rotation*we}set angle(t){this.transform.rotation=t*Se}get pivot(){return this.transform.pivot}get anchor(){return this.pp.anchor}set anchor(t){this.pp.anchor.copyFrom(t);const{pivot:e}=this.transform,{width:s,height:r}=this.getLocalBounds();e.x=s*t.x,e.y=r*t.y,this.markDirty(g.transform)}get tintColor(){return this.pp.tintColor.value}set tintColor(t){const e=this.pp;e.tintColor.value!==t&&(e.tintColor===O.Default&&(e.tintColor=new O(t)),e.tintColor.value=t,this.markDirty(g.color))}get alpha(){return this.pp.alpha}set alpha(t){this.pp.alpha!==t&&(this.pp.alpha=t,this.markDirty(g.color))}get worldAlpha(){return this.pp.tintColor.alpha}get transform(){return this.pp.transform===$t&&(this.pp.transform=new ie({observer:this})),this.pp.transform}get localMatrix(){const{dirty:t,transform:e,localMatrix:s,pos:r}=this.pp;return t&g.transform?e.getMatrix(s,r):s}set localMatrix(t){const{pos:e,scale:s,rotation:r}=t.decompose(this.pp.transform);this.pos=e,this.scale=s,this.rotation=r}get worldMatrix(){const{dirty:t,worldMatrix:e}=this.pp;return t&g.transform&&this._$getParentWorldMatrix(this,e.identity()).append(this.localMatrix),e}_$getParentWorldMatrix(t,e){const s=t.parent;return s&&(this._$getParentWorldMatrix(s,e),e.append(s.localMatrix)),e}markDirty(t){const e=this.pp;if((e.dirty&t)===0){if(e.dirty|=t,t===g.transform||t===g.color)e.children.length&&this._$dirtyChildren(t);else if(t===g.child)return this._$dirtyParent(t);this._$dirtyParent(g.parent)}}_$dirtyParent(t){let e=this.parent;for(;e&&(e.pp.dirty&t)===0;)e.pp.dirty|=t,e=e.parent}_$dirtyChildren(t){for(const e of this.children)(e.pp.dirty&t)===0&&(e.pp.dirty|=t,e.children.length&&e._$dirtyChildren(t))}addChild(t,e){const s=this.pp;return s.children===Lt&&(s.children=[]),t.removeSelf(),t.pp.parent=this,e!==void 0?s.children.splice(e,0,t):s.children.push(t),s.stage&&this._$addToStage(t,s.stage),t.emit(_.added,this),this.markDirty(g.child),t}_$addToStage(t,e){t.pp.stage=e,t.emit(_.addToStage,e);for(const s of t.children)this._$addToStage(s,e)}getIndexInParent(){return this.parent?this.parent.children.indexOf(this):-1}setChildIndex(t,e){const s=this.children;if(e<0||e>=s.length)throw new Error(`The index ${e} is out of bounds`);const r=t.getIndexInParent();s.splice(r,1),s.splice(e,0,t),this.markDirty(g.child)}findChild(t){const{id:e,label:s,Class:r,deep:o}=t,{children:a}=this.pp;for(let h=0,l=a.length;h<l;h++){const u=a[h];if(e&&u.id===e||s&&u.label===s||r&&u instanceof r)return u}if(o)for(let h=0,l=a.length;h<l;h++){const u=a[h].findChild(t);if(u)return u}}removeChild(t){if(t){const e=this.pp.children.indexOf(t);e!==-1&&(t.pp.parent=void 0,t.pp.stage=void 0,this.pp.children.splice(e,1),t.emit(_.removed,this),this.markDirty(g.child))}return t}removeSelf(){this.pp.parent&&this.pp.parent.removeChild(this)}removeChildren(){const{children:t}=this;if(t.length){for(const e of t)e.pp.parent=void 0,e.emit(_.removed,this);t.length=0,this.markDirty(g.child)}}destroyChildren(){const{children:t}=this;if(t.length){for(let e=t.length-1;e>-1;e--)t[e].destroy();t.length=0,this.markDirty(g.child)}}addFilter(t){return this.pp.filters===Ot&&(this.pp.filters=[]),this.pp.filters.push(t),this.markDirty(g.filter),t}updateFilter(t){return t._dirty=!0,this.markDirty(g.filter),t}findFilter(t){const{id:e,label:s,Class:r}=t,{filters:o}=this.pp;for(let a=0,h=o.length;a<h;a++){const l=o[a];if(e&&l.id===e||s&&l.label===s||r&&l instanceof r)return l}}removeFilter(t){if(t){const e=this.pp.filters.indexOf(t);e!==-1&&(this.pp.filters.splice(e,1),this.markDirty(g.filter))}return t}destroyFilters(){const{filters:t}=this;if(t.length){for(let e=t.length-1;e>-1;e--)t[e].destroy();t.length=0,this.markDirty(g.filter)}}addScript(t){const e=this.pp;return e.scripts===Rt&&(e.scripts=[]),e.scripts.push(t),t.target=this,t}findScript(t){const{id:e,label:s,Class:r}=t,{scripts:o}=this.pp;for(let a=0,h=o.length;a<h;a++){const l=o[a];if(e&&l.id===e||s&&l.label===s||r&&l instanceof r)return l}}destroyScripts(){const{scripts:t}=this.pp;for(let e=t.length-1;e>-1;e--)t[e].destroy();t.length=0}getWorldScale(t,e){const s=e??new B;s.x=this.scale.x,s.y=this.scale.y;let r=this.parent;for(;r&&(s.x*=r.scale.x,s.y*=r.scale.y,r!==t);)r=r.parent;return s}getWorldRotation(t){let e=this.rotation,s=this.parent;for(;s&&(e+=s.rotation,s!==t);)s=s.parent;return e}_customLocalBounds(t){}getLocalBounds(){const{dirty:t,width:e,height:s,localBounds:r}=this.pp;return(t&g.size)===0&&(t&g.child)===0?r:(r.reset(),e>=0&&s>=0?(r.addFrame(0,0,e,s),r):(this._customLocalBounds(r),(r.width<=0||r.height<=0||r.width===Number.POSITIVE_INFINITY||r.height===Number.POSITIVE_INFINITY)&&console.warn("localBounds width <=0",this),r))}getWorldBounds(t){const e=Dt.gloBounds.get(this);e.reset();const s=this.getLocalBounds();if(e.addFrame(s.x,s.y,s.right,s.bottom,this.worldMatrix),t&&t!==this.stage){const r=t.worldToLocal(e),o=t.getWorldScale();e.set(r.x,r.y,r.x+e.width/o.x,r.y+e.height/o.y)}return e}getWorldRotatingRect(t){const e=Dt.rotatingRect.get(this);this.localToWorld(B.TEMP.set(0,0),e);const s=this.getWorldScale(t,B.TEMP);return e.width=this.width*s.x,e.height=this.height*s.y,e.rotation=this.getWorldRotation(t),e}localToWorld(t,e,s){const r=this.worldMatrix.apply(t,e);return s&&s!==this.stage&&s.worldToLocal(r,r),r}worldToLocal(t,e,s){if(s&&s!==this.stage){const r=s.worldMatrix.apply(t,e);return this.worldMatrix.applyInverse(r,r)}return this.worldMatrix.applyInverse(t)}fromJson(t){this.pp.id=t.id,this.setProps(t.props);const{children:e}=t;if(e)for(const s of e){const r=s.props.editorOnly?void 0:Jt(s.type);r&&(this.addChild(r),r.fromJson(s))}this.setFilters(t.filters),this.setScripts(t.scripts)}setProps(t){if(t){const e=Object.keys(t);for(const s of e)if(s.startsWith("on")&&typeof t[s]=="function"){const r=s.charAt(2).toLowerCase()+s.slice(3);this.on(r,t[s],this)}else s in this&&(this[s]=t[s])}return this}setScripts(t){if(this.destroyScripts(),t)for(const e of t){const s=De(e);s&&(this.addScript(s),s.setProps(e.props))}}setFilters(t){if(this.destroyFilters(),t)for(const e of t){const s=ke(e.type);s&&(this.addFilter(s),s.setProps(e.props))}}hitTest(t){const e=this.worldToLocal(t,B.TEMP),{width:s,height:r}=this.pp;return s>=0&&r>=0?e.x>=0&&e.y>=0&&s>=e.x&&r>=e.y:this.getLocalBounds().contains(e.x,e.y)}on(t,e,s){this.pp.event===Y&&(this.pp.event=new et),Et[t]&&(!this.pointerEnabled||!this.pointerEnabledForChildren)&&(this.pointerEnabled=!0,this.pointerEnabledForChildren=!0,this._$pointerEnableParent()),this.pp.event.on(t,e,s)}_$pointerEnableParent(){let t=this.parent;for(;t&&!t.pointerEnabledForChildren;)t.pointerEnabledForChildren=!0,t=t.parent}once(t,e,s){this.pp.event===Y&&(this.pp.event=new et),Et[t]&&(this.pointerEnabled=!0,this.pointerEnabledForChildren=!0,this._$pointerEnableParent()),this.pp.event.once(t,e,s)}off(t,e,s){this.pp.event!==Y&&this.pp.event.off(t,e,s)}offAll(t){this.pp.event!==Y&&this.pp.event.offAll(t)}emit(t,...e){this.pp.event!==Y&&this.pp.event.emit(t,...e)}hasListener(t){return this.pp.event===Y?!1:this.pp.event.hasListener(t)}}function oe(i,t){const e=i.byteLength/8|0,s=new Float64Array(i,0,e);new Float64Array(t,0,e).set(s);const r=i.byteLength-e*8;if(r>0){const o=new Uint8Array(i,e*8,r);new Uint8Array(t,e*8,r).set(o)}return t}class Ue{constructor(t=4){n(this,"_array"),n(this,"_buffer"),n(this,"destroyed",!1),n(this,"loaded",!1),n(this,"data"),n(this,"size",0),this.size=t,this._array=new ArrayBuffer(t*4),this.data=new Uint32Array(this._array)}destroy(){var t;this.destroyed||(this.destroyed=!0,(t=this._buffer)==null||t.destroy())}fat(t){var e;let s=Math.max(t,this.size*1.5);s+=s%2,this.size=s;const r=oe(this._array,new ArrayBuffer(s*4));this.data=new Uint32Array(r),(e=this._buffer)==null||e.destroy(),this._buffer=void 0}get buffer(){return this._buffer||(this._buffer=S.createIndexBuffer("index",this.data)),this._buffer}upload(){this.loaded||(this.loaded=!0,S.uploadBuffer(this.buffer,this.data,!0))}reset(){this.loaded=!1}}class yt{constructor(t="vertex"){n(this,"_array"),n(this,"_buffer"),n(this,"f32Data"),n(this,"u32Data"),n(this,"size",0),n(this,"destroyed",!1),n(this,"loaded",!1),this.label=t,this.size=1,this._array=new ArrayBuffer(this.size*4),this.f32Data=new Float32Array(this._array),this.u32Data=new Uint32Array(this._array)}destroy(){var t;this.destroyed||(this.destroyed=!0,(t=this._buffer)==null||t.destroy())}fat(t){var e;this.size=t;const s=oe(this._array,new ArrayBuffer(t*4));this.f32Data=new Float32Array(s),this.u32Data=new Uint32Array(s),(e=this._buffer)==null||e.destroy(),this._buffer=void 0}get buffer(){return this._buffer||(this._buffer=S.createVertexBuffer(this.label,this.f32Data)),this._buffer}upload(){this.loaded||(this.loaded=!0,S.uploadBuffer(this.buffer,this.f32Data))}reset(){this.loaded=!1}}const ne=class Q{static get instance(){return Q._instance??(Q._instance=new Q),Q._instance}render(t,e){const s=t.pp.dirty;let r=e[0].renderNode(t);for(const o of e)s||o._dirty?(r=o.render(r),r.label=t.label):r=o.renderTarget;return r.pp.transform=t.transform,r.pos=t.pos,r.width=t.width,r.height=t.height,r}};n(ne,"_instance");let Xe=ne;const zt=new Map;function Ge(i){let t=zt.get(i);return t||(t=new ct,i.on(_.destroyed,()=>t==null?void 0:t.reset()),zt.set(i,t)),t}class ut{constructor(t){n(this,"vertexSize",4*2),n(this,"indexSize",6),n(this,"colorSize",4*1),n(this,"uvSize",4*3),n(this,"vertexStart",0),n(this,"indexStart",0),n(this,"colorStart",0),n(this,"uvStart",0),n(this,"batch"),n(this,"textureId",0),this.node=t}packVertex(t){const{node:e,vertexStart:s}=this,{f32Data:r}=t,{width:o,height:a,trim:h}=e.texture,{width:l,height:u}=e.getLocalBounds(),f=e.pp.worldMatrix,c=l/o,d=u/a,p=f.a*c,x=f.b*c,y=f.c*d,m=f.d*d,v=f.tx,T=f.ty,P=h.width,A=h.x,z=h.height,N=h.y;r[s]=p*A+y*N+v,r[s+1]=m*N+x*A+T,r[s+2]=p*P+y*N+v,r[s+3]=m*N+x*P+T,r[s+4]=p*P+y*z+v,r[s+5]=m*z+x*P+T,r[s+6]=p*A+y*z+v,r[s+7]=m*z+x*A+T}packIndex(t){const{indexStart:e}=this,{data:s}=t,r=e/this.indexSize*4;s[e]=r+0,s[e+1]=r+1,s[e+2]=r+2,s[e+3]=r+0,s[e+4]=r+2,s[e+5]=r+3}packColor(t){const{colorStart:e}=this,{node:s}=this,{u32Data:r}=t,o=s.pp.tintColor.argb;r[e]=o,r[e+1]=o,r[e+2]=o,r[e+3]=o}packUV(t){const{node:e,uvStart:s,textureId:r}=this,{f32Data:o,u32Data:a}=t,h=e.texture.uvs,l=a;o[s]=h.x0,o[s+1]=h.y0,l[s+2]=r,o[s+3]=h.x1,o[s+4]=h.y1,l[s+5]=r,o[s+6]=h.x2,o[s+7]=h.y2,l[s+8]=r,o[s+9]=h.x3,o[s+10]=h.y3,l[s+11]=r}}const V=[1,1,0,-1,-1,-1,0,1,1,1,0,-1,-1,-1,0,1],U=[0,1,1,1,0,-1,-1,-1,0,1,1,1,0,-1,-1,-1],X=[0,-1,-1,-1,0,1,1,1,0,1,1,1,0,-1,-1,-1],G=[1,1,0,-1,-1,-1,0,1,-1,-1,0,1,1,1,0,-1],wt=[],ae=[],ot=Math.sign;function je(){for(let i=0;i<16;i++){const t=[];wt.push(t);for(let e=0;e<16;e++){const s=ot(V[i]*V[e]+X[i]*U[e]),r=ot(U[i]*V[e]+G[i]*U[e]),o=ot(V[i]*X[e]+X[i]*G[e]),a=ot(U[i]*X[e]+G[i]*G[e]);for(let h=0;h<16;h++)if(V[h]===s&&U[h]===r&&X[h]===o&&G[h]===a){t.push(h);break}}}for(let i=0;i<16;i++){const t=new M;t.set(V[i],U[i],X[i],G[i],0,0),ae.push(t)}}je();const w={E:0,SE:1,S:2,SW:3,W:4,NW:5,N:6,NE:7,MIRROR_VERTICAL:8,MAIN_DIAGONAL:10,MIRROR_HORIZONTAL:12,REVERSE_DIAGONAL:14,uX:i=>V[i],uY:i=>U[i],vX:i=>X[i],vY:i=>G[i],inv:i=>i&8?i&15:-i&7,add:(i,t)=>wt[i][t],sub:(i,t)=>wt[i][w.inv(t)],rotate180:i=>i^4,isVertical:i=>(i&3)===2,byDirection:(i,t)=>Math.abs(i)*2<=Math.abs(t)?t>=0?w.S:w.N:Math.abs(t)*2<=Math.abs(i)?i>0?w.E:w.W:t>0?i>0?w.SE:w.SW:i>0?w.NE:w.NW,matrixAppendRotationInv:(i,t,e=0,s=0)=>{const r=ae[w.inv(t)];r.tx=e,r.ty=s,i.append(r)}};class F{constructor(){n(this,"uid",H()),n(this,"uvs",{x0:0,y0:0,x1:1,y1:0,x2:1,y2:1,x3:0,y3:1}),n(this,"url",""),n(this,"_buffer"),n(this,"_width",0),n(this,"_height",0),n(this,"_destroyed",!1),n(this,"_trimmed",!1),n(this,"_rotated",!1),n(this,"_trim",new se),n(this,"_sheet")}get width(){return this._width}get height(){return this._height}get trimmed(){return this._trimmed}get rotated(){return this._rotated}get sheet(){return this._sheet}get trim(){return this._trim}get destroyed(){return this._destroyed}get buffer(){return this._buffer}static async createFromUrl(t){return R.load(t,"image")}static createFormBuffer(t,e,s){return new F().setBuffer(t,e,s)}setBuffer(t,e,s){var r;return this._buffer!==t&&((r=this._buffer)==null||r.destroy(),this._buffer=t,this._sheet=s,this.url=e??""),s?(this._width=s.sourceSize.w,this._height=s.sourceSize.h,this._trimmed=s.trimmed,this._rotated=s.rotated,this._trim.set(s.spriteSourceSize.x,s.spriteSourceSize.y,s.spriteSourceSize.x+s.frame.w,s.spriteSourceSize.y+s.frame.h),this._updateUvs(s)):(this._width=t.width,this._height=t.height,this._trimmed=!1,this._rotated=!1,this._trim.set(0,0,t.width,t.height)),this}_updateUvs(t){const{uvs:e,_rotated:s}=this,{frame:r}=t,{width:o,height:a}=this.buffer,h=r.x/o,l=r.y/a,u=(s?r.h:r.w)/o,f=(s?r.w:r.h)/a;if(s){let c=2;const d=u/2,p=f/2,x=h+d,y=l+p;c=w.add(c,w.NW),e.x0=x+d*w.uX(c),e.y0=y+p*w.uY(c),c=w.add(c,2),e.x1=x+d*w.uX(c),e.y1=y+p*w.uY(c),c=w.add(c,2),e.x2=x+d*w.uX(c),e.y2=y+p*w.uY(c),c=w.add(c,2),e.x3=x+d*w.uX(c),e.y3=y+p*w.uY(c)}else e.x0=h,e.y0=l,e.x1=h+u,e.y1=l,e.x2=h+u,e.y2=l+f,e.x3=h,e.y3=l+f}destroy(){var t;this._destroyed||(this._destroyed=!0,(t=this._buffer)==null||t.destroy(),this._buffer=void 0)}}var We=(i,t,e,s)=>{for(var r=t,o=i.length-1,a;o>=0;o--)(a=i[o])&&(r=a(r)||r);return r};let St=class extends j{constructor(i){super(),n(this,"renderObject",new ut(this)),this.pp.url="",i instanceof F?this.texture=i:this.setProps(i)}get texture(){return this.pp.texture}set texture(i){if(this.pp.texture!==i){this.pp.texture=i,this.emit(_.resize);const t=this.renderObject.batch,e=(t==null?void 0:t.getTextureId(i))??(t==null?void 0:t.add(this.texture));e&&e>-1?(this.renderObject.textureId=e,this.markDirty(g.texture)):this.markDirty(g.child)}}get url(){return this.pp.url}set url(i){this.load(i)}async load(i){const t=this.pp;if(t.url!==i){t.url=i;const e=await R.load(i);if(this.destroyed||!e)return;this.texture=e,t.width===-1&&(this.width=e.width),t.height===-1&&(this.height=e.height),this.markDirty(g.size)}this.emit(_.loaded)}_customLocalBounds(i){const t=this.pp.texture;t&&i.addFrame(0,0,t.width,t.height)}};St=We([K("Sprite")],St);class he{constructor(t,e){n(this,"uid",H("RenderTargetBuffer")),n(this,"loaded",!0),n(this,"width",0),n(this,"height",0),n(this,"texture"),n(this,"sampler"),n(this,"view"),n(this,"destroyed",!1),this.width=t,this.height=e,this.texture=S.createTexture("renderTarget",t,e),this.sampler=S.defaultSampler,this.view=this.texture.createView()}destroy(){this.destroyed||(this.destroyed=!0,this.texture.destroy())}upload(){}dirty(){}}class He extends St{constructor(){super(),n(this,"buffer"),this.texture=new F}destroy(){var t;(t=this.buffer)==null||t.destroy()}createTexture(t,e){var s;return(!this.buffer||this.width!==t||this.height!==e)&&((s=this.buffer)==null||s.destroy(),this.width=t,this.height=e,this.buffer=new he(t,e),this.texture.setBuffer(this.buffer)),this.buffer.texture}}const qe=16,nt=new He;class Ke{constructor(){n(this,"_group"),n(this,"_binds",[]),n(this,"_cacheKey",""),n(this,"map",new Map),n(this,"buffers",[]),n(this,"count",0),nt.createTexture(1,1).createView();const t=nt.buffer.view,e=nt.buffer.sampler;for(let s=0;s<16;s++)this._binds.push({binding:s*2,visibility:GPUShaderStage.FRAGMENT,type:"TextureView",resource:t}),this._binds.push({binding:s*2+1,visibility:GPUShaderStage.FRAGMENT,type:"Sampler",resource:e})}get group(){const t=this._createTextureGroup(this.buffers);if(this._group!==t){this._group=t;for(let e=0,s=this.buffers.length;e<s;e++)this.buffers[e].upload()}return this._group}reset(){this.count=0,this.map.clear(),this.buffers.length=0}_createTextureGroup(t){const e=t.length,s=this._binds;let r="";for(let o=0;o<16;o++){const a=this._binds[o*2],h=this._binds[o*2+1];let l=nt.buffer;o<e&&(l=t[o],r+=l.uid),a.resource=l.view,h.resource=l.sampler}if(r!==this._cacheKey){this._cacheKey=r;const{group:o}=S.createGroup("texture",s);return o}return this._group}add(t){const e=this.map.get(t.uid);if(e!==void 0)return e;const s=this.count;return s<qe?(this.buffers.push(t),this.map.set(t.uid,s),this.count++,s):-1}getTextureId(t){return this.map.get(t.buffer.uid)}}const le=class Tt{constructor(t){n(this,"textureGroup",new Ke),n(this,"pipeline","batch"),n(this,"used",!0),n(this,"startIndex",0),n(this,"size",0),this.batchGroup=t}static create(t){const e=Tt._pool;for(let r=0,o=e.length;r<o;r++){const a=e[r];if(!a.used)return a.used=!0,a.batchGroup=t,a}const s=new Tt(t);return e.push(s),s}add(t){return this.textureGroup.add(t.buffer)}getTextureId(t){return this.textureGroup.getTextureId(t)}reset(){this.used=!1,this.startIndex=0,this.size=0,this.textureGroup.reset()}};n(le,"_pool",[]);let Je=le;class ct{constructor(){n(this,"camera"),n(this,"batches",[]),n(this,"nodes",[]),n(this,"posBuffer",new yt("pos")),n(this,"colorBuffer",new yt("color")),n(this,"uvBuffer",new yt("uv")),n(this,"indexBuffer",new Ue),n(this,"vertexSize",0),n(this,"colorSize",0),n(this,"uvSize",0),n(this,"indexSize",0),n(this,"spriteCount",0),n(this,"updateCount",0),n(this,"resetCount",0)}collect(t,e,s){return t.pp.dirty===0?this:(t.pp.dirty&g.child?(this.reset(),this.camera=s,this._collect(t,e,t.alpha),this.spriteCount>0&&(this._fat(),this._batch(),this._uploadBuffer())):this.update(),this)}update(){if(!(this.nodes.length<1||this.nodes[0].pp.dirty===0)){this._update(),this._uploadBuffer();for(const t of this.batches)t instanceof ct&&t.update()}}_update(){this.updateCount++;const t=this.nodes.length;let e=0;for(;e<t;){const s=this.nodes[e];e++;const{dirty:r,transform:o,localMatrix:a,worldMatrix:h,pos:l,parent:u,tintColor:f,alpha:c}=s.pp,d=r&g.transform,p=r&g.color;if(d&&o.updateMatrix(a,h,l,u.worldMatrix),p&&(f===O.Default&&(s.pp.tintColor=new O),s.pp.tintColor.changeAlpha(c*u.pp.tintColor.alpha)),"renderObject"in s&&s.texture){const x=s.renderObject;(d||r&g.size)&&(x.packVertex(this.posBuffer),this.posBuffer.loaded=!1),p&&(x.packColor(this.colorBuffer),this.colorBuffer.loaded=!1),r&g.texture&&(x.packUV(this.uvBuffer),this.uvBuffer.loaded=!1)}s.pp.dirty=0}}_collect(t,e,s){const{pp:r,children:o}=t,{visible:a,alpha:h,dirty:l,transform:u,localMatrix:f,pos:c}=r;if(!a||h<.001)return;l&g.transform&&u.updateMatrix(f,r.worldMatrix,c,e),l&g.color&&(r.tintColor===O.Default&&(r.tintColor=new O),r.tintColor.changeAlpha(h*s)),this.nodes.push(t),"texture"in t&&t.texture&&this._add(t);const d=o.length;if(d){let p=0;for(;p<d;)this._collectChild(o[p],r.worldMatrix,r.tintColor.alpha),p++}}_add(t){this.spriteCount++;const e=t.renderObject;e.vertexStart=this.vertexSize,e.colorStart=this.colorSize,e.uvStart=this.uvSize,e.indexStart=this.indexSize,this.vertexSize+=e.vertexSize,this.colorSize+=e.colorSize,this.uvSize+=e.uvSize,this.indexSize+=e.indexSize}_collectChild(t,e,s){const{filters:r}=t.pp;if(r.length){const o=Xe.instance.render(t,r);this._collect(o,e,s)}else if(t.cacheEnabled){const o=Ge(t);o.collect(t,e,this.camera),this.batches.push(o)}else this._collect(t,e,s)}_fat(){this.vertexSize>this.posBuffer.size&&this.posBuffer.fat(this.vertexSize),this.colorSize>this.colorBuffer.size&&this.colorBuffer.fat(this.colorSize),this.uvSize>this.uvBuffer.size&&this.uvBuffer.fat(this.uvSize),this.indexSize>this.indexBuffer.size&&this.indexBuffer.fat(this.indexSize)}_batch(){let t=this._createBatch();const e=this.nodes.length;let s=0;for(let r=0;r<e;r++){const o=this.nodes[r];if(!o.texture){o.pp.dirty=0;continue}const a=o.renderObject;let h=t.add(o.texture);h===-1&&(t.size=s-t.startIndex,t=this._createBatch(),t.startIndex=s,h=t.add(o.texture)),a.batch=t,a.textureId=h,a.packVertex(this.posBuffer),a.packColor(this.colorBuffer),a.packUV(this.uvBuffer),a.packIndex(this.indexBuffer),s+=a.indexSize,o.pp.dirty=0}t.size=s-t.startIndex}_createBatch(){const t=Je.create(this);return this.batches.push(t),t}_uploadBuffer(){this.posBuffer.upload(),this.colorBuffer.upload(),this.uvBuffer.upload(),this.indexBuffer.upload()}reset(){this.resetCount++;for(const t of this.batches)t.reset();this.batches.length=0,this.posBuffer.reset(),this.colorBuffer.reset(),this.uvBuffer.reset(),this.indexBuffer.reset(),this.vertexSize=0,this.colorSize=0,this.uvSize=0,this.indexSize=0,this.nodes.length=0,this.spriteCount=0}}const Qe=`struct VertexInput {
  @location(0) aPos: vec2<f32>,
  @location(1) aColor: vec4<f32>,
  @location(2) aUV: vec2<f32>,
  @location(3) aTextureId: u32,
};

struct VertexOutput {
  @builtin(position) vPos: vec4<f32>,
  @location(0) vUV: vec2<f32>,
  @location(1) vColor: vec4<f32>,
  @location(2) @interpolate(flat) vId: u32,
};

@group(0) @binding(0) var<uniform> uProjection: mat4x4<f32>;

@vertex
fn vert_main(input: VertexInput) -> VertexOutput {
    var output: VertexOutput;
    output.vPos = uProjection * vec4<f32>(input.aPos, 0.0, 1.0);
    output.vUV = input.aUV;
    output.vColor = input.aColor;
    output.vId = input.aTextureId;
    return output;
}

@group(1) @binding(0) var texture1: texture_2d<f32>;
@group(1) @binding(1) var sampler1: sampler;
@group(1) @binding(2) var texture2: texture_2d<f32>;
@group(1) @binding(3) var sampler2: sampler;
@group(1) @binding(4) var texture3: texture_2d<f32>;
@group(1) @binding(5) var sampler3: sampler;
@group(1) @binding(6) var texture4: texture_2d<f32>;
@group(1) @binding(7) var sampler4: sampler;
@group(1) @binding(8) var texture5: texture_2d<f32>;
@group(1) @binding(9) var sampler5: sampler;
@group(1) @binding(10) var texture6: texture_2d<f32>;
@group(1) @binding(11) var sampler6: sampler;
@group(1) @binding(12) var texture7: texture_2d<f32>;
@group(1) @binding(13) var sampler7: sampler;
@group(1) @binding(14) var texture8: texture_2d<f32>;
@group(1) @binding(15) var sampler8: sampler;
@group(1) @binding(16) var texture9: texture_2d<f32>;
@group(1) @binding(17) var sampler9: sampler;
@group(1) @binding(18) var texture10: texture_2d<f32>;
@group(1) @binding(19) var sampler10: sampler;
@group(1) @binding(20) var texture11: texture_2d<f32>;
@group(1) @binding(21) var sampler11: sampler;
@group(1) @binding(22) var texture12: texture_2d<f32>;
@group(1) @binding(23) var sampler12: sampler;
@group(1) @binding(24) var texture13: texture_2d<f32>;
@group(1) @binding(25) var sampler13: sampler;
@group(1) @binding(26) var texture14: texture_2d<f32>;
@group(1) @binding(27) var sampler14: sampler;
@group(1) @binding(28) var texture15: texture_2d<f32>;
@group(1) @binding(29) var sampler15: sampler;
@group(1) @binding(30) var texture16: texture_2d<f32>;
@group(1) @binding(31) var sampler16: sampler;

@fragment
fn frag_main(
    @location(0) vUV: vec2<f32>,
    @location(1) vColor: vec4<f32>,
    @location(2) @interpolate(flat) vId: u32,
) -> @location(0) vec4<f32> {
    var outColor: vec4<f32>;
    var uvDx = dpdx(vUV);
    var uvDy = dpdy(vUV);

    switch vId {
        case 0:{
            outColor = textureSampleGrad(texture1, sampler1, vUV, uvDx, uvDy);
            break;
        }
        case 1:{
            outColor = textureSampleGrad(texture2, sampler2, vUV, uvDx, uvDy);
            break;
        }
        case 2:{
            outColor = textureSampleGrad(texture3, sampler3, vUV, uvDx, uvDy);
            break;
        }
        case 3:{
            outColor = textureSampleGrad(texture4, sampler4, vUV, uvDx, uvDy);
            break;
        }
        case 4:{
            outColor = textureSampleGrad(texture5, sampler5, vUV, uvDx, uvDy);
            break;
        }
        case 5:{
            outColor = textureSampleGrad(texture6, sampler6, vUV, uvDx, uvDy);
            break;
        }
        case 6:{
            outColor = textureSampleGrad(texture7, sampler7, vUV, uvDx, uvDy);
            break;
        }
        case 7:{
            outColor = textureSampleGrad(texture8, sampler8, vUV, uvDx, uvDy);
            break;
        }
        case 8:{
            outColor = textureSampleGrad(texture9, sampler9, vUV, uvDx, uvDy);
            break;
        }
        case 9:{
            outColor = textureSampleGrad(texture10, sampler10, vUV, uvDx, uvDy);
            break;
        }
        case 10:{
            outColor = textureSampleGrad(texture11, sampler11, vUV, uvDx, uvDy);
            break;
        }
        case 11:{
            outColor = textureSampleGrad(texture12, sampler12, vUV, uvDx, uvDy);
            break;
        }
        case 12:{
            outColor = textureSampleGrad(texture13, sampler13, vUV, uvDx, uvDy);
            break;
        }
        case 13:{
            outColor = textureSampleGrad(texture14, sampler14, vUV, uvDx, uvDy);
            break;
        }
        case 14:{
            outColor = textureSampleGrad(texture15, sampler15, vUV, uvDx, uvDy);
            break;
        }
        default:{
            outColor = textureSampleGrad(texture16, sampler16, vUV, uvDx, uvDy);
            break;
        }
    }
    return outColor * vColor;
}`;class Ze{constructor(){n(this,"pipeline");const t=this.createCameraLayout(),e=this.createTexturesLayout();this.pipeline=this.createRenderPipeline([t,e],Qe)}createCameraLayout(){const t=[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{}}];return this.createLayout("camera",t)}createTexturesLayout(){const t=[];for(let e=0;e<32;e+=2)t.push({binding:e,visibility:GPUShaderStage.FRAGMENT,texture:{}}),t.push({binding:e+1,visibility:GPUShaderStage.FRAGMENT,sampler:{}});return this.createLayout("texture",t)}createRenderPipeline(t,e){const{device:s,format:r}=S;return s.createRenderPipeline({label:"spriteRenderPipe",layout:s.createPipelineLayout({bindGroupLayouts:t}),vertex:{module:s.createShaderModule({code:e}),entryPoint:"vert_main",buffers:[{arrayStride:2*4,stepMode:"vertex",attributes:[{shaderLocation:0,format:"float32x2",offset:0}]},{arrayStride:1*4,stepMode:"vertex",attributes:[{shaderLocation:1,format:"unorm8x4",offset:0}]},{arrayStride:3*4,stepMode:"vertex",attributes:[{shaderLocation:2,format:"float32x2",offset:0},{shaderLocation:3,format:"uint32",offset:2*4}]}]},fragment:{module:s.createShaderModule({code:e}),entryPoint:"frag_main",targets:[{format:r,blend:{alpha:{dstFactor:"one-minus-src-alpha",operation:"add",srcFactor:"src-alpha"},color:{dstFactor:"one-minus-src-alpha",operation:"add",srcFactor:"src-alpha"}}}]},primitive:{topology:"triangle-list"}})}createLayout(t,e){const{device:s}=S;return s.createBindGroupLayout({label:`${t}-layout`,entries:e})}render(t,e){const{posBuffer:s,colorBuffer:r,uvBuffer:o,indexBuffer:a,camera:h}=t.batchGroup;e.setPipeline(this.pipeline),e.setVertexBuffer(0,s.buffer),e.setVertexBuffer(1,r.buffer),e.setVertexBuffer(2,o.buffer),e.setIndexBuffer(a.buffer,"uint32"),e.setBindGroup(0,h.group),e.setBindGroup(1,t.textureGroup.group),e.drawIndexed(t.size,1,t.startIndex)}}const Pt=class D{constructor(t){n(this,"_color"),n(this,"batchGroup",new ct);const e=new O(t);this._color={r:e.red,g:e.green,b:e.blue,a:e.alpha},D.addPipeline("batch",new Ze)}static addPipeline(t,e){D._pipelines[t]=e}static getPipeline(t){return D._pipelines[t]}static get instance(){return D._instance??(D._instance=new D),D._instance}render(t,e,s,r){const{device:o}=S,a=this.batchGroup.collect(t,e,s);if(a.batches.length){const h=o.createCommandEncoder(),l=h.beginRenderPass({colorAttachments:[{view:r.createView(),clearValue:this._color,loadOp:"clear",storeOp:"store"}]});this.flush(a,l),l.end(),o.queue.submit([h.finish()])}}flush(t,e){const{batches:s}=t,r=s.length;for(let o=0;o<r;o++){const a=s[o];if("textureGroup"in a){const h=D.getPipeline(a.pipeline);console.assert(h!==void 0,`pipeline ${a.pipeline} is null`),h.render(a,e)}else this.flush(a,e)}}};n(Pt,"_pipelines",{}),n(Pt,"_instance");let ts=Pt;class es{constructor(){n(this,"debug",!1),n(this,"format"),n(this,"device"),n(this,"defaultSampler")}async init(t){const e=await navigator.gpu.requestAdapter();if(!e)throw new Error("Failed to initialize webgpu adapter");if(this.device=await(e==null?void 0:e.requestDevice()),!this.device)throw new Error("Failed to initialize webgpu device");this.format=navigator.gpu.getPreferredCanvasFormat();const s=t.canvas.getContext("webgpu");return s.configure({device:this.device,format:navigator.gpu.getPreferredCanvasFormat()}),this.defaultSampler=this.createSampler("default"),{context:s,gpuRender:new ts(t.bgColor)}}setViewport(t,e){this.debug&&console.log("setViewport",t,e)}createCanvas(t=100,e=100){const s=document.createElement("canvas");return s.width=t,s.height=e,s}createProjectionMatrixBuffer(t,e){const{device:s}=this,r=s.createBuffer({label:`${t}-buffer`,size:e.byteLength,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});s.queue.writeBuffer(r,0,e);const o=s.createBindGroupLayout({label:`${t}-layout`,entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{}}]}),a=s.createBindGroup({label:`${t}-group`,layout:o,entries:[{binding:0,resource:{buffer:r}}]});return this.debug&&console.log("createUniformGroup",t),{buffer:r,group:a}}createVertexBuffer(t,e){const{device:s}=this,r=s.createBuffer({label:`${t}-buffer`,size:e.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST});return this.debug&&console.log("createBuffer",t),r}createIndexBuffer(t,e){const{device:s}=this,r=s.createBuffer({label:`${t}-buffer`,size:e.byteLength,usage:GPUBufferUsage.INDEX|GPUBufferUsage.COPY_DST});return this.debug&&console.log("createBuffer",t),r}createUniformBuffer(t,e){const{device:s}=this,r=s.createBuffer({label:`${t}-buffer`,size:e.byteLength,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});return this.debug&&console.log("createBuffer",t),r}uploadUniform(t,e){this.device.queue.writeBuffer(t,0,e),this.debug&&console.log("uploadUniform",t.label)}uploadBuffer(t,e){this.device.queue.writeBuffer(t,0,e),this.debug&&console.log("uploadBuffer",t.label)}createGroup(t,e){const{device:s}=this,r=s.createBindGroupLayout({label:`${t}-layout`,entries:e.map(a=>{const{type:h}=a;return{binding:a.binding,visibility:a.visibility,buffer:h==="Buffer"?{}:void 0,sampler:h==="Sampler"?{}:void 0,texture:h==="TextureView"?{}:void 0}})}),o=s.createBindGroup({label:`${t}-group`,layout:r,entries:e.map(a=>{const{resource:h}=a;return{binding:a.binding,resource:a.type==="Buffer"?{buffer:h}:h}})});return this.debug&&console.log("createGroup",t),{layout:r,group:o}}createFilterPipeline(t,e,s){this.debug&&console.log("createFilterPipeline",t);const{device:r}=this;return r.createRenderPipeline({label:`${t}-renderPipe`,layout:r.createPipelineLayout({bindGroupLayouts:e}),vertex:{module:r.createShaderModule({code:s}),entryPoint:"vert_main",buffers:[{arrayStride:4*4,stepMode:"vertex",attributes:[{shaderLocation:0,format:"float32x2",offset:0},{shaderLocation:1,format:"float32x2",offset:2*4}]}]},fragment:{module:r.createShaderModule({code:s}),entryPoint:"frag_main",targets:[{format:this.format}]},primitive:{topology:"triangle-strip"}})}createTexture(t,e,s){return this.debug&&console.log("createTexture",t),this.device.createTexture({label:`${t}-texture`,format:this.format,size:[e,s],usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT})}createSampler(t,e="linear",s="linear"){return this.debug&&console.log("createSampler",t),this.device.createSampler({label:`${t}-sampler`,minFilter:e,magFilter:s})}uploadTexture(t,e){this.debug&&console.log("uploadTexture"),this.device.queue.copyExternalImageToTexture({source:t},{texture:e},[t.width,t.height])}}let S;function ss(){S=new es}class pt{constructor(t){n(this,"uid",H("TextureBuffer")),n(this,"width",0),n(this,"height",0),n(this,"bitmap"),n(this,"texture"),n(this,"sampler"),n(this,"view"),n(this,"destroyed",!1),n(this,"loaded",!1);const{width:e,height:s}=t;console.assert(e>=0&&s>=0),this.bitmap=t,this.width=e,this.height=s,this.texture=S.createTexture("texture",e,s),this.sampler=S.defaultSampler,this.view=this.texture.createView()}destroy(){this.destroyed||(this.destroyed=!0,this.texture.destroy())}upload(){this.loaded||(this.loaded=!0,S.uploadTexture(this.bitmap,this.texture))}dirty(){this.uid=H("TextureBuffer"),this.loaded=!1}}class is{constructor(){n(this,"map",{png:!0,jpg:!0,jpeg:!0,webp:!0,image:!0})}test(t){return!!this.map[t]}async load(t){try{const e=await(await fetch(t)).blob(),s=await createImageBitmap(e);return F.createFormBuffer(new pt(s),t)}catch(e){console.error(`Error loading image from ${t}:`,e);return}}}class rs{constructor(){n(this,"map",{json:!0,scene:!0})}test(t){return!!this.map[t]}async load(t){try{return await(await fetch(t)).json()}catch(e){console.error(`Error loading JSON from ${t}:`,e);return}}}const de=class Ct extends et{constructor(){super(...arguments),n(this,"_loadingMap",{}),n(this,"cacheMap",{}),n(this,"_total",0),n(this,"_loaded",0)}static regLoader(t){Ct._loaders.push(t)}get total(){return this._total}get loaded(){return this._loaded}get loadingCount(){return this._total-this._loaded}load(t,e){const s=this.get(t);if(s)return Promise.resolve(s);const r=this._loadingMap[t];if(r)return r;this._total++;const o=e??this._getTypeByExt(t),a=Ct._loaders.find(l=>l.test(o));if(!a)return this._error("no loader can load:",t),Promise.resolve(void 0);const h=new Promise(l=>{a.load(t,this).then(u=>{this._complete(t,u),l(u)}).catch(u=>{this._error(t,u.toString()),l(void 0)})});return this._loadingMap[t]=h,h}_getTypeByExt(t){let e=t.substring(t.lastIndexOf(".")+1);return e.indexOf("?")!==-1&&(e=e.substring(0,e.lastIndexOf("?"))),e.toLowerCase()}_complete(t,e){e!==void 0&&this.cache(t,e),delete this._loadingMap[t],this._loaded++;const s=this._total>0?this._loaded/this._total:1;this.emit(_.progress,s),this.emit(_.loaded,t,e),this._loaded>=this._total&&(this._total=this._loaded,this.emit(_.complete))}_error(t,e){-console.error("Failed to load url:",t,"Error:",e),delete this._loadingMap[t],this._loaded++,this.emit(_.error,t,e)}cache(t,e){e!==void 0&&(this.cacheMap[t]=e)}get(t){return this.cacheMap[t]}unload(t){const e=this.cacheMap[t];delete this.cacheMap[t],e&&(typeof e.destroy=="function"&&e.destroy(),typeof e.dispose=="function"&&e.dispose())}clear(){for(const t of Object.keys(this.cacheMap))this.unload(t);this._loadingMap={},this._total=0,this._loaded=0}resetCount(){this._total-=this._loaded,this._loaded=0}};n(de,"_loaders",[]);let it=de;class os{constructor(){n(this,"map",{atlas:!0,sheet:!0})}test(t){return!!this.map[t]}async load(t,e){try{const s=await(await fetch(t)).json(),r=Me(t),o=r+s.meta.image,a=await fetch(o),h=await createImageBitmap(await a.blob()),l=new pt(h),u=s.frames,f=Object.keys(u),c=f.length,d=[];for(let p=0;p<c;p++){const x=f[p],y=u[x],m=r+x,v=F.createFormBuffer(l,m,y);e.cache(m,v),d.push(v)}return d.sort((p,x)=>{const y=Nt(p.url),m=Nt(x.url);return y-m}),d}catch(s){console.error(`Error loading sheet from ${t}:`,s);return}}}function Nt(i){const t=i.match(/\d+/);return t?Number.parseInt(t[0]):0}const ue=class k{constructor(t,e=!1,s=1){n(this,"url"),n(this,"volume"),n(this,"loop"),n(this,"playbackRate",1),n(this,"isPlaying",!1),n(this,"destroyed",!1),n(this,"onEnd"),n(this,"_gainNode",k.audioContext.createGain()),n(this,"_source"),n(this,"_startTime",0),n(this,"_offset",0),n(this,"_audioPlaying",!1),n(this,"_playID",0),this.url=t,this.loop=e,this.volume=Math.max(0,Math.min(1,s)),this._gainNode.gain.value=s,this._gainNode.connect(k.audioContext.destination)}static async ensureAudioContext(){if(k.audioContext.state==="suspended")try{return await k.audioContext.resume(),!0}catch(t){return console.error("Failed to resume audio context:",t),!1}return!0}currentTime(){return!this.isPlaying||this.destroyed?this._offset:this._offset+(k.audioContext.currentTime-this._startTime)}duration(){const t=R.get(this.url);return t?t.duration:0}play(t=0){if(!(this.isPlaying||this.destroyed))return this.isPlaying=!0,this._playID=Ie(),this._offset=t,this._load(this._playID).then(e=>{e&&(this._source=e,this._audioPlaying=!0,this._source.start(0,this._offset),this._startTime=k.audioContext.currentTime)}),this}async _load(t){const e=await R.load(this.url);if(!e||this.destroyed||!this.isPlaying||this._playID!==t)return;const s=k.audioContext.createBufferSource();return s.buffer=e,s.playbackRate.value=this.playbackRate,s.loop=this.loop,s.connect(this._gainNode),s.onended=()=>{var r;this.loop||(this.stop(),(r=this.onEnd)==null||r.call(this,this.url))},s}pause(){return!this.isPlaying||this.destroyed?this._offset:(this.isPlaying=!1,this._offset+=k.audioContext.currentTime-this._startTime,this._source&&this._audioPlaying&&(this._source.stop(),this._source=void 0,this._audioPlaying=!1),this)}resume(){if(!(this.isPlaying||this.destroyed))return this.play(this._offset),this}stop(){if(!(!this.isPlaying||this.destroyed))return this.isPlaying=!1,this._offset=0,this._source&&this._audioPlaying&&(this._source.stop(),this._source=void 0,this._audioPlaying=!1),this}setLoop(t){if(!(this.loop===t||this.destroyed))return this.loop=t,this._source&&(this._source.loop=t),this}setVolume(t){if(this.volume===t||this.destroyed)return this.volume;const e=Math.max(0,Math.min(1,t));return this.volume=e,this._gainNode.gain.value=e,this}fadeIn(t=0){const e=this._gainNode.gain;if(t>0){const s=k.audioContext.currentTime;e.linearRampToValueAtTime(e.value,s+t),e.setValueAtTime(0,s)}return this}fadeOut(t=0){const e=this._gainNode.gain;if(t>0){const s=k.audioContext.currentTime;e.linearRampToValueAtTime(0,s+t),e.setValueAtTime(e.value,s)}return this}setPlaybackRate(t){if(this.playbackRate===t||this.destroyed)return this.playbackRate;const e=Math.max(.1,Math.min(10,t));return this.playbackRate=e,this._source&&(this._source.playbackRate.value=e),this}destroy(t=!0){this.destroyed||(this.destroyed=!0,this.stop(),this._source&&(this._source.disconnect(),this._source.onended=null,this._source=void 0),this._gainNode.disconnect(),t&&R.unload(this.url))}};n(ue,"audioContext",new(window.AudioContext||window.webkitAudioContext));let Bt=ue;class ns{constructor(){n(this,"map",{mp3:!0,sound:!0})}test(t){return!!this.map[t]}async load(t){try{const e=await(await fetch(t)).arrayBuffer();return await Bt.audioContext.decodeAudioData(e)}catch(e){console.error(`Error loading sound from ${t}`,e);return}}}it.regLoader(new is);it.regLoader(new rs);it.regLoader(new os);it.regLoader(new ns);const R=new it;var as=(i,t,e,s)=>{for(var r=t,o=i.length-1,a;o>=0;o--)(a=i[o])&&(r=a(r)||r);return r};let dt=class extends j{constructor(i){super(),n(this,"json"),n(this,"timeScale",1);const t=this.pp;t.url="",t.currentTime=0,t.isPlaying=!1,t.paused=!1,this.on(_.addToStage,this.play,this),this.on(_.removed,this.stop,this),this.setProps(i)}get scene(){return this}get currentTime(){return this.pp.currentTime}get isPlaying(){return this.pp.isPlaying}get paused(){return this.pp.paused}get url(){return this.pp.url}set url(i){this.load(i)}destroy(){this.destroyed||(this.stop(),this.json=void 0,super.destroy())}async load(i,t=!0){if(this.pp.url===i&&this.json){this.emit(_.loaded);return}this.pp.url=i;try{const e=await R.load(i);if(!e)return;t&&await this.preloadAssets(e),this.fromJson(e),this.emit(_.loaded)}catch(e){throw this.emit(_.error,e),e}}async preloadAssets(i){const t=[];this._$collectAsset(i,t);const e=t.length;if(e){const s=[];let r=0;for(const o of t){const a=R.load(o);a.then(()=>{r++,this.emit(_.progress,r/e)}),s.push(a)}await Promise.all(s)}}_$collectAsset(i,t){var e;if(i.props.url&&t.push(i.props.url),(e=i.children)!=null&&e.length)for(const s of i.children)this._$collectAsset(s,t)}play(){var i;const t=this.pp;t.isPlaying||(t.isPlaying=!0,t.paused=!1,(i=this.stage)==null||i.timer.onFrame(this.update,this),this.emit(_.played))}stop(){var i;this.pp.isPlaying&&(this.pp.isPlaying=!1,(i=this.stage)==null||i.timer.clearTimer(this.update,this),this.emit(_.stopped))}pause(){var i;const t=this.pp;!t.isPlaying||t.paused||(t.paused=!0,(i=this.stage)==null||i.timer.clearTimer(this.update,this),this.emit(_.paused))}resume(){var i;const t=this.pp;!t.isPlaying||!t.paused||(t.paused=!1,(i=this.stage)==null||i.timer.onFrame(this.update,this),this.emit(_.resumed))}update(i){const t=this.stage;if(!this.enabled||!t||this.pp.paused)return;const e=i??t.timer.delta*this.timeScale;this.pp.currentTime+=e,this._$updateScripts(this,e),this.emit(_.update,e)}_$updateScripts(i,t){if(i.enabled){const{scripts:e}=i;if(e.length)for(const r of e)r.update(t);const{children:s}=i;if(s.length)for(const r of s)this._$updateScripts(r,t)}}fromJson(i){this.json=i,super.fromJson(i)}cloneNode(i){const t=this._$findNodeData(i,this.json);if(t){const e=Zt(t),s=Jt(e.type);if(s)return e.props.id=H(),e.props.editorOnly=!1,s.fromJson(e),s}console.warn(`clone node ${i.id??i.label} failed`)}_$findNodeData(i,t){var e;if(!t)return;const{id:s,label:r}=i;if(t.id===s||t.props.label===r)return t;if((e=t.children)!=null&&e.length)for(const o of t.children){const a=this._$findNodeData(i,o);if(a)return a}}};dt=as([K("Scene")],dt);class hs extends j{constructor(){super(),n(this,"timer",new I),n(this,"store",new Fe),n(this,"canvas"),n(this,"renderer"),n(this,"keyboard"),n(this,"pointer"),this.pp.stage=this,this.pointerEnabled=!0,this.label="Stage"}resize(t,e){const s=Math.round(t),r=Math.round(e);s===this.width&&r===this.height||(this.width=s,this.height=r,$.pixelRatio!==1?(this.canvas.width=s*$.pixelRatio,this.canvas.height=r*$.pixelRatio,this.canvas.style.cssText=`width: ${s}px; height: ${r}px; `):(this.canvas.width=s,this.canvas.height=r),this.renderer.resize(s,r),this.pp.localBounds.set(0,0,s,r))}getLocalBounds(){return this.pp.localBounds}hitTest(t){return this.getLocalBounds().contains(t.x,t.y)}async loadScene(t,e){const s=new dt;return await s.load(t,e==null?void 0:e.preloadAssets),e!=null&&e.destroyOther&&this.destroyChildren(),this.addChild(s),s}async createScene(t,e){const s=new dt;return e!=null&&e.preloadAssets&&await s.preloadAssets(t),s.fromJson(t),e!=null&&e.destroyOther&&this.destroyChildren(),this.addChild(s),s}pause(){this.timer.pause()}resume(){this.timer.resume()}destroy(){this.destroyed||(this.timer.destroy(),this.store.destroy(),this.renderer.destroy(),this.keyboard.destroy(),this.pointer.destroy(),super.destroy())}}async function ls(){const{physics:i}=await _e(async()=>{const{physics:t}=await import("./liko.physics.es-DzdsK7A9.js");return{physics:t}},__vite__mapDeps([0,1]));return window.physics=i,i}class ds{constructor(){n(this,"_width",1),n(this,"_height",1),n(this,"group"),n(this,"buffer"),n(this,"data",new Float32Array(16)),n(this,"projectionMatrix",new M),n(this,"rootMatrix",new M),n(this,"loaded",!1),n(this,"destroyed",!1);const{group:t,buffer:e}=S.createProjectionMatrixBuffer("uProjection",this.data);this.group=t,this.buffer=e}destroy(){this.destroyed||(this.destroyed=!0,this.buffer.destroy())}resize(t,e){if(t!==this._width||e!==this._height){const s=this._createMatrix(t,e);S.uploadUniform(this.buffer,s),S.setViewport(t*devicePixelRatio,e*devicePixelRatio),this.loaded=!0}}_createMatrix(t,e){return this._width=t,this._height=e,this.calProjection(this.projectionMatrix,0,0,t,e,!1),this.projectionMatrix.append(this.rootMatrix),this.toArray(this.projectionMatrix)}toArray(t){const e=this.data;return e[0]=t.a,e[1]=t.b,e[2]=0,e[3]=0,e[4]=t.c,e[5]=t.d,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=-1,e[11]=0,e[12]=t.tx,e[13]=t.ty,e[14]=1,e[15]=1,e}calProjection(t,e,s,r,o,a){const h=a?1:-1;return t.identity(),t.a=1/r*2,t.d=h*(1/o*2),t.tx=-1-e*t.a,t.ty=-h-s*t.d,t}}class us{constructor(){n(this,"canvas"),n(this,"context"),n(this,"gpuRender"),n(this,"camera")}destroy(){var t;(t=this.camera)==null||t.destroy()}async init(t){const{context:e,gpuRender:s}=await S.init(t);this.context=e,this.gpuRender=s,this.camera=new ds}render(t){t.pp.dirty!==0&&this.gpuRender.render(t,t.worldMatrix,this.camera,this.context.getCurrentTexture())}resize(t,e){this.camera.resize(t,e)}}const cs={width:innerWidth,height:innerHeight,bgColor:0,pixelRatio:window.devicePixelRatio},ce=class pe{constructor(){n(this,"_frameHandle",0),n(this,"_renderHandler",this.render.bind(this)),n(this,"renderer",new us),n(this,"stage",new hs)}async init(t){ss();const e=(t==null?void 0:t.canvas)??S.createCanvas(),s={canvas:e,...cs,...t};if(pe.pixelRatio=s.pixelRatio,this.stage.canvas=e,this.stage.renderer=this.renderer,this.stage.keyboard=new Ee(this.stage),this.stage.pointer=new $e(this.stage),!e.parentNode){const r=s.container?document.getElementById(s.container):document.body;if(r)r.appendChild(e);else throw new Error(`cant not find canvas's container:${s.container}`)}return await this.renderer.init(s),this.stage.resize(s.width,s.height),s.autoResize&&(window.onresize=()=>{const r=e.parentElement.getBoundingClientRect();this.stage.resize(r.width,r.height)}),s.physics&&(await ls()).init({timer:this.stage.timer,...s.physics}),this._frameHandle=requestAnimationFrame(this._renderHandler),e}pause(){cancelAnimationFrame(this._frameHandle)}resume(){this._frameHandle=requestAnimationFrame(this._renderHandler)}render(t){I.runAllCallLater(),this.renderer.render(this.stage);const e=t*.001;I.system.update(e),this.stage.timer.update(e),this._frameHandle=requestAnimationFrame(this._renderHandler)}destroy(){cancelAnimationFrame(this._frameHandle),this._renderHandler=()=>{},this.stage.destroy(),this.renderer.destroy()}};n(ce,"pixelRatio",window.devicePixelRatio);let $=ce;var ps=(i,t,e,s)=>{for(var r=t,o=i.length-1,a;o>=0;o--)(a=i[o])&&(r=a(r)||r);return r};let Yt=class extends j{constructor(i){super(i),n(this,"renderObject",new ut(this));const t=this.pp;t.bounds=new st,t.cmd=[],t.canvas=S.createCanvas(1,1),t.ctx=t.canvas.getContext("2d"),t.texture=F.createFormBuffer(new he(1,1),"canvas"),t.changed=!1,t.maxLineWidth=0,t.clipped=!1}get texture(){return this.pp.changed&&this._$drawCanvas(),this.pp.texture}clear(){const i=this.pp;return i.cmd.length=0,i.bounds.reset(),i.ctx.clearRect(0,0,i.canvas.width,i.canvas.height),i.maxLineWidth=0,i.clipped=!1,this._$dirty(),this}rect(i,t,e,s){return console.assert(e>=0&&s>=0),this.pp.cmd.push({type:"rect",params:[i,t,e,s]}),this._$addPoint(i,t),this._$addPoint(i+e,t+s),this}roundRect(i,t,e,s,r){return this.pp.cmd.push({type:"roundRect",params:[i,t,e,s,r]}),this._$addPoint(i,t),this._$addPoint(i+e,t+s),this}circle(i,t,e){return this.pp.cmd.push({type:"arc",params:[i,t,e,0,tt]}),this._$addPoint(i-e,t-e),this._$addPoint(i+e,t+e),this}ellipse(i,t,e,s,r=0,o=tt){return this.pp.cmd.push({type:"ellipse",params:[i,t,e,s,0,r,o]}),this._$addPoint(i-e,t-s),this._$addPoint(i+e,t+s),this}polygon(i){this.beginPath();for(let t=0;t<i.length;t++)t===0?this.moveTo(i[t].x,i[t].y):this.lineTo(i[t].x,i[t].y);return this.closePath(),this}moveTo(i,t){return this.pp.cmd.push({type:"moveTo",params:[i,t]}),this._$addPoint(i,t),this}lineTo(i,t){return this.pp.cmd.push({type:"lineTo",params:[i,t]}),this._$addPoint(i,t),this}arc(i,t,e,s,r){return this.pp.cmd.push({type:"arc",params:[i,t,e,s,r]}),this._$addPoint(i-e,t-e),this._$addPoint(i+e,t+e),this}arcTo(i,t,e,s,r){return this.pp.cmd.push({type:"arcTo",params:[i,t,e,s,r]}),this._$addPoint(i,t),this._$addPoint(e,s),this}quadraticCurveTo(i,t,e,s){return this.pp.cmd.push({type:"quadraticCurveTo",params:[i,t,e,s]}),this._$addPoint(e,s),this._$addPoint(i,t),this}bezierCurveTo(i,t,e,s,r,o){return this.pp.cmd.push({type:"bezierCurveTo",params:[i,t,e,s,r,o]}),this._$addPoint(r,o),this._$addPoint(i,t),this._$addPoint(e,s),this}beginPath(){return this.pp.cmd.push({type:"beginPath",params:[]}),this}closePath(){return this.pp.cmd.push({type:"closePath",params:[]}),this}clip(i){this.pp.cmd.push({type:"clip",params:i?[i]:[]}),this.pp.clipped=!0}drawImage(i,t,e,s,r,o,a,h,l){const u=i instanceof F?i.buffer.bitmap:i,f=s??i.width,c=r??i.height,{length:d}=arguments,{cmd:p}=this.pp;if(d===3)p.push({type:"drawImage",params:[u,t,e]});else if(d===5)p.push({type:"drawImage",params:[u,t,e,s,r]});else if(d===9)p.push({type:"drawImage",params:[u,o,a,h,l,t,e,s,r]});else throw new Error("arguments length error");return this._$addPoint(t,e),this._$addPoint(t+f,e+c),this}drawSvg(i,t=0,e=0,s=1){const r=new Blob([i],{type:"image/svg+xml"}),o=URL.createObjectURL(r),a=new Image;return a.src=o,a.onerror=()=>{throw new Error('SVG 内容错误，检查是否包含 xmlns="http://www.w3.org/2000/svg" 的定义')},a.onload=()=>{const h=a.width*s,l=a.height*s;this.pp.cmd.push({type:"drawImage",params:[a,t,e,h,l]}),this._$addPoint(t,e),this._$addPoint(t+h,e+l),this._$dirty()},this}fill(i){return this.pp.cmd.push({type:"fill",params:[(i==null?void 0:i.color)??"#FFD700"]}),this._$dirty(),this}_$fill(i){const{ctx:t}=this.pp;t.fillStyle=i,t.fill()}stroke(i){const t=i?{width:1,color:"#FFD700",...i}:{width:1,color:"#FFD700"};return t.width=Math.max(t.width,1e-4),this.pp.cmd.push({type:"stroke",params:[t.color,t.width,t.cap,t.join,t.dash,t.dashOffset,t.miterLimit]}),t.width&&(this.pp.maxLineWidth=Math.max(this.pp.maxLineWidth,t.width)),this._$dirty(),this}_$stroke(i,t,e,s,r,o,a){const h=this.pp.ctx;h.strokeStyle=i,t&&(h.lineWidth=t),e&&(h.lineCap=e),s&&(h.lineJoin=s),r&&h.setLineDash(r),o&&(h.lineDashOffset=o),a&&(h.miterLimit=a),h.stroke()}_$drawCanvas(){const{changed:i,canvas:t,ctx:e,cmd:s,maxLineWidth:r,bounds:o}=this.pp;if(i&&(this.pp.changed=!1,e.clearRect(0,0,t.width,t.height),s.length)){const{width:a,height:h}=o,l=$.pixelRatio,u=Math.ceil((a+r)*l),f=Math.ceil((h+r)*l),c={x:o.x-r*.5,y:o.y-r*.5};this._$resizeCanvas(c,u,f),e.reset(),e.scale(l,l),e.translate(-c.x,-c.y);for(const d of s)d.type==="fill"?this._$fill.apply(this,d.params):d.type==="stroke"?this._$stroke.apply(this,d.params):CanvasRenderingContext2D.prototype[d.type].apply(e,d.params)}}_$resizeCanvas(i,t,e){console.assert(t>0&&e>0,"canvas width and height must be greater than 0");const{canvas:s,texture:r,width:o,height:a}=this.pp,h={frame:{x:0,y:0,w:t,h:e},spriteSourceSize:{x:i.x*$.pixelRatio,y:i.y*$.pixelRatio,w:t,h:e},sourceSize:{w:t,h:e},rotated:!1,trimmed:!0};t>s.width||e>s.height?(s.width=t,s.height=e,r.setBuffer(new pt(s),void 0,h),this.markDirty(g.child)):(r.setBuffer(r.buffer,void 0,h),r.buffer.dirty()),o===-1&&a===-1&&(this.anchor=this.anchor)}_$addPoint(i,t){if(this.pp.clipped)return;const{bounds:e}=this.pp;i<e.minX&&(e.minX=i),i>e.maxX&&(e.maxX=i),t<e.minY&&(e.minY=t),t>e.maxY&&(e.maxY=t)}_customLocalBounds(i){const{bounds:t,maxLineWidth:e}=this.pp,s=e*.5;i.addFrame(t.minX-s,t.minY-s,t.maxX+s,t.maxY+s)}_$dirty(){this.pp.changed||(this.pp.changed=!0,this.markDirty(g.transform),this.markDirty(g.texture),this.markDirty(g.size),I.callLater(this._$drawCanvas,this))}isPointInPath(i){const t=this.worldToLocal(i);return this.pp.ctx.isPointInPath(t.x,t.y)}destroy(){var i;this.pp.cmd.length=0,(i=this.pp.texture)==null||i.destroy(),super.destroy()}};Yt=ps([K("Canvas")],Yt);var fs=(i,t,e,s)=>{for(var r=t,o=i.length-1,a;o>=0;o--)(a=i[o])&&(r=a(r)||r);return r};let Vt=class extends j{hitTest(){return!1}_customLocalBounds(i){for(const t of this.children){const{pos:e}=t;t.rotation?(i.addFrame(0,0,t.width,t.height),i.addFrame(0,t.height,t.width,0),i.applyMatrix(t.localMatrix)):i.addFrame(e.x,e.y,e.x+t.width,e.y+t.height)}}};Vt=fs([K("Container")],Vt);var ys=(i,t,e,s)=>{for(var r=t,o=i.length-1,a;o>=0;o--)(a=i[o])&&(r=a(r)||r);return r};let Ut=class extends j{constructor(i){super(),n(this,"renderObject",new ut(this)),n(this,"isPlaying",!1),n(this,"frameRate",30),this.pp.url="",this.pp.currentFrame=0,this.pp.textures=[],this.setProps(i),this._$renderFrame(this.pp.currentFrame)}get textures(){return this.pp.textures}set textures(i){this.pp.textures!==i&&(this.pp.textures=i,this._$renderFrame(0),this.markDirty(g.child))}get texture(){return this.pp.texture}set texture(i){this.pp.texture!==i&&(this.pp.texture=i,this.markDirty(g.texture),this.markDirty(g.size))}get duration(){return this.pp.textures.length/this.frameRate}get currentFrame(){return this.pp.currentFrame}set currentFrame(i){this.pp.currentFrame!==i&&(this.pp.currentFrame=i,this._$renderFrame(i))}_$renderFrame(i){const{textures:t}=this.pp;if(t.length){let e=i;e>=t.length&&(e=0,this.pp.currentFrame=0),this.texture=t[e],e===t.length-1&&this.emit(_.ended)}}get url(){return this.pp.url}set url(i){this.load(i)}async load(i){if(this.pp.url!==i){this.pp.url=i;const t=await R.load(i,"sheet");if(this.destroyed||!t)return;console.assert(t.length>0),this.textures=t,this._$renderFrame(this.pp.currentFrame)}this.emit(_.loaded)}_customLocalBounds(i){const{texture:t}=this.pp;t&&i.addFrame(0,0,t.width,t.height)}play(){var i;this.isPlaying||(this.isPlaying=!0,console.assert(this.stage!==void 0,"please add to stage first before play"),(i=this.stage)==null||i.timer.setInterval(1/this.frameRate,this._$update,this),this.emit(_.played))}stop(){var i;this.isPlaying&&(this.isPlaying=!1,(i=this.stage)==null||i.timer.clearTimer(this._$update,this),this.emit(_.stopped))}_$update(){this.currentFrame++}gotoTime(i){this.currentFrame=Math.round(i/this.duration*this.pp.textures.length)}destroy(){this.stop(),this.textures.length=0,super.destroy()}};Ut=ys([K("AnimatedSprite")],Ut);var ms=(i,t,e,s)=>{for(var r=t,o=i.length-1,a;o>=0;o--)(a=i[o])&&(r=a(r)||r);return r};let Xt=class extends j{constructor(i){super(),n(this,"renderObject",new ut(this)),n(this,"padding",4);const t=this.pp;t.canvas=S.createCanvas(100,20),t.ctx=t.canvas.getContext("2d"),t.text="",t.lines=[],t.textColor="#efefef",t.textStrokeColor="",t.textStrokeWidth=0,t.fontFamily="Arial",t.fontSize=12,t.fontWeight="normal",t.textAlign="left",t.lineHeight=0,t.measureWidth=0,t.measureHeight=0,t.changed=!1,t.texture=new F,this.setProps(i)}get texture(){return this.pp.changed&&this._$drawText(),this.pp.texture}get text(){return this.pp.text}set text(i){const t=this.pp;t.text!==i&&(t.text=i,t.lines=t.text.split(`
`),this._$dirty())}_$dirty(){this.pp.changed||(this.pp.changed=!0,this.markDirty(g.texture),this.markDirty(g.transform),this.markDirty(g.size),I.callLater(this._$drawText,this))}get textColor(){return this.pp.textColor}set textColor(i){this.pp.textColor!==i&&(this.pp.textColor=i,this._$dirty())}get textStrokeColor(){return this.pp.textStrokeColor}set textStrokeColor(i){this.pp.textStrokeColor!==i&&(this.pp.textStrokeColor=i,this._$dirty())}get textStrokeWidth(){return this.pp.textStrokeWidth}set textStrokeWidth(i){this.pp.textStrokeWidth!==i&&(this.pp.textStrokeWidth=i,this._$dirty())}get fontFamily(){return this.pp.fontFamily}set fontFamily(i){this.pp.fontFamily!==i&&(this.pp.fontFamily=i,this._$dirty())}get fontSize(){return this.pp.fontSize}set fontSize(i){this.pp.fontSize!==i&&(this.pp.fontSize=i,this._$dirty())}get fontWeight(){return this.pp.fontWeight}set fontWeight(i){this.pp.fontWeight!==i&&(this.pp.fontWeight=i,this._$dirty())}get fontStyle(){return this.pp.fontStyle}set fontStyle(i){this.pp.fontStyle!==i&&(this.pp.fontStyle=i,this._$dirty())}get lineHeight(){const{lineHeight:i,fontSize:t}=this.pp;return i>0?i:t}set lineHeight(i){this.pp.lineHeight!==i&&(this.pp.lineHeight=i,this._$dirty())}get textAlign(){return this.pp.textAlign}set textAlign(i){this.pp.textAlign!==i&&(this.pp.textAlign=i,this._$dirty())}get width(){return super.width}set width(i){this.pp.width!==i&&(super.width=i,this._$dirty())}get height(){return super.height}set height(i){this.pp.height!==i&&(super.height=i,this._$dirty())}get textWidth(){return this.pp.measureWidth+this.pp.textStrokeWidth+this.padding*2}get textHeight(){return this.pp.measureHeight+this.pp.textStrokeWidth+this.padding*2}destroy(){this.pp.texture.destroy(),super.destroy()}setText(i){this.text=i}_$resetStyle(){const{ctx:i,fontStyle:t,fontWeight:e,fontSize:s,fontFamily:r,textColor:o,textAlign:a,textStrokeColor:h}=this.pp;i.textBaseline="alphabetic",i.font=`${t?`${t} `:""}${e} ${s}px ${r}`,i.fillStyle=o,i.textAlign=a,i.strokeStyle=h}_$measure(){const{lines:i,ctx:t}=this.pp;this._$resetStyle();let e=0;for(const r of i)e=Math.max(Math.ceil(t.measureText(r).width),e);this.pp.measureWidth=e,this.pp.measureHeight=this.lineHeight*i.length;const s=t.measureText("|ÉqÅM");return{ascent:s.actualBoundingBoxAscent,fontHeight:s.actualBoundingBoxAscent+s.actualBoundingBoxDescent}}_customLocalBounds(i){i.addFrame(0,0,this.textWidth,this.textHeight)}getLocalBounds(){return this.pp.changed&&this._$drawText(),super.getLocalBounds()}_$drawText(){const{changed:i,canvas:t,ctx:e,textAlign:s,textStrokeWidth:r,textStrokeColor:o,textColor:a,lines:h}=this.pp;if(i){this.pp.changed=!1,e.clearRect(0,0,t.width,t.height);const l=this._$measure(),u=$.pixelRatio,f=Math.ceil(this.textWidth*u),c=Math.ceil(this.textHeight*u);this._$resizeCanvas(f,c),this._$resetStyle();const d=s==="left"?0:s==="right"?this.pp.measureWidth:this.pp.measureWidth*.5,p=this.lineHeight,x=(p-l.fontHeight)*.5;if(e.resetTransform(),e.scale(u,u),e.translate(r*.5+this.padding,r*.5+this.padding),r&&o){e.strokeStyle=o,e.lineWidth=r;for(let y=0;y<h.length;y++){const m=h[y],v=y*p+x+l.ascent;e.strokeText(m,d,v)}}if(a){e.fillStyle=a;for(let y=0;y<h.length;y++){const m=h[y],v=y*p+x+l.ascent;e.fillText(m,d,v)}}}}_$resizeCanvas(i,t){const{canvas:e,texture:s,width:r,height:o}=this.pp;if(i>e.width||t>e.height)e.width=i,e.height=t,s.setBuffer(new pt(e)),this.markDirty(g.child);else{const a={frame:{x:0,y:0,w:i,h:t},spriteSourceSize:{x:0,y:0,w:i,h:t},sourceSize:{w:i,h:t},rotated:!1,trimmed:!0};s.setBuffer(s.buffer,void 0,a),s.buffer.dirty()}r===-1&&o===-1&&(this.anchor=this.anchor)}};Xt=ms([K("Text")],Xt);class fe{constructor(){n(this,"id",""),n(this,"label",""),n(this,"_$awaked",!1),n(this,"_$destroyed",!1),n(this,"_$enabled",!0),n(this,"_$target")}get awaked(){return this._$awaked}get destroyed(){return this._$destroyed}get enabled(){return this._$enabled}set enabled(t){t!==this._$enabled&&(this._$enabled=t,this._$target&&(t?this.onEnable():this.onDisable()))}get target(){return this._$target||console.warn("Script target is not set"),this._$target}set target(t){t!==this._$target&&(this._$target=t,t&&this.onCreate())}get stage(){var t;return(t=this._$target)==null?void 0:t.stage}get scene(){var t;return(t=this._$target)==null?void 0:t.scene}setProps(t){if(t){const e=Object.keys(t);for(const s of e)this.setProp(s,t[s])}return this}setProp(t,e){t in this&&(this[t]=e)}signal(t,e){var s,r;(r=(s=this._$target)==null?void 0:s.scene)==null||r.emit(_.signal,t,e)}update(t){this._$enabled&&(this._$awaked||this._$awake(),this.onUpdate(t))}_$awake(){this._$awaked||(this._$awaked=!0,this.onAwake())}onEnable(){}onDisable(){}onCreate(){}onAwake(){}onUpdate(t){}onDestroy(){}destroy(){var t,e,s,r;this._$destroyed||(this._$destroyed=!0,this._$enabled=!1,this.onDestroy(),(t=this._$target)==null||t.offAll(this),(e=this.scene)==null||e.offAll(this),(s=this.stage)==null||s.offAll(this),(r=this.stage)==null||r.timer.clearAll(this),this._$target=void 0)}}class ye extends fe{_$awake(){this.awaked||(this._$regEvent(),super._$awake())}_$regEvent(){var t;const e=ye.prototype,s=this.target;if(s){const{onClick:r,onPointerDown:o,onPointerUp:a,onPointerMove:h,onCollisionStart:l,onCollisionEnd:u,onSignal:f}=e;this.onClick!==r&&s.on(_.click,this.onClick,this),this.onPointerDown!==o&&s.on(_.pointerdown,this.onPointerDown,this),this.onPointerUp!==a&&s.on(_.pointerup,this.onPointerUp,this),this.onPointerMove!==h&&s.on(_.pointermove,this.onPointerMove,this),this.onCollisionStart!==l&&s.on(_.collisionStart,this.onCollisionStart,this),this.onCollisionEnd!==u&&s.on(_.collisionEnd,this.onCollisionEnd,this),this.onSignal!==f&&((t=this.scene)==null||t.on(_.signal,this.onSignal,this));const{stage:c}=this;if(c){const{onStageClick:d,onStagePointerDown:p,onStagePointerUp:x,onStagePointerMove:y,onKeyDown:m,onKeyUp:v}=e;this.onStageClick!==d&&c.on(_.click,this.onStageClick,this),this.onStagePointerDown!==p&&c.on(_.pointerdown,this.onStagePointerDown,this),this.onStagePointerUp!==x&&c.on(_.pointerup,this.onStagePointerUp,this),this.onStagePointerMove!==y&&c.on(_.pointermove,this.onStagePointerMove,this),this.onKeyDown!==m&&c.on(_.keydown,this.onKeyDown,this),this.onKeyUp!==v&&c.on(_.keyup,this.onKeyUp,this)}}}onClick(t){}onPointerDown(t){}onPointerUp(t){}onPointerMove(t){}onCollisionStart(t){}onCollisionEnd(t){}onSignal(t,e){}onStageClick(t){}onStagePointerDown(t){}onStagePointerUp(t){}onStagePointerMove(t){}onKeyDown(t){}onKeyUp(t){}}const Gt=Math.PI/2,at=7.5625,Z=1.70158,ht=Z*1.525,jt=6.9813172,b={Linear(i){return i},QuadIn(i){return i*i},QuadOut(i){return i*(2-i)},QuadInOut(i){let t=i*2;return t<1?.5*t*t:-.5*(--t*(t-2)-1)},CubicIn(i){return i*i*i},CubicOut(i){return(i-1)**3+1},CubicInOut(i){let t=i*2;return t<1?.5*t**3:(t=t-2,.5*(t**3+2))},QuartIn(i){return i**4},QuartOut(i){return 1-(i-1)**4},QuartInOut(i){let t=i*2;return t<1?.5*t**4:(t=t-2,-.5*(t**4-2))},QuintIn(i){return i*i*i*i*i},QuintOut(i){return(i-1)**5+1},QuintInOut(i){let t=i*2;return t<1?.5*t**5:(t=t-2,.5*(t**5+2))},SineIn(i){return 1-Math.sin((1-i)*Gt)},SineOut(i){return Math.sin(i*Gt)},SineInOut(i){return .5*(1-Math.sin(Math.PI*(.5-i)))},ExpoIn(i){return i===0?0:1024**(i-1)},ExpoOut(i){return i===1?1:1-2**(-10*i)},ExpoInOut(i){if(i===0)return 0;if(i===1)return 1;const t=i*2;return t<1?.5*1024**(t-1):.5*(-(2**(-10*(t-1)))+2)},CircIn(i){return 1-Math.sqrt(1-i*i)},CircOut(i){const t=i-1;return Math.sqrt(1-t*t)},CircInOut(i){let t=i*2;return t<1?-.5*(Math.sqrt(1-t*t)-1):(t=t-2,.5*(Math.sqrt(1-t*t)+1))},ElasticIn(i){return i===0?0:i===1?1:-(2**(10*(i-1)))*Math.sin((i-1.1)*5*Math.PI)},ElasticOut(i){return i===0?0:i===1?1:2**(-10*i)*Math.sin((i-.1)*5*Math.PI)+1},ElasticInOut(i){if(i===0)return 0;if(i===1)return 1;const t=i*2;return t<1?-.5*2**(10*(t-1))*Math.sin((t-1.1)*5*Math.PI):.5*2**(-10*(t-1))*Math.sin((t-.1)*5*Math.PI)+1},BackIn(i){return i===1?1:i*i*((Z+1)*i-Z)},BackOut(i){const t=i-1;return i===0?0:t*t*((Z+1)*t+Z)+1},BackInOut(i){let t=i*2;return t<1?.5*(t*t*((ht+1)*t-ht)):(t=t-2,.5*(t*t*((ht+1)*t+ht)+2))},BounceIn(i){return 1-b.BounceOut(1-i)},BounceOut(i){if(i<1/2.75)return at*i*i;if(i<2/2.75){const e=i-.5454545454545454;return at*e*e+.75}if(i<2.5/2.75){const e=i-.8181818181818182;return at*e*e+.9375}const t=i-2.625/2.75;return at*t*t+.984375},BounceInOut(i){return i<.5?b.BounceIn(i*2)*.5:b.BounceOut(i*2-1)*.5+.5},Immediately(i){return i>0?1:0},Pulse(i){return i<.5?b.SineIn(i*2):1-b.SineOut((i-.5)*2)},Jelly(i){return i<.5?Math.sin(jt*b.SineIn(i*2)):Math.sin(jt*(1-b.SineOut((i-.5)*2)))},Collision(i){return i<.25?b.QuartOut(i*4):1-b.BounceOut((i-.25)*4/3)},Pendulum(i){return i<.25?i*4:i<.5?1-(i-.25)*4:i<.75?(i-.5)*4:1-(i-.75)*4},Heart(i){return i<.25?b.QuadOut(i*4):i<.5?1-b.QuadIn((i-.25)*4):i<.75?b.QuadOut((i-.5)*4):1-b.QuadIn((i-.75)*4)},Breathe(i){return i<.25?b.QuartOut(i*4):i<.5?1-b.QuadIn((i-.25)*4):i<.75?-b.QuartOut((i-.5)*4):b.QuadIn((i-.75)*4)-1},Wave(i){return i<.25?i*4:i<.5?(i-.25)*4:i<.75?(i-.5)*4:(i-.75)*4},Swing(i){return i<.5?b.Breathe(i*2):b.Breathe((i-.5)*2)*.5},Flash(i){return i<.1?b.Linear(i*10):i<.2?1-b.Linear((i-.1)*10):i<.3?b.Linear((i-.2)*10):i<.4?1-b.Linear((i-.3)*10):i<.5?b.Linear((i-.4)*10):b.Linear((i-.5)*2)},Shake(i){const t=1-i;return Math.sin(i*30)*t*t}};function gs(i){return b[i]||b.Linear}class xs{constructor(){n(this,"_from",{}),n(this,"_diff",{}),n(this,"_repeatTimes",0),n(this,"target",{}),n(this,"to"),n(this,"from"),n(this,"_startTime",0),n(this,"_delay",0),n(this,"duration",1),n(this,"_repeat",1),n(this,"repeatDelay",0),n(this,"yoyo",!1),n(this,"_ease",b.Linear),n(this,"awaked",!1),n(this,"started",!1),n(this,"ended",!1)}get delay(){return this._delay}set delay(t){this._delay=t,this._startTime=t}get repeat(){return this._repeat}set repeat(t){t!==this._repeat&&(this._repeat=t<=0?Number.POSITIVE_INFINITY:t)}get ease(){return this._ease}set ease(t){typeof t=="string"?this._ease=gs(t):this._ease=t}setProps(t){if(t){const e=Object.keys(t);for(const s of e)this.setProp(s,t[s])}}setProp(t,e){t in this&&(this[t]=e)}update(t){!this.ended&&t>=this._startTime&&(this.started||this._start(),t<this._startTime+this.duration?this._updateProgress(t):this._end())}_start(){this.awaked||(this.awaked=!0,this.to?this._toKey(this.to):this.from&&this._fromKey(this.from),this.onAwake(this.target)),this.started||(this.started=!0,this.onStart(this.target))}_toKey(t){const e=Object.keys(t);for(const s of e)s in this.target&&this._setDiff(s,this._fromTarget(s,t[s]),this._formatValue(s,t[s]))}_fromKey(t){const e=Object.keys(t);for(const s of e)s in this.target&&this._setDiff(s,this._formatValue(s,t[s]),this._fromTarget(s,t[s]))}_fromTarget(t,e){const s=this.target[t];if(typeof s=="number")return s;const r={},o=Object.keys(e);for(const a of o)r[a]=s[a];return r}_formatValue(t,e){if(typeof e=="number")return e;if(typeof e=="string")return e.startsWith("*")?this.target[t]*Number.parseFloat(e.replace("*","")):this.target[t]+Number.parseFloat(e);const s={},r=Object.keys(e);for(const o of r){const a=e[o];typeof a=="number"?s[o]=a:a.startsWith("*")?s[o]=this.target[t][o]*Number.parseFloat(a.replace("*","")):s[o]=this.target[t][o]+Number.parseFloat(a)}return s}_setDiff(t,e,s){if(this._from[t]=e,typeof e=="number"&&typeof s=="number")this._diff[t]=s-e;else if(typeof e=="object"&&typeof s=="object"){const r={},o=Object.keys(e);for(const a of o)r[a]=s[a]-e[a];this._diff[t]=r}}_updateProgress(t){let e=(t-this._startTime)/this.duration;e=e<0?0:e<1?e:1,this.onUpdate(this._easeValue(e))}_easeValue(t){let e=t;return this.yoyo&&(e=this._repeatTimes%2===0?t:1-t),this.ease(e)}onUpdate(t){const e=Object.keys(this._diff);for(const s of e){const r=this._diff[s];if(typeof r=="number")this.target[s]=this._from[s]+r*t;else{const o=this.target[s],a=Object.keys(r);for(const h of a)o[h]=this._from[s][h]+r[h]*t}}}_end(){this._repeatTimes++,this._repeatTimes<this.repeat?(this._startTime=this.delay+(this.repeatDelay+this.duration)*this._repeatTimes,this.started=!1,this.ended=!1,this.onUpdate(this._easeValue(this.yoyo?0:1)),this.onEnd(this.target)):this._complete()}_complete(){this.onUpdate(this._easeValue(this.yoyo?0:1)),this.ended=!0,this.onEnd(this.target),this.onComplete(this.target)}goto(t){if(this.repeat>1){const e=this.duration+this.repeatDelay;this._repeatTimes=t>this.delay+this.duration?Math.floor((t-this.delay)/e):0,this._repeatTimes>this.repeat&&(this._repeatTimes=this.repeat),this._startTime=this.delay+e*this._repeatTimes}this.started=!1,this.ended=!1,t>=this._startTime&&this.update(t)}reset(){this._repeatTimes=0,this._startTime=this.delay,this.started=!1,this.ended=!1,this.awaked=!1}onAwake(t){}onStart(t){}onEnd(t){}onComplete(t){}}const me=class C{constructor(){n(this,"_effects",[]),n(this,"_current"),n(this,"_currentTime",0),n(this,"_isPlaying",!1),n(this,"_paused",!1),n(this,"_destroyed",!1),n(this,"_resolve"),n(this,"_onAllComplete"),n(this,"label")}static to(t){const e=t.label;e&&C.clear(e);const s=new C().to(t);return s.label=e,C._list.push(s),s}static from(t){const e=t.label;e&&C.clear(e);const s=new C().from(t);return s.label=e,C._list.push(s),s}static clear(t){for(const e of C._list)if(e.label===t){e.destroy();break}}static clearAll(){const t=[...C._list];for(const e of t)e.destroy();C._list.length=0}get destroyed(){return this._destroyed}get isPlaying(){return this._isPlaying}get paused(){return this._paused}set(t,e){const s=Object.keys(e);for(const r of s)r in t&&(t[r]=e[r]);return this}to(t){return this._add(!0,t)}from(t){return this._add(!1,t)}wait(t){return this._add(!0,{target:{},props:{},duration:t})}call(t){return this._add(!0,{target:{},props:{},duration:0,onStart:t})}_add(t,e){const s=new xs;return s.target=e.target,s.duration=e.duration??1,s.ease=e.ease??b.Linear,s.delay=this._lastEndTime()+(e.delay??0),s.repeat=e.repeat??1,s.repeatDelay=e.repeatDelay??0,s.yoyo=!!e.yoyo,e.onUpdate&&(s.onUpdate=e.onUpdate),e.onStart&&(s.onStart=e.onStart),e.onEnd&&(s.onEnd=e.onEnd),e.onComplete&&(s.onComplete=e.onComplete),t?s.to=e.props:s.from=e.props,this._effects.push(s),this}_lastEndTime(){if(this._effects.length<1)return 0;const t=this._effects[this._effects.length-1];return t.delay+t.duration}_next(){const t=this._current??this._effects.shift();if(t){this._current=t;const e=t.onComplete;t.onComplete=()=>{this._current=void 0,e&&e.call(t,t.target),this._next()}}else this.stop(),this._resolve&&this._resolve(),this._onAllComplete&&this._onAllComplete(),this.destroy()}play(){return this._destroyed||this._isPlaying?Promise.resolve():new Promise(t=>{this._currentTime=0,this._paused=!1,this._resolve=t,this._isPlaying=!0,this._next(),this._update(),I.system.onFrame(this._update,this)})}_update(t){var e;this._currentTime+=t??I.system.delta,(e=this._current)==null||e.update(this._currentTime)}pause(){return this._isPlaying&&!this._paused&&(this._paused=!0,I.system.clearTimer(this._update,this)),this}resume(){return this._isPlaying&&this._paused&&(this._paused=!1,I.system.onFrame(this._update,this)),this}stop(){return this._isPlaying&&(this._isPlaying=!1,this._paused=!1,I.system.clearTimer(this._update,this)),this}destroy(){if(this._destroyed)return;this._destroyed=!0,this.stop(),this._effects.length=0,this._current=void 0,this._resolve=void 0,this._onAllComplete=void 0;const t=C._list.indexOf(this);t!==-1&&C._list.splice(t,1)}onAllComplete(t){return this._onAllComplete=t,this}};n(me,"_list",[]);let Is=me;class _s{constructor(){n(this,"_sounds",[])}play(t,e=1,s=!1){let r=this._sounds.find(o=>o.url===t&&!o.isPlaying);r?r.setVolume(e):(r=new Bt(t,!1,e),this._sounds.push(r)),r.onEnd=s?o=>this.destroy(o):void 0,r.play()}stop(t){for(const e of this._sounds)e.url===t&&e.stop()}stopAll(){for(const t of this._sounds)t.stop()}destroy(t){for(const e of this._sounds)e.url===t&&e.destroy();this._sounds=this._sounds.filter(e=>!e.destroyed)}destroyAll(){for(const t of this._sounds)t.destroy();this._sounds=[]}}class vs{constructor(){n(this,"_music",{})}play(t,e=!0,s=1,r=!1){let o=this._music[t];return o&&!o.destroyed?(o.setLoop(e),o.setVolume(s)):(o=new Bt(t,e,s),this._music[t]=o),o.onEnd=r?a=>this.destroy(a):void 0,o.play(),o}pause(t){var e;(e=this._music[t])==null||e.pause()}pauseAll(){for(const t of Object.values(this._music))t.pause()}resume(t){var e;(e=this._music[t])==null||e.resume()}resumeAll(){for(const t of Object.values(this._music))t.resume()}stop(t){var e;(e=this._music[t])==null||e.stop()}stopAll(){for(const t of Object.values(this._music))t.stop()}setVolume(t,e){var s;(s=this._music[t])==null||s.setVolume(e)}setVolumeAll(t){for(const e of Object.values(this._music))e.setVolume(t)}fadeIn(t,e=1){var s;(s=this._music[t])==null||s.fadeIn(e)}fadeInAll(t=1){for(const e of Object.values(this._music))e.fadeIn(t)}fadeOut(t,e=1){var s;(s=this._music[t])==null||s.fadeOut(e)}fadeOutAll(t=1){for(const e of Object.values(this._music))e.fadeOut(t)}setLoop(t,e){var s;(s=this._music[t])==null||s.setLoop(e)}setLoopAll(t){for(const e of Object.values(this._music))e.setLoop(t)}setPlaybackRate(t,e){var s;(s=this._music[t])==null||s.setPlaybackRate(e)}setPlaybackRateAll(t){for(const e of Object.values(this._music))e.setPlaybackRate(t)}destroy(t){var e;(e=this._music[t])==null||e.destroy(),delete this._music[t]}destroyAll(){for(const t of Object.values(this._music))t.destroy();this._music={}}}const Ms=new _s,Ds=new vs;function bs(i,t){if(!i.awaked)return i.joints.push(t),null;const{physics:e,body:s,target:r}=i,{pl:o,world:a,toPhPos:h,toPh:l}=e;switch(t.jointType){case"revolute":{const{localAnchorA:u,localAnchorB:f}=W(i,t),c={bodyA:s,bodyB:t.targetBody.body,localAnchorA:u,localAnchorB:f,collideConnected:t.collideConnected,enableLimit:t.enableLimit,lowerAngle:t.lowerAngle,upperAngle:t.upperAngle,enableMotor:t.enableMotor,maxMotorTorque:t.maxMotorTorque,motorSpeed:t.motorSpeed};return a.createJoint(new o.RevoluteJoint(c))}case"distance":{const{localAnchorA:u,localAnchorB:f}=W(i,t),c={bodyA:s,bodyB:t.targetBody.body,localAnchorA:u,localAnchorB:f,collideConnected:t.collideConnected,length:l(t.length??10),frequencyHz:t.frequency,dampingRatio:t.dampingRatio};return a.createJoint(new o.DistanceJoint(c))}case"fixed":{const{localAnchorA:u,localAnchorB:f}=W(i,t),c={bodyA:s,bodyB:t.targetBody.body,localAnchorA:u,localAnchorB:f,collideConnected:t.collideConnected,frequencyHz:t.frequency,dampingRatio:t.dampingRatio};return a.createJoint(new o.WeldJoint(c))}case"prismatic":{const{localAnchorA:u,localAnchorB:f}=W(i,t),c={bodyA:s,bodyB:t.targetBody.body,localAnchorA:u,localAnchorB:f,localAxisA:{x:-t.localAxis.x,y:-t.localAxis.y},collideConnected:t.collideConnected,enableLimit:t.enableLimit,lowerTranslation:t.lowerTranslation?l(t.lowerTranslation):void 0,upperTranslation:t.upperTranslation?l(t.upperTranslation):void 0,enableMotor:t.enableMotor,maxMotorForce:t.maxMotorForce,motorSpeed:t.motorSpeed};return a.createJoint(new o.PrismaticJoint(c))}case"wheel":{const{localAnchorA:u,localAnchorB:f}=W(i,t),c={bodyA:s,bodyB:t.targetBody.body,localAnchorA:u,localAnchorB:f,localAxisA:{x:-t.localAxis.x,y:-t.localAxis.y},collideConnected:t.collideConnected,enableMotor:t.enableMotor,maxMotorTorque:t.maxMotorTorque,motorSpeed:t.motorSpeed?-t.motorSpeed:void 0,frequencyHz:t.frequency||2,dampingRatio:t.dampingRatio||.7};return a.createJoint(new o.WheelJoint(c))}case"rope":{const{localAnchorA:u,localAnchorB:f}=W(i,t),c={bodyA:s,bodyB:t.targetBody.body,localAnchorA:u,localAnchorB:f,maxLength:l(t.maxLength),collideConnected:t.collideConnected};return a.createJoint(new o.RopeJoint(c))}case"motor":{const u={bodyA:s,bodyB:t.targetBody.body,collideConnected:t.collideConnected!==!1,linearOffset:t.linearOffset?h(t.linearOffset):void 0,angularOffset:t.angularOffset??0,maxForce:t.maxForce??1,maxTorque:t.maxTorque??1,correctionFactor:t.correctionFactor??.3};return a.createJoint(new o.MotorJoint(u))}case"pulley":{const u=t.targetBody.target,f={x:t.localAnchorA.x+r.pivot.x,y:t.localAnchorA.y+r.pivot.y},c={x:t.localAnchorB.x+u.pivot.x,y:t.localAnchorB.y+u.pivot.y},d=h(f),p=h(c),x=h(t.groundAnchorA),y=h(t.groundAnchorB),m={bodyA:s,bodyB:t.targetBody.body,localAnchorA:d,localAnchorB:p,groundAnchorA:x,groundAnchorB:y,lengthA:l(t.lengthA),lengthB:l(t.lengthB),ratio:t.ratio,collideConnected:t.collideConnected!==!1};return a.createJoint(new o.PulleyJoint(m))}}}function W(i,t){if("localAnchor"in t){const{physics:e,target:s}=i,r={x:t.localAnchor.x+s.pivot.x,y:t.localAnchor.y+s.pivot.y},o=t.targetBody.target.worldToLocal(s.localToWorld(r)),a=e.toPhPos(r),h=e.toPhPos(o);return{localAnchorA:a,localAnchorB:h}}return{localAnchorA:{x:0,y:0},localAnchorB:{x:0,y:0}}}function Wt(i,t){var e,s;if(!i.awaked){i.shapes.push(t);return}const{physics:r,body:o}=i,a={density:1,isSensor:i.isSensor,friction:i.friction,restitution:i.restitution,filterGroupIndex:0,filterCategoryBits:r.getCategoryBit(i.category),filterMaskBits:r.getCategoryMask(i.categoryAccepted),...t},h=i.target.getWorldRotatingRect(i.scene),l=r,{pl:u,toPh:f,toPhPos:c}=l;let d;const p=f(((e=t.offset)==null?void 0:e.x)??0),x=f(((s=t.offset)==null?void 0:s.y)??0);switch(t.shapeType){case"box":{const y=f(t.width??h.width)/2,m=f(t.height??h.height)/2;d=o.createFixture(new u.Box(y,m,{x:y+p,y:m+x}),a);break}case"circle":{const y=f(t.radius??h.height/2),m=p+y,v=x+y;d=o.createFixture(new u.Circle({x:m,y:v},y),a);break}case"chain":{const y=t.vertices.map(m=>c({x:m.x+p,y:m.y+x}));if(console.assert(y.length>=2,"Chain shape must have at least 2 vertices"),y.length<2)return;d=o.createFixture(new u.Chain(y,!1),a);break}case"polygon":{const y=t.vertices.map(m=>c({x:m.x+p,y:m.y+x}));if(console.assert(y.length>=3&&y.length<=8,"Polygon shape must have 3-8 vertices"),y.length<3||y.length>8)return;d=o.createFixture(new u.Polygon(y),a);break}}a.crossSide&&(d==null||d.setUserData({crossSide:a.crossSide}))}var ws=(i,t,e,s)=>{for(var r=t,o=i.length-1,a;o>=0;o--)(a=i[o])&&(r=a(r)||r);return r};let Ht=class extends fe{constructor(i){super(),n(this,"_tempPos2D",{x:0,y:0}),n(this,"_joints",[]),n(this,"physics",window.physics),n(this,"body"),n(this,"rigidType","static"),n(this,"shapes",[]),n(this,"joints",[]),n(this,"category",""),n(this,"isSensor",!1),n(this,"friction",.2),n(this,"restitution",0),n(this,"onCollisionStart"),n(this,"onCollisionEnd"),n(this,"_categoryAccepted"),console.assert(this.physics!==void 0,"physics not init"),this.body=this.physics.world.createBody({active:!1,type:"kinematic",fixedRotation:!0}),i&&this.setProps(i)}get categoryAccepted(){return this._categoryAccepted}set categoryAccepted(i){typeof i=="string"?this._categoryAccepted=i.split(/[,，]/):this._categoryAccepted=i}get angularVelocity(){return this.body.getAngularVelocity()}set angularVelocity(i){this.body.setAngularVelocity(i)}get angularDamping(){return this.body.getAngularDamping()}set angularDamping(i){this.body.setAngularDamping(i)}get gravityScale(){return this.body.getGravityScale()}set gravityScale(i){this.body.setGravityScale(i)}get linearVelocity(){return this.body.getLinearVelocity()}set linearVelocity(i){this.body.setLinearVelocity(i)}get linearDamping(){return this.body.getLinearDamping()}set linearDamping(i){this.body.setLinearDamping(i)}get bullet(){return this.body.isBullet()}set bullet(i){this.body.setBullet(i)}get allowRotation(){return!this.body.isFixedRotation()}set allowRotation(i){this.body.setFixedRotation(!i)}get allowSleeping(){return this.body.isSleepingAllowed()}set allowSleeping(i){this.body.setSleepingAllowed(i)}get sleeping(){return!this.body.isAwake()}set sleeping(i){this.body.setAwake(!i)}get mass(){return this.body.getMass()}onAwake(){const i=this.body,t=this.target;if(this.rigidType==="dynamic"?i.setDynamic():this.rigidType==="static"&&i.setStatic(),this.shapes.length)for(const r of this.shapes)Wt(this,r);else Wt(this,{shapeType:"box"});const e=B.TEMP.set(0,0),s=t.localToWorld(e,e,this.scene);if(i.setPosition(this.physics.toPhPos(s)),i.setAngle(t.rotation),i.setActive(!0),i.setUserData(this),(this.onCollisionStart||this.onCollisionEnd)&&this._registerCollisionEvent(),this.joints.length)for(const r of this.joints){const o=bs(this,r);o==null||o.setUserData(r.label),o&&this._joints.push(o)}}_registerCollisionEvent(){this.onCollisionStart&&this.target.on(_.collisionStart,this.onCollisionStart,this),this.onCollisionEnd&&this.target.on(_.collisionEnd,this.onCollisionEnd,this)}onUpdate(){if(this.rigidType==="static")return;const i=this.target,t=this.body.getPosition();let e=this.physics.to2DPos(t,this._tempPos2D);if(!this.physics.inBoundaryArea(e)){this.target.destroy();return}if(this.target.parent!==this.scene&&(e=this.target.parent.worldToLocal(e,e,this.scene)),this.allowRotation){const h=this.body.getAngle();i.rotation=h%tt}const s=i.pivot.x*i.scale.x,r=i.pivot.y*i.scale.y;if(i.rotation===0){i.pos.set(e.x+s,e.y+r);return}const o=Math.cos(i.rotation),a=Math.sin(i.rotation);i.pos.set(e.x+(s*o-r*a),e.y+(s*a+r*o))}onEnable(){this.body.setActive(!0)}onDisable(){this.body.setActive(!1)}setPosition(i,t){let e={x:i,y:t};this.target.parent!==this.scene&&(e=this.target.parent.localToWorld(e,e,this.scene)),this.body.setPosition(this.physics.toPhPos(e)),this.rigidType!=="static"&&this.body.setAwake(!0)}getPosition(){const i=this.body.getPosition();return this.physics.to2DPos(i,i)}getRotation(){return this.body.getAngle()%tt}setRotation(i){this.body.setAngle(i),this.target.rotation=i,this.rigidType!=="static"&&this.body.setAwake(!0)}setLinearVelocity(i,t){this.body.setLinearVelocity({x:i??this.linearVelocity.x,y:t??this.linearVelocity.y})}applyLinearImpulse(i,t={x:0,y:0}){console.assert(this.rigidType==="dynamic","applyLinearImpulse only works on dynamic bodies"),this.body.applyLinearImpulse(i,t,!0)}applyForce(i,t={x:0,y:0}){console.assert(this.rigidType==="dynamic","applyForce only works on dynamic bodies"),this.body.applyForce(i,t,!0)}applyForceToCenter(i){console.assert(this.rigidType==="dynamic","applyForceToCenter only works on dynamic bodies"),this.body.applyForceToCenter(i,!0)}applyTorque(i){console.assert(this.rigidType==="dynamic"&&this.allowRotation,"applyTorque only works on dynamic bodies with allowRotation enabled"),this.body.applyTorque(i,!0)}applyAngularImpulse(i){console.assert(this.rigidType==="dynamic"&&this.allowRotation,"applyAngularImpulse only works on dynamic bodies with allowRotation enabled"),this.body.applyAngularImpulse(i,!0)}destroyJoint(i){const t=this._joints.find(e=>e.getUserData()===i);t&&(this.physics.world.destroyJoint(t),this._joints=this._joints.filter(e=>e!==t))}onDestroy(){for(const i of this._joints)this.physics.world.destroyJoint(i);this.physics.world.destroyBody(this.body)}};Ht=ws([Be("RigidBody")],Ht);export{$,Cs as A,Ts as C,Ms as D,Ut as J,F as L,St as M,R as N,Ps as T,Yt as W,Is as Z,_,dt as a,Ds as b,ye as d,I as k,Xt as q,Ht as t,b as v,Pe as x,se as y};
