import{k as ws}from"./liko.es-CzfWaBAJ.js";import"./index-Bu-paSGE.js";var kn=Object.defineProperty,Dn=(i,t,e)=>t in i?kn(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e,St=(i,t,e)=>Dn(i,typeof t!="symbol"?t+"":t,e);/**
 * Planck.js v1.3.0
 * @license The MIT license
 * @copyright Copyright (c) 2024 Erin Catto, Ali Shakiba
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *//*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */var hs=function(i,t){return hs=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,o){e.__proto__=o}||function(e,o){for(var s in o)Object.prototype.hasOwnProperty.call(o,s)&&(e[s]=o[s])},hs(i,t)};function xt(i,t){if(typeof t!="function"&&t!==null)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");hs(i,t);function e(){this.constructor=i}i.prototype=t===null?Object.create(t):(e.prototype=t.prototype,new e)}var vt=function(){return vt=Object.assign||function(i){for(var t,e=1,o=arguments.length;e<o;e++){t=arguments[e];for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&(i[s]=t[s])}return i},vt.apply(this,arguments)},Nt=function(i,t){(i===null||typeof i>"u")&&(i={});var e=vt({},i);for(var o in t)t.hasOwnProperty(o)&&typeof i[o]>"u"&&(e[o]=t[o]);if(typeof Object.getOwnPropertySymbols=="function")for(var s=Object.getOwnPropertySymbols(t),r=0;r<s.length;r++){var n=s[r];t.propertyIsEnumerable(n)&&typeof i[n]>"u"&&(e[n]=t[n])}return e},Rn=Math.random,It=1e-9,jn=Number.isFinite;function On(i){return i|=i>>1,i|=i>>2,i|=i>>4,i|=i>>8,i|=i>>16,i+1}function En(i){return i>0&&(i&i-1)===0}function yn(i,t,e){return typeof t>"u"?(e=1,t=0):typeof e>"u"&&(e=t,t=0),e>t?(i=(i-t)%(e-t),i+(i<0?e:t)):(i=(i-e)%(t-e),i+(i<=0?t:e))}function pt(i,t,e){return i<t?t:i>e?e:i}function Jn(i,t){return typeof i>"u"?(t=1,i=0):typeof t>"u"&&(t=i,i=0),i===t?i:Rn()*(t-i)+i}var we=Object.create(Math);we.EPSILON=It;we.isFinite=jn;we.nextPowerOfTwo=On;we.isPowerOfTwo=En;we.mod=yn;we.clamp=pt;we.random=Jn;var Vs=Math.abs,Yo=Math.sqrt,Cs=Math.max,Ms=Math.min,a=function(){function i(t,e){if(!(this instanceof i))return new i(t,e);typeof t>"u"?(this.x=0,this.y=0):typeof t=="object"?(this.x=t.x,this.y=t.y):(this.x=t,this.y=e)}return i.prototype._serialize=function(){return{x:this.x,y:this.y}},i._deserialize=function(t){var e=Object.create(i.prototype);return e.x=t.x,e.y=t.y,e},i.zero=function(){var t=Object.create(i.prototype);return t.x=0,t.y=0,t},i.neo=function(t,e){var o=Object.create(i.prototype);return o.x=t,o.y=e,o},i.clone=function(t){return i.neo(t.x,t.y)},i.prototype.toString=function(){return JSON.stringify(this)},i.isValid=function(t){return t===null||typeof t>"u"?!1:Number.isFinite(t.x)&&Number.isFinite(t.y)},i.assert=function(t){},i.prototype.clone=function(){return i.clone(this)},i.prototype.setZero=function(){return this.x=0,this.y=0,this},i.prototype.set=function(t,e){return typeof t=="object"?(this.x=t.x,this.y=t.y):(this.x=t,this.y=e),this},i.prototype.setNum=function(t,e){return this.x=t,this.y=e,this},i.prototype.setVec2=function(t){return this.x=t.x,this.y=t.y,this},i.prototype.wSet=function(t,e,o,s){return typeof o<"u"||typeof s<"u"?this.setCombine(t,e,o,s):this.setMul(t,e)},i.prototype.setCombine=function(t,e,o,s){var r=t*e.x+o*s.x,n=t*e.y+o*s.y;return this.x=r,this.y=n,this},i.prototype.setMul=function(t,e){var o=t*e.x,s=t*e.y;return this.x=o,this.y=s,this},i.prototype.add=function(t){return this.x+=t.x,this.y+=t.y,this},i.prototype.wAdd=function(t,e,o,s){return typeof o<"u"||typeof s<"u"?this.addCombine(t,e,o,s):this.addMul(t,e)},i.prototype.addCombine=function(t,e,o,s){var r=t*e.x+o*s.x,n=t*e.y+o*s.y;return this.x+=r,this.y+=n,this},i.prototype.addMul=function(t,e){var o=t*e.x,s=t*e.y;return this.x+=o,this.y+=s,this},i.prototype.wSub=function(t,e,o,s){return typeof o<"u"||typeof s<"u"?this.subCombine(t,e,o,s):this.subMul(t,e)},i.prototype.subCombine=function(t,e,o,s){var r=t*e.x+o*s.x,n=t*e.y+o*s.y;return this.x-=r,this.y-=n,this},i.prototype.subMul=function(t,e){var o=t*e.x,s=t*e.y;return this.x-=o,this.y-=s,this},i.prototype.sub=function(t){return this.x-=t.x,this.y-=t.y,this},i.prototype.mul=function(t){return this.x*=t,this.y*=t,this},i.prototype.length=function(){return i.lengthOf(this)},i.prototype.lengthSquared=function(){return i.lengthSquared(this)},i.prototype.normalize=function(){var t=this.length();if(t<It)return 0;var e=1/t;return this.x*=e,this.y*=e,t},i.normalize=function(t){var e=i.lengthOf(t);if(e<It)return i.zero();var o=1/e;return i.neo(t.x*o,t.y*o)},i.lengthOf=function(t){return Yo(t.x*t.x+t.y*t.y)},i.lengthSquared=function(t){return t.x*t.x+t.y*t.y},i.distance=function(t,e){var o=t.x-e.x,s=t.y-e.y;return Yo(o*o+s*s)},i.distanceSquared=function(t,e){var o=t.x-e.x,s=t.y-e.y;return o*o+s*s},i.areEqual=function(t,e){return t===e||typeof e=="object"&&e!==null&&t.x===e.x&&t.y===e.y},i.skew=function(t){return i.neo(-t.y,t.x)},i.dot=function(t,e){return t.x*e.x+t.y*e.y},i.cross=function(t,e){return typeof e=="number"?i.neo(e*t.y,-e*t.x):typeof t=="number"?i.neo(-t*e.y,t*e.x):t.x*e.y-t.y*e.x},i.crossVec2Vec2=function(t,e){return t.x*e.y-t.y*e.x},i.crossVec2Num=function(t,e){return i.neo(e*t.y,-e*t.x)},i.crossNumVec2=function(t,e){return i.neo(-t*e.y,t*e.x)},i.addCross=function(t,e,o){if(typeof o=="number")return i.neo(o*e.y+t.x,-o*e.x+t.y);if(typeof e=="number")return i.neo(-e*o.y+t.x,e*o.x+t.y)},i.addCrossVec2Num=function(t,e,o){return i.neo(o*e.y+t.x,-o*e.x+t.y)},i.addCrossNumVec2=function(t,e,o){return i.neo(-e*o.y+t.x,e*o.x+t.y)},i.add=function(t,e){return i.neo(t.x+e.x,t.y+e.y)},i.wAdd=function(t,e,o,s){return typeof o<"u"||typeof s<"u"?i.combine(t,e,o,s):i.mulNumVec2(t,e)},i.combine=function(t,e,o,s){return i.zero().setCombine(t,e,o,s)},i.sub=function(t,e){return i.neo(t.x-e.x,t.y-e.y)},i.mul=function(t,e){if(typeof t=="object")return i.neo(t.x*e,t.y*e);if(typeof e=="object")return i.neo(t*e.x,t*e.y)},i.mulVec2Num=function(t,e){return i.neo(t.x*e,t.y*e)},i.mulNumVec2=function(t,e){return i.neo(t*e.x,t*e.y)},i.prototype.neg=function(){return this.x=-this.x,this.y=-this.y,this},i.neg=function(t){return i.neo(-t.x,-t.y)},i.abs=function(t){return i.neo(Vs(t.x),Vs(t.y))},i.mid=function(t,e){return i.neo((t.x+e.x)*.5,(t.y+e.y)*.5)},i.upper=function(t,e){return i.neo(Cs(t.x,e.x),Cs(t.y,e.y))},i.lower=function(t,e){return i.neo(Ms(t.x,e.x),Ms(t.y,e.y))},i.prototype.clamp=function(t){var e=this.x*this.x+this.y*this.y;if(e>t*t){var o=t/Yo(e);this.x*=o,this.y*=o}return this},i.clamp=function(t,e){var o=i.neo(t.x,t.y);return o.clamp(e),o},i.clampVec2=function(t,e,o){return{x:pt(t.x,e==null?void 0:e.x,o==null?void 0:o.x),y:pt(t.y,e==null?void 0:e.y,o==null?void 0:o.y)}},i.scaleFn=function(t,e){return function(o){return i.neo(o.x*t,o.y*e)}},i.translateFn=function(t,e){return function(o){return i.neo(o.x+t,o.y+e)}},i}(),Dt=Math.max,Ht=Math.min,ht=function(){function i(t,e){if(!(this instanceof i))return new i(t,e);this.lowerBound=a.zero(),this.upperBound=a.zero(),typeof t=="object"&&this.lowerBound.setVec2(t),typeof e=="object"?this.upperBound.setVec2(e):typeof t=="object"&&this.upperBound.setVec2(t)}return i.prototype.isValid=function(){return i.isValid(this)},i.isValid=function(t){return t===null||typeof t>"u"?!1:a.isValid(t.lowerBound)&&a.isValid(t.upperBound)&&a.sub(t.upperBound,t.lowerBound).lengthSquared()>=0},i.assert=function(t){},i.prototype.getCenter=function(){return a.neo((this.lowerBound.x+this.upperBound.x)*.5,(this.lowerBound.y+this.upperBound.y)*.5)},i.prototype.getExtents=function(){return a.neo((this.upperBound.x-this.lowerBound.x)*.5,(this.upperBound.y-this.lowerBound.y)*.5)},i.prototype.getPerimeter=function(){return 2*(this.upperBound.x-this.lowerBound.x+this.upperBound.y-this.lowerBound.y)},i.prototype.combine=function(t,e){e=e||this;var o=t.lowerBound,s=t.upperBound,r=e.lowerBound,n=e.upperBound,m=Ht(o.x,r.x),h=Ht(o.y,r.y),u=Dt(n.x,s.x),l=Dt(n.y,s.y);this.lowerBound.setNum(m,h),this.upperBound.setNum(u,l)},i.prototype.combinePoints=function(t,e){this.lowerBound.setNum(Ht(t.x,e.x),Ht(t.y,e.y)),this.upperBound.setNum(Dt(t.x,e.x),Dt(t.y,e.y))},i.prototype.set=function(t){this.lowerBound.setNum(t.lowerBound.x,t.lowerBound.y),this.upperBound.setNum(t.upperBound.x,t.upperBound.y)},i.prototype.contains=function(t){var e=!0;return e=e&&this.lowerBound.x<=t.lowerBound.x,e=e&&this.lowerBound.y<=t.lowerBound.y,e=e&&t.upperBound.x<=this.upperBound.x,e=e&&t.upperBound.y<=this.upperBound.y,e},i.prototype.extend=function(t){return i.extend(this,t),this},i.extend=function(t,e){return t.lowerBound.x-=e,t.lowerBound.y-=e,t.upperBound.x+=e,t.upperBound.y+=e,t},i.testOverlap=function(t,e){var o=e.lowerBound.x-t.upperBound.x,s=t.lowerBound.x-e.upperBound.x,r=e.lowerBound.y-t.upperBound.y,n=t.lowerBound.y-e.upperBound.y;return!(o>0||r>0||s>0||n>0)},i.areEqual=function(t,e){return a.areEqual(t.lowerBound,e.lowerBound)&&a.areEqual(t.upperBound,e.upperBound)},i.diff=function(t,e){var o=Dt(0,Ht(t.upperBound.x,e.upperBound.x)-Dt(e.lowerBound.x,t.lowerBound.x)),s=Dt(0,Ht(t.upperBound.y,e.upperBound.y)-Dt(e.lowerBound.y,t.lowerBound.y)),r=t.upperBound.x-t.lowerBound.x,n=t.upperBound.y-t.lowerBound.y,m=e.upperBound.x-e.lowerBound.x,h=e.upperBound.y-e.lowerBound.y;return r*n+m*h-o*s},i.prototype.rayCast=function(t,e){for(var o=-1/0,s=1/0,r=e.p1,n=a.sub(e.p2,e.p1),m=a.abs(n),h=a.zero(),u="x";u!==null;u=u==="x"?"y":null)if(m.x<It){if(r[u]<this.lowerBound[u]||this.upperBound[u]<r[u])return!1}else{var l=1/n[u],p=(this.lowerBound[u]-r[u])*l,c=(this.upperBound[u]-r[u])*l,_=-1;if(p>c){var d=p;p=c,c=d,_=1}if(p>o&&(h.setZero(),h[u]=_,o=p),s=Ht(s,c),o>s)return!1}return o<0||e.maxFraction<o?!1:(t.fraction=o,t.normal=h,!0)},i.prototype.toString=function(){return JSON.stringify(this)},i.combinePoints=function(t,e,o){return t.lowerBound.x=Ht(e.x,o.x),t.lowerBound.y=Ht(e.y,o.y),t.upperBound.x=Dt(e.x,o.x),t.upperBound.y=Dt(e.y,o.y),t},i.combinedPerimeter=function(t,e){var o=Ht(t.lowerBound.x,e.lowerBound.x),s=Ht(t.lowerBound.y,e.lowerBound.y),r=Dt(t.upperBound.x,e.upperBound.x),n=Dt(t.upperBound.y,e.upperBound.y);return 2*(r-o+n-s)},i}(),ji=Math.PI,D=function(){function i(){}return Object.defineProperty(i,"polygonRadius",{get:function(){return 2*i.linearSlop},enumerable:!1,configurable:!0}),i.lengthUnitsPerMeter=1,i.maxManifoldPoints=2,i.maxPolygonVertices=12,i.aabbExtension=.1,i.aabbMultiplier=2,i.linearSlop=.005,i.angularSlop=2/180*ji,i.maxSubSteps=8,i.maxTOIContacts=32,i.maxTOIIterations=20,i.maxDistanceIterations=20,i.velocityThreshold=1,i.maxLinearCorrection=.2,i.maxAngularCorrection=8/180*ji,i.maxTranslation=2,i.maxRotation=.5*ji,i.baumgarte=.2,i.toiBaugarte=.75,i.timeToSleep=.5,i.linearSleepTolerance=.01,i.angularSleepTolerance=2/180*ji,i}(),P=function(){function i(){}return Object.defineProperty(i,"maxManifoldPoints",{get:function(){return D.maxManifoldPoints},enumerable:!1,configurable:!0}),Object.defineProperty(i,"maxPolygonVertices",{get:function(){return D.maxPolygonVertices},enumerable:!1,configurable:!0}),Object.defineProperty(i,"aabbExtension",{get:function(){return D.aabbExtension*D.lengthUnitsPerMeter},enumerable:!1,configurable:!0}),Object.defineProperty(i,"aabbMultiplier",{get:function(){return D.aabbMultiplier},enumerable:!1,configurable:!0}),Object.defineProperty(i,"linearSlop",{get:function(){return D.linearSlop*D.lengthUnitsPerMeter},enumerable:!1,configurable:!0}),Object.defineProperty(i,"linearSlopSquared",{get:function(){return D.linearSlop*D.lengthUnitsPerMeter*D.linearSlop*D.lengthUnitsPerMeter},enumerable:!1,configurable:!0}),Object.defineProperty(i,"angularSlop",{get:function(){return D.angularSlop},enumerable:!1,configurable:!0}),Object.defineProperty(i,"polygonRadius",{get:function(){return 2*D.linearSlop},enumerable:!1,configurable:!0}),Object.defineProperty(i,"maxSubSteps",{get:function(){return D.maxSubSteps},enumerable:!1,configurable:!0}),Object.defineProperty(i,"maxTOIContacts",{get:function(){return D.maxTOIContacts},enumerable:!1,configurable:!0}),Object.defineProperty(i,"maxTOIIterations",{get:function(){return D.maxTOIIterations},enumerable:!1,configurable:!0}),Object.defineProperty(i,"maxDistanceIterations",{get:function(){return D.maxDistanceIterations},enumerable:!1,configurable:!0}),Object.defineProperty(i,"velocityThreshold",{get:function(){return D.velocityThreshold*D.lengthUnitsPerMeter},enumerable:!1,configurable:!0}),Object.defineProperty(i,"maxLinearCorrection",{get:function(){return D.maxLinearCorrection*D.lengthUnitsPerMeter},enumerable:!1,configurable:!0}),Object.defineProperty(i,"maxAngularCorrection",{get:function(){return D.maxAngularCorrection},enumerable:!1,configurable:!0}),Object.defineProperty(i,"maxTranslation",{get:function(){return D.maxTranslation*D.lengthUnitsPerMeter},enumerable:!1,configurable:!0}),Object.defineProperty(i,"maxTranslationSquared",{get:function(){return D.maxTranslation*D.lengthUnitsPerMeter*D.maxTranslation*D.lengthUnitsPerMeter},enumerable:!1,configurable:!0}),Object.defineProperty(i,"maxRotation",{get:function(){return D.maxRotation},enumerable:!1,configurable:!0}),Object.defineProperty(i,"maxRotationSquared",{get:function(){return D.maxRotation*D.maxRotation},enumerable:!1,configurable:!0}),Object.defineProperty(i,"baumgarte",{get:function(){return D.baumgarte},enumerable:!1,configurable:!0}),Object.defineProperty(i,"toiBaugarte",{get:function(){return D.toiBaugarte},enumerable:!1,configurable:!0}),Object.defineProperty(i,"timeToSleep",{get:function(){return D.timeToSleep},enumerable:!1,configurable:!0}),Object.defineProperty(i,"linearSleepTolerance",{get:function(){return D.linearSleepTolerance*D.lengthUnitsPerMeter},enumerable:!1,configurable:!0}),Object.defineProperty(i,"linearSleepToleranceSqr",{get:function(){return D.linearSleepTolerance*D.lengthUnitsPerMeter*D.linearSleepTolerance*D.lengthUnitsPerMeter},enumerable:!1,configurable:!0}),Object.defineProperty(i,"angularSleepTolerance",{get:function(){return D.angularSleepTolerance},enumerable:!1,configurable:!0}),Object.defineProperty(i,"angularSleepToleranceSqr",{get:function(){return D.angularSleepTolerance*D.angularSleepTolerance},enumerable:!1,configurable:!0}),i}(),zi=function(){function i(t){this._list=[],this._max=1/0,this._hasCreateFn=!1,this._createCount=0,this._hasAllocateFn=!1,this._allocateCount=0,this._hasReleaseFn=!1,this._releaseCount=0,this._hasDisposeFn=!1,this._disposeCount=0,this._list=[],this._max=t.max||this._max,this._createFn=t.create,this._hasCreateFn=typeof this._createFn=="function",this._allocateFn=t.allocate,this._hasAllocateFn=typeof this._allocateFn=="function",this._releaseFn=t.release,this._hasReleaseFn=typeof this._releaseFn=="function",this._disposeFn=t.dispose,this._hasDisposeFn=typeof this._disposeFn=="function"}return i.prototype.max=function(t){return typeof t=="number"?(this._max=t,this):this._max},i.prototype.size=function(){return this._list.length},i.prototype.allocate=function(){var t;return this._list.length>0?t=this._list.shift():(this._createCount++,this._hasCreateFn?t=this._createFn():t={}),this._allocateCount++,this._hasAllocateFn&&this._allocateFn(t),t},i.prototype.release=function(t){this._list.length<this._max?(this._releaseCount++,this._hasReleaseFn&&this._releaseFn(t),this._list.push(t)):(this._disposeCount++,this._hasDisposeFn&&(t=this._disposeFn(t)))},i.prototype.toString=function(){return" +"+this._createCount+" >"+this._allocateCount+" <"+this._releaseCount+" -"+this._disposeCount+" ="+this._list.length+"/"+this._max},i}(),Is=Math.abs,zt=Math.max,cs=function(){function i(t){this.aabb=new ht,this.userData=null,this.parent=null,this.child1=null,this.child2=null,this.height=-1,this.id=t}return i.prototype.toString=function(){return this.id+": "+this.userData},i.prototype.isLeaf=function(){return this.child1==null},i}(),Ps=new zi({create:function(){return new cs},release:function(i){i.userData=null,i.parent=null,i.child1=null,i.child2=null,i.height=-1,i.id=void 0}}),To=function(){function i(){this.inputPool=new zi({create:function(){return{}},release:function(t){}}),this.stackPool=new zi({create:function(){return[]},release:function(t){t.length=0}}),this.iteratorPool=new zi({create:function(){return new Yn},release:function(t){t.close()}}),this.m_root=null,this.m_nodes={},this.m_lastProxyId=0}return i.prototype.getUserData=function(t){var e=this.m_nodes[t];return e.userData},i.prototype.getFatAABB=function(t){var e=this.m_nodes[t];return e.aabb},i.prototype.allocateNode=function(){var t=Ps.allocate();return t.id=++this.m_lastProxyId,this.m_nodes[t.id]=t,t},i.prototype.freeNode=function(t){delete this.m_nodes[t.id],Ps.release(t)},i.prototype.createProxy=function(t,e){var o=this.allocateNode();return o.aabb.set(t),ht.extend(o.aabb,P.aabbExtension),o.userData=e,o.height=0,this.insertLeaf(o),o.id},i.prototype.destroyProxy=function(t){var e=this.m_nodes[t];this.removeLeaf(e),this.freeNode(e)},i.prototype.moveProxy=function(t,e,o){var s=this.m_nodes[t];return s.aabb.contains(e)?!1:(this.removeLeaf(s),s.aabb.set(e),e=s.aabb,ht.extend(e,P.aabbExtension),o.x<0?e.lowerBound.x+=o.x*P.aabbMultiplier:e.upperBound.x+=o.x*P.aabbMultiplier,o.y<0?e.lowerBound.y+=o.y*P.aabbMultiplier:e.upperBound.y+=o.y*P.aabbMultiplier,this.insertLeaf(s),!0)},i.prototype.insertLeaf=function(t){if(this.m_root==null){this.m_root=t,this.m_root.parent=null;return}for(var e=t.aabb,o=this.m_root;!o.isLeaf();){var s=o.child1,r=o.child2,n=o.aabb.getPerimeter(),m=ht.combinedPerimeter(o.aabb,e),h=2*m,u=2*(m-n),l=ht.combinedPerimeter(e,s.aabb),p=l+u;if(!s.isLeaf()){var c=s.aabb.getPerimeter();p-=c}var _=ht.combinedPerimeter(e,r.aabb),d=_+u;if(!r.isLeaf()){var c=r.aabb.getPerimeter();d-=c}if(h<p&&h<d)break;p<d?o=s:o=r}var y=o,f=y.parent,v=this.allocateNode();for(v.parent=f,v.userData=null,v.aabb.combine(e,y.aabb),v.height=y.height+1,f!=null?(f.child1===y?f.child1=v:f.child2=v,v.child1=y,v.child2=t,y.parent=v,t.parent=v):(v.child1=y,v.child2=t,y.parent=v,t.parent=v,this.m_root=v),o=t.parent;o!=null;){o=this.balance(o);var s=o.child1,r=o.child2;o.height=1+zt(s.height,r.height),o.aabb.combine(s.aabb,r.aabb),o=o.parent}},i.prototype.removeLeaf=function(t){if(t===this.m_root){this.m_root=null;return}var e=t.parent,o=e.parent,s;if(e.child1===t?s=e.child2:s=e.child1,o!=null){o.child1===e?o.child1=s:o.child2=s,s.parent=o,this.freeNode(e);for(var r=o;r!=null;){r=this.balance(r);var n=r.child1,m=r.child2;r.aabb.combine(n.aabb,m.aabb),r.height=1+zt(n.height,m.height),r=r.parent}}else this.m_root=s,s.parent=null,this.freeNode(e)},i.prototype.balance=function(t){var e=t;if(e.isLeaf()||e.height<2)return t;var o=e.child1,s=e.child2,r=s.height-o.height;if(r>1){var n=s.child1,m=s.child2;return s.child1=e,s.parent=e.parent,e.parent=s,s.parent!=null?s.parent.child1===t?s.parent.child1=s:s.parent.child2=s:this.m_root=s,n.height>m.height?(s.child2=n,e.child2=m,m.parent=e,e.aabb.combine(o.aabb,m.aabb),s.aabb.combine(e.aabb,n.aabb),e.height=1+zt(o.height,m.height),s.height=1+zt(e.height,n.height)):(s.child2=m,e.child2=n,n.parent=e,e.aabb.combine(o.aabb,n.aabb),s.aabb.combine(e.aabb,m.aabb),e.height=1+zt(o.height,n.height),s.height=1+zt(e.height,m.height)),s}if(r<-1){var h=o.child1,u=o.child2;return o.child1=e,o.parent=e.parent,e.parent=o,o.parent!=null?o.parent.child1===e?o.parent.child1=o:o.parent.child2=o:this.m_root=o,h.height>u.height?(o.child2=h,e.child1=u,u.parent=e,e.aabb.combine(s.aabb,u.aabb),o.aabb.combine(e.aabb,h.aabb),e.height=1+zt(s.height,u.height),o.height=1+zt(e.height,h.height)):(o.child2=u,e.child1=h,h.parent=e,e.aabb.combine(s.aabb,h.aabb),o.aabb.combine(e.aabb,u.aabb),e.height=1+zt(s.height,h.height),o.height=1+zt(e.height,u.height)),o}return e},i.prototype.getHeight=function(){return this.m_root==null?0:this.m_root.height},i.prototype.getAreaRatio=function(){if(this.m_root==null)return 0;for(var t=this.m_root,e=t.aabb.getPerimeter(),o=0,s,r=this.iteratorPool.allocate().preorder(this.m_root);s=r.next();)s.height<0||(o+=s.aabb.getPerimeter());return this.iteratorPool.release(r),o/e},i.prototype.computeHeight=function(t){var e;if(typeof t<"u"?e=this.m_nodes[t]:e=this.m_root,e.isLeaf())return 0;var o=this.computeHeight(e.child1.id),s=this.computeHeight(e.child2.id);return 1+zt(o,s)},i.prototype.validateStructure=function(t){if(t!=null){this.m_root;var e=t.child1,o=t.child2;t.isLeaf()||(this.validateStructure(e),this.validateStructure(o))}},i.prototype.validateMetrics=function(t){if(t!=null){var e=t.child1,o=t.child2;if(!t.isLeaf()){e.height,o.height;var s=new ht;s.combine(e.aabb,o.aabb),this.validateMetrics(e),this.validateMetrics(o)}}},i.prototype.validate=function(){},i.prototype.getMaxBalance=function(){for(var t=0,e,o=this.iteratorPool.allocate().preorder(this.m_root);e=o.next();)if(!(e.height<=1)){var s=Is(e.child2.height-e.child1.height);t=zt(t,s)}return this.iteratorPool.release(o),t},i.prototype.rebuildBottomUp=function(){for(var t=[],e=0,o,s=this.iteratorPool.allocate().preorder(this.m_root);o=s.next();)o.height<0||(o.isLeaf()?(o.parent=null,t[e]=o,++e):this.freeNode(o));for(this.iteratorPool.release(s);e>1;){for(var r=1/0,n=-1,m=-1,h=0;h<e;++h)for(var u=t[h].aabb,l=h+1;l<e;++l){var p=t[l].aabb,c=ht.combinedPerimeter(u,p);c<r&&(n=h,m=l,r=c)}var _=t[n],d=t[m],y=this.allocateNode();y.child1=_,y.child2=d,y.height=1+zt(_.height,d.height),y.aabb.combine(_.aabb,d.aabb),y.parent=null,_.parent=y,d.parent=y,t[m]=t[e-1],t[n]=y,--e}this.m_root=t[0]},i.prototype.shiftOrigin=function(t){for(var e,o=this.iteratorPool.allocate().preorder(this.m_root);e=o.next();){var s=e.aabb;s.lowerBound.x-=t.x,s.lowerBound.y-=t.y,s.upperBound.x-=t.x,s.upperBound.y-=t.y}this.iteratorPool.release(o)},i.prototype.query=function(t,e){var o=this.stackPool.allocate();for(o.push(this.m_root);o.length>0;){var s=o.pop();if(s!=null&&ht.testOverlap(s.aabb,t))if(s.isLeaf()){var r=e(s.id);if(r===!1)return}else o.push(s.child1),o.push(s.child2)}this.stackPool.release(o)},i.prototype.rayCast=function(t,e){var o=t.p1,s=t.p2,r=a.sub(s,o);r.normalize();var n=a.crossNumVec2(1,r),m=a.abs(n),h=t.maxFraction,u=new ht,l=a.combine(1-h,o,h,s);u.combinePoints(o,l);var p=this.stackPool.allocate(),c=this.inputPool.allocate();for(p.push(this.m_root);p.length>0;){var _=p.pop();if(_!=null&&ht.testOverlap(_.aabb,u)!==!1){var d=_.aabb.getCenter(),y=_.aabb.getExtents(),f=Is(a.dot(n,a.sub(o,d)))-a.dot(m,y);if(!(f>0))if(_.isLeaf()){c.p1=a.clone(t.p1),c.p2=a.clone(t.p2),c.maxFraction=h;var v=e(c,_.id);if(v===0)break;v>0&&(h=v,l=a.combine(1-h,o,h,s),u.combinePoints(o,l))}else p.push(_.child1),p.push(_.child2)}}this.stackPool.release(p),this.inputPool.release(c)},i}(),Yn=function(){function i(){this.parents=[],this.states=[]}return i.prototype.preorder=function(t){return this.parents.length=0,this.parents.push(t),this.states.length=0,this.states.push(0),this},i.prototype.next=function(){for(;this.parents.length>0;){var t=this.parents.length-1,e=this.parents[t];if(this.states[t]===0)return this.states[t]=1,e;if(this.states[t]===1&&(this.states[t]=2,e.child1))return this.parents.push(e.child1),this.states.push(1),e.child1;if(this.states[t]===2&&(this.states[t]=3,e.child2))return this.parents.push(e.child2),this.states.push(1),e.child2;this.parents.pop(),this.states.pop()}},i.prototype.close=function(){this.parents.length=0},i}(),Wn=Math.max,Un=Math.min,ls=function(){function i(){var t=this;this.m_tree=new To,this.m_moveBuffer=[],this.query=function(e,o){t.m_tree.query(e,o)},this.queryCallback=function(e){if(e===t.m_queryProxyId)return!0;var o=Un(e,t.m_queryProxyId),s=Wn(e,t.m_queryProxyId),r=t.m_tree.getUserData(o),n=t.m_tree.getUserData(s);return t.m_callback(r,n),!0}}return i.prototype.getUserData=function(t){return this.m_tree.getUserData(t)},i.prototype.testOverlap=function(t,e){var o=this.m_tree.getFatAABB(t),s=this.m_tree.getFatAABB(e);return ht.testOverlap(o,s)},i.prototype.getFatAABB=function(t){return this.m_tree.getFatAABB(t)},i.prototype.getProxyCount=function(){return this.m_moveBuffer.length},i.prototype.getTreeHeight=function(){return this.m_tree.getHeight()},i.prototype.getTreeBalance=function(){return this.m_tree.getMaxBalance()},i.prototype.getTreeQuality=function(){return this.m_tree.getAreaRatio()},i.prototype.rayCast=function(t,e){this.m_tree.rayCast(t,e)},i.prototype.shiftOrigin=function(t){this.m_tree.shiftOrigin(t)},i.prototype.createProxy=function(t,e){var o=this.m_tree.createProxy(t,e);return this.bufferMove(o),o},i.prototype.destroyProxy=function(t){this.unbufferMove(t),this.m_tree.destroyProxy(t)},i.prototype.moveProxy=function(t,e,o){var s=this.m_tree.moveProxy(t,e,o);s&&this.bufferMove(t)},i.prototype.touchProxy=function(t){this.bufferMove(t)},i.prototype.bufferMove=function(t){this.m_moveBuffer.push(t)},i.prototype.unbufferMove=function(t){for(var e=0;e<this.m_moveBuffer.length;++e)this.m_moveBuffer[e]===t&&(this.m_moveBuffer[e]=null)},i.prototype.updatePairs=function(t){for(this.m_callback=t;this.m_moveBuffer.length>0;)if(this.m_queryProxyId=this.m_moveBuffer.pop(),this.m_queryProxyId!==null){var e=this.m_tree.getFatAABB(this.m_queryProxyId);this.m_tree.query(e,this.queryCallback)}},i}(),dn=Math.sin,fn=Math.cos,_s=Math.sqrt;function A(i,t){return{x:i,y:t}}function Hn(i){return{s:dn(i),c:fn(i)}}function ut(i,t,e){return i.x=t,i.y=e,i}function x(i,t){return i.x=t.x,i.y=t.y,i}function z(i){return i.x=0,i.y=0,i}function Ti(i){return i.x=-i.x,i.y=-i.y,i}function Jt(i,t){return i.x+=t.x,i.y+=t.y,i}function Zn(i,t,e){return i.x=t.x+e.x,i.y=t.x+e.y,i}function ge(i,t){return i.x-=t.x,i.y-=t.y,i}function N(i,t,e){return i.x=t.x-e.x,i.y=t.y-e.y,i}function Ss(i,t){return i.x*=t,i.y*=t,i}function L(i,t,e){return i.x=t*e.x,i.y=t*e.y,i}function Qt(i,t,e){return i.x+=t*e.x,i.y+=t*e.y,i}function Si(i,t,e){return i.x-=t*e.x,i.y-=t*e.y,i}function Q(i,t,e,o,s){return i.x=t*e.x+o*s.x,i.y=t*e.y+o*s.y,i}function ae(i,t,e,o,s,r,n){return i.x=t*e.x+o*s.x+r*n.x,i.y=t*e.y+o*s.y+r*n.y,i}function Kn(i){var t=_s(i.x*i.x+i.y*i.y);if(t!==0){var e=1/t;i.x*=e,i.y*=e}return t}function $t(i){var t=_s(i.x*i.x+i.y*i.y);if(t>0){var e=1/t;i.x*=e,i.y*=e}return i}function He(i,t,e){var o=e*t.y,s=-1*t.x;return i.x=o,i.y=s,i}function Ft(i,t,e){var o=-t*e.y,s=t*e.x;return i.x=o,i.y=s,i}function j(i,t){return i.x*t.y-i.y*t.x}function C(i,t){return i.x*t.x+i.y*t.y}function Ze(i){return i.x*i.x+i.y*i.y}function vn(i,t){var e=i.x-t.x,o=i.y-t.y;return _s(e*e+o*o)}function Ke(i,t){var e=i.x-t.x,o=i.y-t.y;return e*e+o*o}function Xn(i,t){return i.c=fn(t),i.s=dn(t),i}function Yt(i,t,e){return i.x=t.c*e.x-t.s*e.y,i.y=t.s*e.x+t.c*e.y,i}function yi(i,t,e){var o=t.c*e.x+t.s*e.y,s=-t.s*e.x+t.c*e.y;return i.x=o,i.y=s,i}function Gn(i,t,e,o){var s=t.c*o.x+t.s*o.y,r=-t.s*o.x+t.c*o.y,n=e.c*s-e.s*r,m=e.s*s+e.c*r;return i.x=n,i.y=m,i}function Qe(i,t,e){return{p:A(i,t),q:Hn(e)}}function po(i,t){return i.p.x=t.p.x,i.p.y=t.p.y,i.q.s=t.q.s,i.q.c=t.q.c,i}function q(i,t,e){var o=t.q.c*e.x-t.q.s*e.y+t.p.x,s=t.q.s*e.x+t.q.c*e.y+t.p.y;return i.x=o,i.y=s,i}function us(i,t,e){var o=e.x-t.p.x,s=e.y-t.p.y,r=t.q.c*o+t.q.s*s,n=-t.q.s*o+t.q.c*s;return i.x=r,i.y=n,i}function xn(i,t,e,o){var s=t.q.c*o.x-t.q.s*o.y+t.p.x,r=t.q.s*o.x+t.q.c*o.y+t.p.y,n=s-e.p.x,m=r-e.p.y,h=e.q.c*n+e.q.s*m,u=-e.q.s*n+e.q.c*m;return i.x=h,i.y=u,i}function gn(i,t,e){var o=t.q.c*e.q.c+t.q.s*e.q.s,s=t.q.c*e.q.s-t.q.s*e.q.c,r=t.q.c*(e.p.x-t.p.x)+t.q.s*(e.p.y-t.p.y),n=-t.q.s*(e.p.x-t.p.x)+t.q.c*(e.p.y-t.p.y);return i.q.c=o,i.q.s=s,i.p.x=r,i.p.y=n,i}var zs=Math.sin,Ls=Math.cos,Qn=Math.atan2,b=function(){function i(t){if(!(this instanceof i))return new i(t);typeof t=="number"?this.setAngle(t):typeof t=="object"?this.setRot(t):this.setIdentity()}return i.neo=function(t){var e=Object.create(i.prototype);return e.setAngle(t),e},i.clone=function(t){var e=Object.create(i.prototype);return e.s=t.s,e.c=t.c,e},i.identity=function(){var t=Object.create(i.prototype);return t.s=0,t.c=1,t},i.isValid=function(t){return t===null||typeof t>"u"?!1:Number.isFinite(t.s)&&Number.isFinite(t.c)},i.assert=function(t){},i.prototype.setIdentity=function(){this.s=0,this.c=1},i.prototype.set=function(t){typeof t=="object"?(this.s=t.s,this.c=t.c):(this.s=zs(t),this.c=Ls(t))},i.prototype.setRot=function(t){this.s=t.s,this.c=t.c},i.prototype.setAngle=function(t){this.s=zs(t),this.c=Ls(t)},i.prototype.getAngle=function(){return Qn(this.s,this.c)},i.prototype.getXAxis=function(){return a.neo(this.c,this.s)},i.prototype.getYAxis=function(){return a.neo(-this.s,this.c)},i.mul=function(t,e){if("c"in e&&"s"in e){var o=i.identity();return o.s=t.s*e.c+t.c*e.s,o.c=t.c*e.c-t.s*e.s,o}else if("x"in e&&"y"in e)return a.neo(t.c*e.x-t.s*e.y,t.s*e.x+t.c*e.y)},i.mulRot=function(t,e){var o=i.identity();return o.s=t.s*e.c+t.c*e.s,o.c=t.c*e.c-t.s*e.s,o},i.mulVec2=function(t,e){return a.neo(t.c*e.x-t.s*e.y,t.s*e.x+t.c*e.y)},i.mulSub=function(t,e,o){var s=t.c*(e.x-o.x)-t.s*(e.y-o.y),r=t.s*(e.x-o.x)+t.c*(e.y-o.y);return a.neo(s,r)},i.mulT=function(t,e){if("c"in e&&"s"in e){var o=i.identity();return o.s=t.c*e.s-t.s*e.c,o.c=t.c*e.c+t.s*e.s,o}else if("x"in e&&"y"in e)return a.neo(t.c*e.x+t.s*e.y,-t.s*e.x+t.c*e.y)},i.mulTRot=function(t,e){var o=i.identity();return o.s=t.c*e.s-t.s*e.c,o.c=t.c*e.c+t.s*e.s,o},i.mulTVec2=function(t,e){return a.neo(t.c*e.x+t.s*e.y,-t.s*e.x+t.c*e.y)},i}(),$n=Math.atan2,Ts=Math.PI,qe=A(0,0),be=function(){function i(){this.localCenter=a.zero(),this.c=a.zero(),this.a=0,this.alpha0=0,this.c0=a.zero(),this.a0=0}return i.prototype.recycle=function(){z(this.localCenter),z(this.c),this.a=0,this.alpha0=0,z(this.c0),this.a0=0},i.prototype.setTransform=function(t){q(qe,t,this.localCenter),x(this.c,qe),x(this.c0,qe),this.a=this.a0=$n(t.q.s,t.q.c)},i.prototype.setLocalCenter=function(t,e){x(this.localCenter,t),q(qe,e,this.localCenter),x(this.c,qe),x(this.c0,qe)},i.prototype.getTransform=function(t,e){e===void 0&&(e=0),Xn(t.q,(1-e)*this.a0+e*this.a),Q(t.p,1-e,this.c0,e,this.c),ge(t.p,Yt(qe,t.q,this.localCenter))},i.prototype.advance=function(t){var e=(t-this.alpha0)/(1-this.alpha0);Q(this.c0,e,this.c,1-e,this.c0),this.a0=e*this.a+(1-e)*this.a0,this.alpha0=t},i.prototype.forward=function(){this.a0=this.a,x(this.c0,this.c)},i.prototype.normalize=function(){var t=yn(this.a0,-Ts,+Ts);this.a-=this.a0-t,this.a0=t},i.prototype.set=function(t){x(this.localCenter,t.localCenter),x(this.c,t.c),this.a=t.a,this.alpha0=t.alpha0,x(this.c0,t.c0),this.a0=t.a0},i}(),ft=function(){function i(t,e){if(!(this instanceof i))return new i(t,e);this.p=a.zero(),this.q=b.identity(),typeof t<"u"&&this.p.setVec2(t),typeof e<"u"&&this.q.setAngle(e)}return i.clone=function(t){var e=Object.create(i.prototype);return e.p=a.clone(t.p),e.q=b.clone(t.q),e},i.neo=function(t,e){var o=Object.create(i.prototype);return o.p=a.clone(t),o.q=b.clone(e),o},i.identity=function(){var t=Object.create(i.prototype);return t.p=a.zero(),t.q=b.identity(),t},i.prototype.setIdentity=function(){this.p.setZero(),this.q.setIdentity()},i.prototype.set=function(t,e){typeof e>"u"?(this.p.set(t.p),this.q.set(t.q)):(this.p.set(t),this.q.set(e))},i.prototype.setNum=function(t,e){this.p.setVec2(t),this.q.setAngle(e)},i.prototype.setTransform=function(t){this.p.setVec2(t.p),this.q.setRot(t.q)},i.isValid=function(t){return t===null||typeof t>"u"?!1:a.isValid(t.p)&&b.isValid(t.q)},i.assert=function(t){},i.mul=function(t,e){if(Array.isArray(e)){for(var o=[],s=0;s<e.length;s++)o[s]=i.mul(t,e[s]);return o}else{if("x"in e&&"y"in e)return i.mulVec2(t,e);if("p"in e&&"q"in e)return i.mulXf(t,e)}},i.mulAll=function(t,e){for(var o=[],s=0;s<e.length;s++)o[s]=i.mul(t,e[s]);return o},i.mulFn=function(t){return function(e){return i.mul(t,e)}},i.mulVec2=function(t,e){var o=t.q.c*e.x-t.q.s*e.y+t.p.x,s=t.q.s*e.x+t.q.c*e.y+t.p.y;return a.neo(o,s)},i.mulXf=function(t,e){var o=i.identity();return o.q=b.mulRot(t.q,e.q),o.p=a.add(b.mulVec2(t.q,e.p),t.p),o},i.mulT=function(t,e){if("x"in e&&"y"in e)return i.mulTVec2(t,e);if("p"in e&&"q"in e)return i.mulTXf(t,e)},i.mulTVec2=function(t,e){var o=e.x-t.p.x,s=e.y-t.p.y,r=t.q.c*o+t.q.s*s,n=-t.q.s*o+t.q.c*s;return a.neo(r,n)},i.mulTXf=function(t,e){var o=i.identity();return o.q.setRot(b.mulTRot(t.q,e.q)),o.p.setVec2(b.mulTVec2(t.q,a.sub(e.p,t.p))),o},i}(),tr=function(){function i(){this.v=a.zero(),this.w=0}return i}(),An=Math.sin,bn=Math.cos,er=function(){function i(){this.c=a.zero(),this.a=0}return i.prototype.getTransform=function(t,e){return t.q.c=bn(this.a),t.q.s=An(this.a),t.p.x=this.c.x-(t.q.c*e.x-t.q.s*e.y),t.p.y=this.c.y-(t.q.s*e.x+t.q.c*e.y),t},i}();function Oi(i,t,e,o){return i.q.c=bn(o),i.q.s=An(o),i.p.x=e.x-(i.q.c*t.x-i.q.s*t.y),i.p.y=e.y-(i.q.s*t.x+i.q.c*t.y),i}var Ve=function(){function i(){this.style={},this.appData={}}return i.isValid=function(t){return t===null||typeof t>"u"?!1:typeof t.m_type=="string"&&typeof t.m_radius=="number"},i}(),Fs=new ht,qs=new ht,Ns=A(0,0),ir={userData:null,friction:.2,restitution:0,density:0,isSensor:!1,filterGroupIndex:0,filterCategoryBits:1,filterMaskBits:65535},yo=function(){function i(t,e){this.aabb=new ht,this.fixture=t,this.childIndex=e}return i}(),di=function(){function i(t,e,o){this.style={},this.appData={},e.shape?(o=e,e=e.shape):typeof o=="number"&&(o={density:o}),o=Nt(o,ir),this.m_body=t,this.m_friction=o.friction,this.m_restitution=o.restitution,this.m_density=o.density,this.m_isSensor=o.isSensor,this.m_filterGroupIndex=o.filterGroupIndex,this.m_filterCategoryBits=o.filterCategoryBits,this.m_filterMaskBits=o.filterMaskBits,this.m_shape=e,this.m_next=null,this.m_proxies=[],this.m_proxyCount=0;for(var s=this.m_shape.getChildCount(),r=0;r<s;++r)this.m_proxies[r]=new yo(this,r);this.m_userData=o.userData,typeof o.style=="object"&&o.style!==null&&(this.style=o.style)}return i.prototype._reset=function(){var t=this.getBody(),e=t.m_world.m_broadPhase;this.destroyProxies(e),this.m_shape._reset&&this.m_shape._reset();for(var o=this.m_shape.getChildCount(),s=0;s<o;++s)this.m_proxies[s]=new yo(this,s);this.createProxies(e,t.m_xf),t.resetMassData()},i.prototype._serialize=function(){return{friction:this.m_friction,restitution:this.m_restitution,density:this.m_density,isSensor:this.m_isSensor,filterGroupIndex:this.m_filterGroupIndex,filterCategoryBits:this.m_filterCategoryBits,filterMaskBits:this.m_filterMaskBits,shape:this.m_shape}},i._deserialize=function(t,e,o){var s=o(Ve,t.shape),r=s&&new i(e,s,t);return r},i.prototype.getType=function(){return this.m_shape.m_type},i.prototype.getShape=function(){return this.m_shape},i.prototype.isSensor=function(){return this.m_isSensor},i.prototype.setSensor=function(t){t!=this.m_isSensor&&(this.m_body.setAwake(!0),this.m_isSensor=t)},i.prototype.getUserData=function(){return this.m_userData},i.prototype.setUserData=function(t){this.m_userData=t},i.prototype.getBody=function(){return this.m_body},i.prototype.getNext=function(){return this.m_next},i.prototype.getDensity=function(){return this.m_density},i.prototype.setDensity=function(t){this.m_density=t},i.prototype.getFriction=function(){return this.m_friction},i.prototype.setFriction=function(t){this.m_friction=t},i.prototype.getRestitution=function(){return this.m_restitution},i.prototype.setRestitution=function(t){this.m_restitution=t},i.prototype.testPoint=function(t){return this.m_shape.testPoint(this.m_body.getTransform(),t)},i.prototype.rayCast=function(t,e,o){return this.m_shape.rayCast(t,e,this.m_body.getTransform(),o)},i.prototype.getMassData=function(t){this.m_shape.computeMass(t,this.m_density)},i.prototype.getAABB=function(t){return this.m_proxies[t].aabb},i.prototype.createProxies=function(t,e){this.m_proxyCount=this.m_shape.getChildCount();for(var o=0;o<this.m_proxyCount;++o){var s=this.m_proxies[o];this.m_shape.computeAABB(s.aabb,e,o),s.proxyId=t.createProxy(s.aabb,s)}},i.prototype.destroyProxies=function(t){for(var e=0;e<this.m_proxyCount;++e){var o=this.m_proxies[e];t.destroyProxy(o.proxyId),o.proxyId=null}this.m_proxyCount=0},i.prototype.synchronize=function(t,e,o){for(var s=0;s<this.m_proxyCount;++s){var r=this.m_proxies[s];this.m_shape.computeAABB(Fs,e,r.childIndex),this.m_shape.computeAABB(qs,o,r.childIndex),r.aabb.combine(Fs,qs),N(Ns,o.p,e.p),t.moveProxy(r.proxyId,r.aabb,Ns)}},i.prototype.setFilterData=function(t){this.m_filterGroupIndex=t.groupIndex,this.m_filterCategoryBits=t.categoryBits,this.m_filterMaskBits=t.maskBits,this.refilter()},i.prototype.getFilterGroupIndex=function(){return this.m_filterGroupIndex},i.prototype.setFilterGroupIndex=function(t){this.m_filterGroupIndex=t,this.refilter()},i.prototype.getFilterCategoryBits=function(){return this.m_filterCategoryBits},i.prototype.setFilterCategoryBits=function(t){this.m_filterCategoryBits=t,this.refilter()},i.prototype.getFilterMaskBits=function(){return this.m_filterMaskBits},i.prototype.setFilterMaskBits=function(t){this.m_filterMaskBits=t,this.refilter()},i.prototype.refilter=function(){if(this.m_body!=null){for(var t=this.m_body.getContactList();t;){var e=t.contact,o=e.getFixtureA(),s=e.getFixtureB();(o==this||s==this)&&e.flagForFiltering(),t=t.next}var r=this.m_body.getWorld();if(r!=null)for(var n=r.m_broadPhase,m=0;m<this.m_proxyCount;++m)n.touchProxy(this.m_proxies[m].proxyId)}},i.prototype.shouldCollide=function(t){if(t.m_filterGroupIndex===this.m_filterGroupIndex&&t.m_filterGroupIndex!==0)return t.m_filterGroupIndex>0;var e=(t.m_filterMaskBits&this.m_filterCategoryBits)!==0,o=(t.m_filterCategoryBits&this.m_filterMaskBits)!==0,s=e&&o;return s},i}(),pi="static",ks="kinematic",Zt="dynamic",Ei=A(0,0),Ne=A(0,0),Ji=A(0,0),Yi=A(0,0),Ds=Qe(0,0,0),or={type:pi,position:a.zero(),angle:0,linearVelocity:a.zero(),angularVelocity:0,linearDamping:0,angularDamping:0,fixedRotation:!1,bullet:!1,gravityScale:1,allowSleep:!0,awake:!0,active:!0,userData:null},W=function(){function i(t,e){this.style={},this.appData={},e=Nt(e,or),this.m_world=t,this.m_awakeFlag=e.awake,this.m_autoSleepFlag=e.allowSleep,this.m_bulletFlag=e.bullet,this.m_fixedRotationFlag=e.fixedRotation,this.m_activeFlag=e.active,this.m_islandFlag=!1,this.m_toiFlag=!1,this.m_userData=e.userData,this.m_type=e.type,this.m_type==Zt?(this.m_mass=1,this.m_invMass=1):(this.m_mass=0,this.m_invMass=0),this.m_I=0,this.m_invI=0,this.m_xf=ft.identity(),this.m_xf.p.setVec2(e.position),this.m_xf.q.setAngle(e.angle),this.m_sweep=new be,this.m_sweep.setTransform(this.m_xf),this.c_velocity=new tr,this.c_position=new er,this.m_force=a.zero(),this.m_torque=0,this.m_linearVelocity=a.clone(e.linearVelocity),this.m_angularVelocity=e.angularVelocity,this.m_linearDamping=e.linearDamping,this.m_angularDamping=e.angularDamping,this.m_gravityScale=e.gravityScale,this.m_sleepTime=0,this.m_jointList=null,this.m_contactList=null,this.m_fixtureList=null,this.m_prev=null,this.m_next=null,this.m_destroyed=!1,typeof e.style=="object"&&e.style!==null&&(this.style=e.style)}return i.prototype._serialize=function(){for(var t=[],e=this.m_fixtureList;e;e=e.m_next)t.push(e);return{type:this.m_type,bullet:this.m_bulletFlag,position:this.m_xf.p,angle:this.m_xf.q.getAngle(),linearVelocity:this.m_linearVelocity,angularVelocity:this.m_angularVelocity,fixtures:t}},i._deserialize=function(t,e,o){var s=new i(e,t);if(t.fixtures)for(var r=t.fixtures.length-1;r>=0;r--){var n=o(di,t.fixtures[r],s);s._addFixture(n)}return s},i.prototype.isWorldLocked=function(){return!!(this.m_world&&this.m_world.isLocked())},i.prototype.getWorld=function(){return this.m_world},i.prototype.getNext=function(){return this.m_next},i.prototype.setUserData=function(t){this.m_userData=t},i.prototype.getUserData=function(){return this.m_userData},i.prototype.getFixtureList=function(){return this.m_fixtureList},i.prototype.getJointList=function(){return this.m_jointList},i.prototype.getContactList=function(){return this.m_contactList},i.prototype.isStatic=function(){return this.m_type==pi},i.prototype.isDynamic=function(){return this.m_type==Zt},i.prototype.isKinematic=function(){return this.m_type==ks},i.prototype.setStatic=function(){return this.setType(pi),this},i.prototype.setDynamic=function(){return this.setType(Zt),this},i.prototype.setKinematic=function(){return this.setType(ks),this},i.prototype.getType=function(){return this.m_type},i.prototype.setType=function(t){if(this.isWorldLocked()!=!0&&this.m_type!=t){this.m_type=t,this.resetMassData(),this.m_type==pi&&(this.m_linearVelocity.setZero(),this.m_angularVelocity=0,this.m_sweep.forward(),this.synchronizeFixtures()),this.setAwake(!0),this.m_force.setZero(),this.m_torque=0;for(var e=this.m_contactList;e;){var o=e;e=e.next,this.m_world.destroyContact(o.contact)}this.m_contactList=null;for(var s=this.m_world.m_broadPhase,r=this.m_fixtureList;r;r=r.m_next)for(var n=0;n<r.m_proxyCount;++n)s.touchProxy(r.m_proxies[n].proxyId)}},i.prototype.isBullet=function(){return this.m_bulletFlag},i.prototype.setBullet=function(t){this.m_bulletFlag=!!t},i.prototype.isSleepingAllowed=function(){return this.m_autoSleepFlag},i.prototype.setSleepingAllowed=function(t){this.m_autoSleepFlag=!!t,this.m_autoSleepFlag==!1&&this.setAwake(!0)},i.prototype.isAwake=function(){return this.m_awakeFlag},i.prototype.setAwake=function(t){t?(this.m_awakeFlag=!0,this.m_sleepTime=0):(this.m_awakeFlag=!1,this.m_sleepTime=0,this.m_linearVelocity.setZero(),this.m_angularVelocity=0,this.m_force.setZero(),this.m_torque=0)},i.prototype.isActive=function(){return this.m_activeFlag},i.prototype.setActive=function(t){if(t!=this.m_activeFlag)if(this.m_activeFlag=!!t,this.m_activeFlag){for(var e=this.m_world.m_broadPhase,o=this.m_fixtureList;o;o=o.m_next)o.createProxies(e,this.m_xf);this.m_world.m_newFixture=!0}else{for(var e=this.m_world.m_broadPhase,o=this.m_fixtureList;o;o=o.m_next)o.destroyProxies(e);for(var s=this.m_contactList;s;){var r=s;s=s.next,this.m_world.destroyContact(r.contact)}this.m_contactList=null}},i.prototype.isFixedRotation=function(){return this.m_fixedRotationFlag},i.prototype.setFixedRotation=function(t){this.m_fixedRotationFlag!=t&&(this.m_fixedRotationFlag=!!t,this.m_angularVelocity=0,this.resetMassData())},i.prototype.getTransform=function(){return this.m_xf},i.prototype.setTransform=function(t,e){if(this.isWorldLocked()!=!0){typeof e=="number"?this.m_xf.setNum(t,e):this.m_xf.setTransform(t),this.m_sweep.setTransform(this.m_xf);for(var o=this.m_world.m_broadPhase,s=this.m_fixtureList;s;s=s.m_next)s.synchronize(o,this.m_xf,this.m_xf);this.setAwake(!0)}},i.prototype.synchronizeTransform=function(){this.m_sweep.getTransform(this.m_xf,1)},i.prototype.synchronizeFixtures=function(){this.m_sweep.getTransform(Ds,0);for(var t=this.m_world.m_broadPhase,e=this.m_fixtureList;e;e=e.m_next)e.synchronize(t,Ds,this.m_xf)},i.prototype.advance=function(t){this.m_sweep.advance(t),x(this.m_sweep.c,this.m_sweep.c0),this.m_sweep.a=this.m_sweep.a0,this.m_sweep.getTransform(this.m_xf,1)},i.prototype.getPosition=function(){return this.m_xf.p},i.prototype.setPosition=function(t){this.setTransform(t,this.m_sweep.a)},i.prototype.getAngle=function(){return this.m_sweep.a},i.prototype.setAngle=function(t){this.setTransform(this.m_xf.p,t)},i.prototype.getWorldCenter=function(){return this.m_sweep.c},i.prototype.getLocalCenter=function(){return this.m_sweep.localCenter},i.prototype.getLinearVelocity=function(){return this.m_linearVelocity},i.prototype.getLinearVelocityFromWorldPoint=function(t){var e=a.sub(t,this.m_sweep.c);return a.add(this.m_linearVelocity,a.crossNumVec2(this.m_angularVelocity,e))},i.prototype.getLinearVelocityFromLocalPoint=function(t){return this.getLinearVelocityFromWorldPoint(this.getWorldPoint(t))},i.prototype.setLinearVelocity=function(t){this.m_type!=pi&&(a.dot(t,t)>0&&this.setAwake(!0),this.m_linearVelocity.setVec2(t))},i.prototype.getAngularVelocity=function(){return this.m_angularVelocity},i.prototype.setAngularVelocity=function(t){this.m_type!=pi&&(t*t>0&&this.setAwake(!0),this.m_angularVelocity=t)},i.prototype.getLinearDamping=function(){return this.m_linearDamping},i.prototype.setLinearDamping=function(t){this.m_linearDamping=t},i.prototype.getAngularDamping=function(){return this.m_angularDamping},i.prototype.setAngularDamping=function(t){this.m_angularDamping=t},i.prototype.getGravityScale=function(){return this.m_gravityScale},i.prototype.setGravityScale=function(t){this.m_gravityScale=t},i.prototype.getMass=function(){return this.m_mass},i.prototype.getInertia=function(){return this.m_I+this.m_mass*a.dot(this.m_sweep.localCenter,this.m_sweep.localCenter)},i.prototype.getMassData=function(t){t.mass=this.m_mass,t.I=this.getInertia(),x(t.center,this.m_sweep.localCenter)},i.prototype.resetMassData=function(){if(this.m_mass=0,this.m_invMass=0,this.m_I=0,this.m_invI=0,z(this.m_sweep.localCenter),this.isStatic()||this.isKinematic()){x(this.m_sweep.c0,this.m_xf.p),x(this.m_sweep.c,this.m_xf.p),this.m_sweep.a0=this.m_sweep.a;return}z(Ne);for(var t=this.m_fixtureList;t;t=t.m_next)if(t.m_density!=0){var e={mass:0,center:A(0,0),I:0};t.getMassData(e),this.m_mass+=e.mass,Qt(Ne,e.mass,e.center),this.m_I+=e.I}this.m_mass>0?(this.m_invMass=1/this.m_mass,L(Ne,this.m_invMass,Ne)):(this.m_mass=1,this.m_invMass=1),this.m_I>0&&this.m_fixedRotationFlag==!1?(this.m_I-=this.m_mass*C(Ne,Ne),this.m_invI=1/this.m_I):(this.m_I=0,this.m_invI=0),x(Ei,this.m_sweep.c),this.m_sweep.setLocalCenter(Ne,this.m_xf),N(Ji,this.m_sweep.c,Ei),Ft(Yi,this.m_angularVelocity,Ji),Jt(this.m_linearVelocity,Yi)},i.prototype.setMassData=function(t){this.isWorldLocked()!=!0&&this.m_type==Zt&&(this.m_invMass=0,this.m_I=0,this.m_invI=0,this.m_mass=t.mass,this.m_mass<=0&&(this.m_mass=1),this.m_invMass=1/this.m_mass,t.I>0&&this.m_fixedRotationFlag==!1&&(this.m_I=t.I-this.m_mass*C(t.center,t.center),this.m_invI=1/this.m_I),x(Ei,this.m_sweep.c),this.m_sweep.setLocalCenter(t.center,this.m_xf),N(Ji,this.m_sweep.c,Ei),Ft(Yi,this.m_angularVelocity,Ji),Jt(this.m_linearVelocity,Yi))},i.prototype.applyForce=function(t,e,o){o===void 0&&(o=!0),this.m_type==Zt&&(o&&this.m_awakeFlag==!1&&this.setAwake(!0),this.m_awakeFlag&&(this.m_force.add(t),this.m_torque+=a.crossVec2Vec2(a.sub(e,this.m_sweep.c),t)))},i.prototype.applyForceToCenter=function(t,e){e===void 0&&(e=!0),this.m_type==Zt&&(e&&this.m_awakeFlag==!1&&this.setAwake(!0),this.m_awakeFlag&&this.m_force.add(t))},i.prototype.applyTorque=function(t,e){e===void 0&&(e=!0),this.m_type==Zt&&(e&&this.m_awakeFlag==!1&&this.setAwake(!0),this.m_awakeFlag&&(this.m_torque+=t))},i.prototype.applyLinearImpulse=function(t,e,o){o===void 0&&(o=!0),this.m_type==Zt&&(o&&this.m_awakeFlag==!1&&this.setAwake(!0),this.m_awakeFlag&&(this.m_linearVelocity.addMul(this.m_invMass,t),this.m_angularVelocity+=this.m_invI*a.crossVec2Vec2(a.sub(e,this.m_sweep.c),t)))},i.prototype.applyAngularImpulse=function(t,e){e===void 0&&(e=!0),this.m_type==Zt&&(e&&this.m_awakeFlag==!1&&this.setAwake(!0),this.m_awakeFlag&&(this.m_angularVelocity+=this.m_invI*t))},i.prototype.shouldCollide=function(t){if(this.m_type!=Zt&&t.m_type!=Zt)return!1;for(var e=this.m_jointList;e;e=e.next)if(e.other==t&&e.joint.m_collideConnected==!1)return!1;return!0},i.prototype._addFixture=function(t){if(this.isWorldLocked()==!0)return null;if(this.m_activeFlag){var e=this.m_world.m_broadPhase;t.createProxies(e,this.m_xf)}return t.m_next=this.m_fixtureList,this.m_fixtureList=t,t.m_density>0&&this.resetMassData(),this.m_world.m_newFixture=!0,t},i.prototype.createFixture=function(t,e){if(this.isWorldLocked()==!0)return null;var o=new di(this,t,e);return this._addFixture(o),o},i.prototype.destroyFixture=function(t){if(this.isWorldLocked()!=!0){if(this.m_fixtureList===t)this.m_fixtureList=t.m_next;else for(var e=this.m_fixtureList;e!=null;){if(e.m_next===t){e.m_next=t.m_next;break}e=e.m_next}for(var o=this.m_contactList;o;){var s=o.contact;o=o.next;var r=s.getFixtureA(),n=s.getFixtureB();(t==r||t==n)&&this.m_world.destroyContact(s)}if(this.m_activeFlag){var m=this.m_world.m_broadPhase;t.destroyProxies(m)}t.m_body=null,t.m_next=null,this.m_world.publish("remove-fixture",t),this.resetMassData()}},i.prototype.getWorldPoint=function(t){return ft.mulVec2(this.m_xf,t)},i.prototype.getWorldVector=function(t){return b.mulVec2(this.m_xf.q,t)},i.prototype.getLocalPoint=function(t){return ft.mulTVec2(this.m_xf,t)},i.prototype.getLocalVector=function(t){return b.mulTVec2(this.m_xf.q,t)},i.STATIC="static",i.KINEMATIC="kinematic",i.DYNAMIC="dynamic",i}(),fo=function(){function i(){this.other=null,this.joint=null,this.prev=null,this.next=null}return i}(),yt=function(){function i(t,e,o){this.m_type="unknown-joint",this.m_prev=null,this.m_next=null,this.m_edgeA=new fo,this.m_edgeB=new fo,this.m_islandFlag=!1,this.style={},this.appData={},e="bodyA"in t?t.bodyA:e,o="bodyB"in t?t.bodyB:o,this.m_bodyA=e,this.m_bodyB=o,this.m_collideConnected=!!t.collideConnected,this.m_userData=t.userData,typeof t.style=="object"&&t.style!==null&&(this.style=t.style)}return i.prototype.isActive=function(){return this.m_bodyA.isActive()&&this.m_bodyB.isActive()},i.prototype.getType=function(){return this.m_type},i.prototype.getBodyA=function(){return this.m_bodyA},i.prototype.getBodyB=function(){return this.m_bodyB},i.prototype.getNext=function(){return this.m_next},i.prototype.getUserData=function(){return this.m_userData},i.prototype.setUserData=function(t){this.m_userData=t},i.prototype.getCollideConnected=function(){return this.m_collideConnected},i.prototype.shiftOrigin=function(t){},i.prototype._resetAnchors=function(t){return this._reset(t)},i}(),G={gjkCalls:0,gjkIters:0,gjkMaxIters:0,toiTime:0,toiMaxTime:0,toiCalls:0,toiIters:0,toiMaxIters:0,toiRootIters:0,toiMaxRootIters:0,toString:function(i){i=typeof i=="string"?i:`
`;var t="";for(var e in this)typeof this[e]!="function"&&typeof this[e]!="object"&&(t+=e+": "+this[e]+i);return t}},sr=function(){return Date.now()},nr=function(i){return Date.now()-i};const Rs={now:sr,diff:nr};var uo=Math.max,Wi=A(0,0),Ui=A(0,0),Lt=A(0,0),Hi=A(0,0),Wo=A(0,0),rr=A(0,0),ar=A(0,0);G.gjkCalls=0;G.gjkIters=0;G.gjkMaxIters=0;var Fi=function(){function i(){this.proxyA=new Be,this.proxyB=new Be,this.transformA=ft.identity(),this.transformB=ft.identity(),this.useRadii=!1}return i.prototype.recycle=function(){this.proxyA.recycle(),this.proxyB.recycle(),this.transformA.setIdentity(),this.transformB.setIdentity(),this.useRadii=!1},i}(),qi=function(){function i(){this.pointA=A(0,0),this.pointB=A(0,0),this.distance=0,this.iterations=0}return i.prototype.recycle=function(){z(this.pointA),z(this.pointB),this.distance=0,this.iterations=0},i}(),Ni=function(){function i(){this.metric=0,this.indexA=[],this.indexB=[],this.count=0}return i.prototype.recycle=function(){this.metric=0,this.indexA.length=0,this.indexB.length=0,this.count=0},i}(),_e=function(i,t,e){++G.gjkCalls;var o=e.proxyA,s=e.proxyB,r=e.transformA,n=e.transformB;Kt.recycle(),Kt.readCache(t,o,r,s,n);for(var m=Kt.m_v,h=P.maxDistanceIterations,u=[],l=[],p=0,c=0;c<h;){p=Kt.m_count;for(var _=0;_<p;++_)u[_]=m[_].indexA,l[_]=m[_].indexB;if(Kt.solve(),Kt.m_count===3)break;var d=Kt.getSearchDirection();if(Ze(d)<It*It)break;var y=m[Kt.m_count];y.indexA=o.getSupport(yi(Wi,r.q,L(Wi,-1,d))),q(y.wA,r,o.getVertex(y.indexA)),y.indexB=s.getSupport(yi(Wi,n.q,d)),q(y.wB,n,s.getVertex(y.indexB)),N(y.w,y.wB,y.wA),++c,++G.gjkIters;for(var f=!1,_=0;_<p;++_)if(y.indexA===u[_]&&y.indexB===l[_]){f=!0;break}if(f)break;++Kt.m_count}if(G.gjkMaxIters=uo(G.gjkMaxIters,c),Kt.getWitnessPoints(i.pointA,i.pointB),i.distance=vn(i.pointA,i.pointB),i.iterations=c,Kt.writeCache(t),e.useRadii){var v=o.m_radius,g=s.m_radius;if(i.distance>v+g&&i.distance>It)i.distance-=v+g,N(Ui,i.pointB,i.pointA),$t(Ui),Qt(i.pointA,v,Ui),Si(i.pointB,g,Ui);else{var B=N(Wi,i.pointA,i.pointB);x(i.pointA,B),x(i.pointB,B),i.distance=0}}},Be=function(){function i(){this.m_vertices=[],this.m_count=0,this.m_radius=0}return i.prototype.recycle=function(){this.m_vertices.length=0,this.m_count=0,this.m_radius=0},i.prototype.getVertexCount=function(){return this.m_count},i.prototype.getVertex=function(t){return this.m_vertices[t]},i.prototype.getSupport=function(t){for(var e=-1,o=-1/0,s=0;s<this.m_count;++s){var r=C(this.m_vertices[s],t);r>o&&(e=s,o=r)}return e},i.prototype.getSupportVertex=function(t){return this.m_vertices[this.getSupport(t)]},i.prototype.set=function(t,e){t.computeDistanceProxy(this,e)},i.prototype.setVertices=function(t,e,o){this.m_vertices=t,this.m_count=e,this.m_radius=o},i}(),Uo=function(){function i(){this.wA=A(0,0),this.indexA=0,this.wB=A(0,0),this.indexB=0,this.w=A(0,0),this.a=0}return i.prototype.recycle=function(){this.indexA=0,this.indexB=0,z(this.wA),z(this.wB),z(this.w),this.a=0},i.prototype.set=function(t){this.indexA=t.indexA,this.indexB=t.indexB,x(this.wA,t.wA),x(this.wB,t.wB),x(this.w,t.w),this.a=t.a},i}(),Zi=A(0,0),gi=A(0,0),Bn=function(){function i(){this.m_v1=new Uo,this.m_v2=new Uo,this.m_v3=new Uo,this.m_v=[this.m_v1,this.m_v2,this.m_v3]}return i.prototype.recycle=function(){this.m_v1.recycle(),this.m_v2.recycle(),this.m_v3.recycle(),this.m_count=0},i.prototype.toString=function(){return this.m_count===3?["+"+this.m_count,this.m_v1.a,this.m_v1.wA.x,this.m_v1.wA.y,this.m_v1.wB.x,this.m_v1.wB.y,this.m_v2.a,this.m_v2.wA.x,this.m_v2.wA.y,this.m_v2.wB.x,this.m_v2.wB.y,this.m_v3.a,this.m_v3.wA.x,this.m_v3.wA.y,this.m_v3.wB.x,this.m_v3.wB.y].toString():this.m_count===2?["+"+this.m_count,this.m_v1.a,this.m_v1.wA.x,this.m_v1.wA.y,this.m_v1.wB.x,this.m_v1.wB.y,this.m_v2.a,this.m_v2.wA.x,this.m_v2.wA.y,this.m_v2.wB.x,this.m_v2.wB.y].toString():this.m_count===1?["+"+this.m_count,this.m_v1.a,this.m_v1.wA.x,this.m_v1.wA.y,this.m_v1.wB.x,this.m_v1.wB.y].toString():"+"+this.m_count},i.prototype.readCache=function(t,e,o,s,r){this.m_count=t.count;for(var n=0;n<this.m_count;++n){var m=this.m_v[n];m.indexA=t.indexA[n],m.indexB=t.indexB[n];var h=e.getVertex(m.indexA),u=s.getVertex(m.indexB);q(m.wA,o,h),q(m.wB,r,u),N(m.w,m.wB,m.wA),m.a=0}if(this.m_count>1){var l=t.metric,p=this.getMetric();(p<.5*l||2*l<p||p<It)&&(this.m_count=0)}if(this.m_count===0){var m=this.m_v[0];m.indexA=0,m.indexB=0;var h=e.getVertex(0),u=s.getVertex(0);q(m.wA,o,h),q(m.wB,r,u),N(m.w,m.wB,m.wA),m.a=1,this.m_count=1}},i.prototype.writeCache=function(t){t.metric=this.getMetric(),t.count=this.m_count;for(var e=0;e<this.m_count;++e)t.indexA[e]=this.m_v[e].indexA,t.indexB[e]=this.m_v[e].indexB},i.prototype.getSearchDirection=function(){var t=this.m_v1,e=this.m_v2;switch(this.m_v3,this.m_count){case 1:return ut(Zi,-t.w.x,-t.w.y);case 2:{N(Lt,e.w,t.w);var o=-j(Lt,t.w);return o>0?ut(Zi,-Lt.y,Lt.x):ut(Zi,Lt.y,-Lt.x)}default:return z(Zi)}},i.prototype.getClosestPoint=function(){var t=this.m_v1,e=this.m_v2;switch(this.m_v3,this.m_count){case 0:return z(gi);case 1:return x(gi,t.w);case 2:return Q(gi,t.a,t.w,e.a,e.w);case 3:return z(gi);default:return z(gi)}},i.prototype.getWitnessPoints=function(t,e){var o=this.m_v1,s=this.m_v2,r=this.m_v3;switch(this.m_count){case 0:break;case 1:x(t,o.wA),x(e,o.wB);break;case 2:Q(t,o.a,o.wA,s.a,s.wA),Q(e,o.a,o.wB,s.a,s.wB);break;case 3:ae(t,o.a,o.wA,s.a,s.wA,r.a,r.wA),x(e,t);break}},i.prototype.getMetric=function(){switch(this.m_count){case 0:return 0;case 1:return 0;case 2:return vn(this.m_v1.w,this.m_v2.w);case 3:return j(N(rr,this.m_v2.w,this.m_v1.w),N(ar,this.m_v3.w,this.m_v1.w));default:return 0}},i.prototype.solve=function(){switch(this.m_count){case 1:break;case 2:this.solve2();break;case 3:this.solve3();break}},i.prototype.solve2=function(){var t=this.m_v1.w,e=this.m_v2.w;N(Lt,e,t);var o=-C(t,Lt);if(o<=0){this.m_v1.a=1,this.m_count=1;return}var s=C(e,Lt);if(s<=0){this.m_v2.a=1,this.m_count=1,this.m_v1.set(this.m_v2);return}var r=1/(s+o);this.m_v1.a=s*r,this.m_v2.a=o*r,this.m_count=2},i.prototype.solve3=function(){var t=this.m_v1.w,e=this.m_v2.w,o=this.m_v3.w;N(Lt,e,t);var s=C(t,Lt),r=C(e,Lt),n=r,m=-s;N(Hi,o,t);var h=C(t,Hi),u=C(o,Hi),l=u,p=-h;N(Wo,o,e);var c=C(e,Wo),_=C(o,Wo),d=_,y=-c,f=j(Lt,Hi),v=f*j(e,o),g=f*j(o,t),B=f*j(t,e);if(m<=0&&p<=0){this.m_v1.a=1,this.m_count=1;return}if(n>0&&m>0&&B<=0){var w=1/(n+m);this.m_v1.a=n*w,this.m_v2.a=m*w,this.m_count=2;return}if(l>0&&p>0&&g<=0){var V=1/(l+p);this.m_v1.a=l*V,this.m_v3.a=p*V,this.m_count=2,this.m_v2.set(this.m_v3);return}if(n<=0&&y<=0){this.m_v2.a=1,this.m_count=1,this.m_v1.set(this.m_v2);return}if(l<=0&&d<=0){this.m_v3.a=1,this.m_count=1,this.m_v1.set(this.m_v3);return}if(d>0&&y>0&&v<=0){var I=1/(d+y);this.m_v2.a=d*I,this.m_v3.a=y*I,this.m_count=2,this.m_v1.set(this.m_v3);return}var M=1/(v+g+B);this.m_v1.a=v*M,this.m_v2.a=g*M,this.m_v3.a=B*M,this.m_count=3},i}(),Kt=new Bn,ke=new Fi,js=new Ni,Ho=new qi,Fo=function(i,t,e,o,s,r){return ke.recycle(),ke.proxyA.set(i,t),ke.proxyB.set(e,o),po(ke.transformA,s),po(ke.transformB,r),ke.useRadii=!0,Ho.recycle(),js.recycle(),_e(Ho,js,ke),Ho.distance<10*It};_e.testOverlap=Fo;_e.Input=Fi;_e.Output=qi;_e.Proxy=Be;_e.Cache=Ni;var wn=function(){function i(){this.proxyA=new Be,this.proxyB=new Be,this.transformA=ft.identity(),this.transformB=ft.identity(),this.translationB=a.zero()}return i.prototype.recycle=function(){this.proxyA.recycle(),this.proxyB.recycle(),this.transformA.setIdentity(),this.transformB.setIdentity(),z(this.translationB)},i}(),Vn=function(){function i(){this.point=a.zero(),this.normal=a.zero(),this.lambda=1,this.iterations=0}return i}(),Cn=function(i,t){i.iterations=0,i.lambda=1,i.normal.setZero(),i.point.setZero();var e=t.proxyA,o=t.proxyB,s=uo(e.m_radius,P.polygonRadius),r=uo(o.m_radius,P.polygonRadius),n=s+r,m=t.transformA,h=t.transformB,u=t.translationB,l=a.zero(),p=0,c=new Bn;c.m_count=0;for(var _=c.m_v,d=e.getSupport(b.mulTVec2(m.q,a.neg(u))),y=ft.mulVec2(m,e.getVertex(d)),f=o.getSupport(b.mulTVec2(h.q,u)),v=ft.mulVec2(h,o.getVertex(f)),g=a.sub(y,v),B=uo(P.polygonRadius,n-P.polygonRadius),w=.5*P.linearSlop,V=20,I=0;I<V&&g.length()-B>w;){i.iterations+=1,d=e.getSupport(b.mulTVec2(m.q,a.neg(g))),y=ft.mulVec2(m,e.getVertex(d)),f=o.getSupport(b.mulTVec2(h.q,g)),v=ft.mulVec2(h,o.getVertex(f));var M=a.sub(y,v);g.normalize();var S=a.dot(g,M),k=a.dot(g,u);if(S-B>p*k){if(k<=0||(p=(S-B)/k,p>1))return!1;l.setMul(-1,g),c.m_count=0}var T=_[c.m_count];switch(T.indexA=f,T.wA=a.combine(1,v,p,u),T.indexB=d,T.wB=y,T.w=a.sub(T.wB,T.wA),T.a=1,c.m_count+=1,c.m_count){case 1:break;case 2:c.solve2();break;case 3:c.solve3();break}if(c.m_count==3)return!1;g.setVec2(c.getClosestPoint()),++I}if(I==0)return!1;var O=a.zero(),Y=a.zero();return c.getWitnessPoints(Y,O),g.lengthSquared()>0&&(l.setMul(-1,g),l.normalize()),i.point=a.combine(1,O,s,l),i.normal=l,i.lambda=p,i.iterations=I,!0},mr=Math.abs,Ki=Math.max,qo=function(){function i(){this.proxyA=new Be,this.proxyB=new Be,this.sweepA=new be,this.sweepB=new be}return i.prototype.recycle=function(){this.proxyA.recycle(),this.proxyB.recycle(),this.sweepA.recycle(),this.sweepB.recycle(),this.tMax=-1},i}(),Mt;(function(i){i[i.e_unset=-1]="e_unset",i[i.e_unknown=0]="e_unknown",i[i.e_failed=1]="e_failed",i[i.e_overlapped=2]="e_overlapped",i[i.e_touching=3]="e_touching",i[i.e_separated=4]="e_separated"})(Mt||(Mt={}));var No=function(){function i(){this.state=Mt.e_unset,this.t=-1}return i.prototype.recycle=function(){this.state=Mt.e_unset,this.t=-1},i}();G.toiTime=0;G.toiMaxTime=0;G.toiCalls=0;G.toiIters=0;G.toiMaxIters=0;G.toiRootIters=0;G.toiMaxRootIters=0;var ei=new Fi,Zo=new qi,Ko=new Ni,wt=Qe(0,0,0),Vt=Qe(0,0,0),Ai=A(0,0),ie=A(0,0),Rt=A(0,0),Bt=A(0,0),Xi=A(0,0),Gi=A(0,0),Qi=A(0,0),$i=A(0,0),fi=function(i,t){var e=Rs.now();++G.toiCalls,i.state=Mt.e_unknown,i.t=t.tMax;var o=t.proxyA,s=t.proxyB,r=t.sweepA,n=t.sweepB;r.normalize(),n.normalize();var m=t.tMax,h=o.m_radius+s.m_radius,u=Ki(P.linearSlop,h-3*P.linearSlop),l=.25*P.linearSlop,p=0,c=P.maxTOIIterations,_=0;for(Ko.recycle(),ei.proxyA.setVertices(o.m_vertices,o.m_count,o.m_radius),ei.proxyB.setVertices(s.m_vertices,s.m_count,s.m_radius),ei.useRadii=!1;;){if(r.getTransform(wt,p),n.getTransform(Vt,p),po(ei.transformA,wt),po(ei.transformB,Vt),_e(Zo,Ko,ei),Zo.distance<=0){i.state=Mt.e_overlapped,i.t=0;break}if(Zo.distance<u+l){i.state=Mt.e_touching,i.t=p;break}bi.initialize(Ko,o,r,s,n,p);for(var d=!1,y=m,f=0;;){var v=bi.findMinSeparation(y);if(v>u+l){i.state=Mt.e_separated,i.t=m,d=!0;break}if(v>u-l){p=y;break}var g=bi.evaluate(p);if(g<u-l){i.state=Mt.e_failed,i.t=p,d=!0;break}if(g<=u+l){i.state=Mt.e_touching,i.t=p,d=!0;break}for(var B=0,w=p,V=y;;){var I=void 0;B&1?I=w+(u-g)*(V-w)/(v-g):I=.5*(w+V),++B,++G.toiRootIters;var M=bi.evaluate(I);if(mr(M-u)<l){y=I;break}if(M>u?(w=I,g=M):(V=I,v=M),B===50)break}if(G.toiMaxRootIters=Ki(G.toiMaxRootIters,B),++f,f===P.maxPolygonVertices)break}if(++_,++G.toiIters,d)break;if(_===c){i.state=Mt.e_failed,i.t=p;break}}G.toiMaxIters=Ki(G.toiMaxIters,_);var S=Rs.diff(e);G.toiMaxTime=Ki(G.toiMaxTime,S),G.toiTime+=S,bi.recycle()},me;(function(i){i[i.e_unset=-1]="e_unset",i[i.e_points=1]="e_points",i[i.e_faceA=2]="e_faceA",i[i.e_faceB=3]="e_faceB"})(me||(me={}));var hr=function(){function i(){this.m_proxyA=null,this.m_proxyB=null,this.m_sweepA=null,this.m_sweepB=null,this.m_type=me.e_unset,this.m_localPoint=A(0,0),this.m_axis=A(0,0),this.indexA=-1,this.indexB=-1}return i.prototype.recycle=function(){this.m_proxyA=null,this.m_proxyB=null,this.m_sweepA=null,this.m_sweepB=null,this.m_type=me.e_unset,z(this.m_localPoint),z(this.m_axis),this.indexA=-1,this.indexB=-1},i.prototype.initialize=function(t,e,o,s,r,n){var m=t.count;if(this.m_proxyA=e,this.m_proxyB=s,this.m_sweepA=o,this.m_sweepB=r,this.m_sweepA.getTransform(wt,n),this.m_sweepB.getTransform(Vt,n),m===1){this.m_type=me.e_points;var h=this.m_proxyA.getVertex(t.indexA[0]),u=this.m_proxyB.getVertex(t.indexB[0]);q(ie,wt,h),q(Rt,Vt,u),N(this.m_axis,Rt,ie);var l=Kn(this.m_axis);return l}else if(t.indexA[0]===t.indexA[1]){this.m_type=me.e_faceB;var p=s.getVertex(t.indexB[0]),c=s.getVertex(t.indexB[1]);He(this.m_axis,N(Ai,c,p),1),$t(this.m_axis),Yt(Bt,Vt.q,this.m_axis),Q(this.m_localPoint,.5,p,.5,c),q(Rt,Vt,this.m_localPoint);var _=e.getVertex(t.indexA[0]),d=ft.mulVec2(wt,_),l=C(d,Bt)-C(Rt,Bt);return l<0&&(Ti(this.m_axis),l=-l),l}else{this.m_type=me.e_faceA;var y=this.m_proxyA.getVertex(t.indexA[0]),f=this.m_proxyA.getVertex(t.indexA[1]);He(this.m_axis,N(Ai,f,y),1),$t(this.m_axis),Yt(Bt,wt.q,this.m_axis),Q(this.m_localPoint,.5,y,.5,f),q(ie,wt,this.m_localPoint);var v=this.m_proxyB.getVertex(t.indexB[0]);q(Rt,Vt,v);var l=C(Rt,Bt)-C(ie,Bt);return l<0&&(Ti(this.m_axis),l=-l),l}},i.prototype.compute=function(t,e){switch(this.m_sweepA.getTransform(wt,e),this.m_sweepB.getTransform(Vt,e),this.m_type){case me.e_points:{t&&(yi(Xi,wt.q,this.m_axis),yi(Gi,Vt.q,L(Ai,-1,this.m_axis)),this.indexA=this.m_proxyA.getSupport(Xi),this.indexB=this.m_proxyB.getSupport(Gi)),x(Qi,this.m_proxyA.getVertex(this.indexA)),x($i,this.m_proxyB.getVertex(this.indexB)),q(ie,wt,Qi),q(Rt,Vt,$i);var o=C(Rt,this.m_axis)-C(ie,this.m_axis);return o}case me.e_faceA:{Yt(Bt,wt.q,this.m_axis),q(ie,wt,this.m_localPoint),t&&(yi(Gi,Vt.q,L(Ai,-1,Bt)),this.indexA=-1,this.indexB=this.m_proxyB.getSupport(Gi)),x($i,this.m_proxyB.getVertex(this.indexB)),q(Rt,Vt,$i);var o=C(Rt,Bt)-C(ie,Bt);return o}case me.e_faceB:{Yt(Bt,Vt.q,this.m_axis),q(Rt,Vt,this.m_localPoint),t&&(yi(Xi,wt.q,L(Ai,-1,Bt)),this.indexB=-1,this.indexA=this.m_proxyA.getSupport(Xi)),x(Qi,this.m_proxyA.getVertex(this.indexA)),q(ie,wt,Qi);var o=C(ie,Bt)-C(Rt,Bt);return o}default:return t&&(this.indexA=-1,this.indexB=-1),0}},i.prototype.findMinSeparation=function(t){return this.compute(!0,t)},i.prototype.evaluate=function(t){return this.compute(!1,t)},i}(),bi=new hr;fi.Input=qo;fi.Output=No;var Os=Math.abs,Es=Math.sqrt,to=Math.min,ki=function(){function i(){this.dt=0,this.inv_dt=0,this.velocityIterations=0,this.positionIterations=0,this.warmStarting=!1,this.blockSolve=!0,this.inv_dt0=0,this.dtRatio=1}return i.prototype.reset=function(t){this.dt>0&&(this.inv_dt0=this.inv_dt),this.dt=t,this.inv_dt=t==0?0:1/t,this.dtRatio=t*this.inv_dt0},i}(),ii=new ki,ue=A(0,0),dt=A(0,0),eo=A(0,0),oi=new qo,Xo=new No,Js=new be,Ys=new be,Ws=new be,ps=function(){function i(t){this.contact=t,this.normals=[],this.tangents=[]}return i.prototype.recycle=function(){this.normals.length=0,this.tangents.length=0},Object.defineProperty(i.prototype,"normalImpulses",{get:function(){var t=this.contact,e=this.normals;e.length=0;for(var o=0;o<t.v_points.length;++o)e.push(t.v_points[o].normalImpulse);return e},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"tangentImpulses",{get:function(){var t=this.contact,e=this.tangents;e.length=0;for(var o=0;o<t.v_points.length;++o)e.push(t.v_points[o].tangentImpulse);return e},enumerable:!1,configurable:!0}),i}(),ko=function(){function i(t){this.m_world=t,this.m_stack=[],this.m_bodies=[],this.m_contacts=[],this.m_joints=[]}return i.prototype.clear=function(){this.m_stack.length=0,this.m_bodies.length=0,this.m_contacts.length=0,this.m_joints.length=0},i.prototype.addBody=function(t){this.m_bodies.push(t)},i.prototype.addContact=function(t){this.m_contacts.push(t)},i.prototype.addJoint=function(t){this.m_joints.push(t)},i.prototype.solveWorld=function(t){for(var e=this.m_world,o=e.m_bodyList;o;o=o.m_next)o.m_islandFlag=!1;for(var s=e.m_contactList;s;s=s.m_next)s.m_islandFlag=!1;for(var r=e.m_jointList;r;r=r.m_next)r.m_islandFlag=!1;for(var n=this.m_stack,m=e.m_bodyList;m;m=m.m_next)if(!m.m_islandFlag&&!(m.isAwake()==!1||m.isActive()==!1)&&!m.isStatic()){for(this.clear(),n.push(m),m.m_islandFlag=!0;n.length>0;){var o=n.pop();if(this.addBody(o),o.m_awakeFlag=!0,!o.isStatic()){for(var h=o.m_contactList;h;h=h.next){var u=h.contact;if(!u.m_islandFlag&&!(u.isEnabled()==!1||u.isTouching()==!1)){var l=u.m_fixtureA.m_isSensor,p=u.m_fixtureB.m_isSensor;if(!(l||p)){this.addContact(u),u.m_islandFlag=!0;var c=h.other;c.m_islandFlag||(n.push(c),c.m_islandFlag=!0)}}}for(var _=o.m_jointList;_;_=_.next)if(_.joint.m_islandFlag!=!0){var c=_.other;c.isActive()!=!1&&(this.addJoint(_.joint),_.joint.m_islandFlag=!0,!c.m_islandFlag&&(n.push(c),c.m_islandFlag=!0))}}}this.solveIsland(t);for(var d=0;d<this.m_bodies.length;++d){var o=this.m_bodies[d];o.isStatic()&&(o.m_islandFlag=!1)}}},i.prototype.solveIsland=function(t){for(var e=this.m_world,o=e.m_gravity,s=e.m_allowSleep,r=t.dt,n=0;n<this.m_bodies.length;++n){var m=this.m_bodies[n];x(ue,m.m_sweep.c);var h=m.m_sweep.a;x(dt,m.m_linearVelocity);var u=m.m_angularVelocity;x(m.m_sweep.c0,m.m_sweep.c),m.m_sweep.a0=m.m_sweep.a,m.isDynamic()&&(Qt(dt,r*m.m_gravityScale,o),Qt(dt,r*m.m_invMass,m.m_force),u+=r*m.m_invI*m.m_torque,L(dt,1/(1+r*m.m_linearDamping),dt),u*=1/(1+r*m.m_angularDamping)),x(m.c_position.c,ue),m.c_position.a=h,x(m.c_velocity.v,dt),m.c_velocity.w=u}for(var n=0;n<this.m_contacts.length;++n){var l=this.m_contacts[n];l.initConstraint(t)}for(var n=0;n<this.m_contacts.length;++n){var l=this.m_contacts[n];l.initVelocityConstraint(t)}if(t.warmStarting)for(var n=0;n<this.m_contacts.length;++n){var l=this.m_contacts[n];l.warmStartConstraint(t)}for(var n=0;n<this.m_joints.length;++n){var p=this.m_joints[n];p.initVelocityConstraints(t)}for(var n=0;n<t.velocityIterations;++n){for(var c=0;c<this.m_joints.length;++c){var p=this.m_joints[c];p.solveVelocityConstraints(t)}for(var c=0;c<this.m_contacts.length;++c){var l=this.m_contacts[c];l.solveVelocityConstraint(t)}}for(var n=0;n<this.m_contacts.length;++n){var l=this.m_contacts[n];l.storeConstraintImpulses(t)}for(var n=0;n<this.m_bodies.length;++n){var m=this.m_bodies[n];x(ue,m.c_position.c);var h=m.c_position.a;x(dt,m.c_velocity.v);var u=m.c_velocity.w;L(eo,r,dt);var _=Ze(eo);if(_>P.maxTranslationSquared){var d=P.maxTranslation/Es(_);Ss(dt,d)}var y=r*u;if(y*y>P.maxRotationSquared){var d=P.maxRotation/Os(y);u*=d}Qt(ue,r,dt),h+=r*u,x(m.c_position.c,ue),m.c_position.a=h,x(m.c_velocity.v,dt),m.c_velocity.w=u}for(var f=!1,n=0;n<t.positionIterations;++n){for(var v=0,c=0;c<this.m_contacts.length;++c){var l=this.m_contacts[c],g=l.solvePositionConstraint(t);v=to(v,g)}for(var B=v>=-3*P.linearSlop,w=!0,c=0;c<this.m_joints.length;++c){var p=this.m_joints[c],V=p.solvePositionConstraints(t);w=w&&V}if(B&&w){f=!0;break}}for(var n=0;n<this.m_bodies.length;++n){var m=this.m_bodies[n];x(m.m_sweep.c,m.c_position.c),m.m_sweep.a=m.c_position.a,x(m.m_linearVelocity,m.c_velocity.v),m.m_angularVelocity=m.c_velocity.w,m.synchronizeTransform()}if(this.postSolveIsland(),s){for(var I=1/0,M=P.linearSleepToleranceSqr,S=P.angularSleepToleranceSqr,n=0;n<this.m_bodies.length;++n){var m=this.m_bodies[n];m.isStatic()||(m.m_autoSleepFlag==!1||m.m_angularVelocity*m.m_angularVelocity>S||Ze(m.m_linearVelocity)>M?(m.m_sleepTime=0,I=0):(m.m_sleepTime+=r,I=to(I,m.m_sleepTime)))}if(I>=P.timeToSleep&&f)for(var n=0;n<this.m_bodies.length;++n){var m=this.m_bodies[n];m.setAwake(!1)}}},i.prototype.solveWorldTOI=function(t){var e=this.m_world;if(e.m_stepComplete){for(var o=e.m_bodyList;o;o=o.m_next)o.m_islandFlag=!1,o.m_sweep.alpha0=0;for(var s=e.m_contactList;s;s=s.m_next)s.m_toiFlag=!1,s.m_islandFlag=!1,s.m_toiCount=0,s.m_toi=1}for(;;){for(var r=null,n=1,m=e.m_contactList;m;m=m.m_next)if(m.isEnabled()!=!1&&!(m.m_toiCount>P.maxSubSteps)){var h=1;if(m.m_toiFlag)h=m.m_toi;else{var u=m.getFixtureA(),l=m.getFixtureB();if(u.isSensor()||l.isSensor())continue;var p=u.getBody(),c=l.getBody(),_=p.isAwake()&&!p.isStatic(),d=c.isAwake()&&!c.isStatic();if(_==!1&&d==!1)continue;var y=p.isBullet()||!p.isDynamic(),f=c.isBullet()||!c.isDynamic();if(y==!1&&f==!1)continue;var v=p.m_sweep.alpha0;p.m_sweep.alpha0<c.m_sweep.alpha0?(v=c.m_sweep.alpha0,p.m_sweep.advance(v)):c.m_sweep.alpha0<p.m_sweep.alpha0&&(v=p.m_sweep.alpha0,c.m_sweep.advance(v));var g=m.getChildIndexA(),B=m.getChildIndexB();p.m_sweep,c.m_sweep,oi.proxyA.set(u.getShape(),g),oi.proxyB.set(l.getShape(),B),oi.sweepA.set(p.m_sweep),oi.sweepB.set(c.m_sweep),oi.tMax=1,fi(Xo,oi);var w=Xo.t;Xo.state==Mt.e_touching?h=to(v+(1-v)*w,1):h=1,m.m_toi=h,m.m_toiFlag=!0}h<n&&(r=m,n=h)}if(r==null||1-10*It<n){e.m_stepComplete=!0;break}var V=r.getFixtureA(),I=r.getFixtureB(),M=V.getBody(),S=I.getBody();if(Ys.set(M.m_sweep),Ws.set(S.m_sweep),M.advance(n),S.advance(n),r.update(e),r.m_toiFlag=!1,++r.m_toiCount,r.isEnabled()==!1||r.isTouching()==!1){r.setEnabled(!1),M.m_sweep.set(Ys),S.m_sweep.set(Ws),M.synchronizeTransform(),S.synchronizeTransform();continue}M.setAwake(!0),S.setAwake(!0),this.clear(),this.addBody(M),this.addBody(S),this.addContact(r),M.m_islandFlag=!0,S.m_islandFlag=!0,r.m_islandFlag=!0;for(var k=[M,S],T=0;T<k.length;++T){var O=k[T];if(O.isDynamic())for(var Y=O.m_contactList;Y;Y=Y.next){var U=Y.contact;if(!U.m_islandFlag){var Z=Y.other;if(!(Z.isDynamic()&&!O.isBullet()&&!Z.isBullet())){var Pt=U.m_fixtureA.m_isSensor,_t=U.m_fixtureB.m_isSensor;if(!(Pt||_t)){if(Js.set(Z.m_sweep),Z.m_islandFlag==!1&&Z.advance(n),U.update(e),U.isEnabled()==!1||U.isTouching()==!1){Z.m_sweep.set(Js),Z.synchronizeTransform();continue}U.m_islandFlag=!0,this.addContact(U),!Z.m_islandFlag&&(Z.m_islandFlag=!0,Z.isStatic()||Z.setAwake(!0),this.addBody(Z))}}}}}ii.reset((1-n)*t.dt),ii.dtRatio=1,ii.positionIterations=20,ii.velocityIterations=t.velocityIterations,ii.warmStarting=!1,this.solveIslandTOI(ii,M,S);for(var T=0;T<this.m_bodies.length;++T){var O=this.m_bodies[T];if(O.m_islandFlag=!1,!!O.isDynamic()){O.synchronizeFixtures();for(var Y=O.m_contactList;Y;Y=Y.next)Y.contact.m_toiFlag=!1,Y.contact.m_islandFlag=!1}}if(e.findNewContacts(),e.m_subStepping){e.m_stepComplete=!1;break}}},i.prototype.solveIslandTOI=function(t,e,o){for(var l=0;l<this.m_bodies.length;++l){var s=this.m_bodies[l];x(s.c_position.c,s.m_sweep.c),s.c_position.a=s.m_sweep.a,x(s.c_velocity.v,s.m_linearVelocity),s.c_velocity.w=s.m_angularVelocity}for(var l=0;l<this.m_contacts.length;++l){var r=this.m_contacts[l];r.initConstraint(t)}for(var l=0;l<t.positionIterations;++l){for(var n=0,m=0;m<this.m_contacts.length;++m){var r=this.m_contacts[m],h=r.solvePositionConstraintTOI(t,e,o);n=to(n,h)}var u=n>=-1.5*P.linearSlop;if(u)break}var l;x(e.m_sweep.c0,e.c_position.c),e.m_sweep.a0=e.c_position.a,x(o.m_sweep.c0,o.c_position.c),o.m_sweep.a0=o.c_position.a;for(var l=0;l<this.m_contacts.length;++l){var r=this.m_contacts[l];r.initVelocityConstraint(t)}for(var l=0;l<t.velocityIterations;++l)for(var m=0;m<this.m_contacts.length;++m){var r=this.m_contacts[m];r.solveVelocityConstraint(t)}for(var p=t.dt,l=0;l<this.m_bodies.length;++l){var s=this.m_bodies[l];x(ue,s.c_position.c);var c=s.c_position.a;x(dt,s.c_velocity.v);var _=s.c_velocity.w;L(eo,p,dt);var d=Ze(eo);if(d>P.maxTranslationSquared){var y=P.maxTranslation/Es(d);Ss(dt,y)}var f=p*_;if(f*f>P.maxRotationSquared){var y=P.maxRotation/Os(f);_*=y}Qt(ue,p,dt),c+=p*_,x(s.c_position.c,ue),s.c_position.a=c,x(s.c_velocity.v,dt),s.c_velocity.w=_,x(s.m_sweep.c,ue),s.m_sweep.a=c,x(s.m_linearVelocity,dt),s.m_angularVelocity=_,s.synchronizeTransform()}this.postSolveIsland()},i.prototype.postSolveIsland=function(){for(var t=0;t<this.m_contacts.length;++t){var e=this.m_contacts[t];this.m_world.postSolve(e,e.m_impulse)}},i}();ko.TimeStep=ki;var qt=function(){function i(t,e,o,s){typeof t=="object"&&t!==null?(this.ex=a.clone(t),this.ey=a.clone(e)):typeof t=="number"?(this.ex=a.neo(t,o),this.ey=a.neo(e,s)):(this.ex=a.zero(),this.ey=a.zero())}return i.prototype.toString=function(){return JSON.stringify(this)},i.isValid=function(t){return t===null||typeof t>"u"?!1:a.isValid(t.ex)&&a.isValid(t.ey)},i.assert=function(t){},i.prototype.set=function(t,e,o,s){typeof t=="number"&&typeof e=="number"&&typeof o=="number"&&typeof s=="number"?(this.ex.setNum(t,o),this.ey.setNum(e,s)):typeof t=="object"&&typeof e=="object"?(this.ex.setVec2(t),this.ey.setVec2(e)):typeof t=="object"&&(this.ex.setVec2(t.ex),this.ey.setVec2(t.ey))},i.prototype.setIdentity=function(){this.ex.x=1,this.ey.x=0,this.ex.y=0,this.ey.y=1},i.prototype.setZero=function(){this.ex.x=0,this.ey.x=0,this.ex.y=0,this.ey.y=0},i.prototype.getInverse=function(){var t=this.ex.x,e=this.ey.x,o=this.ex.y,s=this.ey.y,r=t*s-e*o;r!==0&&(r=1/r);var n=new i;return n.ex.x=r*s,n.ey.x=-r*e,n.ex.y=-r*o,n.ey.y=r*t,n},i.prototype.solve=function(t){var e=this.ex.x,o=this.ey.x,s=this.ex.y,r=this.ey.y,n=e*r-o*s;n!==0&&(n=1/n);var m=a.zero();return m.x=n*(r*t.x-o*t.y),m.y=n*(e*t.y-s*t.x),m},i.mul=function(t,e){if(e&&"x"in e&&"y"in e){var o=t.ex.x*e.x+t.ey.x*e.y,s=t.ex.y*e.x+t.ey.y*e.y;return a.neo(o,s)}else if(e&&"ex"in e&&"ey"in e){var r=t.ex.x*e.ex.x+t.ey.x*e.ex.y,n=t.ex.x*e.ey.x+t.ey.x*e.ey.y,m=t.ex.y*e.ex.x+t.ey.y*e.ex.y,h=t.ex.y*e.ey.x+t.ey.y*e.ey.y;return new i(r,n,m,h)}},i.mulVec2=function(t,e){var o=t.ex.x*e.x+t.ey.x*e.y,s=t.ex.y*e.x+t.ey.y*e.y;return a.neo(o,s)},i.mulMat22=function(t,e){var o=t.ex.x*e.ex.x+t.ey.x*e.ex.y,s=t.ex.x*e.ey.x+t.ey.x*e.ey.y,r=t.ex.y*e.ex.x+t.ey.y*e.ex.y,n=t.ex.y*e.ey.x+t.ey.y*e.ey.y;return new i(o,s,r,n)},i.mulT=function(t,e){if(e&&"x"in e&&"y"in e)return a.neo(a.dot(e,t.ex),a.dot(e,t.ey));if(e&&"ex"in e&&"ey"in e){var o=a.neo(a.dot(t.ex,e.ex),a.dot(t.ey,e.ex)),s=a.neo(a.dot(t.ex,e.ey),a.dot(t.ey,e.ey));return new i(o,s)}},i.mulTVec2=function(t,e){return a.neo(a.dot(e,t.ex),a.dot(e,t.ey))},i.mulTMat22=function(t,e){var o=a.neo(a.dot(t.ex,e.ex),a.dot(t.ey,e.ex)),s=a.neo(a.dot(t.ex,e.ey),a.dot(t.ey,e.ey));return new i(o,s)},i.abs=function(t){return new i(a.abs(t.ex),a.abs(t.ey))},i.add=function(t,e){return new i(a.add(t.ex,e.ex),a.add(t.ey,e.ey))},i}(),cr=Math.sqrt,Go=A(0,0),Qo=A(0,0),Bi=A(0,0),pe=A(0,0),ye=A(0,0),$o=A(0,0),io=A(0,0),Me=A(0,0),$;(function(i){i[i.e_unset=-1]="e_unset",i[i.e_circles=0]="e_circles",i[i.e_faceA=1]="e_faceA",i[i.e_faceB=2]="e_faceB"})($||($={}));var E;(function(i){i[i.e_unset=-1]="e_unset",i[i.e_vertex=0]="e_vertex",i[i.e_face=1]="e_face"})(E||(E={}));var Ae;(function(i){i[i.nullState=0]="nullState",i[i.addState=1]="addState",i[i.persistState=2]="persistState",i[i.removeState=3]="removeState"})(Ae||(Ae={}));var At=function(){function i(){this.v=A(0,0),this.id=new Do}return i.prototype.set=function(t){x(this.v,t.v),this.id.set(t.id)},i.prototype.recycle=function(){z(this.v),this.id.recycle()},i}(),Di=function(){function i(){this.localNormal=A(0,0),this.localPoint=A(0,0),this.points=[new vo,new vo],this.pointCount=0}return i.prototype.set=function(t){this.type=t.type,x(this.localNormal,t.localNormal),x(this.localPoint,t.localPoint),this.pointCount=t.pointCount,this.points[0].set(t.points[0]),this.points[1].set(t.points[1])},i.prototype.recycle=function(){this.type=$.e_unset,z(this.localNormal),z(this.localPoint),this.pointCount=0,this.points[0].recycle(),this.points[1].recycle()},i.prototype.getWorldManifold=function(t,e,o,s,r){if(this.pointCount==0)return t;t=t||new Ro,t.pointCount=this.pointCount;var n=t.normal,m=t.points,h=t.separations;switch(this.type){case $.e_circles:{ut(n,1,0);var u=this.points[0];q(Go,e,this.localPoint),q(Qo,s,u.localPoint),N($o,Qo,Go);var l=Ze($o);if(l>It*It){var p=cr(l);L(n,1/p,$o)}Q(pe,1,Go,o,n),Q(ye,1,Qo,-r,n),Q(m[0],.5,pe,.5,ye),h[0]=C(N(Bi,ye,pe),n);break}case $.e_faceA:{Yt(n,e.q,this.localNormal),q(io,e,this.localPoint);for(var c=0;c<this.pointCount;++c){var u=this.points[c];q(Me,s,u.localPoint),Q(pe,1,Me,o-C(N(Bi,Me,io),n),n),Q(ye,1,Me,-r,n),Q(m[c],.5,pe,.5,ye),h[c]=C(N(Bi,ye,pe),n)}break}case $.e_faceB:{Yt(n,s.q,this.localNormal),q(io,s,this.localPoint);for(var c=0;c<this.pointCount;++c){var u=this.points[c];q(Me,e,u.localPoint),Q(ye,1,Me,r-C(N(Bi,Me,io),n),n),Q(pe,1,Me,-o,n),Q(m[c],.5,pe,.5,ye),h[c]=C(N(Bi,pe,ye),n)}Ti(n);break}}return t},i.clipSegmentToLine=Xe,i.ClipVertex=At,i.getPointStates=ys,i.PointState=Ae,i}(),vo=function(){function i(){this.localPoint=A(0,0),this.normalImpulse=0,this.tangentImpulse=0,this.id=new Do}return i.prototype.set=function(t){x(this.localPoint,t.localPoint),this.normalImpulse=t.normalImpulse,this.tangentImpulse=t.tangentImpulse,this.id.set(t.id)},i.prototype.recycle=function(){z(this.localPoint),this.normalImpulse=0,this.tangentImpulse=0,this.id.recycle()},i}(),Do=function(){function i(){this.key=-1,this.indexA=-1,this.indexB=-1,this.typeA=E.e_unset,this.typeB=E.e_unset}return i.prototype.setFeatures=function(t,e,o,s){this.indexA=t,this.indexB=o,this.typeA=e,this.typeB=s,this.key=this.indexA+this.indexB*4+this.typeA*16+this.typeB*64},i.prototype.set=function(t){this.indexA=t.indexA,this.indexB=t.indexB,this.typeA=t.typeA,this.typeB=t.typeB,this.key=this.indexA+this.indexB*4+this.typeA*16+this.typeB*64},i.prototype.swapFeatures=function(){var t=this.indexA,e=this.indexB,o=this.typeA,s=this.typeB;this.indexA=e,this.indexB=t,this.typeA=s,this.typeB=o,this.key=this.indexA+this.indexB*4+this.typeA*16+this.typeB*64},i.prototype.recycle=function(){this.indexA=0,this.indexB=0,this.typeA=E.e_unset,this.typeB=E.e_unset,this.key=-1},i}(),Ro=function(){function i(){this.normal=A(0,0),this.points=[A(0,0),A(0,0)],this.separations=[0,0],this.pointCount=0}return i.prototype.recycle=function(){z(this.normal),z(this.points[0]),z(this.points[1]),this.separations[0]=0,this.separations[1]=0,this.pointCount=0},i}();function ys(i,t,e,o){for(var s=0;s<e.pointCount;++s){var r=e.points[s].id;i[s]=Ae.removeState;for(var n=0;n<o.pointCount;++n)if(o.points[n].id.key===r.key){i[s]=Ae.persistState;break}}for(var s=0;s<o.pointCount;++s){var r=o.points[s].id;t[s]=Ae.addState;for(var n=0;n<e.pointCount;++n)if(e.points[n].id.key===r.key){t[s]=Ae.persistState;break}}}function Xe(i,t,e,o,s){var r=0,n=C(e,t[0].v)-o,m=C(e,t[1].v)-o;if(n<=0&&i[r++].set(t[0]),m<=0&&i[r++].set(t[1]),n*m<0){var h=n/(n-m);Q(i[r].v,1-h,t[0].v,h,t[1].v),i[r].id.setFeatures(s,E.e_vertex,t[0].id.indexB,E.e_face),++r}return r}var lr=Math.sqrt,_r=Math.max,ur=Math.min,Us=new zi({create:function(){return new Wt},release:function(i){i.recycle()}}),si=new Di,oo=new Ro,xo=function(){function i(t){this.prev=null,this.next=null,this.other=null,this.contact=t}return i.prototype.recycle=function(){this.prev=null,this.next=null,this.other=null},i}();function go(i,t){return lr(i*t)}function Ao(i,t){return i>t?i:t}var De=[],bo=function(){function i(){this.rA=A(0,0),this.rB=A(0,0),this.normalImpulse=0,this.tangentImpulse=0,this.normalMass=0,this.tangentMass=0,this.velocityBias=0}return i.prototype.recycle=function(){z(this.rA),z(this.rB),this.normalImpulse=0,this.tangentImpulse=0,this.normalMass=0,this.tangentMass=0,this.velocityBias=0},i}(),de=A(0,0),et=A(0,0),fe=A(0,0),it=A(0,0),Ie=A(0,0),Re=Qe(0,0,0),je=Qe(0,0,0),so=A(0,0),no=A(0,0),ni=A(0,0),ro=A(0,0),ts=A(0,0),es=A(0,0),ot=A(0,0),H=A(0,0),wi=A(0,0),jt=A(0,0),ri=A(0,0),ai=A(0,0),Tt=A(0,0),ve=A(0,0),X=A(0,0),Ot=A(0,0),st=A(0,0),nt=A(0,0),oe=A(0,0),Wt=function(){function i(){this.m_nodeA=new xo(this),this.m_nodeB=new xo(this),this.m_fixtureA=null,this.m_fixtureB=null,this.m_indexA=-1,this.m_indexB=-1,this.m_evaluateFcn=null,this.m_manifold=new Di,this.m_prev=null,this.m_next=null,this.m_toi=1,this.m_toiCount=0,this.m_toiFlag=!1,this.m_friction=0,this.m_restitution=0,this.m_tangentSpeed=0,this.m_enabledFlag=!0,this.m_islandFlag=!1,this.m_touchingFlag=!1,this.m_filterFlag=!1,this.m_bulletHitFlag=!1,this.m_impulse=new ps(this),this.v_points=[new bo,new bo],this.v_normal=A(0,0),this.v_normalMass=new qt,this.v_K=new qt,this.v_pointCount=0,this.v_tangentSpeed=0,this.v_friction=0,this.v_restitution=0,this.v_invMassA=0,this.v_invMassB=0,this.v_invIA=0,this.v_invIB=0,this.p_localPoints=[A(0,0),A(0,0)],this.p_localNormal=A(0,0),this.p_localPoint=A(0,0),this.p_localCenterA=A(0,0),this.p_localCenterB=A(0,0),this.p_type=$.e_unset,this.p_radiusA=0,this.p_radiusB=0,this.p_pointCount=0,this.p_invMassA=0,this.p_invMassB=0,this.p_invIA=0,this.p_invIB=0}return i.prototype.initialize=function(t,e,o,s,r){this.m_fixtureA=t,this.m_fixtureB=o,this.m_indexA=e,this.m_indexB=s,this.m_evaluateFcn=r,this.m_friction=go(this.m_fixtureA.m_friction,this.m_fixtureB.m_friction),this.m_restitution=Ao(this.m_fixtureA.m_restitution,this.m_fixtureB.m_restitution)},i.prototype.recycle=function(){this.m_nodeA.recycle(),this.m_nodeB.recycle(),this.m_fixtureA=null,this.m_fixtureB=null,this.m_indexA=-1,this.m_indexB=-1,this.m_evaluateFcn=null,this.m_manifold.recycle(),this.m_prev=null,this.m_next=null,this.m_toi=1,this.m_toiCount=0,this.m_toiFlag=!1,this.m_friction=0,this.m_restitution=0,this.m_tangentSpeed=0,this.m_enabledFlag=!0,this.m_islandFlag=!1,this.m_touchingFlag=!1,this.m_filterFlag=!1,this.m_bulletHitFlag=!1,this.m_impulse.recycle();for(var t=0,e=this.v_points;t<e.length;t++){var o=e[t];o.recycle()}z(this.v_normal),this.v_normalMass.setZero(),this.v_K.setZero(),this.v_pointCount=0,this.v_tangentSpeed=0,this.v_friction=0,this.v_restitution=0,this.v_invMassA=0,this.v_invMassB=0,this.v_invIA=0,this.v_invIB=0;for(var s=0,r=this.p_localPoints;s<r.length;s++){var n=r[s];z(n)}z(this.p_localNormal),z(this.p_localPoint),z(this.p_localCenterA),z(this.p_localCenterB),this.p_type=$.e_unset,this.p_radiusA=0,this.p_radiusB=0,this.p_pointCount=0,this.p_invMassA=0,this.p_invMassB=0,this.p_invIA=0,this.p_invIB=0},i.prototype.initConstraint=function(t){var e=this.m_fixtureA,o=this.m_fixtureB;if(!(e===null||o===null)){var s=e.m_body,r=o.m_body;if(!(s===null||r===null)){var n=e.m_shape,m=o.m_shape;if(!(n===null||m===null)){var h=this.m_manifold,u=h.pointCount;this.v_invMassA=s.m_invMass,this.v_invMassB=r.m_invMass,this.v_invIA=s.m_invI,this.v_invIB=r.m_invI,this.v_friction=this.m_friction,this.v_restitution=this.m_restitution,this.v_tangentSpeed=this.m_tangentSpeed,this.v_pointCount=u,this.v_K.setZero(),this.v_normalMass.setZero(),this.p_invMassA=s.m_invMass,this.p_invMassB=r.m_invMass,this.p_invIA=s.m_invI,this.p_invIB=r.m_invI,x(this.p_localCenterA,s.m_sweep.localCenter),x(this.p_localCenterB,r.m_sweep.localCenter),this.p_radiusA=n.m_radius,this.p_radiusB=m.m_radius,this.p_type=h.type,x(this.p_localNormal,h.localNormal),x(this.p_localPoint,h.localPoint),this.p_pointCount=u;for(var l=0;l<P.maxManifoldPoints;++l)this.v_points[l].recycle(),z(this.p_localPoints[l]);for(var l=0;l<u;++l){var p=h.points[l],c=this.v_points[l];t.warmStarting&&(c.normalImpulse=t.dtRatio*p.normalImpulse,c.tangentImpulse=t.dtRatio*p.tangentImpulse),x(this.p_localPoints[l],p.localPoint)}}}}},i.prototype.getManifold=function(){return this.m_manifold},i.prototype.getWorldManifold=function(t){var e=this.m_fixtureA,o=this.m_fixtureB;if(!(e===null||o===null)){var s=e.m_body,r=o.m_body;if(!(s===null||r===null)){var n=e.m_shape,m=o.m_shape;if(!(n===null||m===null))return this.m_manifold.getWorldManifold(t,s.getTransform(),n.m_radius,r.getTransform(),m.m_radius)}}},i.prototype.setEnabled=function(t){this.m_enabledFlag=!!t},i.prototype.isEnabled=function(){return this.m_enabledFlag},i.prototype.isTouching=function(){return this.m_touchingFlag},i.prototype.getNext=function(){return this.m_next},i.prototype.getFixtureA=function(){return this.m_fixtureA},i.prototype.getFixtureB=function(){return this.m_fixtureB},i.prototype.getChildIndexA=function(){return this.m_indexA},i.prototype.getChildIndexB=function(){return this.m_indexB},i.prototype.flagForFiltering=function(){this.m_filterFlag=!0},i.prototype.setFriction=function(t){this.m_friction=t},i.prototype.getFriction=function(){return this.m_friction},i.prototype.resetFriction=function(){var t=this.m_fixtureA,e=this.m_fixtureB;t===null||e===null||(this.m_friction=go(t.m_friction,e.m_friction))},i.prototype.setRestitution=function(t){this.m_restitution=t},i.prototype.getRestitution=function(){return this.m_restitution},i.prototype.resetRestitution=function(){var t=this.m_fixtureA,e=this.m_fixtureB;t===null||e===null||(this.m_restitution=Ao(t.m_restitution,e.m_restitution))},i.prototype.setTangentSpeed=function(t){this.m_tangentSpeed=t},i.prototype.getTangentSpeed=function(){return this.m_tangentSpeed},i.prototype.evaluate=function(t,e,o){var s=this.m_fixtureA,r=this.m_fixtureB;s===null||r===null||this.m_evaluateFcn(t,e,s,this.m_indexA,o,r,this.m_indexB)},i.prototype.update=function(t){var e=this.m_fixtureA,o=this.m_fixtureB;if(!(e===null||o===null)){var s=e.m_body,r=o.m_body;if(!(s===null||r===null)){var n=e.m_shape,m=o.m_shape;if(!(n===null||m===null)){this.m_enabledFlag=!0;var h=!1,u=this.m_touchingFlag,l=e.m_isSensor,p=o.m_isSensor,c=l||p,_=s.m_xf,d=r.m_xf;if(c)h=Fo(n,this.m_indexA,m,this.m_indexB,_,d),this.m_manifold.pointCount=0;else{si.recycle(),si.set(this.m_manifold),this.m_manifold.recycle(),this.evaluate(this.m_manifold,_,d),h=this.m_manifold.pointCount>0;for(var y=0;y<this.m_manifold.pointCount;++y){var f=this.m_manifold.points[y];f.normalImpulse=0,f.tangentImpulse=0;for(var v=0;v<si.pointCount;++v){var g=si.points[v];if(g.id.key===f.id.key){f.normalImpulse=g.normalImpulse,f.tangentImpulse=g.tangentImpulse;break}}}h!==u&&(s.setAwake(!0),r.setAwake(!0))}this.m_touchingFlag=h;var B=typeof t=="object"&&t!==null;!u&&h&&B&&t.beginContact(this),u&&!h&&B&&t.endContact(this),!c&&h&&B&&si&&t.preSolve(this,si)}}}},i.prototype.solvePositionConstraint=function(t){return this._solvePositionConstraint(t,null,null)},i.prototype.solvePositionConstraintTOI=function(t,e,o){return this._solvePositionConstraint(t,e,o)},i.prototype._solvePositionConstraint=function(t,e,o){var s=e!==null&&o!==null,r=0,n=this.m_fixtureA,m=this.m_fixtureB;if(n===null||m===null)return r;var h=n.m_body,u=m.m_body;if(h===null||u===null)return r;h.c_velocity,u.c_velocity;var l=h.c_position,p=u.c_position,c=this.p_localCenterA,_=this.p_localCenterB,d=0,y=0;(!s||h===e||h===o)&&(d=this.p_invMassA,y=this.p_invIA);var f=0,v=0;(!s||u===e||u===o)&&(f=this.p_invMassB,v=this.p_invIB),x(de,l.c);var g=l.a;x(fe,p.c);for(var B=p.a,w=0;w<this.p_pointCount;++w){Oi(Re,c,de,g),Oi(je,_,fe,B);var V=void 0;switch(this.p_type){case $.e_circles:{q(so,Re,this.p_localPoint),q(no,je,this.p_localPoints[0]),N(H,no,so),$t(H),Q(wi,.5,so,.5,no),V=C(no,H)-C(so,H)-this.p_radiusA-this.p_radiusB;break}case $.e_faceA:{Yt(H,Re.q,this.p_localNormal),q(ro,Re,this.p_localPoint),q(ni,je,this.p_localPoints[w]),V=C(ni,H)-C(ro,H)-this.p_radiusA-this.p_radiusB,x(wi,ni);break}case $.e_faceB:{Yt(H,je.q,this.p_localNormal),q(ro,je,this.p_localPoint),q(ni,Re,this.p_localPoints[w]),V=C(ni,H)-C(ro,H)-this.p_radiusA-this.p_radiusB,x(wi,ni),Ti(H);break}default:return r}N(ts,wi,de),N(es,wi,fe),r=ur(r,V);var I=s?P.toiBaugarte:P.baumgarte,M=P.linearSlop,S=P.maxLinearCorrection,k=pt(I*(V+M),-S,0),T=j(ts,H),O=j(es,H),Y=d+f+y*T*T+v*O*O,U=Y>0?-k/Y:0;L(ot,U,H),Si(de,d,ot),g-=y*j(ts,ot),Qt(fe,f,ot),B+=v*j(es,ot)}return x(l.c,de),l.a=g,x(p.c,fe),p.a=B,r},i.prototype.initVelocityConstraint=function(t){var e=this.m_fixtureA,o=this.m_fixtureB;if(!(e===null||o===null)){var s=e.m_body,r=o.m_body;if(!(s===null||r===null)){var n=s.c_velocity,m=r.c_velocity,h=s.c_position,u=r.c_position,l=this.p_radiusA,p=this.p_radiusB,c=this.m_manifold,_=this.v_invMassA,d=this.v_invMassB,y=this.v_invIA,f=this.v_invIB,v=this.p_localCenterA,g=this.p_localCenterB;x(de,h.c);var B=h.a;x(et,n.v);var w=n.w;x(fe,u.c);var V=u.a;x(it,m.v);var I=m.w;Oi(Re,v,de,B),Oi(je,g,fe,V),oo.recycle(),c.getWorldManifold(oo,Re,l,je,p),x(this.v_normal,oo.normal);for(var M=0;M<this.v_pointCount;++M){var S=this.v_points[M],k=oo.points[M];N(S.rA,k,de),N(S.rB,k,fe);var T=j(S.rA,this.v_normal),O=j(S.rB,this.v_normal),Y=_+d+y*T*T+f*O*O;S.normalMass=Y>0?1/Y:0,He(Ie,this.v_normal,1);var U=j(S.rA,Ie),Z=j(S.rB,Ie),Pt=_+d+y*U*U+f*Z*Z;S.tangentMass=Pt>0?1/Pt:0,S.velocityBias=0;var _t=0;_t+=C(this.v_normal,it),_t+=C(this.v_normal,Ft(oe,I,S.rB)),_t-=C(this.v_normal,et),_t-=C(this.v_normal,Ft(oe,w,S.rA)),_t<-P.velocityThreshold&&(S.velocityBias=-this.v_restitution*_t)}if(this.v_pointCount==2&&t.blockSolve){var Ut=this.v_points[0],bt=this.v_points[1],tt=j(Ut.rA,this.v_normal),vi=j(Ut.rB,this.v_normal),kt=j(bt.rA,this.v_normal),Ce=j(bt.rB,this.v_normal),Te=_+d+y*tt*tt+f*vi*vi,xi=_+d+y*kt*kt+f*Ce*Ce,ti=_+d+y*tt*kt+f*vi*Ce,Jo=1e3;if(Te*Te<Jo*(Te*xi-ti*ti)){this.v_K.ex.setNum(Te,ti),this.v_K.ey.setNum(ti,xi);var gs=this.v_K.ex.x,As=this.v_K.ey.x,bs=this.v_K.ex.y,Bs=this.v_K.ey.y,Fe=gs*Bs-As*bs;Fe!==0&&(Fe=1/Fe),this.v_normalMass.ex.x=Fe*Bs,this.v_normalMass.ey.x=-Fe*As,this.v_normalMass.ex.y=-Fe*bs,this.v_normalMass.ey.y=Fe*gs}else this.v_pointCount=1}x(h.c,de),h.a=B,x(n.v,et),n.w=w,x(u.c,fe),u.a=V,x(m.v,it),m.w=I}}},i.prototype.warmStartConstraint=function(t){var e=this.m_fixtureA,o=this.m_fixtureB;if(!(e===null||o===null)){var s=e.m_body,r=o.m_body;if(!(s===null||r===null)){var n=s.c_velocity,m=r.c_velocity;s.c_position,r.c_position;var h=this.v_invMassA,u=this.v_invIA,l=this.v_invMassB,p=this.v_invIB;x(et,n.v);var c=n.w;x(it,m.v);var _=m.w;x(H,this.v_normal),He(Ie,H,1);for(var d=0;d<this.v_pointCount;++d){var y=this.v_points[d];Q(ot,y.normalImpulse,H,y.tangentImpulse,Ie),c-=u*j(y.rA,ot),Si(et,h,ot),_+=p*j(y.rB,ot),Qt(it,l,ot)}x(n.v,et),n.w=c,x(m.v,it),m.w=_}}},i.prototype.storeConstraintImpulses=function(t){for(var e=this.m_manifold,o=0;o<this.v_pointCount;++o)e.points[o].normalImpulse=this.v_points[o].normalImpulse,e.points[o].tangentImpulse=this.v_points[o].tangentImpulse},i.prototype.solveVelocityConstraint=function(t){var e=this.m_fixtureA,o=this.m_fixtureB;if(!(e===null||o===null)){var s=e.m_body,r=o.m_body;if(!(s===null||r===null)){var n=s.c_velocity;s.c_position;var m=r.c_velocity;r.c_position;var h=this.v_invMassA,u=this.v_invIA,l=this.v_invMassB,p=this.v_invIB;x(et,n.v);var c=n.w;x(it,m.v);var _=m.w;x(H,this.v_normal),He(Ie,H,1);for(var d=this.v_friction,y=0;y<this.v_pointCount;++y){var f=this.v_points[y];z(jt),Jt(jt,it),Jt(jt,Ft(oe,_,f.rB)),ge(jt,et),ge(jt,Ft(oe,c,f.rA));var v=C(jt,Ie)-this.v_tangentSpeed,g=f.tangentMass*-v,B=d*f.normalImpulse,w=pt(f.tangentImpulse+g,-B,B);g=w-f.tangentImpulse,f.tangentImpulse=w,L(ot,g,Ie),Si(et,h,ot),c-=u*j(f.rA,ot),Qt(it,l,ot),_+=p*j(f.rB,ot)}if(this.v_pointCount==1||t.blockSolve==!1)for(var V=0;V<this.v_pointCount;++V){var f=this.v_points[V];z(jt),Jt(jt,it),Jt(jt,Ft(oe,_,f.rB)),ge(jt,et),ge(jt,Ft(oe,c,f.rA));var I=C(jt,H),g=-f.normalMass*(I-f.velocityBias),w=_r(f.normalImpulse+g,0);g=w-f.normalImpulse,f.normalImpulse=w,L(ot,g,H),Si(et,h,ot),c-=u*j(f.rA,ot),Qt(it,l,ot),_+=p*j(f.rB,ot)}else{var M=this.v_points[0],S=this.v_points[1];ut(ve,M.normalImpulse,S.normalImpulse),z(ri),Jt(ri,it),Jt(ri,Ft(oe,_,M.rB)),ge(ri,et),ge(ri,Ft(oe,c,M.rA)),z(ai),Jt(ai,it),Jt(ai,Ft(oe,_,S.rB)),ge(ai,et),ge(ai,Ft(oe,c,S.rA));var k=C(ri,H),T=C(ai,H);for(ut(Tt,k-M.velocityBias,T-S.velocityBias),Tt.x-=this.v_K.ex.x*ve.x+this.v_K.ey.x*ve.y,Tt.y-=this.v_K.ex.y*ve.x+this.v_K.ey.y*ve.y;;){if(z(X),X.x=-(this.v_normalMass.ex.x*Tt.x+this.v_normalMass.ey.x*Tt.y),X.y=-(this.v_normalMass.ex.y*Tt.x+this.v_normalMass.ey.y*Tt.y),X.x>=0&&X.y>=0){N(Ot,X,ve),L(st,Ot.x,H),L(nt,Ot.y,H),ae(et,-h,st,-h,nt,1,et),c-=u*(j(M.rA,st)+j(S.rA,nt)),ae(it,l,st,l,nt,1,it),_+=p*(j(M.rB,st)+j(S.rB,nt)),M.normalImpulse=X.x,S.normalImpulse=X.y;break}if(X.x=-M.normalMass*Tt.x,X.y=0,k=0,T=this.v_K.ex.y*X.x+Tt.y,X.x>=0&&T>=0){N(Ot,X,ve),L(st,Ot.x,H),L(nt,Ot.y,H),ae(et,-h,st,-h,nt,1,et),c-=u*(j(M.rA,st)+j(S.rA,nt)),ae(it,l,st,l,nt,1,it),_+=p*(j(M.rB,st)+j(S.rB,nt)),M.normalImpulse=X.x,S.normalImpulse=X.y;break}if(X.x=0,X.y=-S.normalMass*Tt.y,k=this.v_K.ey.x*X.y+Tt.x,T=0,X.y>=0&&k>=0){N(Ot,X,ve),L(st,Ot.x,H),L(nt,Ot.y,H),ae(et,-h,st,-h,nt,1,et),c-=u*(j(M.rA,st)+j(S.rA,nt)),ae(it,l,st,l,nt,1,it),_+=p*(j(M.rB,st)+j(S.rB,nt)),M.normalImpulse=X.x,S.normalImpulse=X.y;break}if(X.x=0,X.y=0,k=Tt.x,T=Tt.y,k>=0&&T>=0){N(Ot,X,ve),L(st,Ot.x,H),L(nt,Ot.y,H),ae(et,-h,st,-h,nt,1,et),c-=u*(j(M.rA,st)+j(S.rA,nt)),ae(it,l,st,l,nt,1,it),_+=p*(j(M.rB,st)+j(S.rB,nt)),M.normalImpulse=X.x,S.normalImpulse=X.y;break}break}}x(n.v,et),n.w=c,x(m.v,it),m.w=_}}},i.addType=function(t,e,o){De[t]=De[t]||{},De[t][e]=o},i.create=function(t,e,o,s){var r=t.m_shape.m_type,n=o.m_shape.m_type,m=Us.allocate(),h;if(h=De[r]&&De[r][n])m.initialize(t,e,o,s,h);else if(h=De[n]&&De[n][r])m.initialize(o,s,t,e,h);else return null;t=m.m_fixtureA,o=m.m_fixtureB,e=m.getChildIndexA(),s=m.getChildIndexB();var u=t.m_body,l=o.m_body;return m.m_nodeA.contact=m,m.m_nodeA.other=l,m.m_nodeA.prev=null,m.m_nodeA.next=u.m_contactList,u.m_contactList!=null&&(u.m_contactList.prev=m.m_nodeA),u.m_contactList=m.m_nodeA,m.m_nodeB.contact=m,m.m_nodeB.other=u,m.m_nodeB.prev=null,m.m_nodeB.next=l.m_contactList,l.m_contactList!=null&&(l.m_contactList.prev=m.m_nodeB),l.m_contactList=m.m_nodeB,t.isSensor()==!1&&o.isSensor()==!1&&(u.setAwake(!0),l.setAwake(!0)),m},i.destroy=function(t,e){var o=t.m_fixtureA,s=t.m_fixtureB;if(!(o===null||s===null)){var r=o.m_body,n=s.m_body;r===null||n===null||(t.isTouching()&&e.endContact(t),t.m_nodeA.prev&&(t.m_nodeA.prev.next=t.m_nodeA.next),t.m_nodeA.next&&(t.m_nodeA.next.prev=t.m_nodeA.prev),t.m_nodeA==r.m_contactList&&(r.m_contactList=t.m_nodeA.next),t.m_nodeB.prev&&(t.m_nodeB.prev.next=t.m_nodeB.next),t.m_nodeB.next&&(t.m_nodeB.next.prev=t.m_nodeB.prev),t.m_nodeB==n.m_contactList&&(n.m_contactList=t.m_nodeB.next),t.m_manifold.pointCount>0&&!o.m_isSensor&&!s.m_isSensor&&(r.setAwake(!0),n.setAwake(!0)),Us.release(t))}},i}(),pr={gravity:a.zero(),allowSleep:!0,warmStarting:!0,continuousPhysics:!0,subStepping:!1,blockSolve:!0,velocityIterations:8,positionIterations:3},$e=function(){function i(t){if(!(this instanceof i))return new i(t);this.s_step=new ki,t?a.isValid(t)&&(t={gravity:t}):t={},t=Nt(t,pr),this.m_solver=new ko(this),this.m_broadPhase=new ls,this.m_contactList=null,this.m_contactCount=0,this.m_bodyList=null,this.m_bodyCount=0,this.m_jointList=null,this.m_jointCount=0,this.m_stepComplete=!0,this.m_allowSleep=t.allowSleep,this.m_gravity=a.clone(t.gravity),this.m_clearForces=!0,this.m_newFixture=!1,this.m_locked=!1,this.m_warmStarting=t.warmStarting,this.m_continuousPhysics=t.continuousPhysics,this.m_subStepping=t.subStepping,this.m_blockSolve=t.blockSolve,this.m_velocityIterations=t.velocityIterations,this.m_positionIterations=t.positionIterations,this.m_t=0,this.m_step_callback=[]}return i.prototype._serialize=function(){for(var t=[],e=[],o=this.getBodyList();o;o=o.getNext())t.push(o);for(var s=this.getJointList();s;s=s.getNext())typeof s._serialize=="function"&&e.push(s);return{gravity:this.m_gravity,bodies:t,joints:e}},i._deserialize=function(t,e,o){if(!t)return new i;var s=new i(t.gravity);if(t.bodies)for(var r=t.bodies.length-1;r>=0;r-=1)s._addBody(o(W,t.bodies[r],s));if(t.joints)for(var r=t.joints.length-1;r>=0;r--)s.createJoint(o(yt,t.joints[r],s));return s},i.prototype.getBodyList=function(){return this.m_bodyList},i.prototype.getJointList=function(){return this.m_jointList},i.prototype.getContactList=function(){return this.m_contactList},i.prototype.getBodyCount=function(){return this.m_bodyCount},i.prototype.getJointCount=function(){return this.m_jointCount},i.prototype.getContactCount=function(){return this.m_contactCount},i.prototype.setGravity=function(t){this.m_gravity.set(t)},i.prototype.getGravity=function(){return this.m_gravity},i.prototype.isLocked=function(){return this.m_locked},i.prototype.setAllowSleeping=function(t){if(t!=this.m_allowSleep&&(this.m_allowSleep=t,this.m_allowSleep==!1))for(var e=this.m_bodyList;e;e=e.m_next)e.setAwake(!0)},i.prototype.getAllowSleeping=function(){return this.m_allowSleep},i.prototype.setWarmStarting=function(t){this.m_warmStarting=t},i.prototype.getWarmStarting=function(){return this.m_warmStarting},i.prototype.setContinuousPhysics=function(t){this.m_continuousPhysics=t},i.prototype.getContinuousPhysics=function(){return this.m_continuousPhysics},i.prototype.setSubStepping=function(t){this.m_subStepping=t},i.prototype.getSubStepping=function(){return this.m_subStepping},i.prototype.setAutoClearForces=function(t){this.m_clearForces=t},i.prototype.getAutoClearForces=function(){return this.m_clearForces},i.prototype.clearForces=function(){for(var t=this.m_bodyList;t;t=t.getNext())t.m_force.setZero(),t.m_torque=0},i.prototype.queryAABB=function(t,e){var o=this.m_broadPhase;this.m_broadPhase.query(t,function(s){var r=o.getUserData(s);return e(r.fixture)})},i.prototype.rayCast=function(t,e,o){var s=this.m_broadPhase;this.m_broadPhase.rayCast({maxFraction:1,p1:t,p2:e},function(r,n){var m=s.getUserData(n),h=m.fixture,u=m.childIndex,l={},p=h.rayCast(l,r,u);if(p){var c=l.fraction,_=a.add(a.mulNumVec2(1-c,r.p1),a.mulNumVec2(c,r.p2));return o(h,_,l.normal,c)}return r.maxFraction})},i.prototype.getProxyCount=function(){return this.m_broadPhase.getProxyCount()},i.prototype.getTreeHeight=function(){return this.m_broadPhase.getTreeHeight()},i.prototype.getTreeBalance=function(){return this.m_broadPhase.getTreeBalance()},i.prototype.getTreeQuality=function(){return this.m_broadPhase.getTreeQuality()},i.prototype.shiftOrigin=function(t){if(!this.isLocked()){for(var e=this.m_bodyList;e;e=e.m_next)e.m_xf.p.sub(t),e.m_sweep.c0.sub(t),e.m_sweep.c.sub(t);for(var o=this.m_jointList;o;o=o.m_next)o.shiftOrigin(t);this.m_broadPhase.shiftOrigin(t)}},i.prototype._addBody=function(t){this.isLocked()||(t.m_prev=null,t.m_next=this.m_bodyList,this.m_bodyList&&(this.m_bodyList.m_prev=t),this.m_bodyList=t,++this.m_bodyCount)},i.prototype.createBody=function(t,e){if(this.isLocked())return null;var o={};t&&(a.isValid(t)?o={position:t,angle:e}:typeof t=="object"&&(o=t));var s=new W(this,o);return this._addBody(s),s},i.prototype.createDynamicBody=function(t,e){var o={};return t&&(a.isValid(t)?o={position:t,angle:e}:typeof t=="object"&&(o=t)),o.type="dynamic",this.createBody(o)},i.prototype.createKinematicBody=function(t,e){var o={};return t&&(a.isValid(t)?o={position:t,angle:e}:typeof t=="object"&&(o=t)),o.type="kinematic",this.createBody(o)},i.prototype.destroyBody=function(t){if(!this.isLocked()){if(t.m_destroyed)return!1;for(var e=t.m_jointList;e;){var o=e;e=e.next,this.publish("remove-joint",o.joint),this.destroyJoint(o.joint),t.m_jointList=e}t.m_jointList=null;for(var s=t.m_contactList;s;){var r=s;s=s.next,this.destroyContact(r.contact),t.m_contactList=s}t.m_contactList=null;for(var n=t.m_fixtureList;n;){var m=n;n=n.m_next,this.publish("remove-fixture",m),m.destroyProxies(this.m_broadPhase),t.m_fixtureList=n}return t.m_fixtureList=null,t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t==this.m_bodyList&&(this.m_bodyList=t.m_next),t.m_destroyed=!0,--this.m_bodyCount,this.publish("remove-body",t),!0}},i.prototype.createJoint=function(t){if(this.isLocked())return null;if(t.m_prev=null,t.m_next=this.m_jointList,this.m_jointList&&(this.m_jointList.m_prev=t),this.m_jointList=t,++this.m_jointCount,t.m_edgeA.joint=t,t.m_edgeA.other=t.m_bodyB,t.m_edgeA.prev=null,t.m_edgeA.next=t.m_bodyA.m_jointList,t.m_bodyA.m_jointList&&(t.m_bodyA.m_jointList.prev=t.m_edgeA),t.m_bodyA.m_jointList=t.m_edgeA,t.m_edgeB.joint=t,t.m_edgeB.other=t.m_bodyA,t.m_edgeB.prev=null,t.m_edgeB.next=t.m_bodyB.m_jointList,t.m_bodyB.m_jointList&&(t.m_bodyB.m_jointList.prev=t.m_edgeB),t.m_bodyB.m_jointList=t.m_edgeB,t.m_collideConnected==!1)for(var e=t.m_bodyB.getContactList();e;e=e.next)e.other==t.m_bodyA&&e.contact.flagForFiltering();return t},i.prototype.destroyJoint=function(t){if(!this.isLocked()){t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t==this.m_jointList&&(this.m_jointList=t.m_next);var e=t.m_bodyA,o=t.m_bodyB;if(e.setAwake(!0),o.setAwake(!0),t.m_edgeA.prev&&(t.m_edgeA.prev.next=t.m_edgeA.next),t.m_edgeA.next&&(t.m_edgeA.next.prev=t.m_edgeA.prev),t.m_edgeA==e.m_jointList&&(e.m_jointList=t.m_edgeA.next),t.m_edgeA.prev=null,t.m_edgeA.next=null,t.m_edgeB.prev&&(t.m_edgeB.prev.next=t.m_edgeB.next),t.m_edgeB.next&&(t.m_edgeB.next.prev=t.m_edgeB.prev),t.m_edgeB==o.m_jointList&&(o.m_jointList=t.m_edgeB.next),t.m_edgeB.prev=null,t.m_edgeB.next=null,--this.m_jointCount,t.m_collideConnected==!1)for(var s=o.getContactList();s;)s.other==e&&s.contact.flagForFiltering(),s=s.next;this.publish("remove-joint",t)}},i.prototype.step=function(t,e,o){if(this.publish("pre-step",t),(e|0)!==e&&(e=0),e=e||this.m_velocityIterations,o=o||this.m_positionIterations,this.m_newFixture&&(this.findNewContacts(),this.m_newFixture=!1),this.m_locked=!0,this.s_step.reset(t),this.s_step.velocityIterations=e,this.s_step.positionIterations=o,this.s_step.warmStarting=this.m_warmStarting,this.s_step.blockSolve=this.m_blockSolve,this.updateContacts(),this.m_stepComplete&&t>0){this.m_solver.solveWorld(this.s_step);for(var s=this.m_bodyList;s;s=s.getNext())s.m_islandFlag!=!1&&(s.isStatic()||s.synchronizeFixtures());this.findNewContacts()}this.m_continuousPhysics&&t>0&&this.m_solver.solveWorldTOI(this.s_step),this.m_clearForces&&this.clearForces(),this.m_locked=!1;for(var r;r=this.m_step_callback.shift();)r(this);this.publish("post-step",t)},i.prototype.queueUpdate=function(t){this.isLocked()?this.m_step_callback.push(t):t(this)},i.prototype.findNewContacts=function(){var t=this;this.m_broadPhase.updatePairs(function(e,o){return t.createContact(e,o)})},i.prototype.createContact=function(t,e){var o=t.fixture,s=e.fixture,r=t.childIndex,n=e.childIndex,m=o.getBody(),h=s.getBody();if(m!=h){for(var u=h.getContactList();u;){if(u.other==m){var l=u.contact.getFixtureA(),p=u.contact.getFixtureB(),c=u.contact.getChildIndexA(),_=u.contact.getChildIndexB();if(l==o&&p==s&&c==r&&_==n||l==s&&p==o&&c==n&&_==r)return}u=u.next}if(h.shouldCollide(m)!=!1&&s.shouldCollide(o)!=!1){var d=Wt.create(o,r,s,n);d!=null&&(d.m_prev=null,this.m_contactList!=null&&(d.m_next=this.m_contactList,this.m_contactList.m_prev=d),this.m_contactList=d,++this.m_contactCount)}}},i.prototype.updateContacts=function(){for(var t,e=this.m_contactList;t=e;){e=t.getNext();var o=t.getFixtureA(),s=t.getFixtureB(),r=t.getChildIndexA(),n=t.getChildIndexB(),m=o.getBody(),h=s.getBody();if(t.m_filterFlag){if(h.shouldCollide(m)==!1){this.destroyContact(t);continue}if(s.shouldCollide(o)==!1){this.destroyContact(t);continue}t.m_filterFlag=!1}var u=m.isAwake()&&!m.isStatic(),l=h.isAwake()&&!h.isStatic();if(!(u==!1&&l==!1)){var p=o.m_proxies[r].proxyId,c=s.m_proxies[n].proxyId,_=this.m_broadPhase.testOverlap(p,c);if(_==!1){this.destroyContact(t);continue}t.update(this)}}},i.prototype.destroyContact=function(t){t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t==this.m_contactList&&(this.m_contactList=t.m_next),Wt.destroy(t,this),--this.m_contactCount},i.prototype.on=function(t,e){return typeof t!="string"||typeof e!="function"?this:(this._listeners||(this._listeners={}),this._listeners[t]||(this._listeners[t]=[]),this._listeners[t].push(e),this)},i.prototype.off=function(t,e){if(typeof t!="string"||typeof e!="function")return this;var o=this._listeners&&this._listeners[t];if(!o||!o.length)return this;var s=o.indexOf(e);return s>=0&&o.splice(s,1),this},i.prototype.publish=function(t,e,o,s){var r=this._listeners&&this._listeners[t];if(!r||!r.length)return 0;for(var n=0;n<r.length;n++)r[n].call(this,e,o,s);return r.length},i.prototype.beginContact=function(t){this.publish("begin-contact",t)},i.prototype.endContact=function(t){this.publish("end-contact",t)},i.prototype.preSolve=function(t,e){this.publish("pre-solve",t,e)},i.prototype.postSolve=function(t,e){this.publish("post-solve",t,e)},i}(),J=function(){function i(t,e,o){if(!(this instanceof i))return new i(t,e,o);typeof t>"u"?(this.x=0,this.y=0,this.z=0):typeof t=="object"?(this.x=t.x,this.y=t.y,this.z=t.z):(this.x=t,this.y=e,this.z=o)}return i.prototype._serialize=function(){return{x:this.x,y:this.y,z:this.z}},i._deserialize=function(t){var e=Object.create(i.prototype);return e.x=t.x,e.y=t.y,e.z=t.z,e},i.neo=function(t,e,o){var s=Object.create(i.prototype);return s.x=t,s.y=e,s.z=o,s},i.zero=function(){var t=Object.create(i.prototype);return t.x=0,t.y=0,t.z=0,t},i.clone=function(t){return i.neo(t.x,t.y,t.z)},i.prototype.toString=function(){return JSON.stringify(this)},i.isValid=function(t){return t===null||typeof t>"u"?!1:Number.isFinite(t.x)&&Number.isFinite(t.y)&&Number.isFinite(t.z)},i.assert=function(t){},i.prototype.setZero=function(){return this.x=0,this.y=0,this.z=0,this},i.prototype.set=function(t,e,o){return this.x=t,this.y=e,this.z=o,this},i.prototype.add=function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this},i.prototype.sub=function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this},i.prototype.mul=function(t){return this.x*=t,this.y*=t,this.z*=t,this},i.areEqual=function(t,e){return t===e||typeof t=="object"&&t!==null&&typeof e=="object"&&e!==null&&t.x===e.x&&t.y===e.y&&t.z===e.z},i.dot=function(t,e){return t.x*e.x+t.y*e.y+t.z*e.z},i.cross=function(t,e){return new i(t.y*e.z-t.z*e.y,t.z*e.x-t.x*e.z,t.x*e.y-t.y*e.x)},i.add=function(t,e){return new i(t.x+e.x,t.y+e.y,t.z+e.z)},i.sub=function(t,e){return new i(t.x-e.x,t.y-e.y,t.z-e.z)},i.mul=function(t,e){return new i(e*t.x,e*t.y,e*t.z)},i.prototype.neg=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},i.neg=function(t){return new i(-t.x,-t.y,-t.z)},i}(),Hs=A(0,0),Zs=A(0,0),te=function(i){xt(t,i);function t(e,o){var s=this;return s instanceof t?(s=i.call(this)||this,s.m_type=t.TYPE,s.m_radius=P.polygonRadius,s.m_vertex1=e?a.clone(e):a.zero(),s.m_vertex2=o?a.clone(o):a.zero(),s.m_vertex0=a.zero(),s.m_vertex3=a.zero(),s.m_hasVertex0=!1,s.m_hasVertex3=!1,s):new t(e,o)}return t.prototype._serialize=function(){return{type:this.m_type,vertex1:this.m_vertex1,vertex2:this.m_vertex2,vertex0:this.m_vertex0,vertex3:this.m_vertex3,hasVertex0:this.m_hasVertex0,hasVertex3:this.m_hasVertex3}},t._deserialize=function(e){var o=new t(e.vertex1,e.vertex2);return o.m_hasVertex0&&o.setPrevVertex(e.vertex0),o.m_hasVertex3&&o.setNextVertex(e.vertex3),o},t.prototype._reset=function(){},t.prototype.getRadius=function(){return this.m_radius},t.prototype.getType=function(){return this.m_type},t.prototype.setNext=function(e){return this.setNextVertex(e)},t.prototype.setNextVertex=function(e){return e?(this.m_vertex3.setVec2(e),this.m_hasVertex3=!0):(this.m_vertex3.setZero(),this.m_hasVertex3=!1),this},t.prototype.getNextVertex=function(){return this.m_vertex3},t.prototype.setPrev=function(e){return this.setPrevVertex(e)},t.prototype.setPrevVertex=function(e){return e?(this.m_vertex0.setVec2(e),this.m_hasVertex0=!0):(this.m_vertex0.setZero(),this.m_hasVertex0=!1),this},t.prototype.getPrevVertex=function(){return this.m_vertex0},t.prototype._set=function(e,o){return this.m_vertex1.setVec2(e),this.m_vertex2.setVec2(o),this.m_hasVertex0=!1,this.m_hasVertex3=!1,this},t.prototype._clone=function(){var e=new t;return e.m_type=this.m_type,e.m_radius=this.m_radius,e.m_vertex1.setVec2(this.m_vertex1),e.m_vertex2.setVec2(this.m_vertex2),e.m_vertex0.setVec2(this.m_vertex0),e.m_vertex3.setVec2(this.m_vertex3),e.m_hasVertex0=this.m_hasVertex0,e.m_hasVertex3=this.m_hasVertex3,e},t.prototype.getChildCount=function(){return 1},t.prototype.testPoint=function(e,o){return!1},t.prototype.rayCast=function(e,o,s,r){var n=b.mulTVec2(s.q,a.sub(o.p1,s.p)),m=b.mulTVec2(s.q,a.sub(o.p2,s.p)),h=a.sub(m,n),u=this.m_vertex1,l=this.m_vertex2,p=a.sub(l,u),c=a.neo(p.y,-p.x);c.normalize();var _=a.dot(c,a.sub(u,n)),d=a.dot(c,h);if(d==0)return!1;var y=_/d;if(y<0||o.maxFraction<y)return!1;var f=a.add(n,a.mulNumVec2(y,h)),v=a.sub(l,u),g=a.dot(v,v);if(g==0)return!1;var B=a.dot(a.sub(f,u),v)/g;return B<0||1<B?!1:(e.fraction=y,_>0?e.normal=b.mulVec2(s.q,c).neg():e.normal=b.mulVec2(s.q,c),!0)},t.prototype.computeAABB=function(e,o,s){q(Hs,o,this.m_vertex1),q(Zs,o,this.m_vertex2),ht.combinePoints(e,Hs,Zs),ht.extend(e,this.m_radius)},t.prototype.computeMass=function(e,o){e.mass=0,Q(e.center,.5,this.m_vertex1,.5,this.m_vertex2),e.I=0},t.prototype.computeDistanceProxy=function(e){e.m_vertices[0]=this.m_vertex1,e.m_vertices[1]=this.m_vertex2,e.m_vertices.length=2,e.m_count=2,e.m_radius=this.m_radius},t.TYPE="edge",t}(Ve),Mn=te,Ks=A(0,0),Xs=A(0,0),Ge=function(i){xt(t,i);function t(e,o){var s=this;return s instanceof t?(s=i.call(this)||this,s.m_type=t.TYPE,s.m_radius=P.polygonRadius,s.m_vertices=[],s.m_count=0,s.m_prevVertex=null,s.m_nextVertex=null,s.m_hasPrevVertex=!1,s.m_hasNextVertex=!1,s.m_isLoop=!!o,e&&e.length&&(o?s._createLoop(e):s._createChain(e)),s):new t(e,o)}return t.prototype._serialize=function(){var e={type:this.m_type,vertices:this.m_isLoop?this.m_vertices.slice(0,this.m_vertices.length-1):this.m_vertices,isLoop:this.m_isLoop,hasPrevVertex:this.m_hasPrevVertex,hasNextVertex:this.m_hasNextVertex,prevVertex:null,nextVertex:null};return this.m_prevVertex&&(e.prevVertex=this.m_prevVertex),this.m_nextVertex&&(e.nextVertex=this.m_nextVertex),e},t._deserialize=function(e,o,s){var r=[];if(e.vertices)for(var n=0;n<e.vertices.length;n++)r.push(s(a,e.vertices[n]));var m=new t(r,e.isLoop);return e.prevVertex&&m.setPrevVertex(e.prevVertex),e.nextVertex&&m.setNextVertex(e.nextVertex),m},t.prototype.getType=function(){return this.m_type},t.prototype.getRadius=function(){return this.m_radius},t.prototype._createLoop=function(e){if(!(e.length<3)){for(var o=1;o<e.length;++o)e[o-1],e[o];this.m_vertices=[],this.m_count=e.length+1;for(var o=0;o<e.length;++o)this.m_vertices[o]=a.clone(e[o]);return this.m_vertices[e.length]=a.clone(e[0]),this.m_prevVertex=this.m_vertices[this.m_count-2],this.m_nextVertex=this.m_vertices[1],this.m_hasPrevVertex=!0,this.m_hasNextVertex=!0,this}},t.prototype._createChain=function(e){for(var o=1;o<e.length;++o)e[o-1],e[o];this.m_vertices=[],this.m_count=e.length;for(var o=0;o<e.length;++o)this.m_vertices[o]=a.clone(e[o]);return this.m_prevVertex=null,this.m_nextVertex=null,this.m_hasPrevVertex=!1,this.m_hasNextVertex=!1,this},t.prototype._reset=function(){this.m_isLoop?this._createLoop(this.m_vertices.slice(0,this.m_vertices.length-1)):this._createChain(this.m_vertices)},t.prototype.setPrevVertex=function(e){this.m_prevVertex=e,this.m_hasPrevVertex=!0},t.prototype.getPrevVertex=function(){return this.m_prevVertex},t.prototype.setNextVertex=function(e){this.m_nextVertex=e,this.m_hasNextVertex=!0},t.prototype.getNextVertex=function(){return this.m_nextVertex},t.prototype._clone=function(){var e=new t;return e._createChain(this.m_vertices),e.m_type=this.m_type,e.m_radius=this.m_radius,e.m_prevVertex=this.m_prevVertex,e.m_nextVertex=this.m_nextVertex,e.m_hasPrevVertex=this.m_hasPrevVertex,e.m_hasNextVertex=this.m_hasNextVertex,e},t.prototype.getChildCount=function(){return this.m_count-1},t.prototype.getChildEdge=function(e,o){e.m_type=te.TYPE,e.m_radius=this.m_radius,e.m_vertex1=this.m_vertices[o],e.m_vertex2=this.m_vertices[o+1],o>0?(e.m_vertex0=this.m_vertices[o-1],e.m_hasVertex0=!0):(e.m_vertex0=this.m_prevVertex,e.m_hasVertex0=this.m_hasPrevVertex),o<this.m_count-2?(e.m_vertex3=this.m_vertices[o+2],e.m_hasVertex3=!0):(e.m_vertex3=this.m_nextVertex,e.m_hasVertex3=this.m_hasNextVertex)},t.prototype.getVertex=function(e){return e<this.m_count?this.m_vertices[e]:this.m_vertices[0]},t.prototype.isLoop=function(){return this.m_isLoop},t.prototype.testPoint=function(e,o){return!1},t.prototype.rayCast=function(e,o,s,r){var n=new te(this.getVertex(r),this.getVertex(r+1));return n.rayCast(e,o,s,0)},t.prototype.computeAABB=function(e,o,s){q(Ks,o,this.getVertex(s)),q(Xs,o,this.getVertex(s+1)),ht.combinePoints(e,Ks,Xs)},t.prototype.computeMass=function(e,o){e.mass=0,z(e.center),e.I=0},t.prototype.computeDistanceProxy=function(e,o){e.m_vertices[0]=this.getVertex(o),e.m_vertices[1]=this.getVertex(o+1),e.m_count=2,e.m_radius=this.m_radius},t.TYPE="chain",t}(Ve),In=Ge,Gs=Math.max,is=Math.min,Ue=A(0,0),Qs=A(0,0),Vi=A(0,0),mi=A(0,0),Oe=A(0,0),Pe=A(0,0),ee=function(i){xt(t,i);function t(e){var o=this;return o instanceof t?(o=i.call(this)||this,o.m_type=t.TYPE,o.m_radius=P.polygonRadius,o.m_centroid=a.zero(),o.m_vertices=[],o.m_normals=[],o.m_count=0,e&&e.length&&o._set(e),o):new t(e)}return t.prototype._serialize=function(){return{type:this.m_type,vertices:this.m_vertices}},t._deserialize=function(e,o,s){var r=[];if(e.vertices)for(var n=0;n<e.vertices.length;n++)r.push(s(a,e.vertices[n]));var m=new t(r);return m},t.prototype.getType=function(){return this.m_type},t.prototype.getRadius=function(){return this.m_radius},t.prototype._clone=function(){var e=new t;e.m_type=this.m_type,e.m_radius=this.m_radius,e.m_count=this.m_count,e.m_centroid.setVec2(this.m_centroid);for(var o=0;o<this.m_count;o++)e.m_vertices.push(this.m_vertices[o].clone());for(var o=0;o<this.m_normals.length;o++)e.m_normals.push(this.m_normals[o].clone());return e},t.prototype.getChildCount=function(){return 1},t.prototype._reset=function(){this._set(this.m_vertices)},t.prototype._set=function(e){if(e.length<3){this._setAsBox(1,1);return}for(var o=is(e.length,P.maxPolygonVertices),s=[],r=0;r<o;++r){for(var n=e[r],m=!0,h=0;h<s.length;++h)if(a.distanceSquared(n,s[h])<.25*P.linearSlopSquared){m=!1;break}m&&s.push(a.clone(n))}if(o=s.length,o<3){this._setAsBox(1,1);return}for(var u=0,l=s[0].x,r=1;r<o;++r){var p=s[r].x;(p>l||p===l&&s[r].y<s[u].y)&&(u=r,l=p)}for(var c=[],_=0,d=u;;){c[_]=d;for(var y=0,h=1;h<o;++h){if(y===d){y=h;continue}var f=a.sub(s[y],s[c[_]]),n=a.sub(s[h],s[c[_]]),v=a.crossVec2Vec2(f,n);v<0&&(y=h),v===0&&n.lengthSquared()>f.lengthSquared()&&(y=h)}if(++_,d=y,y===u)break}if(_<3){this._setAsBox(1,1);return}this.m_count=_,this.m_vertices=[];for(var r=0;r<_;++r)this.m_vertices[r]=s[c[r]];for(var r=0;r<_;++r){var g=r,B=r+1<_?r+1:0,w=a.sub(this.m_vertices[B],this.m_vertices[g]);this.m_normals[r]=a.crossVec2Num(w,1),this.m_normals[r].normalize()}this.m_centroid=yr(this.m_vertices,_)},t.prototype._setAsBox=function(e,o,s,r){if(this.m_vertices[0]=a.neo(e,-o),this.m_vertices[1]=a.neo(e,o),this.m_vertices[2]=a.neo(-e,o),this.m_vertices[3]=a.neo(-e,-o),this.m_normals[0]=a.neo(1,0),this.m_normals[1]=a.neo(0,1),this.m_normals[2]=a.neo(-1,0),this.m_normals[3]=a.neo(0,-1),this.m_count=4,s&&a.isValid(s)){r=r||0,x(this.m_centroid,s);var n=ft.identity();n.p.setVec2(s),n.q.setAngle(r);for(var m=0;m<this.m_count;++m)this.m_vertices[m]=ft.mulVec2(n,this.m_vertices[m]),this.m_normals[m]=b.mulVec2(n.q,this.m_normals[m])}},t.prototype.testPoint=function(e,o){for(var s=us(Ue,e,o),r=0;r<this.m_count;++r){var n=C(this.m_normals[r],s)-C(this.m_normals[r],this.m_vertices[r]);if(n>0)return!1}return!0},t.prototype.rayCast=function(e,o,s,r){for(var n=b.mulTVec2(s.q,a.sub(o.p1,s.p)),m=b.mulTVec2(s.q,a.sub(o.p2,s.p)),h=a.sub(m,n),u=0,l=o.maxFraction,p=-1,c=0;c<this.m_count;++c){var _=a.dot(this.m_normals[c],a.sub(this.m_vertices[c],n)),d=a.dot(this.m_normals[c],h);if(d==0){if(_<0)return!1}else d<0&&_<u*d?(u=_/d,p=c):d>0&&_<l*d&&(l=_/d);if(l<u)return!1}return p>=0?(e.fraction=u,e.normal=b.mulVec2(s.q,this.m_normals[p]),!0):!1},t.prototype.computeAABB=function(e,o,s){for(var r=1/0,n=1/0,m=-1/0,h=-1/0,u=0;u<this.m_count;++u){var l=q(Ue,o,this.m_vertices[u]);r=is(r,l.x),m=Gs(m,l.x),n=is(n,l.y),h=Gs(h,l.y)}ut(e.lowerBound,r-this.m_radius,n-this.m_radius),ut(e.upperBound,m+this.m_radius,h+this.m_radius)},t.prototype.computeMass=function(e,o){z(Oe);var s=0,r=0;z(Pe);for(var n=0;n<this.m_count;++n)Jt(Pe,this.m_vertices[n]);L(Pe,1/this.m_count,Pe);for(var m=1/3,n=0;n<this.m_count;++n){N(Vi,this.m_vertices[n],Pe),n+1<this.m_count?N(mi,this.m_vertices[n+1],Pe):N(mi,this.m_vertices[0],Pe);var h=j(Vi,mi),u=.5*h;s+=u,Q(Ue,u*m,Vi,u*m,mi),Jt(Oe,Ue);var l=Vi.x,p=Vi.y,c=mi.x,_=mi.y,d=l*l+c*l+c*c,y=p*p+_*p+_*_;r+=.25*m*h*(d+y)}e.mass=o*s,L(Oe,1/s,Oe),Zn(e.center,Oe,Pe),e.I=o*r,e.I+=e.mass*(C(e.center,e.center)-C(Oe,Oe))},t.prototype.validate=function(){for(var e=0;e<this.m_count;++e){var o=e,s=e<this.m_count-1?o+1:0,r=this.m_vertices[o];N(Qs,this.m_vertices[s],r);for(var n=0;n<this.m_count;++n)if(!(n==o||n==s)){var m=j(Qs,N(Ue,this.m_vertices[n],r));if(m<0)return!1}}return!0},t.prototype.computeDistanceProxy=function(e){for(var o=0;o<this.m_count;++o)e.m_vertices[o]=this.m_vertices[o];e.m_vertices.length=this.m_count,e.m_count=this.m_count,e.m_radius=this.m_radius},t.TYPE="polygon",t}(Ve);function yr(i,t){for(var e=a.zero(),o=0,s=a.zero(),n,r=1/3,n=0;n<t;++n){var m=s,h=i[n],u=n+1<t?i[n+1]:i[0],l=a.sub(h,m),p=a.sub(u,m),c=a.crossVec2Vec2(l,p),_=.5*c;o+=_,ae(Ue,1,m,1,h,1,u),Qt(e,_*r,Ue)}return e.mul(1/o),e}var Pn=ee,dr=Math.sqrt,fr=Math.PI,$s=A(0,0),le=function(i){xt(t,i);function t(e,o){var s=this;return s instanceof t?(s=i.call(this)||this,s.m_type=t.TYPE,s.m_p=a.zero(),s.m_radius=1,typeof e=="object"&&a.isValid(e)?(s.m_p.setVec2(e),typeof o=="number"&&(s.m_radius=o)):typeof e=="number"&&(s.m_radius=e),s):new t(e,o)}return t.prototype._serialize=function(){return{type:this.m_type,p:this.m_p,radius:this.m_radius}},t._deserialize=function(e){return new t(e.p,e.radius)},t.prototype._reset=function(){},t.prototype.getType=function(){return this.m_type},t.prototype.getRadius=function(){return this.m_radius},t.prototype.getCenter=function(){return this.m_p},t.prototype._clone=function(){var e=new t;return e.m_type=this.m_type,e.m_radius=this.m_radius,e.m_p=this.m_p.clone(),e},t.prototype.getChildCount=function(){return 1},t.prototype.testPoint=function(e,o){var s=q($s,e,this.m_p);return Ke(o,s)<=this.m_radius*this.m_radius},t.prototype.rayCast=function(e,o,s,r){var n=a.add(s.p,b.mulVec2(s.q,this.m_p)),m=a.sub(o.p1,n),h=a.dot(m,m)-this.m_radius*this.m_radius,u=a.sub(o.p2,o.p1),l=a.dot(m,u),p=a.dot(u,u),c=l*l-p*h;if(c<0||p<It)return!1;var _=-(l+dr(c));return 0<=_&&_<=o.maxFraction*p?(_/=p,e.fraction=_,e.normal=a.add(m,a.mulNumVec2(_,u)),e.normal.normalize(),!0):!1},t.prototype.computeAABB=function(e,o,s){var r=q($s,o,this.m_p);ut(e.lowerBound,r.x-this.m_radius,r.y-this.m_radius),ut(e.upperBound,r.x+this.m_radius,r.y+this.m_radius)},t.prototype.computeMass=function(e,o){e.mass=o*fr*this.m_radius*this.m_radius,x(e.center,this.m_p),e.I=e.mass*(.5*this.m_radius*this.m_radius+Ze(this.m_p))},t.prototype.computeDistanceProxy=function(e){e.m_vertices[0]=this.m_p,e.m_vertices.length=1,e.m_count=1,e.m_radius=this.m_radius},t.TYPE="circle",t}(Ve),Sn=le,vr=Math.abs,xr=Math.PI,gr={frequencyHz:0,dampingRatio:0},Bo=function(i){xt(t,i);function t(e,o,s,r,n){var m=this;if(!(m instanceof t))return new t(e,o,s,r,n);if(s&&r&&"m_type"in r&&"x"in s&&"y"in s){var h=s;s=r,r=h}return e=Nt(e,gr),m=i.call(this,e,o,s)||this,o=m.m_bodyA,s=m.m_bodyB,m.m_type=t.TYPE,m.m_localAnchorA=a.clone(r?o.getLocalPoint(r):e.localAnchorA||a.zero()),m.m_localAnchorB=a.clone(n?s.getLocalPoint(n):e.localAnchorB||a.zero()),m.m_length=Number.isFinite(e.length)?e.length:a.distance(o.getWorldPoint(m.m_localAnchorA),s.getWorldPoint(m.m_localAnchorB)),m.m_frequencyHz=e.frequencyHz,m.m_dampingRatio=e.dampingRatio,m.m_impulse=0,m.m_gamma=0,m.m_bias=0,m}return t.prototype._serialize=function(){return{type:this.m_type,bodyA:this.m_bodyA,bodyB:this.m_bodyB,collideConnected:this.m_collideConnected,frequencyHz:this.m_frequencyHz,dampingRatio:this.m_dampingRatio,localAnchorA:this.m_localAnchorA,localAnchorB:this.m_localAnchorB,length:this.m_length,impulse:this.m_impulse,gamma:this.m_gamma,bias:this.m_bias}},t._deserialize=function(e,o,s){e=vt({},e),e.bodyA=s(W,e.bodyA,o),e.bodyB=s(W,e.bodyB,o);var r=new t(e);return r},t.prototype._reset=function(e){e.anchorA?this.m_localAnchorA.setVec2(this.m_bodyA.getLocalPoint(e.anchorA)):e.localAnchorA&&this.m_localAnchorA.setVec2(e.localAnchorA),e.anchorB?this.m_localAnchorB.setVec2(this.m_bodyB.getLocalPoint(e.anchorB)):e.localAnchorB&&this.m_localAnchorB.setVec2(e.localAnchorB),e.length>0?this.m_length=+e.length:e.length<0||(e.anchorA||e.anchorA||e.anchorA||e.anchorA)&&(this.m_length=a.distance(this.m_bodyA.getWorldPoint(this.m_localAnchorA),this.m_bodyB.getWorldPoint(this.m_localAnchorB))),Number.isFinite(e.frequencyHz)&&(this.m_frequencyHz=e.frequencyHz),Number.isFinite(e.dampingRatio)&&(this.m_dampingRatio=e.dampingRatio)},t.prototype.getLocalAnchorA=function(){return this.m_localAnchorA},t.prototype.getLocalAnchorB=function(){return this.m_localAnchorB},t.prototype.setLength=function(e){this.m_length=e},t.prototype.getLength=function(){return this.m_length},t.prototype.setFrequency=function(e){this.m_frequencyHz=e},t.prototype.getFrequency=function(){return this.m_frequencyHz},t.prototype.setDampingRatio=function(e){this.m_dampingRatio=e},t.prototype.getDampingRatio=function(){return this.m_dampingRatio},t.prototype.getAnchorA=function(){return this.m_bodyA.getWorldPoint(this.m_localAnchorA)},t.prototype.getAnchorB=function(){return this.m_bodyB.getWorldPoint(this.m_localAnchorB)},t.prototype.getReactionForce=function(e){return a.mulNumVec2(this.m_impulse,this.m_u).mul(e)},t.prototype.getReactionTorque=function(e){return 0},t.prototype.initVelocityConstraints=function(e){this.m_localCenterA=this.m_bodyA.m_sweep.localCenter,this.m_localCenterB=this.m_bodyB.m_sweep.localCenter,this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var o=this.m_bodyA.c_position.c,s=this.m_bodyA.c_position.a,r=this.m_bodyA.c_velocity.v,n=this.m_bodyA.c_velocity.w,m=this.m_bodyB.c_position.c,h=this.m_bodyB.c_position.a,u=this.m_bodyB.c_velocity.v,l=this.m_bodyB.c_velocity.w,p=b.neo(s),c=b.neo(h);this.m_rA=b.mulVec2(p,a.sub(this.m_localAnchorA,this.m_localCenterA)),this.m_rB=b.mulVec2(c,a.sub(this.m_localAnchorB,this.m_localCenterB)),this.m_u=a.sub(a.add(m,this.m_rB),a.add(o,this.m_rA));var _=this.m_u.length();_>P.linearSlop?this.m_u.mul(1/_):this.m_u.setNum(0,0);var d=a.crossVec2Vec2(this.m_rA,this.m_u),y=a.crossVec2Vec2(this.m_rB,this.m_u),f=this.m_invMassA+this.m_invIA*d*d+this.m_invMassB+this.m_invIB*y*y;if(this.m_mass=f!=0?1/f:0,this.m_frequencyHz>0){var v=_-this.m_length,g=2*xr*this.m_frequencyHz,B=2*this.m_mass*this.m_dampingRatio*g,w=this.m_mass*g*g,V=e.dt;this.m_gamma=V*(B+V*w),this.m_gamma=this.m_gamma!=0?1/this.m_gamma:0,this.m_bias=v*V*w*this.m_gamma,f+=this.m_gamma,this.m_mass=f!=0?1/f:0}else this.m_gamma=0,this.m_bias=0;if(e.warmStarting){this.m_impulse*=e.dtRatio;var I=a.mulNumVec2(this.m_impulse,this.m_u);r.subMul(this.m_invMassA,I),n-=this.m_invIA*a.crossVec2Vec2(this.m_rA,I),u.addMul(this.m_invMassB,I),l+=this.m_invIB*a.crossVec2Vec2(this.m_rB,I)}else this.m_impulse=0;this.m_bodyA.c_velocity.v.setVec2(r),this.m_bodyA.c_velocity.w=n,this.m_bodyB.c_velocity.v.setVec2(u),this.m_bodyB.c_velocity.w=l},t.prototype.solveVelocityConstraints=function(e){var o=this.m_bodyA.c_velocity.v,s=this.m_bodyA.c_velocity.w,r=this.m_bodyB.c_velocity.v,n=this.m_bodyB.c_velocity.w,m=a.add(o,a.crossNumVec2(s,this.m_rA)),h=a.add(r,a.crossNumVec2(n,this.m_rB)),u=a.dot(this.m_u,h)-a.dot(this.m_u,m),l=-this.m_mass*(u+this.m_bias+this.m_gamma*this.m_impulse);this.m_impulse+=l;var p=a.mulNumVec2(l,this.m_u);o.subMul(this.m_invMassA,p),s-=this.m_invIA*a.crossVec2Vec2(this.m_rA,p),r.addMul(this.m_invMassB,p),n+=this.m_invIB*a.crossVec2Vec2(this.m_rB,p),this.m_bodyA.c_velocity.v.setVec2(o),this.m_bodyA.c_velocity.w=s,this.m_bodyB.c_velocity.v.setVec2(r),this.m_bodyB.c_velocity.w=n},t.prototype.solvePositionConstraints=function(e){if(this.m_frequencyHz>0)return!0;var o=this.m_bodyA.c_position.c,s=this.m_bodyA.c_position.a,r=this.m_bodyB.c_position.c,n=this.m_bodyB.c_position.a,m=b.neo(s),h=b.neo(n),u=b.mulSub(m,this.m_localAnchorA,this.m_localCenterA),l=b.mulSub(h,this.m_localAnchorB,this.m_localCenterB),p=a.sub(a.add(r,l),a.add(o,u)),c=p.normalize(),_=pt(c-this.m_length,-P.maxLinearCorrection,P.maxLinearCorrection),d=-this.m_mass*_,y=a.mulNumVec2(d,p);return o.subMul(this.m_invMassA,y),s-=this.m_invIA*a.crossVec2Vec2(u,y),r.addMul(this.m_invMassB,y),n+=this.m_invIB*a.crossVec2Vec2(l,y),this.m_bodyA.c_position.c.setVec2(o),this.m_bodyA.c_position.a=s,this.m_bodyB.c_position.c.setVec2(r),this.m_bodyB.c_position.a=n,vr(_)<P.linearSlop},t.TYPE="distance-joint",t}(yt),Ar={maxForce:0,maxTorque:0},wo=function(i){xt(t,i);function t(e,o,s,r){var n=this;return n instanceof t?(e=Nt(e,Ar),n=i.call(this,e,o,s)||this,o=n.m_bodyA,s=n.m_bodyB,n.m_type=t.TYPE,n.m_localAnchorA=a.clone(r?o.getLocalPoint(r):e.localAnchorA||a.zero()),n.m_localAnchorB=a.clone(r?s.getLocalPoint(r):e.localAnchorB||a.zero()),n.m_linearImpulse=a.zero(),n.m_angularImpulse=0,n.m_maxForce=e.maxForce,n.m_maxTorque=e.maxTorque,n):new t(e,o,s,r)}return t.prototype._serialize=function(){return{type:this.m_type,bodyA:this.m_bodyA,bodyB:this.m_bodyB,collideConnected:this.m_collideConnected,maxForce:this.m_maxForce,maxTorque:this.m_maxTorque,localAnchorA:this.m_localAnchorA,localAnchorB:this.m_localAnchorB}},t._deserialize=function(e,o,s){e=vt({},e),e.bodyA=s(W,e.bodyA,o),e.bodyB=s(W,e.bodyB,o);var r=new t(e);return r},t.prototype._reset=function(e){e.anchorA?this.m_localAnchorA.setVec2(this.m_bodyA.getLocalPoint(e.anchorA)):e.localAnchorA&&this.m_localAnchorA.setVec2(e.localAnchorA),e.anchorB?this.m_localAnchorB.setVec2(this.m_bodyB.getLocalPoint(e.anchorB)):e.localAnchorB&&this.m_localAnchorB.setVec2(e.localAnchorB),Number.isFinite(e.maxForce)&&(this.m_maxForce=e.maxForce),Number.isFinite(e.maxTorque)&&(this.m_maxTorque=e.maxTorque)},t.prototype.getLocalAnchorA=function(){return this.m_localAnchorA},t.prototype.getLocalAnchorB=function(){return this.m_localAnchorB},t.prototype.setMaxForce=function(e){this.m_maxForce=e},t.prototype.getMaxForce=function(){return this.m_maxForce},t.prototype.setMaxTorque=function(e){this.m_maxTorque=e},t.prototype.getMaxTorque=function(){return this.m_maxTorque},t.prototype.getAnchorA=function(){return this.m_bodyA.getWorldPoint(this.m_localAnchorA)},t.prototype.getAnchorB=function(){return this.m_bodyB.getWorldPoint(this.m_localAnchorB)},t.prototype.getReactionForce=function(e){return a.mulNumVec2(e,this.m_linearImpulse)},t.prototype.getReactionTorque=function(e){return e*this.m_angularImpulse},t.prototype.initVelocityConstraints=function(e){this.m_localCenterA=this.m_bodyA.m_sweep.localCenter,this.m_localCenterB=this.m_bodyB.m_sweep.localCenter,this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var o=this.m_bodyA.c_position.a,s=this.m_bodyA.c_velocity.v,r=this.m_bodyA.c_velocity.w,n=this.m_bodyB.c_position.a,m=this.m_bodyB.c_velocity.v,h=this.m_bodyB.c_velocity.w,u=b.neo(o),l=b.neo(n);this.m_rA=b.mulVec2(u,a.sub(this.m_localAnchorA,this.m_localCenterA)),this.m_rB=b.mulVec2(l,a.sub(this.m_localAnchorB,this.m_localCenterB));var p=this.m_invMassA,c=this.m_invMassB,_=this.m_invIA,d=this.m_invIB,y=new qt;if(y.ex.x=p+c+_*this.m_rA.y*this.m_rA.y+d*this.m_rB.y*this.m_rB.y,y.ex.y=-_*this.m_rA.x*this.m_rA.y-d*this.m_rB.x*this.m_rB.y,y.ey.x=y.ex.y,y.ey.y=p+c+_*this.m_rA.x*this.m_rA.x+d*this.m_rB.x*this.m_rB.x,this.m_linearMass=y.getInverse(),this.m_angularMass=_+d,this.m_angularMass>0&&(this.m_angularMass=1/this.m_angularMass),e.warmStarting){this.m_linearImpulse.mul(e.dtRatio),this.m_angularImpulse*=e.dtRatio;var f=a.neo(this.m_linearImpulse.x,this.m_linearImpulse.y);s.subMul(p,f),r-=_*(a.crossVec2Vec2(this.m_rA,f)+this.m_angularImpulse),m.addMul(c,f),h+=d*(a.crossVec2Vec2(this.m_rB,f)+this.m_angularImpulse)}else this.m_linearImpulse.setZero(),this.m_angularImpulse=0;this.m_bodyA.c_velocity.v=s,this.m_bodyA.c_velocity.w=r,this.m_bodyB.c_velocity.v=m,this.m_bodyB.c_velocity.w=h},t.prototype.solveVelocityConstraints=function(e){var o=this.m_bodyA.c_velocity.v,s=this.m_bodyA.c_velocity.w,r=this.m_bodyB.c_velocity.v,n=this.m_bodyB.c_velocity.w,m=this.m_invMassA,h=this.m_invMassB,u=this.m_invIA,l=this.m_invIB,p=e.dt;{var c=n-s,_=-this.m_angularMass*c,d=this.m_angularImpulse,y=p*this.m_maxTorque;this.m_angularImpulse=pt(this.m_angularImpulse+_,-y,y),_=this.m_angularImpulse-d,s-=u*_,n+=l*_}{var c=a.sub(a.add(r,a.crossNumVec2(n,this.m_rB)),a.add(o,a.crossNumVec2(s,this.m_rA))),_=a.neg(qt.mulVec2(this.m_linearMass,c)),d=this.m_linearImpulse;this.m_linearImpulse.add(_);var y=p*this.m_maxForce;this.m_linearImpulse.lengthSquared()>y*y&&(this.m_linearImpulse.normalize(),this.m_linearImpulse.mul(y)),_=a.sub(this.m_linearImpulse,d),o.subMul(m,_),s-=u*a.crossVec2Vec2(this.m_rA,_),r.addMul(h,_),n+=l*a.crossVec2Vec2(this.m_rB,_)}this.m_bodyA.c_velocity.v=o,this.m_bodyA.c_velocity.w=s,this.m_bodyB.c_velocity.v=r,this.m_bodyB.c_velocity.w=n},t.prototype.solvePositionConstraints=function(e){return!0},t.TYPE="friction-joint",t}(yt),ce=function(){function i(t,e,o){typeof t=="object"&&t!==null?(this.ex=J.clone(t),this.ey=J.clone(e),this.ez=J.clone(o)):(this.ex=J.zero(),this.ey=J.zero(),this.ez=J.zero())}return i.prototype.toString=function(){return JSON.stringify(this)},i.isValid=function(t){return t===null||typeof t>"u"?!1:J.isValid(t.ex)&&J.isValid(t.ey)&&J.isValid(t.ez)},i.assert=function(t){},i.prototype.setZero=function(){return this.ex.setZero(),this.ey.setZero(),this.ez.setZero(),this},i.prototype.solve33=function(t){var e=this.ey.y*this.ez.z-this.ey.z*this.ez.y,o=this.ey.z*this.ez.x-this.ey.x*this.ez.z,s=this.ey.x*this.ez.y-this.ey.y*this.ez.x,r=this.ex.x*e+this.ex.y*o+this.ex.z*s;r!==0&&(r=1/r);var n=new J;return e=this.ey.y*this.ez.z-this.ey.z*this.ez.y,o=this.ey.z*this.ez.x-this.ey.x*this.ez.z,s=this.ey.x*this.ez.y-this.ey.y*this.ez.x,n.x=r*(t.x*e+t.y*o+t.z*s),e=t.y*this.ez.z-t.z*this.ez.y,o=t.z*this.ez.x-t.x*this.ez.z,s=t.x*this.ez.y-t.y*this.ez.x,n.y=r*(this.ex.x*e+this.ex.y*o+this.ex.z*s),e=this.ey.y*t.z-this.ey.z*t.y,o=this.ey.z*t.x-this.ey.x*t.z,s=this.ey.x*t.y-this.ey.y*t.x,n.z=r*(this.ex.x*e+this.ex.y*o+this.ex.z*s),n},i.prototype.solve22=function(t){var e=this.ex.x,o=this.ey.x,s=this.ex.y,r=this.ey.y,n=e*r-o*s;n!==0&&(n=1/n);var m=a.zero();return m.x=n*(r*t.x-o*t.y),m.y=n*(e*t.y-s*t.x),m},i.prototype.getInverse22=function(t){var e=this.ex.x,o=this.ey.x,s=this.ex.y,r=this.ey.y,n=e*r-o*s;n!==0&&(n=1/n),t.ex.x=n*r,t.ey.x=-n*o,t.ex.z=0,t.ex.y=-n*s,t.ey.y=n*e,t.ey.z=0,t.ez.x=0,t.ez.y=0,t.ez.z=0},i.prototype.getSymInverse33=function(t){var e=J.dot(this.ex,J.cross(this.ey,this.ez));e!==0&&(e=1/e);var o=this.ex.x,s=this.ey.x,r=this.ez.x,n=this.ey.y,m=this.ez.y,h=this.ez.z;t.ex.x=e*(n*h-m*m),t.ex.y=e*(r*m-s*h),t.ex.z=e*(s*m-r*n),t.ey.x=t.ex.y,t.ey.y=e*(o*h-r*r),t.ey.z=e*(r*s-o*m),t.ez.x=t.ex.z,t.ez.y=t.ey.z,t.ez.z=e*(o*n-s*s)},i.mul=function(t,e){if(e&&"z"in e&&"y"in e&&"x"in e){var o=t.ex.x*e.x+t.ey.x*e.y+t.ez.x*e.z,s=t.ex.y*e.x+t.ey.y*e.y+t.ez.y*e.z,r=t.ex.z*e.x+t.ey.z*e.y+t.ez.z*e.z;return new J(o,s,r)}else if(e&&"y"in e&&"x"in e){var o=t.ex.x*e.x+t.ey.x*e.y,s=t.ex.y*e.x+t.ey.y*e.y;return a.neo(o,s)}},i.mulVec3=function(t,e){var o=t.ex.x*e.x+t.ey.x*e.y+t.ez.x*e.z,s=t.ex.y*e.x+t.ey.y*e.y+t.ez.y*e.z,r=t.ex.z*e.x+t.ey.z*e.y+t.ez.z*e.z;return new J(o,s,r)},i.mulVec2=function(t,e){var o=t.ex.x*e.x+t.ey.x*e.y,s=t.ex.y*e.x+t.ey.y*e.y;return a.neo(o,s)},i.add=function(t,e){return new i(J.add(t.ex,e.ex),J.add(t.ey,e.ey),J.add(t.ez,e.ez))},i}(),tn=Math.abs,lt;(function(i){i[i.inactiveLimit=0]="inactiveLimit",i[i.atLowerLimit=1]="atLowerLimit",i[i.atUpperLimit=2]="atUpperLimit",i[i.equalLimits=3]="equalLimits"})(lt||(lt={}));var hi={lowerAngle:0,upperAngle:0,maxMotorTorque:0,motorSpeed:0,enableLimit:!1,enableMotor:!1},he=function(i){xt(t,i);function t(e,o,s,r){var n=this,m,h,u,l,p,c;return n instanceof t?(e=e??{},n=i.call(this,e,o,s)||this,o=n.m_bodyA,s=n.m_bodyB,n.m_mass=new ce,n.m_limitState=lt.inactiveLimit,n.m_type=t.TYPE,a.isValid(r)?n.m_localAnchorA=o.getLocalPoint(r):a.isValid(e.localAnchorA)?n.m_localAnchorA=a.clone(e.localAnchorA):n.m_localAnchorA=a.zero(),a.isValid(r)?n.m_localAnchorB=s.getLocalPoint(r):a.isValid(e.localAnchorB)?n.m_localAnchorB=a.clone(e.localAnchorB):n.m_localAnchorB=a.zero(),Number.isFinite(e.referenceAngle)?n.m_referenceAngle=e.referenceAngle:n.m_referenceAngle=s.getAngle()-o.getAngle(),n.m_impulse=new J,n.m_motorImpulse=0,n.m_lowerAngle=(m=e.lowerAngle)!==null&&m!==void 0?m:hi.lowerAngle,n.m_upperAngle=(h=e.upperAngle)!==null&&h!==void 0?h:hi.upperAngle,n.m_maxMotorTorque=(u=e.maxMotorTorque)!==null&&u!==void 0?u:hi.maxMotorTorque,n.m_motorSpeed=(l=e.motorSpeed)!==null&&l!==void 0?l:hi.motorSpeed,n.m_enableLimit=(p=e.enableLimit)!==null&&p!==void 0?p:hi.enableLimit,n.m_enableMotor=(c=e.enableMotor)!==null&&c!==void 0?c:hi.enableMotor,n):new t(e,o,s,r)}return t.prototype._serialize=function(){return{type:this.m_type,bodyA:this.m_bodyA,bodyB:this.m_bodyB,collideConnected:this.m_collideConnected,lowerAngle:this.m_lowerAngle,upperAngle:this.m_upperAngle,maxMotorTorque:this.m_maxMotorTorque,motorSpeed:this.m_motorSpeed,enableLimit:this.m_enableLimit,enableMotor:this.m_enableMotor,localAnchorA:this.m_localAnchorA,localAnchorB:this.m_localAnchorB,referenceAngle:this.m_referenceAngle}},t._deserialize=function(e,o,s){e=vt({},e),e.bodyA=s(W,e.bodyA,o),e.bodyB=s(W,e.bodyB,o);var r=new t(e);return r},t.prototype._reset=function(e){e.anchorA?this.m_localAnchorA.setVec2(this.m_bodyA.getLocalPoint(e.anchorA)):e.localAnchorA&&this.m_localAnchorA.setVec2(e.localAnchorA),e.anchorB?this.m_localAnchorB.setVec2(this.m_bodyB.getLocalPoint(e.anchorB)):e.localAnchorB&&this.m_localAnchorB.setVec2(e.localAnchorB),Number.isFinite(e.referenceAngle)&&(this.m_referenceAngle=e.referenceAngle),e.enableLimit!==void 0&&(this.m_enableLimit=e.enableLimit),Number.isFinite(e.lowerAngle)&&(this.m_lowerAngle=e.lowerAngle),Number.isFinite(e.upperAngle)&&(this.m_upperAngle=e.upperAngle),Number.isFinite(e.maxMotorTorque)&&(this.m_maxMotorTorque=e.maxMotorTorque),Number.isFinite(e.motorSpeed)&&(this.m_motorSpeed=e.motorSpeed),e.enableMotor!==void 0&&(this.m_enableMotor=e.enableMotor)},t.prototype.getLocalAnchorA=function(){return this.m_localAnchorA},t.prototype.getLocalAnchorB=function(){return this.m_localAnchorB},t.prototype.getReferenceAngle=function(){return this.m_referenceAngle},t.prototype.getJointAngle=function(){var e=this.m_bodyA,o=this.m_bodyB;return o.m_sweep.a-e.m_sweep.a-this.m_referenceAngle},t.prototype.getJointSpeed=function(){var e=this.m_bodyA,o=this.m_bodyB;return o.m_angularVelocity-e.m_angularVelocity},t.prototype.isMotorEnabled=function(){return this.m_enableMotor},t.prototype.enableMotor=function(e){e!=this.m_enableMotor&&(this.m_bodyA.setAwake(!0),this.m_bodyB.setAwake(!0),this.m_enableMotor=e)},t.prototype.getMotorTorque=function(e){return e*this.m_motorImpulse},t.prototype.setMotorSpeed=function(e){e!=this.m_motorSpeed&&(this.m_bodyA.setAwake(!0),this.m_bodyB.setAwake(!0),this.m_motorSpeed=e)},t.prototype.getMotorSpeed=function(){return this.m_motorSpeed},t.prototype.setMaxMotorTorque=function(e){e!=this.m_maxMotorTorque&&(this.m_bodyA.setAwake(!0),this.m_bodyB.setAwake(!0),this.m_maxMotorTorque=e)},t.prototype.getMaxMotorTorque=function(){return this.m_maxMotorTorque},t.prototype.isLimitEnabled=function(){return this.m_enableLimit},t.prototype.enableLimit=function(e){e!=this.m_enableLimit&&(this.m_bodyA.setAwake(!0),this.m_bodyB.setAwake(!0),this.m_enableLimit=e,this.m_impulse.z=0)},t.prototype.getLowerLimit=function(){return this.m_lowerAngle},t.prototype.getUpperLimit=function(){return this.m_upperAngle},t.prototype.setLimits=function(e,o){(e!=this.m_lowerAngle||o!=this.m_upperAngle)&&(this.m_bodyA.setAwake(!0),this.m_bodyB.setAwake(!0),this.m_impulse.z=0,this.m_lowerAngle=e,this.m_upperAngle=o)},t.prototype.getAnchorA=function(){return this.m_bodyA.getWorldPoint(this.m_localAnchorA)},t.prototype.getAnchorB=function(){return this.m_bodyB.getWorldPoint(this.m_localAnchorB)},t.prototype.getReactionForce=function(e){return a.neo(this.m_impulse.x,this.m_impulse.y).mul(e)},t.prototype.getReactionTorque=function(e){return e*this.m_impulse.z},t.prototype.initVelocityConstraints=function(e){this.m_localCenterA=this.m_bodyA.m_sweep.localCenter,this.m_localCenterB=this.m_bodyB.m_sweep.localCenter,this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var o=this.m_bodyA.c_position.a,s=this.m_bodyA.c_velocity.v,r=this.m_bodyA.c_velocity.w,n=this.m_bodyB.c_position.a,m=this.m_bodyB.c_velocity.v,h=this.m_bodyB.c_velocity.w,u=b.neo(o),l=b.neo(n);this.m_rA=b.mulVec2(u,a.sub(this.m_localAnchorA,this.m_localCenterA)),this.m_rB=b.mulVec2(l,a.sub(this.m_localAnchorB,this.m_localCenterB));var p=this.m_invMassA,c=this.m_invMassB,_=this.m_invIA,d=this.m_invIB,y=_+d===0;if(this.m_mass.ex.x=p+c+this.m_rA.y*this.m_rA.y*_+this.m_rB.y*this.m_rB.y*d,this.m_mass.ey.x=-this.m_rA.y*this.m_rA.x*_-this.m_rB.y*this.m_rB.x*d,this.m_mass.ez.x=-this.m_rA.y*_-this.m_rB.y*d,this.m_mass.ex.y=this.m_mass.ey.x,this.m_mass.ey.y=p+c+this.m_rA.x*this.m_rA.x*_+this.m_rB.x*this.m_rB.x*d,this.m_mass.ez.y=this.m_rA.x*_+this.m_rB.x*d,this.m_mass.ex.z=this.m_mass.ez.x,this.m_mass.ey.z=this.m_mass.ez.y,this.m_mass.ez.z=_+d,this.m_motorMass=_+d,this.m_motorMass>0&&(this.m_motorMass=1/this.m_motorMass),(this.m_enableMotor==!1||y)&&(this.m_motorImpulse=0),this.m_enableLimit&&y==!1){var f=n-o-this.m_referenceAngle;tn(this.m_upperAngle-this.m_lowerAngle)<2*P.angularSlop?this.m_limitState=lt.equalLimits:f<=this.m_lowerAngle?(this.m_limitState!=lt.atLowerLimit&&(this.m_impulse.z=0),this.m_limitState=lt.atLowerLimit):f>=this.m_upperAngle?(this.m_limitState!=lt.atUpperLimit&&(this.m_impulse.z=0),this.m_limitState=lt.atUpperLimit):(this.m_limitState=lt.inactiveLimit,this.m_impulse.z=0)}else this.m_limitState=lt.inactiveLimit;if(e.warmStarting){this.m_impulse.mul(e.dtRatio),this.m_motorImpulse*=e.dtRatio;var v=a.neo(this.m_impulse.x,this.m_impulse.y);s.subMul(p,v),r-=_*(a.crossVec2Vec2(this.m_rA,v)+this.m_motorImpulse+this.m_impulse.z),m.addMul(c,v),h+=d*(a.crossVec2Vec2(this.m_rB,v)+this.m_motorImpulse+this.m_impulse.z)}else this.m_impulse.setZero(),this.m_motorImpulse=0;this.m_bodyA.c_velocity.v=s,this.m_bodyA.c_velocity.w=r,this.m_bodyB.c_velocity.v=m,this.m_bodyB.c_velocity.w=h},t.prototype.solveVelocityConstraints=function(e){var o=this.m_bodyA.c_velocity.v,s=this.m_bodyA.c_velocity.w,r=this.m_bodyB.c_velocity.v,n=this.m_bodyB.c_velocity.w,m=this.m_invMassA,h=this.m_invMassB,u=this.m_invIA,l=this.m_invIB,p=u+l===0;if(this.m_enableMotor&&this.m_limitState!=lt.equalLimits&&p==!1){var c=n-s-this.m_motorSpeed,_=-this.m_motorMass*c,d=this.m_motorImpulse,y=e.dt*this.m_maxMotorTorque;this.m_motorImpulse=pt(this.m_motorImpulse+_,-y,y),_=this.m_motorImpulse-d,s-=u*_,n+=l*_}if(this.m_enableLimit&&this.m_limitState!=lt.inactiveLimit&&p==!1){var f=a.zero();f.addCombine(1,r,1,a.crossNumVec2(n,this.m_rB)),f.subCombine(1,o,1,a.crossNumVec2(s,this.m_rA));var v=n-s,c=new J(f.x,f.y,v),_=J.neg(this.m_mass.solve33(c));if(this.m_limitState==lt.equalLimits)this.m_impulse.add(_);else if(this.m_limitState==lt.atLowerLimit){var g=this.m_impulse.z+_.z;if(g<0){var B=a.combine(-1,f,this.m_impulse.z,a.neo(this.m_mass.ez.x,this.m_mass.ez.y)),w=this.m_mass.solve22(B);_.x=w.x,_.y=w.y,_.z=-this.m_impulse.z,this.m_impulse.x+=w.x,this.m_impulse.y+=w.y,this.m_impulse.z=0}else this.m_impulse.add(_)}else if(this.m_limitState==lt.atUpperLimit){var g=this.m_impulse.z+_.z;if(g>0){var B=a.combine(-1,f,this.m_impulse.z,a.neo(this.m_mass.ez.x,this.m_mass.ez.y)),w=this.m_mass.solve22(B);_.x=w.x,_.y=w.y,_.z=-this.m_impulse.z,this.m_impulse.x+=w.x,this.m_impulse.y+=w.y,this.m_impulse.z=0}else this.m_impulse.add(_)}var V=a.neo(_.x,_.y);o.subMul(m,V),s-=u*(a.crossVec2Vec2(this.m_rA,V)+_.z),r.addMul(h,V),n+=l*(a.crossVec2Vec2(this.m_rB,V)+_.z)}else{var c=a.zero();c.addCombine(1,r,1,a.crossNumVec2(n,this.m_rB)),c.subCombine(1,o,1,a.crossNumVec2(s,this.m_rA));var _=this.m_mass.solve22(a.neg(c));this.m_impulse.x+=_.x,this.m_impulse.y+=_.y,o.subMul(m,_),s-=u*a.crossVec2Vec2(this.m_rA,_),r.addMul(h,_),n+=l*a.crossVec2Vec2(this.m_rB,_)}this.m_bodyA.c_velocity.v=o,this.m_bodyA.c_velocity.w=s,this.m_bodyB.c_velocity.v=r,this.m_bodyB.c_velocity.w=n},t.prototype.solvePositionConstraints=function(e){var o=this.m_bodyA.c_position.c,s=this.m_bodyA.c_position.a,r=this.m_bodyB.c_position.c,n=this.m_bodyB.c_position.a,m=b.neo(s),h=b.neo(n),u=0,l=0,p=this.m_invIA+this.m_invIB==0;if(this.m_enableLimit&&this.m_limitState!=lt.inactiveLimit&&p==!1){var c=n-s-this.m_referenceAngle,_=0;if(this.m_limitState==lt.equalLimits){var d=pt(c-this.m_lowerAngle,-P.maxAngularCorrection,P.maxAngularCorrection);_=-this.m_motorMass*d,u=tn(d)}else if(this.m_limitState==lt.atLowerLimit){var d=c-this.m_lowerAngle;u=-d,d=pt(d+P.angularSlop,-P.maxAngularCorrection,0),_=-this.m_motorMass*d}else if(this.m_limitState==lt.atUpperLimit){var d=c-this.m_upperAngle;u=d,d=pt(d-P.angularSlop,0,P.maxAngularCorrection),_=-this.m_motorMass*d}s-=this.m_invIA*_,n+=this.m_invIB*_}{m.setAngle(s),h.setAngle(n);var y=b.mulVec2(m,a.sub(this.m_localAnchorA,this.m_localCenterA)),f=b.mulVec2(h,a.sub(this.m_localAnchorB,this.m_localCenterB)),d=a.zero();d.addCombine(1,r,1,f),d.subCombine(1,o,1,y),l=d.length();var v=this.m_invMassA,g=this.m_invMassB,B=this.m_invIA,w=this.m_invIB,V=new qt;V.ex.x=v+g+B*y.y*y.y+w*f.y*f.y,V.ex.y=-B*y.x*y.y-w*f.x*f.y,V.ey.x=V.ex.y,V.ey.y=v+g+B*y.x*y.x+w*f.x*f.x;var I=a.neg(V.solve(d));o.subMul(v,I),s-=B*a.crossVec2Vec2(y,I),r.addMul(g,I),n+=w*a.crossVec2Vec2(f,I)}return this.m_bodyA.c_position.c.setVec2(o),this.m_bodyA.c_position.a=s,this.m_bodyB.c_position.c.setVec2(r),this.m_bodyB.c_position.a=n,l<=P.linearSlop&&u<=P.angularSlop},t.TYPE="revolute-joint",t}(yt),Ci=Math.abs,en=Math.max,br=Math.min,Ct;(function(i){i[i.inactiveLimit=0]="inactiveLimit",i[i.atLowerLimit=1]="atLowerLimit",i[i.atUpperLimit=2]="atUpperLimit",i[i.equalLimits=3]="equalLimits"})(Ct||(Ct={}));var Br={enableLimit:!1,lowerTranslation:0,upperTranslation:0,enableMotor:!1,maxMotorForce:0,motorSpeed:0},Vo=function(i){xt(t,i);function t(e,o,s,r,n){var m=this;return m instanceof t?(e=Nt(e,Br),m=i.call(this,e,o,s)||this,o=m.m_bodyA,s=m.m_bodyB,m.m_type=t.TYPE,m.m_localAnchorA=a.clone(r?o.getLocalPoint(r):e.localAnchorA||a.zero()),m.m_localAnchorB=a.clone(r?s.getLocalPoint(r):e.localAnchorB||a.zero()),m.m_localXAxisA=a.clone(n?o.getLocalVector(n):e.localAxisA||a.neo(1,0)),m.m_localXAxisA.normalize(),m.m_localYAxisA=a.crossNumVec2(1,m.m_localXAxisA),m.m_referenceAngle=Number.isFinite(e.referenceAngle)?e.referenceAngle:s.getAngle()-o.getAngle(),m.m_impulse=new J,m.m_motorMass=0,m.m_motorImpulse=0,m.m_lowerTranslation=e.lowerTranslation,m.m_upperTranslation=e.upperTranslation,m.m_maxMotorForce=e.maxMotorForce,m.m_motorSpeed=e.motorSpeed,m.m_enableLimit=e.enableLimit,m.m_enableMotor=e.enableMotor,m.m_limitState=Ct.inactiveLimit,m.m_axis=a.zero(),m.m_perp=a.zero(),m.m_K=new ce,m):new t(e,o,s,r,n)}return t.prototype._serialize=function(){return{type:this.m_type,bodyA:this.m_bodyA,bodyB:this.m_bodyB,collideConnected:this.m_collideConnected,lowerTranslation:this.m_lowerTranslation,upperTranslation:this.m_upperTranslation,maxMotorForce:this.m_maxMotorForce,motorSpeed:this.m_motorSpeed,enableLimit:this.m_enableLimit,enableMotor:this.m_enableMotor,localAnchorA:this.m_localAnchorA,localAnchorB:this.m_localAnchorB,localAxisA:this.m_localXAxisA,referenceAngle:this.m_referenceAngle}},t._deserialize=function(e,o,s){e=vt({},e),e.bodyA=s(W,e.bodyA,o),e.bodyB=s(W,e.bodyB,o),e.localAxisA=a.clone(e.localAxisA);var r=new t(e);return r},t.prototype._reset=function(e){e.anchorA?this.m_localAnchorA.setVec2(this.m_bodyA.getLocalPoint(e.anchorA)):e.localAnchorA&&this.m_localAnchorA.setVec2(e.localAnchorA),e.anchorB?this.m_localAnchorB.setVec2(this.m_bodyB.getLocalPoint(e.anchorB)):e.localAnchorB&&this.m_localAnchorB.setVec2(e.localAnchorB),e.localAxisA&&(this.m_localXAxisA.setVec2(e.localAxisA),this.m_localYAxisA.setVec2(a.crossNumVec2(1,e.localAxisA))),Number.isFinite(e.referenceAngle)&&(this.m_referenceAngle=e.referenceAngle),typeof e.enableLimit<"u"&&(this.m_enableLimit=!!e.enableLimit),Number.isFinite(e.lowerTranslation)&&(this.m_lowerTranslation=e.lowerTranslation),Number.isFinite(e.upperTranslation)&&(this.m_upperTranslation=e.upperTranslation),typeof e.enableMotor<"u"&&(this.m_enableMotor=!!e.enableMotor),Number.isFinite(e.maxMotorForce)&&(this.m_maxMotorForce=e.maxMotorForce),Number.isFinite(e.motorSpeed)&&(this.m_motorSpeed=e.motorSpeed)},t.prototype.getLocalAnchorA=function(){return this.m_localAnchorA},t.prototype.getLocalAnchorB=function(){return this.m_localAnchorB},t.prototype.getLocalAxisA=function(){return this.m_localXAxisA},t.prototype.getReferenceAngle=function(){return this.m_referenceAngle},t.prototype.getJointTranslation=function(){var e=this.m_bodyA.getWorldPoint(this.m_localAnchorA),o=this.m_bodyB.getWorldPoint(this.m_localAnchorB),s=a.sub(o,e),r=this.m_bodyA.getWorldVector(this.m_localXAxisA),n=a.dot(s,r);return n},t.prototype.getJointSpeed=function(){var e=this.m_bodyA,o=this.m_bodyB,s=b.mulVec2(e.m_xf.q,a.sub(this.m_localAnchorA,e.m_sweep.localCenter)),r=b.mulVec2(o.m_xf.q,a.sub(this.m_localAnchorB,o.m_sweep.localCenter)),n=a.add(e.m_sweep.c,s),m=a.add(o.m_sweep.c,r),h=a.sub(m,n),u=b.mulVec2(e.m_xf.q,this.m_localXAxisA),l=e.m_linearVelocity,p=o.m_linearVelocity,c=e.m_angularVelocity,_=o.m_angularVelocity,d=a.dot(h,a.crossNumVec2(c,u))+a.dot(u,a.sub(a.addCrossNumVec2(p,_,r),a.addCrossNumVec2(l,c,s)));return d},t.prototype.isLimitEnabled=function(){return this.m_enableLimit},t.prototype.enableLimit=function(e){e!=this.m_enableLimit&&(this.m_bodyA.setAwake(!0),this.m_bodyB.setAwake(!0),this.m_enableLimit=e,this.m_impulse.z=0)},t.prototype.getLowerLimit=function(){return this.m_lowerTranslation},t.prototype.getUpperLimit=function(){return this.m_upperTranslation},t.prototype.setLimits=function(e,o){(e!=this.m_lowerTranslation||o!=this.m_upperTranslation)&&(this.m_bodyA.setAwake(!0),this.m_bodyB.setAwake(!0),this.m_lowerTranslation=e,this.m_upperTranslation=o,this.m_impulse.z=0)},t.prototype.isMotorEnabled=function(){return this.m_enableMotor},t.prototype.enableMotor=function(e){e!=this.m_enableMotor&&(this.m_bodyA.setAwake(!0),this.m_bodyB.setAwake(!0),this.m_enableMotor=e)},t.prototype.setMotorSpeed=function(e){e!=this.m_motorSpeed&&(this.m_bodyA.setAwake(!0),this.m_bodyB.setAwake(!0),this.m_motorSpeed=e)},t.prototype.setMaxMotorForce=function(e){e!=this.m_maxMotorForce&&(this.m_bodyA.setAwake(!0),this.m_bodyB.setAwake(!0),this.m_maxMotorForce=e)},t.prototype.getMaxMotorForce=function(){return this.m_maxMotorForce},t.prototype.getMotorSpeed=function(){return this.m_motorSpeed},t.prototype.getMotorForce=function(e){return e*this.m_motorImpulse},t.prototype.getAnchorA=function(){return this.m_bodyA.getWorldPoint(this.m_localAnchorA)},t.prototype.getAnchorB=function(){return this.m_bodyB.getWorldPoint(this.m_localAnchorB)},t.prototype.getReactionForce=function(e){return a.combine(this.m_impulse.x,this.m_perp,this.m_motorImpulse+this.m_impulse.z,this.m_axis).mul(e)},t.prototype.getReactionTorque=function(e){return e*this.m_impulse.y},t.prototype.initVelocityConstraints=function(e){this.m_localCenterA=this.m_bodyA.m_sweep.localCenter,this.m_localCenterB=this.m_bodyB.m_sweep.localCenter,this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var o=this.m_bodyA.c_position.c,s=this.m_bodyA.c_position.a,r=this.m_bodyA.c_velocity.v,n=this.m_bodyA.c_velocity.w,m=this.m_bodyB.c_position.c,h=this.m_bodyB.c_position.a,u=this.m_bodyB.c_velocity.v,l=this.m_bodyB.c_velocity.w,p=b.neo(s),c=b.neo(h),_=b.mulVec2(p,a.sub(this.m_localAnchorA,this.m_localCenterA)),d=b.mulVec2(c,a.sub(this.m_localAnchorB,this.m_localCenterB)),y=a.zero();y.addCombine(1,m,1,d),y.subCombine(1,o,1,_);var f=this.m_invMassA,v=this.m_invMassB,g=this.m_invIA,B=this.m_invIB;this.m_axis=b.mulVec2(p,this.m_localXAxisA),this.m_a1=a.crossVec2Vec2(a.add(y,_),this.m_axis),this.m_a2=a.crossVec2Vec2(d,this.m_axis),this.m_motorMass=f+v+g*this.m_a1*this.m_a1+B*this.m_a2*this.m_a2,this.m_motorMass>0&&(this.m_motorMass=1/this.m_motorMass);{this.m_perp=b.mulVec2(p,this.m_localYAxisA),this.m_s1=a.crossVec2Vec2(a.add(y,_),this.m_perp),this.m_s2=a.crossVec2Vec2(d,this.m_perp),a.crossVec2Vec2(_,this.m_perp);var w=f+v+g*this.m_s1*this.m_s1+B*this.m_s2*this.m_s2,V=g*this.m_s1+B*this.m_s2,I=g*this.m_s1*this.m_a1+B*this.m_s2*this.m_a2,M=g+B;M==0&&(M=1);var S=g*this.m_a1+B*this.m_a2,k=f+v+g*this.m_a1*this.m_a1+B*this.m_a2*this.m_a2;this.m_K.ex.set(w,V,I),this.m_K.ey.set(V,M,S),this.m_K.ez.set(I,S,k)}if(this.m_enableLimit){var T=a.dot(this.m_axis,y);Ci(this.m_upperTranslation-this.m_lowerTranslation)<2*P.linearSlop?this.m_limitState=Ct.equalLimits:T<=this.m_lowerTranslation?this.m_limitState!=Ct.atLowerLimit&&(this.m_limitState=Ct.atLowerLimit,this.m_impulse.z=0):T>=this.m_upperTranslation?this.m_limitState!=Ct.atUpperLimit&&(this.m_limitState=Ct.atUpperLimit,this.m_impulse.z=0):(this.m_limitState=Ct.inactiveLimit,this.m_impulse.z=0)}else this.m_limitState=Ct.inactiveLimit,this.m_impulse.z=0;if(this.m_enableMotor==!1&&(this.m_motorImpulse=0),e.warmStarting){this.m_impulse.mul(e.dtRatio),this.m_motorImpulse*=e.dtRatio;var O=a.combine(this.m_impulse.x,this.m_perp,this.m_motorImpulse+this.m_impulse.z,this.m_axis),Y=this.m_impulse.x*this.m_s1+this.m_impulse.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_a1,U=this.m_impulse.x*this.m_s2+this.m_impulse.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_a2;r.subMul(f,O),n-=g*Y,u.addMul(v,O),l+=B*U}else this.m_impulse.setZero(),this.m_motorImpulse=0;this.m_bodyA.c_velocity.v.setVec2(r),this.m_bodyA.c_velocity.w=n,this.m_bodyB.c_velocity.v.setVec2(u),this.m_bodyB.c_velocity.w=l},t.prototype.solveVelocityConstraints=function(e){var o=this.m_bodyA.c_velocity.v,s=this.m_bodyA.c_velocity.w,r=this.m_bodyB.c_velocity.v,n=this.m_bodyB.c_velocity.w,m=this.m_invMassA,h=this.m_invMassB,u=this.m_invIA,l=this.m_invIB;if(this.m_enableMotor&&this.m_limitState!=Ct.equalLimits){var p=a.dot(this.m_axis,a.sub(r,o))+this.m_a2*n-this.m_a1*s,c=this.m_motorMass*(this.m_motorSpeed-p),_=this.m_motorImpulse,d=e.dt*this.m_maxMotorForce;this.m_motorImpulse=pt(this.m_motorImpulse+c,-d,d),c=this.m_motorImpulse-_;var y=a.mulNumVec2(c,this.m_axis),f=c*this.m_a1,v=c*this.m_a2;o.subMul(m,y),s-=u*f,r.addMul(h,y),n+=l*v}var g=a.zero();if(g.x+=a.dot(this.m_perp,r)+this.m_s2*n,g.x-=a.dot(this.m_perp,o)+this.m_s1*s,g.y=n-s,this.m_enableLimit&&this.m_limitState!=Ct.inactiveLimit){var B=0;B+=a.dot(this.m_axis,r)+this.m_a2*n,B-=a.dot(this.m_axis,o)+this.m_a1*s;var p=new J(g.x,g.y,B),w=J.clone(this.m_impulse),V=this.m_K.solve33(J.neg(p));this.m_impulse.add(V),this.m_limitState==Ct.atLowerLimit?this.m_impulse.z=en(this.m_impulse.z,0):this.m_limitState==Ct.atUpperLimit&&(this.m_impulse.z=br(this.m_impulse.z,0));var I=a.combine(-1,g,-(this.m_impulse.z-w.z),a.neo(this.m_K.ez.x,this.m_K.ez.y)),M=a.add(this.m_K.solve22(I),a.neo(w.x,w.y));this.m_impulse.x=M.x,this.m_impulse.y=M.y,V=J.sub(this.m_impulse,w);var y=a.combine(V.x,this.m_perp,V.z,this.m_axis),f=V.x*this.m_s1+V.y+V.z*this.m_a1,v=V.x*this.m_s2+V.y+V.z*this.m_a2;o.subMul(m,y),s-=u*f,r.addMul(h,y),n+=l*v}else{var V=this.m_K.solve22(a.neg(g));this.m_impulse.x+=V.x,this.m_impulse.y+=V.y;var y=a.mulNumVec2(V.x,this.m_perp),f=V.x*this.m_s1+V.y,v=V.x*this.m_s2+V.y;o.subMul(m,y),s-=u*f,r.addMul(h,y),n+=l*v}this.m_bodyA.c_velocity.v=o,this.m_bodyA.c_velocity.w=s,this.m_bodyB.c_velocity.v=r,this.m_bodyB.c_velocity.w=n},t.prototype.solvePositionConstraints=function(e){var o=this.m_bodyA.c_position.c,s=this.m_bodyA.c_position.a,r=this.m_bodyB.c_position.c,n=this.m_bodyB.c_position.a,m=b.neo(s),h=b.neo(n),u=this.m_invMassA,l=this.m_invMassB,p=this.m_invIA,c=this.m_invIB,_=b.mulVec2(m,a.sub(this.m_localAnchorA,this.m_localCenterA)),d=b.mulVec2(h,a.sub(this.m_localAnchorB,this.m_localCenterB)),y=a.sub(a.add(r,d),a.add(o,_)),f=b.mulVec2(m,this.m_localXAxisA),v=a.crossVec2Vec2(a.add(y,_),f),g=a.crossVec2Vec2(d,f),B=b.mulVec2(m,this.m_localYAxisA),w=a.crossVec2Vec2(a.add(y,_),B),V=a.crossVec2Vec2(d,B),I=new J,M=a.zero();M.x=a.dot(B,y),M.y=n-s-this.m_referenceAngle;var S=Ci(M.x),k=Ci(M.y),T=P.linearSlop,O=P.maxLinearCorrection,Y=!1,U=0;if(this.m_enableLimit){var Z=a.dot(f,y);Ci(this.m_upperTranslation-this.m_lowerTranslation)<2*T?(U=pt(Z,-O,O),S=en(S,Ci(Z)),Y=!0):Z<=this.m_lowerTranslation?(U=pt(Z-this.m_lowerTranslation+T,-O,0),S=Math.max(S,this.m_lowerTranslation-Z),Y=!0):Z>=this.m_upperTranslation&&(U=pt(Z-this.m_upperTranslation-T,0,O),S=Math.max(S,Z-this.m_upperTranslation),Y=!0)}if(Y){var Pt=u+l+p*w*w+c*V*V,_t=p*w+c*V,Ut=p*w*v+c*V*g,bt=p+c;bt==0&&(bt=1);var tt=p*v+c*g,vi=u+l+p*v*v+c*g*g,kt=new ce;kt.ex.set(Pt,_t,Ut),kt.ey.set(_t,bt,tt),kt.ez.set(Ut,tt,vi);var Ce=new J;Ce.x=M.x,Ce.y=M.y,Ce.z=U,I=kt.solve33(J.neg(Ce))}else{var Pt=u+l+p*w*w+c*V*V,_t=p*w+c*V,bt=p+c;bt==0&&(bt=1);var kt=new qt;kt.ex.setNum(Pt,_t),kt.ey.setNum(_t,bt);var Te=kt.solve(a.neg(M));I.x=Te.x,I.y=Te.y,I.z=0}var xi=a.combine(I.x,B,I.z,f),ti=I.x*w+I.y+I.z*v,Jo=I.x*V+I.y+I.z*g;return o.subMul(u,xi),s-=p*ti,r.addMul(l,xi),n+=c*Jo,this.m_bodyA.c_position.c=o,this.m_bodyA.c_position.a=s,this.m_bodyB.c_position.c=r,this.m_bodyB.c_position.a=n,S<=P.linearSlop&&k<=P.angularSlop},t.TYPE="prismatic-joint",t}(yt),wr={ratio:1},Co=function(i){xt(t,i);function t(e,o,s,r,n,m){var h=this;if(!(h instanceof t))return new t(e,o,s,r,n,m);e=Nt(e,wr),h=i.call(this,e,o,s)||this,o=h.m_bodyA,s=h.m_bodyB,h.m_type=t.TYPE,h.m_joint1=r||e.joint1,h.m_joint2=n||e.joint2,h.m_ratio=Number.isFinite(m)?m:e.ratio,h.m_type1=h.m_joint1.getType(),h.m_type2=h.m_joint2.getType();var u,l;h.m_bodyC=h.m_joint1.getBodyA(),h.m_bodyA=h.m_joint1.getBodyB();var p=h.m_bodyA.m_xf,c=h.m_bodyA.m_sweep.a,_=h.m_bodyC.m_xf,d=h.m_bodyC.m_sweep.a;if(h.m_type1===he.TYPE){var y=h.m_joint1;h.m_localAnchorC=y.m_localAnchorA,h.m_localAnchorA=y.m_localAnchorB,h.m_referenceAngleA=y.m_referenceAngle,h.m_localAxisC=a.zero(),u=c-d-h.m_referenceAngleA}else{var f=h.m_joint1;h.m_localAnchorC=f.m_localAnchorA,h.m_localAnchorA=f.m_localAnchorB,h.m_referenceAngleA=f.m_referenceAngle,h.m_localAxisC=f.m_localXAxisA;var v=h.m_localAnchorC,g=b.mulTVec2(_.q,a.add(b.mulVec2(p.q,h.m_localAnchorA),a.sub(p.p,_.p)));u=a.dot(g,h.m_localAxisC)-a.dot(v,h.m_localAxisC)}h.m_bodyD=h.m_joint2.getBodyA(),h.m_bodyB=h.m_joint2.getBodyB();var B=h.m_bodyB.m_xf,w=h.m_bodyB.m_sweep.a,V=h.m_bodyD.m_xf,I=h.m_bodyD.m_sweep.a;if(h.m_type2===he.TYPE){var y=h.m_joint2;h.m_localAnchorD=y.m_localAnchorA,h.m_localAnchorB=y.m_localAnchorB,h.m_referenceAngleB=y.m_referenceAngle,h.m_localAxisD=a.zero(),l=w-I-h.m_referenceAngleB}else{var f=h.m_joint2;h.m_localAnchorD=f.m_localAnchorA,h.m_localAnchorB=f.m_localAnchorB,h.m_referenceAngleB=f.m_referenceAngle,h.m_localAxisD=f.m_localXAxisA;var M=h.m_localAnchorD,S=b.mulTVec2(V.q,a.add(b.mulVec2(B.q,h.m_localAnchorB),a.sub(B.p,V.p)));l=a.dot(S,h.m_localAxisD)-a.dot(M,h.m_localAxisD)}return h.m_constant=u+h.m_ratio*l,h.m_impulse=0,h}return t.prototype._serialize=function(){return{type:this.m_type,bodyA:this.m_bodyA,bodyB:this.m_bodyB,collideConnected:this.m_collideConnected,joint1:this.m_joint1,joint2:this.m_joint2,ratio:this.m_ratio}},t._deserialize=function(e,o,s){e=vt({},e),e.bodyA=s(W,e.bodyA,o),e.bodyB=s(W,e.bodyB,o),e.joint1=s(yt,e.joint1,o),e.joint2=s(yt,e.joint2,o);var r=new t(e);return r},t.prototype._reset=function(e){Number.isFinite(e.ratio)&&(this.m_ratio=e.ratio)},t.prototype.getJoint1=function(){return this.m_joint1},t.prototype.getJoint2=function(){return this.m_joint2},t.prototype.setRatio=function(e){this.m_ratio=e},t.prototype.getRatio=function(){return this.m_ratio},t.prototype.getAnchorA=function(){return this.m_bodyA.getWorldPoint(this.m_localAnchorA)},t.prototype.getAnchorB=function(){return this.m_bodyB.getWorldPoint(this.m_localAnchorB)},t.prototype.getReactionForce=function(e){return a.mulNumVec2(this.m_impulse,this.m_JvAC).mul(e)},t.prototype.getReactionTorque=function(e){var o=this.m_impulse*this.m_JwA;return e*o},t.prototype.initVelocityConstraints=function(e){this.m_lcA=this.m_bodyA.m_sweep.localCenter,this.m_lcB=this.m_bodyB.m_sweep.localCenter,this.m_lcC=this.m_bodyC.m_sweep.localCenter,this.m_lcD=this.m_bodyD.m_sweep.localCenter,this.m_mA=this.m_bodyA.m_invMass,this.m_mB=this.m_bodyB.m_invMass,this.m_mC=this.m_bodyC.m_invMass,this.m_mD=this.m_bodyD.m_invMass,this.m_iA=this.m_bodyA.m_invI,this.m_iB=this.m_bodyB.m_invI,this.m_iC=this.m_bodyC.m_invI,this.m_iD=this.m_bodyD.m_invI;var o=this.m_bodyA.c_position.a,s=this.m_bodyA.c_velocity.v,r=this.m_bodyA.c_velocity.w,n=this.m_bodyB.c_position.a,m=this.m_bodyB.c_velocity.v,h=this.m_bodyB.c_velocity.w,u=this.m_bodyC.c_position.a,l=this.m_bodyC.c_velocity.v,p=this.m_bodyC.c_velocity.w,c=this.m_bodyD.c_position.a,_=this.m_bodyD.c_velocity.v,d=this.m_bodyD.c_velocity.w,y=b.neo(o),f=b.neo(n),v=b.neo(u),g=b.neo(c);if(this.m_mass=0,this.m_type1==he.TYPE)this.m_JvAC=a.zero(),this.m_JwA=1,this.m_JwC=1,this.m_mass+=this.m_iA+this.m_iC;else{var B=b.mulVec2(v,this.m_localAxisC),w=b.mulSub(v,this.m_localAnchorC,this.m_lcC),V=b.mulSub(y,this.m_localAnchorA,this.m_lcA);this.m_JvAC=B,this.m_JwC=a.crossVec2Vec2(w,B),this.m_JwA=a.crossVec2Vec2(V,B),this.m_mass+=this.m_mC+this.m_mA+this.m_iC*this.m_JwC*this.m_JwC+this.m_iA*this.m_JwA*this.m_JwA}if(this.m_type2==he.TYPE)this.m_JvBD=a.zero(),this.m_JwB=this.m_ratio,this.m_JwD=this.m_ratio,this.m_mass+=this.m_ratio*this.m_ratio*(this.m_iB+this.m_iD);else{var B=b.mulVec2(g,this.m_localAxisD),I=b.mulSub(g,this.m_localAnchorD,this.m_lcD),M=b.mulSub(f,this.m_localAnchorB,this.m_lcB);this.m_JvBD=a.mulNumVec2(this.m_ratio,B),this.m_JwD=this.m_ratio*a.crossVec2Vec2(I,B),this.m_JwB=this.m_ratio*a.crossVec2Vec2(M,B),this.m_mass+=this.m_ratio*this.m_ratio*(this.m_mD+this.m_mB)+this.m_iD*this.m_JwD*this.m_JwD+this.m_iB*this.m_JwB*this.m_JwB}this.m_mass=this.m_mass>0?1/this.m_mass:0,e.warmStarting?(s.addMul(this.m_mA*this.m_impulse,this.m_JvAC),r+=this.m_iA*this.m_impulse*this.m_JwA,m.addMul(this.m_mB*this.m_impulse,this.m_JvBD),h+=this.m_iB*this.m_impulse*this.m_JwB,l.subMul(this.m_mC*this.m_impulse,this.m_JvAC),p-=this.m_iC*this.m_impulse*this.m_JwC,_.subMul(this.m_mD*this.m_impulse,this.m_JvBD),d-=this.m_iD*this.m_impulse*this.m_JwD):this.m_impulse=0,this.m_bodyA.c_velocity.v.setVec2(s),this.m_bodyA.c_velocity.w=r,this.m_bodyB.c_velocity.v.setVec2(m),this.m_bodyB.c_velocity.w=h,this.m_bodyC.c_velocity.v.setVec2(l),this.m_bodyC.c_velocity.w=p,this.m_bodyD.c_velocity.v.setVec2(_),this.m_bodyD.c_velocity.w=d},t.prototype.solveVelocityConstraints=function(e){var o=this.m_bodyA.c_velocity.v,s=this.m_bodyA.c_velocity.w,r=this.m_bodyB.c_velocity.v,n=this.m_bodyB.c_velocity.w,m=this.m_bodyC.c_velocity.v,h=this.m_bodyC.c_velocity.w,u=this.m_bodyD.c_velocity.v,l=this.m_bodyD.c_velocity.w,p=a.dot(this.m_JvAC,o)-a.dot(this.m_JvAC,m)+a.dot(this.m_JvBD,r)-a.dot(this.m_JvBD,u);p+=this.m_JwA*s-this.m_JwC*h+(this.m_JwB*n-this.m_JwD*l);var c=-this.m_mass*p;this.m_impulse+=c,o.addMul(this.m_mA*c,this.m_JvAC),s+=this.m_iA*c*this.m_JwA,r.addMul(this.m_mB*c,this.m_JvBD),n+=this.m_iB*c*this.m_JwB,m.subMul(this.m_mC*c,this.m_JvAC),h-=this.m_iC*c*this.m_JwC,u.subMul(this.m_mD*c,this.m_JvBD),l-=this.m_iD*c*this.m_JwD,this.m_bodyA.c_velocity.v.setVec2(o),this.m_bodyA.c_velocity.w=s,this.m_bodyB.c_velocity.v.setVec2(r),this.m_bodyB.c_velocity.w=n,this.m_bodyC.c_velocity.v.setVec2(m),this.m_bodyC.c_velocity.w=h,this.m_bodyD.c_velocity.v.setVec2(u),this.m_bodyD.c_velocity.w=l},t.prototype.solvePositionConstraints=function(e){var o=this.m_bodyA.c_position.c,s=this.m_bodyA.c_position.a,r=this.m_bodyB.c_position.c,n=this.m_bodyB.c_position.a,m=this.m_bodyC.c_position.c,h=this.m_bodyC.c_position.a,u=this.m_bodyD.c_position.c,l=this.m_bodyD.c_position.a,p=b.neo(s),c=b.neo(n),_=b.neo(h),d=b.neo(l),y=0,f,v,g,B,w,V,I,M,S=0;if(this.m_type1==he.TYPE)g=a.zero(),w=1,I=1,S+=this.m_iA+this.m_iC,f=s-h-this.m_referenceAngleA;else{var k=b.mulVec2(_,this.m_localAxisC),T=b.mulSub(_,this.m_localAnchorC,this.m_lcC),O=b.mulSub(p,this.m_localAnchorA,this.m_lcA);g=k,I=a.crossVec2Vec2(T,k),w=a.crossVec2Vec2(O,k),S+=this.m_mC+this.m_mA+this.m_iC*I*I+this.m_iA*w*w;var Y=a.sub(this.m_localAnchorC,this.m_lcC),U=b.mulTVec2(_,a.add(O,a.sub(o,m)));f=a.dot(a.sub(U,Y),this.m_localAxisC)}if(this.m_type2==he.TYPE)B=a.zero(),V=this.m_ratio,M=this.m_ratio,S+=this.m_ratio*this.m_ratio*(this.m_iB+this.m_iD),v=n-l-this.m_referenceAngleB;else{var k=b.mulVec2(d,this.m_localAxisD),Z=b.mulSub(d,this.m_localAnchorD,this.m_lcD),Pt=b.mulSub(c,this.m_localAnchorB,this.m_lcB);B=a.mulNumVec2(this.m_ratio,k),M=this.m_ratio*a.crossVec2Vec2(Z,k),V=this.m_ratio*a.crossVec2Vec2(Pt,k),S+=this.m_ratio*this.m_ratio*(this.m_mD+this.m_mB)+this.m_iD*M*M+this.m_iB*V*V;var _t=a.sub(this.m_localAnchorD,this.m_lcD),Ut=b.mulTVec2(d,a.add(Pt,a.sub(r,u)));v=a.dot(Ut,this.m_localAxisD)-a.dot(_t,this.m_localAxisD)}var bt=f+this.m_ratio*v-this.m_constant,tt=0;return S>0&&(tt=-bt/S),o.addMul(this.m_mA*tt,g),s+=this.m_iA*tt*w,r.addMul(this.m_mB*tt,B),n+=this.m_iB*tt*V,m.subMul(this.m_mC*tt,g),h-=this.m_iC*tt*I,u.subMul(this.m_mD*tt,B),l-=this.m_iD*tt*M,this.m_bodyA.c_position.c.setVec2(o),this.m_bodyA.c_position.a=s,this.m_bodyB.c_position.c.setVec2(r),this.m_bodyB.c_position.a=n,this.m_bodyC.c_position.c.setVec2(m),this.m_bodyC.c_position.a=h,this.m_bodyD.c_position.c.setVec2(u),this.m_bodyD.c_position.a=l,y<P.linearSlop},t.TYPE="gear-joint",t}(yt),Vr={maxForce:1,maxTorque:1,correctionFactor:.3},Mo=function(i){xt(t,i);function t(e,o,s){var r=this;return r instanceof t?(e=Nt(e,Vr),r=i.call(this,e,o,s)||this,o=r.m_bodyA,s=r.m_bodyB,r.m_type=t.TYPE,r.m_linearOffset=a.isValid(e.linearOffset)?a.clone(e.linearOffset):o.getLocalPoint(s.getPosition()),r.m_angularOffset=Number.isFinite(e.angularOffset)?e.angularOffset:s.getAngle()-o.getAngle(),r.m_linearImpulse=a.zero(),r.m_angularImpulse=0,r.m_maxForce=e.maxForce,r.m_maxTorque=e.maxTorque,r.m_correctionFactor=e.correctionFactor,r):new t(e,o,s)}return t.prototype._serialize=function(){return{type:this.m_type,bodyA:this.m_bodyA,bodyB:this.m_bodyB,collideConnected:this.m_collideConnected,maxForce:this.m_maxForce,maxTorque:this.m_maxTorque,correctionFactor:this.m_correctionFactor,linearOffset:this.m_linearOffset,angularOffset:this.m_angularOffset}},t._deserialize=function(e,o,s){e=vt({},e),e.bodyA=s(W,e.bodyA,o),e.bodyB=s(W,e.bodyB,o);var r=new t(e);return r},t.prototype._reset=function(e){Number.isFinite(e.angularOffset)&&(this.m_angularOffset=e.angularOffset),Number.isFinite(e.maxForce)&&(this.m_maxForce=e.maxForce),Number.isFinite(e.maxTorque)&&(this.m_maxTorque=e.maxTorque),Number.isFinite(e.correctionFactor)&&(this.m_correctionFactor=e.correctionFactor),a.isValid(e.linearOffset)&&this.m_linearOffset.set(e.linearOffset)},t.prototype.setMaxForce=function(e){this.m_maxForce=e},t.prototype.getMaxForce=function(){return this.m_maxForce},t.prototype.setMaxTorque=function(e){this.m_maxTorque=e},t.prototype.getMaxTorque=function(){return this.m_maxTorque},t.prototype.setCorrectionFactor=function(e){this.m_correctionFactor=e},t.prototype.getCorrectionFactor=function(){return this.m_correctionFactor},t.prototype.setLinearOffset=function(e){(e.x!=this.m_linearOffset.x||e.y!=this.m_linearOffset.y)&&(this.m_bodyA.setAwake(!0),this.m_bodyB.setAwake(!0),this.m_linearOffset.set(e))},t.prototype.getLinearOffset=function(){return this.m_linearOffset},t.prototype.setAngularOffset=function(e){e!=this.m_angularOffset&&(this.m_bodyA.setAwake(!0),this.m_bodyB.setAwake(!0),this.m_angularOffset=e)},t.prototype.getAngularOffset=function(){return this.m_angularOffset},t.prototype.getAnchorA=function(){return this.m_bodyA.getPosition()},t.prototype.getAnchorB=function(){return this.m_bodyB.getPosition()},t.prototype.getReactionForce=function(e){return a.mulNumVec2(e,this.m_linearImpulse)},t.prototype.getReactionTorque=function(e){return e*this.m_angularImpulse},t.prototype.initVelocityConstraints=function(e){this.m_localCenterA=this.m_bodyA.m_sweep.localCenter,this.m_localCenterB=this.m_bodyB.m_sweep.localCenter,this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var o=this.m_bodyA.c_position.c,s=this.m_bodyA.c_position.a,r=this.m_bodyA.c_velocity.v,n=this.m_bodyA.c_velocity.w,m=this.m_bodyB.c_position.c,h=this.m_bodyB.c_position.a,u=this.m_bodyB.c_velocity.v,l=this.m_bodyB.c_velocity.w,p=b.neo(s),c=b.neo(h);this.m_rA=b.mulVec2(p,a.sub(this.m_linearOffset,this.m_localCenterA)),this.m_rB=b.mulVec2(c,a.neg(this.m_localCenterB));var _=this.m_invMassA,d=this.m_invMassB,y=this.m_invIA,f=this.m_invIB,v=new qt;if(v.ex.x=_+d+y*this.m_rA.y*this.m_rA.y+f*this.m_rB.y*this.m_rB.y,v.ex.y=-y*this.m_rA.x*this.m_rA.y-f*this.m_rB.x*this.m_rB.y,v.ey.x=v.ex.y,v.ey.y=_+d+y*this.m_rA.x*this.m_rA.x+f*this.m_rB.x*this.m_rB.x,this.m_linearMass=v.getInverse(),this.m_angularMass=y+f,this.m_angularMass>0&&(this.m_angularMass=1/this.m_angularMass),this.m_linearError=a.zero(),this.m_linearError.addCombine(1,m,1,this.m_rB),this.m_linearError.subCombine(1,o,1,this.m_rA),this.m_angularError=h-s-this.m_angularOffset,e.warmStarting){this.m_linearImpulse.mul(e.dtRatio),this.m_angularImpulse*=e.dtRatio;var g=a.neo(this.m_linearImpulse.x,this.m_linearImpulse.y);r.subMul(_,g),n-=y*(a.crossVec2Vec2(this.m_rA,g)+this.m_angularImpulse),u.addMul(d,g),l+=f*(a.crossVec2Vec2(this.m_rB,g)+this.m_angularImpulse)}else this.m_linearImpulse.setZero(),this.m_angularImpulse=0;this.m_bodyA.c_velocity.v=r,this.m_bodyA.c_velocity.w=n,this.m_bodyB.c_velocity.v=u,this.m_bodyB.c_velocity.w=l},t.prototype.solveVelocityConstraints=function(e){var o=this.m_bodyA.c_velocity.v,s=this.m_bodyA.c_velocity.w,r=this.m_bodyB.c_velocity.v,n=this.m_bodyB.c_velocity.w,m=this.m_invMassA,h=this.m_invMassB,u=this.m_invIA,l=this.m_invIB,p=e.dt,c=e.inv_dt;{var _=n-s+c*this.m_correctionFactor*this.m_angularError,d=-this.m_angularMass*_,y=this.m_angularImpulse,f=p*this.m_maxTorque;this.m_angularImpulse=pt(this.m_angularImpulse+d,-f,f),d=this.m_angularImpulse-y,s-=u*d,n+=l*d}{var _=a.zero();_.addCombine(1,r,1,a.crossNumVec2(n,this.m_rB)),_.subCombine(1,o,1,a.crossNumVec2(s,this.m_rA)),_.addMul(c*this.m_correctionFactor,this.m_linearError);var d=a.neg(qt.mulVec2(this.m_linearMass,_)),y=a.clone(this.m_linearImpulse);this.m_linearImpulse.add(d);var f=p*this.m_maxForce;this.m_linearImpulse.clamp(f),d=a.sub(this.m_linearImpulse,y),o.subMul(m,d),s-=u*a.crossVec2Vec2(this.m_rA,d),r.addMul(h,d),n+=l*a.crossVec2Vec2(this.m_rB,d)}this.m_bodyA.c_velocity.v=o,this.m_bodyA.c_velocity.w=s,this.m_bodyB.c_velocity.v=r,this.m_bodyB.c_velocity.w=n},t.prototype.solvePositionConstraints=function(e){return!0},t.TYPE="motor-joint",t}(yt),Cr=Math.PI,Mr={maxForce:0,frequencyHz:5,dampingRatio:.7},Io=function(i){xt(t,i);function t(e,o,s,r){var n=this;return n instanceof t?(e=Nt(e,Mr),n=i.call(this,e,o,s)||this,o=n.m_bodyA,s=n.m_bodyB,n.m_type=t.TYPE,a.isValid(r)?n.m_targetA=a.clone(r):a.isValid(e.target)?n.m_targetA=a.clone(e.target):n.m_targetA=a.zero(),n.m_localAnchorB=ft.mulTVec2(s.getTransform(),n.m_targetA),n.m_maxForce=e.maxForce,n.m_impulse=a.zero(),n.m_frequencyHz=e.frequencyHz,n.m_dampingRatio=e.dampingRatio,n.m_beta=0,n.m_gamma=0,n.m_rB=a.zero(),n.m_localCenterB=a.zero(),n.m_invMassB=0,n.m_invIB=0,n.m_mass=new qt,n.m_C=a.zero(),n):new t(e,o,s,r)}return t.prototype._serialize=function(){return{type:this.m_type,bodyA:this.m_bodyA,bodyB:this.m_bodyB,collideConnected:this.m_collideConnected,target:this.m_targetA,maxForce:this.m_maxForce,frequencyHz:this.m_frequencyHz,dampingRatio:this.m_dampingRatio,_localAnchorB:this.m_localAnchorB}},t._deserialize=function(e,o,s){e=vt({},e),e.bodyA=s(W,e.bodyA,o),e.bodyB=s(W,e.bodyB,o),e.target=a.clone(e.target);var r=new t(e);return e._localAnchorB&&(r.m_localAnchorB=e._localAnchorB),r},t.prototype._reset=function(e){Number.isFinite(e.maxForce)&&(this.m_maxForce=e.maxForce),Number.isFinite(e.frequencyHz)&&(this.m_frequencyHz=e.frequencyHz),Number.isFinite(e.dampingRatio)&&(this.m_dampingRatio=e.dampingRatio)},t.prototype.setTarget=function(e){a.areEqual(e,this.m_targetA)||(this.m_bodyB.setAwake(!0),this.m_targetA.set(e))},t.prototype.getTarget=function(){return this.m_targetA},t.prototype.setMaxForce=function(e){this.m_maxForce=e},t.prototype.getMaxForce=function(){return this.m_maxForce},t.prototype.setFrequency=function(e){this.m_frequencyHz=e},t.prototype.getFrequency=function(){return this.m_frequencyHz},t.prototype.setDampingRatio=function(e){this.m_dampingRatio=e},t.prototype.getDampingRatio=function(){return this.m_dampingRatio},t.prototype.getAnchorA=function(){return a.clone(this.m_targetA)},t.prototype.getAnchorB=function(){return this.m_bodyB.getWorldPoint(this.m_localAnchorB)},t.prototype.getReactionForce=function(e){return a.mulNumVec2(e,this.m_impulse)},t.prototype.getReactionTorque=function(e){return e*0},t.prototype.shiftOrigin=function(e){this.m_targetA.sub(e)},t.prototype.initVelocityConstraints=function(e){this.m_localCenterB=this.m_bodyB.m_sweep.localCenter,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIB=this.m_bodyB.m_invI;var o=this.m_bodyB.c_position,s=this.m_bodyB.c_velocity,r=o.c,n=o.a,m=s.v,h=s.w,u=b.neo(n),l=this.m_bodyB.getMass(),p=2*Cr*this.m_frequencyHz,c=2*l*this.m_dampingRatio*p,_=l*(p*p),d=e.dt;this.m_gamma=d*(c+d*_),this.m_gamma!=0&&(this.m_gamma=1/this.m_gamma),this.m_beta=d*_*this.m_gamma,this.m_rB=b.mulVec2(u,a.sub(this.m_localAnchorB,this.m_localCenterB));var y=new qt;y.ex.x=this.m_invMassB+this.m_invIB*this.m_rB.y*this.m_rB.y+this.m_gamma,y.ex.y=-this.m_invIB*this.m_rB.x*this.m_rB.y,y.ey.x=y.ex.y,y.ey.y=this.m_invMassB+this.m_invIB*this.m_rB.x*this.m_rB.x+this.m_gamma,this.m_mass=y.getInverse(),this.m_C.setVec2(r),this.m_C.addCombine(1,this.m_rB,-1,this.m_targetA),this.m_C.mul(this.m_beta),h*=.98,e.warmStarting?(this.m_impulse.mul(e.dtRatio),m.addMul(this.m_invMassB,this.m_impulse),h+=this.m_invIB*a.crossVec2Vec2(this.m_rB,this.m_impulse)):this.m_impulse.setZero(),s.v.setVec2(m),s.w=h},t.prototype.solveVelocityConstraints=function(e){var o=this.m_bodyB.c_velocity,s=a.clone(o.v),r=o.w,n=a.crossNumVec2(r,this.m_rB);n.add(s),n.addCombine(1,this.m_C,this.m_gamma,this.m_impulse),n.neg();var m=qt.mulVec2(this.m_mass,n),h=a.clone(this.m_impulse);this.m_impulse.add(m);var u=e.dt*this.m_maxForce;this.m_impulse.clamp(u),m=a.sub(this.m_impulse,h),s.addMul(this.m_invMassB,m),r+=this.m_invIB*a.crossVec2Vec2(this.m_rB,m),o.v.setVec2(s),o.w=r},t.prototype.solvePositionConstraints=function(e){return!0},t.TYPE="mouse-joint",t}(yt),Ir=Math.abs,Pr={collideConnected:!0},Po=function(i){xt(t,i);function t(e,o,s,r,n,m,h,u){var l=this;return l instanceof t?(e=Nt(e,Pr),l=i.call(this,e,o,s)||this,o=l.m_bodyA,s=l.m_bodyB,l.m_type=t.TYPE,l.m_groundAnchorA=a.clone(r||e.groundAnchorA||a.neo(-1,1)),l.m_groundAnchorB=a.clone(n||e.groundAnchorB||a.neo(1,1)),l.m_localAnchorA=a.clone(m?o.getLocalPoint(m):e.localAnchorA||a.neo(-1,0)),l.m_localAnchorB=a.clone(h?s.getLocalPoint(h):e.localAnchorB||a.neo(1,0)),l.m_lengthA=Number.isFinite(e.lengthA)?e.lengthA:a.distance(m,r),l.m_lengthB=Number.isFinite(e.lengthB)?e.lengthB:a.distance(h,n),l.m_ratio=Number.isFinite(u)?u:e.ratio,l.m_constant=l.m_lengthA+l.m_ratio*l.m_lengthB,l.m_impulse=0,l):new t(e,o,s,r,n,m,h,u)}return t.prototype._serialize=function(){return{type:this.m_type,bodyA:this.m_bodyA,bodyB:this.m_bodyB,collideConnected:this.m_collideConnected,groundAnchorA:this.m_groundAnchorA,groundAnchorB:this.m_groundAnchorB,localAnchorA:this.m_localAnchorA,localAnchorB:this.m_localAnchorB,lengthA:this.m_lengthA,lengthB:this.m_lengthB,ratio:this.m_ratio}},t._deserialize=function(e,o,s){e=vt({},e),e.bodyA=s(W,e.bodyA,o),e.bodyB=s(W,e.bodyB,o);var r=new t(e);return r},t.prototype._reset=function(e){a.isValid(e.groundAnchorA)&&this.m_groundAnchorA.set(e.groundAnchorA),a.isValid(e.groundAnchorB)&&this.m_groundAnchorB.set(e.groundAnchorB),a.isValid(e.localAnchorA)?this.m_localAnchorA.set(e.localAnchorA):a.isValid(e.anchorA)&&this.m_localAnchorA.set(this.m_bodyA.getLocalPoint(e.anchorA)),a.isValid(e.localAnchorB)?this.m_localAnchorB.set(e.localAnchorB):a.isValid(e.anchorB)&&this.m_localAnchorB.set(this.m_bodyB.getLocalPoint(e.anchorB)),Number.isFinite(e.lengthA)&&(this.m_lengthA=e.lengthA),Number.isFinite(e.lengthB)&&(this.m_lengthB=e.lengthB),Number.isFinite(e.ratio)&&(this.m_ratio=e.ratio)},t.prototype.getGroundAnchorA=function(){return this.m_groundAnchorA},t.prototype.getGroundAnchorB=function(){return this.m_groundAnchorB},t.prototype.getLengthA=function(){return this.m_lengthA},t.prototype.getLengthB=function(){return this.m_lengthB},t.prototype.getRatio=function(){return this.m_ratio},t.prototype.getCurrentLengthA=function(){var e=this.m_bodyA.getWorldPoint(this.m_localAnchorA),o=this.m_groundAnchorA;return a.distance(e,o)},t.prototype.getCurrentLengthB=function(){var e=this.m_bodyB.getWorldPoint(this.m_localAnchorB),o=this.m_groundAnchorB;return a.distance(e,o)},t.prototype.shiftOrigin=function(e){this.m_groundAnchorA.sub(e),this.m_groundAnchorB.sub(e)},t.prototype.getAnchorA=function(){return this.m_bodyA.getWorldPoint(this.m_localAnchorA)},t.prototype.getAnchorB=function(){return this.m_bodyB.getWorldPoint(this.m_localAnchorB)},t.prototype.getReactionForce=function(e){return a.mulNumVec2(this.m_impulse,this.m_uB).mul(e)},t.prototype.getReactionTorque=function(e){return 0},t.prototype.initVelocityConstraints=function(e){this.m_localCenterA=this.m_bodyA.m_sweep.localCenter,this.m_localCenterB=this.m_bodyB.m_sweep.localCenter,this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var o=this.m_bodyA.c_position.c,s=this.m_bodyA.c_position.a,r=this.m_bodyA.c_velocity.v,n=this.m_bodyA.c_velocity.w,m=this.m_bodyB.c_position.c,h=this.m_bodyB.c_position.a,u=this.m_bodyB.c_velocity.v,l=this.m_bodyB.c_velocity.w,p=b.neo(s),c=b.neo(h);this.m_rA=b.mulVec2(p,a.sub(this.m_localAnchorA,this.m_localCenterA)),this.m_rB=b.mulVec2(c,a.sub(this.m_localAnchorB,this.m_localCenterB)),this.m_uA=a.sub(a.add(o,this.m_rA),this.m_groundAnchorA),this.m_uB=a.sub(a.add(m,this.m_rB),this.m_groundAnchorB);var _=this.m_uA.length(),d=this.m_uB.length();_>10*P.linearSlop?this.m_uA.mul(1/_):this.m_uA.setZero(),d>10*P.linearSlop?this.m_uB.mul(1/d):this.m_uB.setZero();var y=a.crossVec2Vec2(this.m_rA,this.m_uA),f=a.crossVec2Vec2(this.m_rB,this.m_uB),v=this.m_invMassA+this.m_invIA*y*y,g=this.m_invMassB+this.m_invIB*f*f;if(this.m_mass=v+this.m_ratio*this.m_ratio*g,this.m_mass>0&&(this.m_mass=1/this.m_mass),e.warmStarting){this.m_impulse*=e.dtRatio;var B=a.mulNumVec2(-this.m_impulse,this.m_uA),w=a.mulNumVec2(-this.m_ratio*this.m_impulse,this.m_uB);r.addMul(this.m_invMassA,B),n+=this.m_invIA*a.crossVec2Vec2(this.m_rA,B),u.addMul(this.m_invMassB,w),l+=this.m_invIB*a.crossVec2Vec2(this.m_rB,w)}else this.m_impulse=0;this.m_bodyA.c_velocity.v=r,this.m_bodyA.c_velocity.w=n,this.m_bodyB.c_velocity.v=u,this.m_bodyB.c_velocity.w=l},t.prototype.solveVelocityConstraints=function(e){var o=this.m_bodyA.c_velocity.v,s=this.m_bodyA.c_velocity.w,r=this.m_bodyB.c_velocity.v,n=this.m_bodyB.c_velocity.w,m=a.add(o,a.crossNumVec2(s,this.m_rA)),h=a.add(r,a.crossNumVec2(n,this.m_rB)),u=-a.dot(this.m_uA,m)-this.m_ratio*a.dot(this.m_uB,h),l=-this.m_mass*u;this.m_impulse+=l;var p=a.mulNumVec2(-l,this.m_uA),c=a.mulNumVec2(-this.m_ratio*l,this.m_uB);o.addMul(this.m_invMassA,p),s+=this.m_invIA*a.crossVec2Vec2(this.m_rA,p),r.addMul(this.m_invMassB,c),n+=this.m_invIB*a.crossVec2Vec2(this.m_rB,c),this.m_bodyA.c_velocity.v=o,this.m_bodyA.c_velocity.w=s,this.m_bodyB.c_velocity.v=r,this.m_bodyB.c_velocity.w=n},t.prototype.solvePositionConstraints=function(e){var o=this.m_bodyA.c_position.c,s=this.m_bodyA.c_position.a,r=this.m_bodyB.c_position.c,n=this.m_bodyB.c_position.a,m=b.neo(s),h=b.neo(n),u=b.mulVec2(m,a.sub(this.m_localAnchorA,this.m_localCenterA)),l=b.mulVec2(h,a.sub(this.m_localAnchorB,this.m_localCenterB)),p=a.sub(a.add(o,this.m_rA),this.m_groundAnchorA),c=a.sub(a.add(r,this.m_rB),this.m_groundAnchorB),_=p.length(),d=c.length();_>10*P.linearSlop?p.mul(1/_):p.setZero(),d>10*P.linearSlop?c.mul(1/d):c.setZero();var y=a.crossVec2Vec2(u,p),f=a.crossVec2Vec2(l,c),v=this.m_invMassA+this.m_invIA*y*y,g=this.m_invMassB+this.m_invIB*f*f,B=v+this.m_ratio*this.m_ratio*g;B>0&&(B=1/B);var w=this.m_constant-_-this.m_ratio*d,V=Ir(w),I=-B*w,M=a.mulNumVec2(-I,p),S=a.mulNumVec2(-this.m_ratio*I,c);return o.addMul(this.m_invMassA,M),s+=this.m_invIA*a.crossVec2Vec2(u,M),r.addMul(this.m_invMassB,S),n+=this.m_invIB*a.crossVec2Vec2(l,S),this.m_bodyA.c_position.c=o,this.m_bodyA.c_position.a=s,this.m_bodyB.c_position.c=r,this.m_bodyB.c_position.a=n,V<P.linearSlop},t.TYPE="pulley-joint",t}(yt),Sr=Math.min,Li;(function(i){i[i.inactiveLimit=0]="inactiveLimit",i[i.atLowerLimit=1]="atLowerLimit",i[i.atUpperLimit=2]="atUpperLimit",i[i.equalLimits=3]="equalLimits"})(Li||(Li={}));var zr={maxLength:0},So=function(i){xt(t,i);function t(e,o,s,r){var n=this;return n instanceof t?(e=Nt(e,zr),n=i.call(this,e,o,s)||this,o=n.m_bodyA,s=n.m_bodyB,n.m_type=t.TYPE,n.m_localAnchorA=a.clone(r?o.getLocalPoint(r):e.localAnchorA||a.neo(-1,0)),n.m_localAnchorB=a.clone(r?s.getLocalPoint(r):e.localAnchorB||a.neo(1,0)),n.m_maxLength=e.maxLength,n.m_mass=0,n.m_impulse=0,n.m_length=0,n.m_state=Li.inactiveLimit,n):new t(e,o,s,r)}return t.prototype._serialize=function(){return{type:this.m_type,bodyA:this.m_bodyA,bodyB:this.m_bodyB,collideConnected:this.m_collideConnected,localAnchorA:this.m_localAnchorA,localAnchorB:this.m_localAnchorB,maxLength:this.m_maxLength}},t._deserialize=function(e,o,s){e=vt({},e),e.bodyA=s(W,e.bodyA,o),e.bodyB=s(W,e.bodyB,o);var r=new t(e);return r},t.prototype._reset=function(e){Number.isFinite(e.maxLength)&&(this.m_maxLength=e.maxLength)},t.prototype.getLocalAnchorA=function(){return this.m_localAnchorA},t.prototype.getLocalAnchorB=function(){return this.m_localAnchorB},t.prototype.setMaxLength=function(e){this.m_maxLength=e},t.prototype.getMaxLength=function(){return this.m_maxLength},t.prototype.getLimitState=function(){return this.m_state},t.prototype.getAnchorA=function(){return this.m_bodyA.getWorldPoint(this.m_localAnchorA)},t.prototype.getAnchorB=function(){return this.m_bodyB.getWorldPoint(this.m_localAnchorB)},t.prototype.getReactionForce=function(e){return a.mulNumVec2(this.m_impulse,this.m_u).mul(e)},t.prototype.getReactionTorque=function(e){return 0},t.prototype.initVelocityConstraints=function(e){this.m_localCenterA=this.m_bodyA.m_sweep.localCenter,this.m_localCenterB=this.m_bodyB.m_sweep.localCenter,this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var o=this.m_bodyA.c_position.c,s=this.m_bodyA.c_position.a,r=this.m_bodyA.c_velocity.v,n=this.m_bodyA.c_velocity.w,m=this.m_bodyB.c_position.c,h=this.m_bodyB.c_position.a,u=this.m_bodyB.c_velocity.v,l=this.m_bodyB.c_velocity.w,p=b.neo(s),c=b.neo(h);this.m_rA=b.mulSub(p,this.m_localAnchorA,this.m_localCenterA),this.m_rB=b.mulSub(c,this.m_localAnchorB,this.m_localCenterB),this.m_u=a.zero(),this.m_u.addCombine(1,m,1,this.m_rB),this.m_u.subCombine(1,o,1,this.m_rA),this.m_length=this.m_u.length();var _=this.m_length-this.m_maxLength;if(_>0?this.m_state=Li.atUpperLimit:this.m_state=Li.inactiveLimit,this.m_length>P.linearSlop)this.m_u.mul(1/this.m_length);else{this.m_u.setZero(),this.m_mass=0,this.m_impulse=0;return}var d=a.crossVec2Vec2(this.m_rA,this.m_u),y=a.crossVec2Vec2(this.m_rB,this.m_u),f=this.m_invMassA+this.m_invIA*d*d+this.m_invMassB+this.m_invIB*y*y;if(this.m_mass=f!=0?1/f:0,e.warmStarting){this.m_impulse*=e.dtRatio;var v=a.mulNumVec2(this.m_impulse,this.m_u);r.subMul(this.m_invMassA,v),n-=this.m_invIA*a.crossVec2Vec2(this.m_rA,v),u.addMul(this.m_invMassB,v),l+=this.m_invIB*a.crossVec2Vec2(this.m_rB,v)}else this.m_impulse=0;this.m_bodyA.c_velocity.v.setVec2(r),this.m_bodyA.c_velocity.w=n,this.m_bodyB.c_velocity.v.setVec2(u),this.m_bodyB.c_velocity.w=l},t.prototype.solveVelocityConstraints=function(e){var o=this.m_bodyA.c_velocity.v,s=this.m_bodyA.c_velocity.w,r=this.m_bodyB.c_velocity.v,n=this.m_bodyB.c_velocity.w,m=a.addCrossNumVec2(o,s,this.m_rA),h=a.addCrossNumVec2(r,n,this.m_rB),u=this.m_length-this.m_maxLength,l=a.dot(this.m_u,a.sub(h,m));u<0&&(l+=e.inv_dt*u);var p=-this.m_mass*l,c=this.m_impulse;this.m_impulse=Sr(0,this.m_impulse+p),p=this.m_impulse-c;var _=a.mulNumVec2(p,this.m_u);o.subMul(this.m_invMassA,_),s-=this.m_invIA*a.crossVec2Vec2(this.m_rA,_),r.addMul(this.m_invMassB,_),n+=this.m_invIB*a.crossVec2Vec2(this.m_rB,_),this.m_bodyA.c_velocity.v=o,this.m_bodyA.c_velocity.w=s,this.m_bodyB.c_velocity.v=r,this.m_bodyB.c_velocity.w=n},t.prototype.solvePositionConstraints=function(e){var o=this.m_bodyA.c_position.c,s=this.m_bodyA.c_position.a,r=this.m_bodyB.c_position.c,n=this.m_bodyB.c_position.a,m=b.neo(s),h=b.neo(n),u=b.mulSub(m,this.m_localAnchorA,this.m_localCenterA),l=b.mulSub(h,this.m_localAnchorB,this.m_localCenterB),p=a.zero();p.addCombine(1,r,1,l),p.subCombine(1,o,1,u);var c=p.normalize(),_=c-this.m_maxLength;_=pt(_,0,P.maxLinearCorrection);var d=-this.m_mass*_,y=a.mulNumVec2(d,p);return o.subMul(this.m_invMassA,y),s-=this.m_invIA*a.crossVec2Vec2(u,y),r.addMul(this.m_invMassB,y),n+=this.m_invIB*a.crossVec2Vec2(l,y),this.m_bodyA.c_position.c.setVec2(o),this.m_bodyA.c_position.a=s,this.m_bodyB.c_position.c.setVec2(r),this.m_bodyB.c_position.a=n,c-this.m_maxLength<P.linearSlop},t.TYPE="rope-joint",t}(yt),Lr=Math.abs,Tr=Math.PI,Fr={frequencyHz:0,dampingRatio:0},zo=function(i){xt(t,i);function t(e,o,s,r){var n=this;return n instanceof t?(e=Nt(e,Fr),n=i.call(this,e,o,s)||this,o=n.m_bodyA,s=n.m_bodyB,n.m_type=t.TYPE,n.m_localAnchorA=a.clone(r?o.getLocalPoint(r):e.localAnchorA||a.zero()),n.m_localAnchorB=a.clone(r?s.getLocalPoint(r):e.localAnchorB||a.zero()),n.m_referenceAngle=Number.isFinite(e.referenceAngle)?e.referenceAngle:s.getAngle()-o.getAngle(),n.m_frequencyHz=e.frequencyHz,n.m_dampingRatio=e.dampingRatio,n.m_impulse=new J,n.m_bias=0,n.m_gamma=0,n.m_mass=new ce,n):new t(e,o,s,r)}return t.prototype._serialize=function(){return{type:this.m_type,bodyA:this.m_bodyA,bodyB:this.m_bodyB,collideConnected:this.m_collideConnected,frequencyHz:this.m_frequencyHz,dampingRatio:this.m_dampingRatio,localAnchorA:this.m_localAnchorA,localAnchorB:this.m_localAnchorB,referenceAngle:this.m_referenceAngle}},t._deserialize=function(e,o,s){e=vt({},e),e.bodyA=s(W,e.bodyA,o),e.bodyB=s(W,e.bodyB,o);var r=new t(e);return r},t.prototype._reset=function(e){e.anchorA?this.m_localAnchorA.setVec2(this.m_bodyA.getLocalPoint(e.anchorA)):e.localAnchorA&&this.m_localAnchorA.setVec2(e.localAnchorA),e.anchorB?this.m_localAnchorB.setVec2(this.m_bodyB.getLocalPoint(e.anchorB)):e.localAnchorB&&this.m_localAnchorB.setVec2(e.localAnchorB),Number.isFinite(e.frequencyHz)&&(this.m_frequencyHz=e.frequencyHz),Number.isFinite(e.dampingRatio)&&(this.m_dampingRatio=e.dampingRatio)},t.prototype.getLocalAnchorA=function(){return this.m_localAnchorA},t.prototype.getLocalAnchorB=function(){return this.m_localAnchorB},t.prototype.getReferenceAngle=function(){return this.m_referenceAngle},t.prototype.setFrequency=function(e){this.m_frequencyHz=e},t.prototype.getFrequency=function(){return this.m_frequencyHz},t.prototype.setDampingRatio=function(e){this.m_dampingRatio=e},t.prototype.getDampingRatio=function(){return this.m_dampingRatio},t.prototype.getAnchorA=function(){return this.m_bodyA.getWorldPoint(this.m_localAnchorA)},t.prototype.getAnchorB=function(){return this.m_bodyB.getWorldPoint(this.m_localAnchorB)},t.prototype.getReactionForce=function(e){return a.neo(this.m_impulse.x,this.m_impulse.y).mul(e)},t.prototype.getReactionTorque=function(e){return e*this.m_impulse.z},t.prototype.initVelocityConstraints=function(e){this.m_localCenterA=this.m_bodyA.m_sweep.localCenter,this.m_localCenterB=this.m_bodyB.m_sweep.localCenter,this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var o=this.m_bodyA.c_position.a,s=this.m_bodyA.c_velocity.v,r=this.m_bodyA.c_velocity.w,n=this.m_bodyB.c_position.a,m=this.m_bodyB.c_velocity.v,h=this.m_bodyB.c_velocity.w,u=b.neo(o),l=b.neo(n);this.m_rA=b.mulVec2(u,a.sub(this.m_localAnchorA,this.m_localCenterA)),this.m_rB=b.mulVec2(l,a.sub(this.m_localAnchorB,this.m_localCenterB));var p=this.m_invMassA,c=this.m_invMassB,_=this.m_invIA,d=this.m_invIB,y=new ce;if(y.ex.x=p+c+this.m_rA.y*this.m_rA.y*_+this.m_rB.y*this.m_rB.y*d,y.ey.x=-this.m_rA.y*this.m_rA.x*_-this.m_rB.y*this.m_rB.x*d,y.ez.x=-this.m_rA.y*_-this.m_rB.y*d,y.ex.y=y.ey.x,y.ey.y=p+c+this.m_rA.x*this.m_rA.x*_+this.m_rB.x*this.m_rB.x*d,y.ez.y=this.m_rA.x*_+this.m_rB.x*d,y.ex.z=y.ez.x,y.ey.z=y.ez.y,y.ez.z=_+d,this.m_frequencyHz>0){y.getInverse22(this.m_mass);var f=_+d,v=f>0?1/f:0,g=n-o-this.m_referenceAngle,B=2*Tr*this.m_frequencyHz,w=2*v*this.m_dampingRatio*B,V=v*B*B,I=e.dt;this.m_gamma=I*(w+I*V),this.m_gamma=this.m_gamma!=0?1/this.m_gamma:0,this.m_bias=g*I*V*this.m_gamma,f+=this.m_gamma,this.m_mass.ez.z=f!=0?1/f:0}else y.ez.z==0?(y.getInverse22(this.m_mass),this.m_gamma=0,this.m_bias=0):(y.getSymInverse33(this.m_mass),this.m_gamma=0,this.m_bias=0);if(e.warmStarting){this.m_impulse.mul(e.dtRatio);var M=a.neo(this.m_impulse.x,this.m_impulse.y);s.subMul(p,M),r-=_*(a.crossVec2Vec2(this.m_rA,M)+this.m_impulse.z),m.addMul(c,M),h+=d*(a.crossVec2Vec2(this.m_rB,M)+this.m_impulse.z)}else this.m_impulse.setZero();this.m_bodyA.c_velocity.v=s,this.m_bodyA.c_velocity.w=r,this.m_bodyB.c_velocity.v=m,this.m_bodyB.c_velocity.w=h},t.prototype.solveVelocityConstraints=function(e){var o=this.m_bodyA.c_velocity.v,s=this.m_bodyA.c_velocity.w,r=this.m_bodyB.c_velocity.v,n=this.m_bodyB.c_velocity.w,m=this.m_invMassA,h=this.m_invMassB,u=this.m_invIA,l=this.m_invIB;if(this.m_frequencyHz>0){var p=n-s,c=-this.m_mass.ez.z*(p+this.m_bias+this.m_gamma*this.m_impulse.z);this.m_impulse.z+=c,s-=u*c,n+=l*c;var _=a.zero();_.addCombine(1,r,1,a.crossNumVec2(n,this.m_rB)),_.subCombine(1,o,1,a.crossNumVec2(s,this.m_rA));var d=a.neg(ce.mulVec2(this.m_mass,_));this.m_impulse.x+=d.x,this.m_impulse.y+=d.y;var y=a.clone(d);o.subMul(m,y),s-=u*a.crossVec2Vec2(this.m_rA,y),r.addMul(h,y),n+=l*a.crossVec2Vec2(this.m_rB,y)}else{var _=a.zero();_.addCombine(1,r,1,a.crossNumVec2(n,this.m_rB)),_.subCombine(1,o,1,a.crossNumVec2(s,this.m_rA));var p=n-s,f=new J(_.x,_.y,p),v=J.neg(ce.mulVec3(this.m_mass,f));this.m_impulse.add(v);var y=a.neo(v.x,v.y);o.subMul(m,y),s-=u*(a.crossVec2Vec2(this.m_rA,y)+v.z),r.addMul(h,y),n+=l*(a.crossVec2Vec2(this.m_rB,y)+v.z)}this.m_bodyA.c_velocity.v=o,this.m_bodyA.c_velocity.w=s,this.m_bodyB.c_velocity.v=r,this.m_bodyB.c_velocity.w=n},t.prototype.solvePositionConstraints=function(e){var o=this.m_bodyA.c_position.c,s=this.m_bodyA.c_position.a,r=this.m_bodyB.c_position.c,n=this.m_bodyB.c_position.a,m=b.neo(s),h=b.neo(n),u=this.m_invMassA,l=this.m_invMassB,p=this.m_invIA,c=this.m_invIB,_=b.mulVec2(m,a.sub(this.m_localAnchorA,this.m_localCenterA)),d=b.mulVec2(h,a.sub(this.m_localAnchorB,this.m_localCenterB)),y,f,v=new ce;if(v.ex.x=u+l+_.y*_.y*p+d.y*d.y*c,v.ey.x=-_.y*_.x*p-d.y*d.x*c,v.ez.x=-_.y*p-d.y*c,v.ex.y=v.ey.x,v.ey.y=u+l+_.x*_.x*p+d.x*d.x*c,v.ez.y=_.x*p+d.x*c,v.ex.z=v.ez.x,v.ey.z=v.ez.y,v.ez.z=p+c,this.m_frequencyHz>0){var g=a.zero();g.addCombine(1,r,1,d),g.subCombine(1,o,1,_),y=g.length(),f=0;var B=a.neg(v.solve22(g));o.subMul(u,B),s-=p*a.crossVec2Vec2(_,B),r.addMul(l,B),n+=c*a.crossVec2Vec2(d,B)}else{var g=a.zero();g.addCombine(1,r,1,d),g.subCombine(1,o,1,_);var w=n-s-this.m_referenceAngle;y=g.length(),f=Lr(w);var V=new J(g.x,g.y,w),I=new J;if(v.ez.z>0)I=J.neg(v.solve33(V));else{var M=a.neg(v.solve22(g));I.set(M.x,M.y,0)}var B=a.neo(I.x,I.y);o.subMul(u,B),s-=p*(a.crossVec2Vec2(_,B)+I.z),r.addMul(l,B),n+=c*(a.crossVec2Vec2(d,B)+I.z)}return this.m_bodyA.c_position.c=o,this.m_bodyA.c_position.a=s,this.m_bodyB.c_position.c=r,this.m_bodyB.c_position.a=n,y<=P.linearSlop&&f<=P.angularSlop},t.TYPE="weld-joint",t}(yt),qr=Math.abs,Nr=Math.PI,kr={enableMotor:!1,maxMotorTorque:0,motorSpeed:0,frequencyHz:2,dampingRatio:.7},Lo=function(i){xt(t,i);function t(e,o,s,r,n){var m=this;return m instanceof t?(e=Nt(e,kr),m=i.call(this,e,o,s)||this,o=m.m_bodyA,s=m.m_bodyB,m.m_ax=a.zero(),m.m_ay=a.zero(),m.m_type=t.TYPE,m.m_localAnchorA=a.clone(r?o.getLocalPoint(r):e.localAnchorA||a.zero()),m.m_localAnchorB=a.clone(r?s.getLocalPoint(r):e.localAnchorB||a.zero()),a.isValid(n)?m.m_localXAxisA=o.getLocalVector(n):a.isValid(e.localAxisA)?m.m_localXAxisA=a.clone(e.localAxisA):a.isValid(e.localAxis)?m.m_localXAxisA=a.clone(e.localAxis):m.m_localXAxisA=a.neo(1,0),m.m_localYAxisA=a.crossNumVec2(1,m.m_localXAxisA),m.m_mass=0,m.m_impulse=0,m.m_motorMass=0,m.m_motorImpulse=0,m.m_springMass=0,m.m_springImpulse=0,m.m_maxMotorTorque=e.maxMotorTorque,m.m_motorSpeed=e.motorSpeed,m.m_enableMotor=e.enableMotor,m.m_frequencyHz=e.frequencyHz,m.m_dampingRatio=e.dampingRatio,m.m_bias=0,m.m_gamma=0,m):new t(e,o,s,r,n)}return t.prototype._serialize=function(){return{type:this.m_type,bodyA:this.m_bodyA,bodyB:this.m_bodyB,collideConnected:this.m_collideConnected,enableMotor:this.m_enableMotor,maxMotorTorque:this.m_maxMotorTorque,motorSpeed:this.m_motorSpeed,frequencyHz:this.m_frequencyHz,dampingRatio:this.m_dampingRatio,localAnchorA:this.m_localAnchorA,localAnchorB:this.m_localAnchorB,localAxisA:this.m_localXAxisA}},t._deserialize=function(e,o,s){e=vt({},e),e.bodyA=s(W,e.bodyA,o),e.bodyB=s(W,e.bodyB,o);var r=new t(e);return r},t.prototype._reset=function(e){e.anchorA?this.m_localAnchorA.setVec2(this.m_bodyA.getLocalPoint(e.anchorA)):e.localAnchorA&&this.m_localAnchorA.setVec2(e.localAnchorA),e.anchorB?this.m_localAnchorB.setVec2(this.m_bodyB.getLocalPoint(e.anchorB)):e.localAnchorB&&this.m_localAnchorB.setVec2(e.localAnchorB),e.localAxisA&&(this.m_localXAxisA.setVec2(e.localAxisA),this.m_localYAxisA.setVec2(a.crossNumVec2(1,e.localAxisA))),e.enableMotor!==void 0&&(this.m_enableMotor=e.enableMotor),Number.isFinite(e.maxMotorTorque)&&(this.m_maxMotorTorque=e.maxMotorTorque),Number.isFinite(e.motorSpeed)&&(this.m_motorSpeed=e.motorSpeed),Number.isFinite(e.frequencyHz)&&(this.m_frequencyHz=e.frequencyHz),Number.isFinite(e.dampingRatio)&&(this.m_dampingRatio=e.dampingRatio)},t.prototype.getLocalAnchorA=function(){return this.m_localAnchorA},t.prototype.getLocalAnchorB=function(){return this.m_localAnchorB},t.prototype.getLocalAxisA=function(){return this.m_localXAxisA},t.prototype.getJointTranslation=function(){var e=this.m_bodyA,o=this.m_bodyB,s=e.getWorldPoint(this.m_localAnchorA),r=o.getWorldPoint(this.m_localAnchorB),n=a.sub(r,s),m=e.getWorldVector(this.m_localXAxisA),h=a.dot(n,m);return h},t.prototype.getJointSpeed=function(){var e=this.m_bodyA.m_angularVelocity,o=this.m_bodyB.m_angularVelocity;return o-e},t.prototype.isMotorEnabled=function(){return this.m_enableMotor},t.prototype.enableMotor=function(e){e!=this.m_enableMotor&&(this.m_bodyA.setAwake(!0),this.m_bodyB.setAwake(!0),this.m_enableMotor=e)},t.prototype.setMotorSpeed=function(e){e!=this.m_motorSpeed&&(this.m_bodyA.setAwake(!0),this.m_bodyB.setAwake(!0),this.m_motorSpeed=e)},t.prototype.getMotorSpeed=function(){return this.m_motorSpeed},t.prototype.setMaxMotorTorque=function(e){e!=this.m_maxMotorTorque&&(this.m_bodyA.setAwake(!0),this.m_bodyB.setAwake(!0),this.m_maxMotorTorque=e)},t.prototype.getMaxMotorTorque=function(){return this.m_maxMotorTorque},t.prototype.getMotorTorque=function(e){return e*this.m_motorImpulse},t.prototype.setSpringFrequencyHz=function(e){this.m_frequencyHz=e},t.prototype.getSpringFrequencyHz=function(){return this.m_frequencyHz},t.prototype.setSpringDampingRatio=function(e){this.m_dampingRatio=e},t.prototype.getSpringDampingRatio=function(){return this.m_dampingRatio},t.prototype.getAnchorA=function(){return this.m_bodyA.getWorldPoint(this.m_localAnchorA)},t.prototype.getAnchorB=function(){return this.m_bodyB.getWorldPoint(this.m_localAnchorB)},t.prototype.getReactionForce=function(e){return a.combine(this.m_impulse,this.m_ay,this.m_springImpulse,this.m_ax).mul(e)},t.prototype.getReactionTorque=function(e){return e*this.m_motorImpulse},t.prototype.initVelocityConstraints=function(e){this.m_localCenterA=this.m_bodyA.m_sweep.localCenter,this.m_localCenterB=this.m_bodyB.m_sweep.localCenter,this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var o=this.m_invMassA,s=this.m_invMassB,r=this.m_invIA,n=this.m_invIB,m=this.m_bodyA.c_position.c,h=this.m_bodyA.c_position.a,u=this.m_bodyA.c_velocity.v,l=this.m_bodyA.c_velocity.w,p=this.m_bodyB.c_position.c,c=this.m_bodyB.c_position.a,_=this.m_bodyB.c_velocity.v,d=this.m_bodyB.c_velocity.w,y=b.neo(h),f=b.neo(c),v=b.mulVec2(y,a.sub(this.m_localAnchorA,this.m_localCenterA)),g=b.mulVec2(f,a.sub(this.m_localAnchorB,this.m_localCenterB)),B=a.zero();if(B.addCombine(1,p,1,g),B.subCombine(1,m,1,v),this.m_ay=b.mulVec2(y,this.m_localYAxisA),this.m_sAy=a.crossVec2Vec2(a.add(B,v),this.m_ay),this.m_sBy=a.crossVec2Vec2(g,this.m_ay),this.m_mass=o+s+r*this.m_sAy*this.m_sAy+n*this.m_sBy*this.m_sBy,this.m_mass>0&&(this.m_mass=1/this.m_mass),this.m_springMass=0,this.m_bias=0,this.m_gamma=0,this.m_frequencyHz>0){this.m_ax=b.mulVec2(y,this.m_localXAxisA),this.m_sAx=a.crossVec2Vec2(a.add(B,v),this.m_ax),this.m_sBx=a.crossVec2Vec2(g,this.m_ax);var w=o+s+r*this.m_sAx*this.m_sAx+n*this.m_sBx*this.m_sBx;if(w>0){this.m_springMass=1/w;var V=a.dot(B,this.m_ax),I=2*Nr*this.m_frequencyHz,M=2*this.m_springMass*this.m_dampingRatio*I,S=this.m_springMass*I*I,k=e.dt;this.m_gamma=k*(M+k*S),this.m_gamma>0&&(this.m_gamma=1/this.m_gamma),this.m_bias=V*k*S*this.m_gamma,this.m_springMass=w+this.m_gamma,this.m_springMass>0&&(this.m_springMass=1/this.m_springMass)}}else this.m_springImpulse=0;if(this.m_enableMotor?(this.m_motorMass=r+n,this.m_motorMass>0&&(this.m_motorMass=1/this.m_motorMass)):(this.m_motorMass=0,this.m_motorImpulse=0),e.warmStarting){this.m_impulse*=e.dtRatio,this.m_springImpulse*=e.dtRatio,this.m_motorImpulse*=e.dtRatio;var T=a.combine(this.m_impulse,this.m_ay,this.m_springImpulse,this.m_ax),O=this.m_impulse*this.m_sAy+this.m_springImpulse*this.m_sAx+this.m_motorImpulse,Y=this.m_impulse*this.m_sBy+this.m_springImpulse*this.m_sBx+this.m_motorImpulse;u.subMul(this.m_invMassA,T),l-=this.m_invIA*O,_.addMul(this.m_invMassB,T),d+=this.m_invIB*Y}else this.m_impulse=0,this.m_springImpulse=0,this.m_motorImpulse=0;this.m_bodyA.c_velocity.v.setVec2(u),this.m_bodyA.c_velocity.w=l,this.m_bodyB.c_velocity.v.setVec2(_),this.m_bodyB.c_velocity.w=d},t.prototype.solveVelocityConstraints=function(e){var o=this.m_invMassA,s=this.m_invMassB,r=this.m_invIA,n=this.m_invIB,m=this.m_bodyA.c_velocity.v,h=this.m_bodyA.c_velocity.w,u=this.m_bodyB.c_velocity.v,l=this.m_bodyB.c_velocity.w;{var p=a.dot(this.m_ax,u)-a.dot(this.m_ax,m)+this.m_sBx*l-this.m_sAx*h,c=-this.m_springMass*(p+this.m_bias+this.m_gamma*this.m_springImpulse);this.m_springImpulse+=c;var _=a.mulNumVec2(c,this.m_ax),d=c*this.m_sAx,y=c*this.m_sBx;m.subMul(o,_),h-=r*d,u.addMul(s,_),l+=n*y}{var p=l-h-this.m_motorSpeed,c=-this.m_motorMass*p,f=this.m_motorImpulse,v=e.dt*this.m_maxMotorTorque;this.m_motorImpulse=pt(this.m_motorImpulse+c,-v,v),c=this.m_motorImpulse-f,h-=r*c,l+=n*c}{var p=a.dot(this.m_ay,u)-a.dot(this.m_ay,m)+this.m_sBy*l-this.m_sAy*h,c=-this.m_mass*p;this.m_impulse+=c;var _=a.mulNumVec2(c,this.m_ay),d=c*this.m_sAy,y=c*this.m_sBy;m.subMul(o,_),h-=r*d,u.addMul(s,_),l+=n*y}this.m_bodyA.c_velocity.v.setVec2(m),this.m_bodyA.c_velocity.w=h,this.m_bodyB.c_velocity.v.setVec2(u),this.m_bodyB.c_velocity.w=l},t.prototype.solvePositionConstraints=function(e){var o=this.m_bodyA.c_position.c,s=this.m_bodyA.c_position.a,r=this.m_bodyB.c_position.c,n=this.m_bodyB.c_position.a,m=b.neo(s),h=b.neo(n),u=b.mulVec2(m,a.sub(this.m_localAnchorA,this.m_localCenterA)),l=b.mulVec2(h,a.sub(this.m_localAnchorB,this.m_localCenterB)),p=a.zero();p.addCombine(1,r,1,l),p.subCombine(1,o,1,u);var c=b.mulVec2(m,this.m_localYAxisA),_=a.crossVec2Vec2(a.add(p,u),c),d=a.crossVec2Vec2(l,c),y=a.dot(p,c),f=this.m_invMassA+this.m_invMassB+this.m_invIA*this.m_sAy*this.m_sAy+this.m_invIB*this.m_sBy*this.m_sBy,v=f!=0?-y/f:0,g=a.mulNumVec2(v,c),B=v*_,w=v*d;return o.subMul(this.m_invMassA,g),s-=this.m_invIA*B,r.addMul(this.m_invMassB,g),n+=this.m_invIB*w,this.m_bodyA.c_position.c.setVec2(o),this.m_bodyA.c_position.a=s,this.m_bodyB.c_position.c.setVec2(r),this.m_bodyB.c_position.a=n,qr(y)<=P.linearSlop},t.TYPE="wheel-joint",t}(yt),rt,Dr=0,on={World:$e,Body:W,Joint:yt,Fixture:di,Shape:Ve},sn={Vec2:a,Vec3:J,World:$e,Body:W,Joint:yt,Fixture:di,Shape:Ve},Rr=(rt={},rt[W.STATIC]=W,rt[W.DYNAMIC]=W,rt[W.KINEMATIC]=W,rt[Ge.TYPE]=Ge,rt[ee.TYPE]=ee,rt[te.TYPE]=te,rt[le.TYPE]=le,rt[Bo.TYPE]=Bo,rt[wo.TYPE]=wo,rt[Co.TYPE]=Co,rt[Mo.TYPE]=Mo,rt[Io.TYPE]=Io,rt[Vo.TYPE]=Vo,rt[Po.TYPE]=Po,rt[he.TYPE]=he,rt[So.TYPE]=So,rt[zo.TYPE]=zo,rt[Lo.TYPE]=Lo,rt),jr={rootClass:$e,preSerialize:function(i){return i},postSerialize:function(i,t){return i},preDeserialize:function(i){return i},postDeserialize:function(i,t){return i}},Ri=function(){function i(t){var e=this;this.toJson=function(o){var s=e.options.preSerialize,r=e.options.postSerialize,n=[],m=[o],h={};function u(d,y){if(d.__sid=d.__sid||++Dr,!h[d.__sid]){m.push(d);var f=n.length+m.length,v={refIndex:f,refType:y};h[d.__sid]=v}return h[d.__sid]}function l(d){d=s(d);var y=d._serialize();return y=r(y,d),y}function p(d,y){if(y===void 0&&(y=!1),typeof d!="object"||d===null)return d;if(typeof d._serialize=="function"){if(!y){for(var f in on)if(d instanceof on[f])return u(d,f)}d=l(d)}if(Array.isArray(d)){for(var v=[],g=0;g<d.length;g++)v[g]=p(d[g]);d=v}else{var v={};for(var g in d)d.hasOwnProperty(g)&&(v[g]=p(d[g]));d=v}return d}for(;m.length;){var c=m.shift(),_=p(c,!0);n.push(_)}return n},this.fromJson=function(o){var s=e.options.preDeserialize,r=e.options.postDeserialize,n=e.options.rootClass,m={};function h(p,c,_){(!p||!p._deserialize)&&(p=Rr[c.type]);var d=p&&p._deserialize;if(d){c=s(c);var y=p._deserialize,f=y(c,_,u);return f=r(f,c),f}}function u(p,c,_){var d=c.refIndex&&c.refType;if(!d)return h(p,c,_);var y=c;sn[y.refType]&&(p=sn[y.refType]);var f=y.refIndex;if(!m[f]){var v=o[f],g=h(p,v,_);m[f]=g}return m[f]}var l=h(n,o[0],null);return l},this.options=vt(vt({},jr),t)}return i}(),zn=new Ri({rootClass:$e});Ri.fromJson=zn.fromJson;Ri.toJson=zn.toJson;var ds=function(){function i(){this.width=80,this.height=60,this.x=0,this.y=-10,this.scaleY=-1,this.hz=60,this.speed=1,this.background="#222222",this.activeKeys={},this.step=function(t,e){},this.keydown=function(t,e){},this.keyup=function(t,e){}}return i.mount=function(t){throw new Error("Not implemented")},i.start=function(t){var e=i.mount();return e.start(t),e},i.prototype.color=function(t,e,o){return t=t*256|0,e=e*256|0,o=o*256|0,"rgb("+t+", "+e+", "+o+")"},i}();function Ln(i,t){var e,o;typeof i=="function"?(e=i,o=t):typeof t=="function"?(e=t,o=i):o=i??t;var s=ds.mount(o);if(e){var r=e(s)||s.world;s.start(r)}else return s}var fs=function(i){xt(t,i);function t(e,o,s,r){var n=this;return n instanceof t?(n=i.call(this)||this,n._setAsBox(e,o,s,r),n):new t(e,o,s,r)}return t.TYPE="polygon",t}(ee),Tn=fs;Wt.addType(le.TYPE,le.TYPE,Or);function Or(i,t,e,o,s,r,n){vs(i,e.getShape(),t,r.getShape(),s)}var nn=A(0,0),rn=A(0,0),vs=function(i,t,e,o,s){i.pointCount=0,q(nn,e,t.m_p),q(rn,s,o.m_p);var r=Ke(rn,nn),n=t.m_radius,m=o.m_radius,h=n+m;r>h*h||(i.type=$.e_circles,x(i.localPoint,t.m_p),z(i.localNormal),i.pointCount=1,x(i.points[0].localPoint,o.m_p),i.points[0].id.setFeatures(0,E.e_vertex,0,E.e_vertex))};Wt.addType(te.TYPE,le.TYPE,Er);Wt.addType(Ge.TYPE,le.TYPE,Jr);function Er(i,t,e,o,s,r,n){var m=e.getShape(),h=r.getShape();jo(i,m,t,h,s)}function Jr(i,t,e,o,s,r,n){var m=e.getShape(),h=new te;m.getChildEdge(h,o);var u=h,l=r.getShape();jo(i,u,t,l,s)}var Ee=A(0,0),os=A(0,0),ss=A(0,0),xe=A(0,0),Je=A(0,0),ci=A(0,0),jo=function(i,t,e,o,s){i.pointCount=0,xn(xe,s,e,o.m_p);var r=t.m_vertex1,n=t.m_vertex2;N(Ee,n,r);var m=C(Ee,n)-C(Ee,xe),h=C(Ee,xe)-C(Ee,r),u=t.m_radius+o.m_radius;if(h<=0){x(Je,r);var l=Ke(xe,r);if(l>u*u)return;if(t.m_hasVertex0){var p=t.m_vertex0,c=r;N(os,c,p);var _=C(os,c)-C(os,xe);if(_>0)return}i.type=$.e_circles,z(i.localNormal),x(i.localPoint,Je),i.pointCount=1,x(i.points[0].localPoint,o.m_p),i.points[0].id.setFeatures(0,E.e_vertex,0,E.e_vertex);return}if(m<=0){x(Je,n);var d=Ke(xe,Je);if(d>u*u)return;if(t.m_hasVertex3){var y=t.m_vertex3,f=n;N(ss,y,f);var v=C(ss,xe)-C(ss,f);if(v>0)return}i.type=$.e_circles,z(i.localNormal),x(i.localPoint,Je),i.pointCount=1,x(i.points[0].localPoint,o.m_p),i.points[0].id.setFeatures(1,E.e_vertex,0,E.e_vertex);return}var g=Ze(Ee);Q(Je,m/g,r,h/g,n);var B=Ke(xe,Je);B>u*u||(Ft(ci,1,Ee),C(ci,xe)-C(ci,r)<0&&Ti(ci),$t(ci),i.type=$.e_faceA,x(i.localNormal,ci),x(i.localPoint,r),i.pointCount=1,x(i.points[0].localPoint,o.m_p),i.points[0].id.setFeatures(0,E.e_face,0,E.e_vertex))},ao=[new At,new At],mo=[new At,new At],Ye=[new At,new At],ho=A(0,0),an=A(0,0),ns=A(0,0),rs=Qe(0,0,0),We=A(0,0),li=A(0,0),co=A(0,0),mn=A(0,0),hn=A(0,0),Se=A(0,0),as=A(0,0),cn=A(0,0);Wt.addType(ee.TYPE,ee.TYPE,Yr);function Yr(i,t,e,o,s,r,n){Oo(i,e.getShape(),t,r.getShape(),s)}function ln(i,t,e,o,s){var r=i.m_count,n=e.m_count,m=i.m_normals,h=i.m_vertices,u=e.m_vertices;gn(rs,o,t);for(var l=0,p=-1/0,c=0;c<r;++c){Yt(ns,rs.q,m[c]),q(an,rs,h[c]);for(var _=1/0,d=0;d<n;++d){var y=C(ns,u[d])-C(ns,an);y<_&&(_=y)}_>p&&(p=_,l=c)}s.maxSeparation=p,s.bestIndex=l}function Wr(i,t,e,o,s,r){var n=t.m_normals,m=s.m_count,h=s.m_vertices,u=s.m_normals;Gn(cn,r.q,e.q,n[o]);for(var l=0,p=1/0,c=0;c<m;++c){var _=C(cn,u[c]);_<p&&(p=_,l=c)}var d=l,y=d+1<m?d+1:0;q(i[0].v,r,h[d]),i[0].id.setFeatures(o,E.e_face,d,E.e_vertex),q(i[1].v,r,h[y]),i[1].id.setFeatures(o,E.e_face,y,E.e_vertex)}var _i={maxSeparation:0,bestIndex:0},Oo=function(i,t,e,o,s){i.pointCount=0;var r=t.m_radius+o.m_radius;ln(t,e,o,s,_i);var n=_i.bestIndex,m=_i.maxSeparation;if(!(m>r)){ln(o,s,t,e,_i);var h=_i.bestIndex,u=_i.maxSeparation;if(!(u>r)){var l,p,c,_,d,y,f=.1*P.linearSlop;u>m+f?(l=o,p=t,c=s,_=e,d=h,i.type=$.e_faceB,y=!0):(l=t,p=o,c=e,_=s,d=n,i.type=$.e_faceA,y=!1),ao[0].recycle(),ao[1].recycle(),Wr(ao,l,c,d,p,_);var v=l.m_count,g=l.m_vertices,B=d,w=d+1<v?d+1:0;x(We,g[B]),x(li,g[w]),N(co,li,We),$t(co),He(mn,co,1),Q(hn,.5,We,.5,li),Yt(Se,c.q,co),He(as,Se,1),q(We,c,We),q(li,c,li);var V=C(as,We),I=-C(Se,We)+r,M=C(Se,li)+r;mo[0].recycle(),mo[1].recycle(),Ye[0].recycle(),Ye[1].recycle(),ut(ho,-Se.x,-Se.y);var S=Xe(mo,ao,ho,I,B);if(!(S<2)){ut(ho,Se.x,Se.y);var k=Xe(Ye,mo,ho,M,w);if(!(k<2)){x(i.localNormal,mn),x(i.localPoint,hn);for(var T=0,O=0;O<Ye.length;++O){var Y=C(as,Ye[O].v)-V;if(Y<=r){var U=i.points[T];us(U.localPoint,_,Ye[O].v),U.id.set(Ye[O].id),y&&U.id.swapFeatures(),++T}}i.pointCount=T}}}}};Wt.addType(ee.TYPE,le.TYPE,Ur);function Ur(i,t,e,o,s,r,n){xs(i,e.getShape(),t,r.getShape(),s)}var Xt=A(0,0),ms=A(0,0),xs=function(i,t,e,o,s){i.pointCount=0,xn(Xt,s,e,o.m_p);for(var r=0,n=-1/0,m=t.m_radius+o.m_radius,h=t.m_count,u=t.m_vertices,l=t.m_normals,p=0;p<h;++p){var c=C(l[p],Xt)-C(l[p],u[p]);if(c>m)return;c>n&&(n=c,r=p)}var _=r,d=_+1<h?_+1:0,y=u[_],f=u[d];if(n<It){i.pointCount=1,i.type=$.e_faceA,x(i.localNormal,l[r]),Q(i.localPoint,.5,y,.5,f),x(i.points[0].localPoint,o.m_p),i.points[0].id.setFeatures(0,E.e_vertex,0,E.e_vertex);return}var v=C(Xt,f)-C(Xt,y)-C(y,f)+C(y,y),g=C(Xt,y)-C(Xt,f)-C(f,y)+C(f,f);if(v<=0){if(Ke(Xt,y)>m*m)return;i.pointCount=1,i.type=$.e_faceA,N(i.localNormal,Xt,y),$t(i.localNormal),x(i.localPoint,y),x(i.points[0].localPoint,o.m_p),i.points[0].id.setFeatures(0,E.e_vertex,0,E.e_vertex)}else if(g<=0){if(Ke(Xt,f)>m*m)return;i.pointCount=1,i.type=$.e_faceA,N(i.localNormal,Xt,f),$t(i.localNormal),x(i.localPoint,f),x(i.points[0].localPoint,o.m_p),i.points[0].id.setFeatures(0,E.e_vertex,0,E.e_vertex)}else{Q(ms,.5,y,.5,f);var B=C(Xt,l[_])-C(ms,l[_]);if(B>m)return;i.pointCount=1,i.type=$.e_faceA,x(i.localNormal,l[_]),x(i.localPoint,ms),x(i.points[0].localPoint,o.m_p),i.points[0].id.setFeatures(0,E.e_vertex,0,E.e_vertex)}},Hr=Math.min;Wt.addType(te.TYPE,ee.TYPE,Zr);Wt.addType(Ge.TYPE,ee.TYPE,Kr);function Zr(i,t,e,o,s,r,n){Eo(i,e.getShape(),t,r.getShape(),s)}var _n=new te;function Kr(i,t,e,o,s,r,n){var m=e.getShape();m.getChildEdge(_n,o),Eo(i,_n,t,r.getShape(),s)}var Et;(function(i){i[i.e_unknown=-1]="e_unknown",i[i.e_edgeA=1]="e_edgeA",i[i.e_edgeB=2]="e_edgeB"})(Et||(Et={}));var un;(function(i){i[i.e_isolated=0]="e_isolated",i[i.e_concave=1]="e_concave",i[i.e_convex=2]="e_convex"})(un||(un={}));var Fn=function(){function i(){}return i}(),Xr=function(){function i(){this.vertices=[],this.normals=[],this.count=0;for(var t=0;t<P.maxPolygonVertices;t++)this.vertices.push(A(0,0)),this.normals.push(A(0,0))}return i}(),Gr=function(){function i(){this.v1=A(0,0),this.v2=A(0,0),this.normal=A(0,0),this.sideNormal1=A(0,0),this.sideNormal2=A(0,0)}return i.prototype.recycle=function(){z(this.v1),z(this.v2),z(this.normal),z(this.sideNormal1),z(this.sideNormal2)},i}(),lo=[new At,new At],ze=[new At,new At],Gt=[new At,new At],se=new Fn,gt=new Fn,ct=new Xr,R=new Gr,_o=A(0,0),Mi=A(0,0),ui=A(0,0),Ii=A(0,0),Pi=Qe(0,0,0),K=A(0,0),ne=A(0,0),F=A(0,0),re=A(0,0),at=A(0,0),mt=A(0,0),pn=A(0,0),Le=A(0,0),Eo=function(i,t,e,o,s){gn(Pi,e,s),q(_o,Pi,o.m_centroid);var r=t.m_vertex0,n=t.m_vertex1,m=t.m_vertex2,h=t.m_vertex3,u=t.m_hasVertex0,l=t.m_hasVertex3;N(ui,m,n),$t(ui),ut(F,ui.y,-ui.x);var p=C(F,_o)-C(F,n),c=0,_=0,d=!1,y=!1;z(ne),z(re),u&&(N(Mi,n,r),$t(Mi),ut(ne,Mi.y,-Mi.x),d=j(Mi,ui)>=0,c=a.dot(ne,_o)-a.dot(ne,r)),l&&(N(Ii,h,m),$t(Ii),ut(re,Ii.y,-Ii.x),y=a.crossVec2Vec2(ui,Ii)>0,_=a.dot(re,_o)-a.dot(re,m));var f;z(K),z(at),z(mt),u&&l?d&&y?(f=c>=0||p>=0||_>=0,f?(x(K,F),x(at,ne),x(mt,re)):(L(K,-1,F),L(at,-1,F),L(mt,-1,F))):d?(f=c>=0||p>=0&&_>=0,f?(x(K,F),x(at,ne),x(mt,F)):(L(K,-1,F),L(at,-1,re),L(mt,-1,F))):y?(f=_>=0||c>=0&&p>=0,f?(x(K,F),x(at,F),x(mt,re)):(L(K,-1,F),L(at,-1,F),L(mt,-1,ne))):(f=c>=0&&p>=0&&_>=0,f?(x(K,F),x(at,F),x(mt,F)):(L(K,-1,F),L(at,-1,re),L(mt,-1,ne))):u?d?(f=c>=0||p>=0,f?(x(K,F),x(at,ne),L(mt,-1,F)):(L(K,-1,F),x(at,F),L(mt,-1,F))):(f=c>=0&&p>=0,f?(x(K,F),x(at,F),L(mt,-1,F)):(L(K,-1,F),x(at,F),L(mt,-1,ne))):l?y?(f=p>=0||_>=0,f?(x(K,F),L(at,-1,F),x(mt,re)):(L(K,-1,F),L(at,-1,F),x(mt,F))):(f=p>=0&&_>=0,f?(x(K,F),L(at,-1,F),x(mt,F)):(L(K,-1,F),L(at,-1,re),x(mt,F))):(f=p>=0,f?(x(K,F),L(at,-1,F),L(mt,-1,F)):(L(K,-1,F),x(at,F),x(mt,F))),ct.count=o.m_count;for(var v=0;v<o.m_count;++v)q(ct.vertices[v],Pi,o.m_vertices[v]),Yt(ct.normals[v],Pi.q,o.m_normals[v]);var g=o.m_radius+t.m_radius;i.pointCount=0;{se.type=Et.e_edgeA,se.index=f?0:1,se.separation=1/0;for(var v=0;v<ct.count;++v){var B=ct.vertices[v],w=C(K,B)-C(K,n);w<se.separation&&(se.separation=w)}}if(se.type!=Et.e_unknown&&!(se.separation>g)){{gt.type=Et.e_unknown,gt.index=-1,gt.separation=-1/0,ut(pn,-K.y,K.x);for(var v=0;v<ct.count;++v){L(Le,-1,ct.normals[v]);var V=C(Le,ct.vertices[v])-C(Le,n),I=C(Le,ct.vertices[v])-C(Le,m),w=Hr(V,I);if(w>g){gt.type=Et.e_edgeB,gt.index=v,gt.separation=w;break}if(C(Le,pn)>=0){if(C(Le,K)-C(mt,K)<-P.angularSlop)continue}else if(C(Le,K)-C(at,K)<-P.angularSlop)continue;w>gt.separation&&(gt.type=Et.e_edgeB,gt.index=v,gt.separation=w)}}if(!(gt.type!=Et.e_unknown&&gt.separation>g)){var M=.98,S=.001,k;if(gt.type==Et.e_unknown?k=se:gt.separation>M*se.separation+S?k=gt:k=se,Gt[0].recycle(),Gt[1].recycle(),k.type==Et.e_edgeA){i.type=$.e_faceA;for(var T=0,O=C(K,ct.normals[0]),v=1;v<ct.count;++v){var Y=C(K,ct.normals[v]);Y<O&&(O=Y,T=v)}var U=T,Z=U+1<ct.count?U+1:0;x(Gt[0].v,ct.vertices[U]),Gt[0].id.setFeatures(0,E.e_face,U,E.e_vertex),x(Gt[1].v,ct.vertices[Z]),Gt[1].id.setFeatures(0,E.e_face,Z,E.e_vertex),f?(R.i1=0,R.i2=1,x(R.v1,n),x(R.v2,m),x(R.normal,F)):(R.i1=1,R.i2=0,x(R.v1,m),x(R.v2,n),L(R.normal,-1,F))}else i.type=$.e_faceB,x(Gt[0].v,n),Gt[0].id.setFeatures(0,E.e_vertex,k.index,E.e_face),x(Gt[1].v,m),Gt[1].id.setFeatures(0,E.e_vertex,k.index,E.e_face),R.i1=k.index,R.i2=R.i1+1<ct.count?R.i1+1:0,x(R.v1,ct.vertices[R.i1]),x(R.v2,ct.vertices[R.i2]),x(R.normal,ct.normals[R.i1]);ut(R.sideNormal1,R.normal.y,-R.normal.x),ut(R.sideNormal2,-R.sideNormal1.x,-R.sideNormal1.y),R.sideOffset1=C(R.sideNormal1,R.v1),R.sideOffset2=C(R.sideNormal2,R.v2),lo[0].recycle(),lo[1].recycle(),ze[0].recycle(),ze[1].recycle();var Pt=Xe(lo,Gt,R.sideNormal1,R.sideOffset1,R.i1);if(!(Pt<P.maxManifoldPoints)){var _t=Xe(ze,lo,R.sideNormal2,R.sideOffset2,R.i2);if(!(_t<P.maxManifoldPoints)){k.type==Et.e_edgeA?(x(i.localNormal,R.normal),x(i.localPoint,R.v1)):(x(i.localNormal,o.m_normals[R.i1]),x(i.localPoint,o.m_vertices[R.i1]));for(var Ut=0,v=0;v<P.maxManifoldPoints;++v){var bt=C(R.normal,ze[v].v)-C(R.normal,R.v1);if(bt<=g){var tt=i.points[Ut];k.type==Et.e_edgeA?(us(tt.localPoint,Pi,ze[v].v),tt.id.set(ze[v].id)):(x(tt.localPoint,ze[v].v),tt.id.set(ze[v].id),tt.id.swapFeatures()),++Ut}}i.pointCount=Ut}}}}},qn={CollidePolygons:Oo,Settings:D,Sweep:be,Manifold:Di,Distance:_e,TimeOfImpact:fi,DynamicTree:To,stats:G},Nn=function(){function i(t,e){this._refMap={},this._map={},this._xmap={},this._data=[],this._entered=[],this._exited=[],this._key=t,this._listener=e}return i.prototype.update=function(t){if(!Array.isArray(t))throw"Invalid data: "+t;this._entered.length=0,this._exited.length=0,this._data.length=t.length;for(var e=0;e<t.length;e++)if(!(typeof t[e]!="object"||t[e]===null)){var o=t[e],s=this._key(o);this._map[s]?delete this._map[s]:this._entered.push(o),this._data[e]=o,this._xmap[s]=o}for(var s in this._map)this._exited.push(this._map[s]),delete this._map[s];var r=this._map;this._map=this._xmap,this._xmap=r;for(var e=0;e<this._exited.length;e++){var o=this._exited[e],n=this._key(o),m=this._refMap[n];this._listener.exit(o,m),delete this._refMap[n]}for(var e=0;e<this._entered.length;e++){var o=this._entered[e],n=this._key(o),m=this._listener.enter(o);m&&(this._refMap[n]=m)}for(var e=0;e<this._data.length;e++)if(!(typeof t[e]!="object"||t[e]===null)){var o=this._data[e],n=this._key(o),m=this._refMap[n];this._listener.update(o,m)}this._entered.length=0,this._exited.length=0,this._data.length=0},i.prototype.ref=function(t){return this._refMap[this._key(t)]},i}();const Qr=Object.freeze(Object.defineProperty({__proto__:null,AABB:ht,Body:W,Box:Tn,BoxShape:fs,BroadPhase:ls,Chain:In,ChainShape:Ge,Circle:Sn,CircleShape:le,ClipVertex:At,CollideCircles:vs,CollideEdgeCircle:jo,CollideEdgePolygon:Eo,CollidePolygonCircle:xs,CollidePolygons:Oo,Contact:Wt,ContactEdge:xo,get ContactFeatureType(){return E},ContactID:Do,ContactImpulse:ps,DataDriver:Nn,Distance:_e,DistanceInput:Fi,DistanceJoint:Bo,DistanceOutput:qi,DistanceProxy:Be,DynamicTree:To,Edge:Mn,EdgeShape:te,Fixture:di,FixtureProxy:yo,FrictionJoint:wo,GearJoint:Co,Joint:yt,JointEdge:fo,Manifold:Di,ManifoldPoint:vo,get ManifoldType(){return $},Mat22:qt,Mat33:ce,Math:we,MotorJoint:Mo,MouseJoint:Io,get PointState(){return Ae},Polygon:Pn,PolygonShape:ee,PrismaticJoint:Vo,PulleyJoint:Po,RevoluteJoint:he,RopeJoint:So,Rot:b,Serializer:Ri,Settings:D,SettingsInternal:P,Shape:Ve,ShapeCast:Cn,ShapeCastInput:wn,ShapeCastOutput:Vn,SimplexCache:Ni,Solver:ko,Sweep:be,TOIInput:qo,TOIOutput:No,get TOIOutputState(){return Mt},Testbed:ds,TimeOfImpact:fi,TimeStep:ki,Transform:ft,TreeNode:cs,Vec2:a,Vec3:J,VelocityConstraintPoint:bo,WeldJoint:zo,WheelJoint:Lo,World:$e,WorldManifold:Ro,clipSegmentToLine:Xe,getPointStates:ys,internal:qn,mixFriction:go,mixRestitution:Ao,stats:G,testOverlap:Fo,testbed:Ln},Symbol.toStringTag,{value:"Module"})),$r=Object.freeze(Object.defineProperty({__proto__:null,AABB:ht,Body:W,Box:Tn,BoxShape:fs,BroadPhase:ls,Chain:In,ChainShape:Ge,Circle:Sn,CircleShape:le,ClipVertex:At,CollideCircles:vs,CollideEdgeCircle:jo,CollideEdgePolygon:Eo,CollidePolygonCircle:xs,CollidePolygons:Oo,Contact:Wt,ContactEdge:xo,get ContactFeatureType(){return E},ContactID:Do,ContactImpulse:ps,DataDriver:Nn,Distance:_e,DistanceInput:Fi,DistanceJoint:Bo,DistanceOutput:qi,DistanceProxy:Be,DynamicTree:To,Edge:Mn,EdgeShape:te,Fixture:di,FixtureProxy:yo,FrictionJoint:wo,GearJoint:Co,Joint:yt,JointEdge:fo,Manifold:Di,ManifoldPoint:vo,get ManifoldType(){return $},Mat22:qt,Mat33:ce,Math:we,MotorJoint:Mo,MouseJoint:Io,get PointState(){return Ae},Polygon:Pn,PolygonShape:ee,PrismaticJoint:Vo,PulleyJoint:Po,RevoluteJoint:he,RopeJoint:So,Rot:b,Serializer:Ri,Settings:D,SettingsInternal:P,Shape:Ve,ShapeCast:Cn,ShapeCastInput:wn,ShapeCastOutput:Vn,SimplexCache:Ni,Solver:ko,Sweep:be,TOIInput:qo,TOIOutput:No,get TOIOutputState(){return Mt},Testbed:ds,TimeOfImpact:fi,TimeStep:ki,Transform:ft,TreeNode:cs,Vec2:a,Vec3:J,VelocityConstraintPoint:bo,WeldJoint:zo,WheelJoint:Lo,World:$e,WorldManifold:Ro,clipSegmentToLine:Xe,default:Qr,getPointStates:ys,internal:qn,mixFriction:go,mixRestitution:Ao,stats:G,testOverlap:Fo,testbed:Ln},Symbol.toStringTag,{value:"Module"}));class ta{constructor(){St(this,"_categoryBitCount",1),St(this,"_categoryMap",{}),St(this,"_contacts",[]),St(this,"_enabled",!1),St(this,"_timer",ws.system),St(this,"_pixelRatio",50),St(this,"pl",$r),St(this,"world",new $e({gravity:{x:0,y:20}})),St(this,"boundaryArea"),St(this,"toPh",t=>t/this._pixelRatio),St(this,"to2D",t=>t*this._pixelRatio),St(this,"toPhPos",(t,e={x:0,y:0})=>(e.x=t.x/this._pixelRatio,e.y=t.y/this._pixelRatio,e)),St(this,"to2DPos",(t,e={x:0,y:0})=>(e.x=t.x*this._pixelRatio,e.y=t.y*this._pixelRatio,e)),this._setupCollision()}_setupCollision(){const t=this.world;t.on("pre-solve",e=>{const o=e.getFixtureA().getUserData();if(o!=null&&o.crossSide){const s=e.getManifold().localNormal;switch(o.crossSide){case"left":s.x<-.5&&e.setEnabled(!1);break;case"right":s.x>.5&&e.setEnabled(!1);break;case"top":s.y<-.5&&e.setEnabled(!1);break;case"bottom":s.y>.5&&e.setEnabled(!1);break}}}),t.on("begin-contact",e=>this._onContact(0,e)),t.on("end-contact",e=>this._onContact(1,e))}_onContact(t,e){this._contacts.push(t,e)}init(t){return t&&(t.timer&&(this._timer=t.timer),t.gravity&&this.setGravity(t.gravity.x,t.gravity.y),t.allowSleeping&&this.allowSleeping(t.allowSleeping),t.boundaryArea&&this.setBoundaryArea(t.boundaryArea),t.enabled&&this.enable(!0),t.debug&&this.debug()),this}setGravity(t=0,e=20){return this.world.setGravity({x:t,y:e}),this}allowSleeping(t){return this.world.setAllowSleeping(t),this}clearForces(){return this.world.clearForces(),this}shiftOrigin(t=0,e=10){return this.world.shiftOrigin({x:t,y:e}),this}enable(t=!0){var e,o;return this._enabled!==t&&(this._enabled=t,t?(e=this._timer)==null||e.onFrame(this.update,this):(o=this._timer)==null||o.clearTimer(this.update,this)),this}setBoundaryArea(t){return this.boundaryArea=t,this}inBoundaryArea(t){return this.boundaryArea?this.boundaryArea.contains(t.x,t.y):!0}getCategoryBit(t){if(!t)return 1;if(!this._categoryMap[t]){if(this._categoryBitCount>=31)return console.error("(30)"),1;this._categoryMap[t]=2**this._categoryBitCount,this._categoryBitCount++}return this._categoryMap[t]}getCategoryMask(t){if(!t||t.length===0)return 65535;let e=0;for(const o of t)e|=this.getCategoryBit(o);return e}update(){this.world.step(ws.system.delta),this._processContacts()}_processContacts(){var t,e;const{_contacts:o}=this;for(let s=0;s<o.length;s+=2){const r=o[s]?"collisionEnd":"collisionStart",n=o[s+1],m=(t=n.getFixtureA())==null?void 0:t.getBody().getUserData(),h=(e=n.getFixtureB())==null?void 0:e.getBody().getUserData();!(m!=null&&m.destroyed)&&m!=null&&m.target.hasListener(r)&&m.target.emit(r,{other:h,contact:{normal:n.getManifold().localNormal}}),!(h!=null&&h.destroyed)&&h!=null&&h.target.hasListener(r)&&h.target.emit(r,{other:m,contact:{normal:n.getManifold().localNormal}})}o.length=0}debug(){const t=document.createElement("script");return t.src="https://cdn.jsdelivr.net/npm/planck/dist/planck-with-testbed.min.js",t.onload=()=>{const e=window.planck.Testbed.mount();e.start(this.world);const o=e.canvas;o.style.backgroundColor="rgba(0, 0, 0, 0.5)",o.style.transform="scaleY(-1)",o.style.pointerEvents="none"},document.body.appendChild(t),this}}const oa=new ta;export{ta as Physics,oa as physics};
